"use strict";var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};function writer(){this._indent=0;this._currentLine="";this._tabChar="  ";this._codeStr="";this._lineNumber=1;this._tags={};this._remoteTags={};this._fromTemplate=null;this.toString=function(){return this.getCode()};this.include=function(fileName){var fs=require("fs");var data=fs.readFileSync(fileName,"utf8");this.out(data);return this};this.forkTemplate=function(tpl){var f=this.fork(null);if(typeof tpl=="string")tpl=new jsSimpleTemplate(tpl,f);f._fromTemplate=tpl;return f};this.apply=function(o){if(this._fromTemplate){this._fromTemplate.apply(o)}else{console.error("No template specified for apply")}};this.getCode=function(parentRangeStart,parentLineStart){var _this=this;if(this._fromTemplate){return this._fromTemplate.getOutput()}if(!parentRangeStart)parentRangeStart=0;if(!parentLineStart)parentLineStart=0;var tagList=Object.keys(this._tags);if(tagList.length>0){var s=this._codeStr+this._currentLine;var parts=[];tagList.sort(function(a,b){return _this._tags[a]._tagPos-_this._tags[b]._tagPos});var resStr="",prev_pos=0;tagList.forEach(function(tagName){var tag=_this._tags[tagName];parts.push(s.slice(prev_pos,tag._tagPos));prev_pos=tag._tagPos});parts.push(s.slice(prev_pos));tagList.forEach(function(tagName,index){var tag=_this._tags[tagName];resStr+=parts[index];tag._rangeStart=resStr.length+parentRangeStart;var lineCnt=resStr.split("\n").length;tag._rangeStartLine=lineCnt+parentLineStart;resStr+=tag.getCode(tag._rangeStart,tag._rangeStartLine-1);tag._rangeEnd=resStr.length+parentRangeStart;var lineCnt=resStr.split("\n").length;tag._rangeEndLine=lineCnt+parentLineStart-1});resStr+=parts[parts.length-1];return resStr}return this._codeStr+this._currentLine};this.fork=function(forkData){var tagName="fork"+make_uuid();if(!this._tags[tagName]){this._tags[tagName]=new writer;this._tags[tagName]._tagPos=(this._codeStr+this._currentLine).length;this._tags[tagName]._indent=this._indent;this._tags[tagName]._tagStart=true;this._tags[tagName]._parent=this;this._tags[tagName]._data=forkData}return this._tags[tagName]};this.findTplTag=function(tagName){if(this._fromTemplate){var tplWriter=this._fromTemplate.findTag(tagName);if(tplWriter)return tplWriter}if(this._parent){return this._parent.findTplTag(tagName)}};this.findTag=function(tagName){var tplTag=this.findTplTag(tagName);if(tplTag){return tplTag}if(!this._tags[tagName]){if(this._parent)return this._parent.findTag(tagName)}else{return this._tags[tagName]}};this.tag=function(tagName){var tt=this.findTplTag(tagName);if(tt){return tt}if(!this._tags[tagName]){if(this._parent){var ptag=this._parent.findTag(tagName);if(ptag)return ptag}this._tags[tagName]=new writer;this._tags[tagName]._tagPos=(this._codeStr+this._currentLine).length;this._tags[tagName]._indent=this._indent;this._tags[tagName]._tagStart=true;this._tags[tagName]._parent=this}return this._tags[tagName]};this.indent=function(delta){this._indent+=delta;if(this._indent<0)this._indent=0};this.out=function(str,newLine,trimLines){var _this2=this;if(str instanceof Array){str.forEach(function(s){if((typeof s==="undefined"?"undefined":_typeof(s))=="object"){if(s.tagname){var wr=_this2.tag(s.tagname);if(s.indent){wr._indent=s.indent}return}_this2.out(s+"",true)}else{var tabs=0;var spaces=0;var ii=0;var c=s.charCodeAt(ii);while(ii<s.length&&(c==9||c==32)){if(c==9){tabs++}ii++;c=s.charCodeAt(ii)}s=s.substring(ii);_this2._indent=tabs+Math.floor(spaces/2);_this2.out(s+"",true)}});return}if(!str.split){console.log("Not a string ",str);return}if(this._fromTemplate){console.error("Trying to write to template without tag",newLine);return}if(str){var subs=str.split("\n");if(subs.length>1){this.out(subs);if(newLine){this.out("",true)}return}if(this._currentLine.length==0){for(var i=0;i<this._indent;i++){this._currentLine+=this._tabChar}}this._currentLine+=str}if(newLine){if(this._tagStart)this._tagStart=false;this._codeStr+=this._currentLine+"\n";this._currentLine="";this._lineNumber++}}}(function(_glob){var ctx_prototype=function ctx_prototype(){this.__values=function(){return Object.keys(this.__values)};this.__param=function(n,ctx){var val=this[n];if(val&&val[0]=="@"){val=val.substring(1);return ctx[val]}return val};this.__keys=function(){return Object.keys(this.__defined)};this.__typeof=function(n){if(!this.__defined[n]){if(this.__parent&&this.__parent.__typeof){return this.__parent.__typeof(n)}return}return this.__types[n]};this.__def=function(n,t){var _value;if(this.__defined[n])return;this.__defined[n]=true;this.__types[n]=t;var o=this;Object.defineProperty(this,n,{set:function set(v){o.__values[n]=v;if(o.__events[n]){var list=o.__events[n];for(var i=0;i<list.length;i++){list[i].call(o,v,o)}}},get:function get(){if(!o.__defined[n]){if(o.__parent)return o.__parent[n];return}return o.__values[n]}})};this.__on=function(n,f){if(!this.__defined[n]){if(this.__parent&&this.__parent.__on){this.__parent.__on(n,f)}return}if(!this.__events[n])this.__events[n]=[];this.__events[n].push(f)};this.__fork=function(){return new ctx_class(this)};this.get=function(n){if(!this.__defined[n]){if(this.__parent)return this.__parent.get(n);return}return this.values[n]};this.__def=function(n,t){this.__defined[n]=true;this.__types[n]=t};this.set=function(n,v){if(!this._defined[n]){if(this.parent)return this.parent.set(n,v);return}this.values[n]=v};this.__fork=function(){return create_ctx(this)}};var ctx_class=function ctx_class(parent,autoDefine){this.__parent=parent;this.__defined={};this.__types={};this.__values={};this.__events={};if(autoDefine){var o=this;Object.keys(autoDefine).forEach(function(k){o.__def(k);o[k]=autoDefine[k]})}};ctx_class.prototype=new ctx_prototype;_glob.ranger_ctx=ctx_class;function create_ctx(parent,autoDefine){if(parent){ctx_prototype.prototype=parent}else{ctx_prototype.prototype=null}var o=new ctx_prototype;o.__parent=parent;o.__defined={};o.__types={};o.__values={};o.__events={};if(autoDefine){Object.keys(autoDefine).forEach(function(k){o.__def(k);o[k]=autoDefine[k]})}return o}function create_ctx2(parent,autoDefine){var parentCtxBase=function parentCtxBase(){};if(parent){parentCtxBase.prototype=parent}var o=new parentCtxBase;var values={};var events={};var def_types={};var is_defined={};o.__values=function(){return Object.keys(values)};o.__param=function(n,ctx){var val=o[n];if(val&&val[0]=="@"){val=val.substring(1);return ctx[val]}return val};o.__keys=function(){return Object.keys(is_defined)};o.__typeof=function(n){if(!is_defined[n]){if(parent&&parent.__typeof){return parent.__typeof(n)}return}return def_types[n]};o.__def=function(n,t){var _value;if(is_defined[n])return;is_defined[n]=true;def_types[n]=t;Object.defineProperty(o,n,{set:function set(v){values[n]=v;if(events[n]){var list=events[n];for(var i=0;i<list.length;i++){list[i].call(o,v,o)}}},get:function get(){return values[n]}})};o.__on=function(n,f){if(!is_defined[n]){if(parent&&parent.__on){parent.__on(n,f)}return}if(!events[n])events[n]=[];events[n].push(f)};o.__fork=function(){return create_ctx(o)};if(autoDefine){Object.keys(autoDefine).forEach(function(k){o.__def(k);o[k]=autoDefine[k]})}return o}if(!_glob["Jinx"])_glob["Jinx"]={};_glob["Jinx"].CreateContext=create_ctx})(window);function JMLParser(s,obj){var l=s.length;var len=l;var rootNode=null;var active_node=null;var parents=[];var tag_list=[];var start_index=0;var tag_depth=0;var brace_cnt=0;var parenth_cnt=0;var rootNode=null;var curr_node=null;for(var i=start_index;i<l;i++){tag_expression_parser()}if(tag_depth!=0||brace_cnt!=0||parenth_cnt!=0){throw"Invalid code"}rootNode._code=s;return rootNode;function tag_attr_parser(){while(i<len&&s.charCodeAt(i)<=32){i++}if(s.charCodeAt(i)==40){parenth_cnt++;i++;var last_i;var do_break=false;var attr_name;while(i<len){last_i=i;while(i<len&&s.charCodeAt(i)<=32){i++}var sp=i;var ep=i;var c;while(i<len&&(c=s.charCodeAt(i))>=65&&c<=122){i++}ep=i;if(i<len&&ep>sp){var an_sp=sp;var an_ep=ep;while(i<len&&(c=s.charCodeAt(i))!=58){i++}if(c==58)i++;while(i<len&&s.charCodeAt(i)<=32){i++}var fc=s.charCodeAt(i);if(fc==34){i++;var sp=i;var ep=i;var c;while(i<len&&s.charCodeAt(i)!=34){i++}ep=i;if(i<len&&ep>sp){curr_node.attrs[s.substring(an_sp,an_ep)]=s.substring(sp,ep)}}else{if(fc==40){tag_depth++;var c_node=curr_node;var attr_node={lisp:true,children:[]};curr_node=attr_node;parents.push(curr_node);i++;parse_lisp_expression();curr_node.attrs[s.substring(an_sp,an_ep)]=attr_node;tag_depth--}else{var sp=i;var ep=i;var c;while(i<len&&((c=s.charCodeAt(i))>=65&&c<=90||c>=48&&c<=57||c==95||c==46||c==64||c>=97&&c<=122)){i++}ep=i;if(i<len&&ep>sp){curr_node.attrs[s.substring(an_sp,an_ep)]=s.substring(sp,ep)}}}}if(s.charCodeAt(i)==41){i++;parenth_cnt--;break}if(i==last_i)i++}}}function tag_body_parser(){var c;while(i<len&&(c=s.charCodeAt(i))<=32){i++}if(s.charCodeAt(i)==45&&s.charCodeAt(i+1)==45&&s.charCodeAt(i+2)==61&&s.charCodeAt(i+3)==61&&s.charCodeAt(i+4)==40){i+=5;var sp=i;var ep=i;while(i<len&&!(s.charCodeAt(i)!=40&&s.charCodeAt(i+1)==61&&s.charCodeAt(i+2)==61&&s.charCodeAt(i+3)==45&&s.charCodeAt(i+4)==45)){i++}ep=i;if(i<len&&ep>sp){curr_node.text=s.substring(sp,ep)}i+=5}if(s.charCodeAt(i)!=123){return}i++;brace_cnt++;tag_expression_parser()}function parse_lisp_expression(){parenth_cnt++;while(i<len){var last_i=i;while(i<len&&s.charCodeAt(i)<=32){i++}var c=s.charCodeAt(i);if(s.charCodeAt(i)==59){while(i<len&&s.charCodeAt(i)>31){i++}var c=s.charCodeAt(i)}if(c==34){var end_d=c;i++;var sp=i;var ep=i;while(i<len&&s.charCodeAt(i)!=end_d){i++}ep=i;if(i<len){curr_node.children.push(s.substring(sp,ep))}i++;continue}var c=s.charCodeAt(i);var next_c=s.charCodeAt(i+1);if(c==40||c==39&&next_c==40||c==96&&next_c==40){var is_literal=c==39;var is_quasiliteral=c==96;if(is_literal||is_quasiliteral)i++;tag_depth++;if(!curr_node){curr_node={lisp:true,children:[],__sp:i,literal:is_literal,quasi:is_quasiliteral};rootNode=curr_node;parents.push(curr_node)}else{var new_node={lisp:true,children:[],__sp:i,parent:curr_node,literal:is_literal,quasi:is_quasiliteral};curr_node.children.push(new_node);curr_node=new_node;parents.push(curr_node)}i++;parse_lisp_expression();tag_depth--;continue}var sp=i;var ep=i;var c;var fc=c=s.charCodeAt(i);var idx=curr_node.children.length;if(fc==45&&s.charCodeAt(i+1)>=46&&s.charCodeAt(i+1)<=57||fc>=48&&fc<=57){while(i<len&&(c=s.charCodeAt(i))>32&&c!=40&&c!=41){i++}ep=i;if(i<len&&ep>sp){curr_node.children.push(parseFloat(s.substring(sp,ep)))}}else{if(s.charCodeAt(i)==116&&s.charCodeAt(i+1)==114&&s.charCodeAt(i+2)==117&&s.charCodeAt(i+3)==101){i+=4;curr_node.children.push(true);continue}if(s.charCodeAt(i)==102&&s.charCodeAt(i+1)==97&&s.charCodeAt(i+2)==108&&s.charCodeAt(i+3)==115&&s.charCodeAt(i+4)==101){i+=5;curr_node.children.push(false);continue}if(s.charCodeAt(i)==60){var second=s.charCodeAt(i+1);if(second>=65&&second<=90||second>=97&&second<=122){xml_tag_expression_parser();continue}}var ns=[];var last_ns=sp;while(i<len&&(c=s.charCodeAt(i))>32&&c!=58&&c!=40&&c!=41){if(c==46){ns.push(s.substring(last_ns,i));last_ns=i+1}i++}ep=i;if(ns.length>0){ns.push(s.substring(last_ns,i))}while(i<len&&s.charCodeAt(i)<=32){i++}c=s.charCodeAt(i);if(c==58){i++;while(i<len&&s.charCodeAt(i)<=32){i++}var vt_sp=i;var vt_ep=i;var c=s.charCodeAt(i);if(c==91){i++;var hash_sep=0;while(i<len&&(c=s.charCodeAt(i))>32&&c!=93){if(c==58){hash_sep=i}i++}vt_ep=i;if(hash_sep>0){var array_type=s.substring(hash_sep+1,vt_ep);var key_type=s.substring(vt_sp+1,hash_sep);i++;curr_node.children.push({vref:s.substring(sp,ep),type:"hash",array_type:array_type,key_type:key_type,__sp:vt_sp,__ep:vt_ep,parent:curr_node,ns:ns});continue}else{var array_type=s.substring(vt_sp+1,vt_ep);i++;curr_node.children.push({vref:s.substring(sp,ep),type:"array",array_type:array_type,__sp:vt_sp,__ep:vt_ep,parent:curr_node,ns:ns});continue}}if(c==40){tag_depth++;var c_node=curr_node;var attr_node={lisp:true,children:[]};curr_node=attr_node;parents.push(curr_node);i++;parse_lisp_expression();curr_node.children.push({vref:s.substring(sp,ep),type_def:attr_node,__sp:vt_sp,__ep:vt_ep,parent:curr_node,ns:ns});tag_depth--;continue}while(i<len&&(c=s.charCodeAt(i))>32&&c!=58&&c!=40&&c!=41){i++}vt_ep=i;var type_name=s.substring(vt_sp,vt_ep);curr_node.children.push({vref:s.substring(sp,ep),type:type_name,__sp:vt_sp,__ep:vt_ep,parent:curr_node,ns:ns})}else{if(i<len&&ep>sp){curr_node.children.push({vref:s.substring(sp,ep),__sp:sp,__ep:ep,parent:curr_node,ns:ns})}}}if(s.charCodeAt(i)==41){i++;parenth_cnt--;parents.pop();if(curr_node){curr_node.__ep=i}if(parents.length){curr_node=parents[parents.length-1]}else{curr_node=rootNode}if(curr_node.xml)return;break}if(i==last_i)i++}}function tag_expression_parser(){var do_break=false;var tag;while(i<len){var last_i=i;var pipe_operator=false;var macro_operator=false;while(i<len&&s.charCodeAt(i)<=32){i++}if(s.charCodeAt(i)==125){brace_cnt--;i++;break}if(s.charCodeAt(i)==60){xml_tag_expression_parser()}if(s.charCodeAt(i)==40){tag_depth++;if(!curr_node){curr_node={lisp:true,children:[]};rootNode=curr_node;parents.push(curr_node)}else{var new_node={lisp:true,children:[]};curr_node.children.push(new_node);curr_node=new_node;parents.push(curr_node)}i++;parse_lisp_expression();tag_depth--}if(s.charCodeAt(i)==47&&s.charCodeAt(i+1)==47){while(i<len&&s.charCodeAt(i)>31){i++}}if(s.charCodeAt(i)==59){while(i<len&&s.charCodeAt(i)>31){i++}}if(s.charCodeAt(i)==124&&s.charCodeAt(i+1)==62){pipe_operator=true;i+=2;while(i<len&&s.charCodeAt(i)<=32){i++}}if(s.charCodeAt(i)==33){macro_operator=true;i++;while(i<len&&s.charCodeAt(i)<=32){i++}}var sp=i;var ep=i;var c=s.charCodeAt(i);while(i<len&&(c>=65&&c<=122||c>=48&&c<=57)){i++;c=s.charCodeAt(i)}ep=i;if(i<len&&ep>sp){tag_depth++;var p_type=2;if(ep-sp==7){if(s.charCodeAt(sp)==112&&s.charCodeAt(sp+1)==114&&s.charCodeAt(sp+2)==111&&s.charCodeAt(sp+3)==99&&s.charCodeAt(sp+4)==101&&s.charCodeAt(sp+5)==115&&s.charCodeAt(sp+6)==115){p_type=1}}if(!curr_node){curr_node={name:s.substring(sp,ep),children:[],attrs:{},ptype:p_type,pnode:true,macro:macro_operator,pipe:pipe_operator};rootNode=curr_node;parents.push(curr_node)}else{var new_node={name:s.substring(sp,ep),children:[],attrs:{},ptype:p_type,pnode:true,macro:macro_operator,pipe:pipe_operator};curr_node.children.push(new_node);curr_node=new_node;parents.push(curr_node)}tag_attr_parser();tag_body_parser();tag_depth--;var p=parents.pop();if(parents.length){curr_node=parents[parents.length-1]}else{curr_node=rootNode}}if(last_i==i)i++}}function xml_tag_attr_parser(){var last_i;var do_break=false;var attr_name;while(i<len){last_i=i;while(i<len&&s.charCodeAt(i)<=32){i++}var cc1=s.charCodeAt(i);var cc2=s.charCodeAt(i+1);if(cc1==62){break}if(cc1==47&&cc2==62){i=i+2;do_break=true;tag_list.pop();break}var sp=i;var ep=i;var c;while(i<len&&((c=s.charCodeAt(i))>=65&&c<=122||c==45)){i++}ep=i;if(i<len&&ep>sp){var an_sp=sp;var an_ep=ep;while(i<len&&(c=s.charCodeAt(i))!=61){i++}if(c==61)i++;while(i<len&&s.charCodeAt(i)<=32){i++}if(s.charCodeAt(i)==40){tag_depth++;var c_node=curr_node;var attr_node={lisp:true,children:[]};curr_node=attr_node;parents.push(curr_node);i++;parse_lisp_expression();curr_node.attrs[s.substring(an_sp,an_ep)]=attr_node;tag_depth--;continue}if(s.charCodeAt(i)==34){i++;var sp=i;var ep=i;var c;while(i<len&&s.charCodeAt(i)!=34){i++}ep=i;if(i<len&&ep>sp){curr_node.attrs[s.substring(an_sp,an_ep)]=s.substring(sp,ep)}i++}}if(i==last_i)i++}return do_break}function xml_tag_expression_parser(){var do_break=false;var tag;while(i<len){var last_i=i;var cc1=s.charCodeAt(i);var cc2=s.charCodeAt(i+1);if(cc1==62){i++;cc1=s.charCodeAt(i);cc2=s.charCodeAt(i+1)}if(cc1==47&&cc2==62){tag_depth--;var p=parents.pop();if(parents.length){curr_node=parents[parents.length-1]}else{curr_node=rootNode}tag_list.pop();if(tag_depth<0)throw"Invalid XML";if(tag_list.length==0)return;if(curr_node.lisp)return}if(cc1==60&&cc2==47){i+=2;var sp=i;var ep=i;var c;while(i<len&&((c=s.charCodeAt(i))>=65&&c<=90||c>=48&&c<=57||c==95||c==46||c==64||c>=97&&c<=122)){i++}ep=i;var end_tag_name=s.substring(sp,ep);if(curr_node.xml&&curr_node.name!=end_tag_name){throw"tag end mismatch, expected "+curr_node.name+" got "+end_tag_name}tag_depth--;var p=parents.pop();if(parents.length){curr_node=parents[parents.length-1]}else{curr_node=rootNode}tag_list.pop();i++;if(tag_depth<0)throw"Invalid XML, depth < 0 ";if(tag_list.length==0)return;if(curr_node.lisp){return}}if(cc1==60&&cc2==33&&s.charCodeAt(i+2)==45&&s.charCodeAt(i+3)==45){i+=3;while(i<len&&!(s.charCodeAt(i)==45&&s.charCodeAt(i+1)==45&&s.charCodeAt(i+2)==62)){i++}}if(s.charCodeAt(i)==60&&s.charCodeAt(i+1)==33&&s.charCodeAt(i+2)==91&&s.charCodeAt(i+3)==67&&s.charCodeAt(i+4)==68&&s.charCodeAt(i+5)==65&&s.charCodeAt(i+6)==84&&s.charCodeAt(i+7)==65&&s.charCodeAt(i+8)==91){i+=9;var sp=i;var ep=i;while(i<len&&!(s.charCodeAt(i)==93&&s.charCodeAt(i+1)==93&&s.charCodeAt(i+2)==62)){i++}ep=i;if(i<len&&ep>sp){if(!curr_node.text)curr_node.text="";curr_node.text+=s.substring(sp,ep)}else{}i+=3;continue}if(s.charCodeAt(i)==40){tag_depth++;var c_node=curr_node;var t_node={lisp:true,children:[]};curr_node=t_node;parents.push(curr_node);i++;parse_lisp_expression();curr_node.children.push(t_node);tag_depth--;continue}if(s.charCodeAt(i)==60){i++;var sp=i;var ep=i;var c;while(i<len&&((c=s.charCodeAt(i))>=65&&c<=90||c>=48&&c<=57||c==95||c==46||c==64||c>=97&&c<=122)){i++}ep=i;if(i<len&&ep>sp){var tag_name=s.substring(sp,ep);tag_depth++;if(!curr_node){curr_node={name:tag_name,attrs:{},children:[],xml:true};rootNode=curr_node;parents.push(curr_node)}else{var new_node={name:tag_name,attrs:{},children:[],xml:true};curr_node.children.push(new_node);curr_node=new_node;parents.push(curr_node)}tag_list.push(tag_name);if(xml_tag_attr_parser()){tag_depth--;var p=parents.pop();if(parents.length){curr_node=parents[parents.length-1]}else{curr_node=rootNode}if(tag_depth<0)throw"Invalid XML, depth < 0 ";if(tag_list.length==0)return;if(curr_node.lisp){return}}}}else{var sp=i;var ep=i;while(i<len&&s.charCodeAt(i)!=60&&s.charCodeAt(i)!=40){i++}ep=i;curr_node.children.push({charNode:true,cdata:s.substring(sp,ep)})}if(last_i==i)i++}}}(function(_glob){function raw_value(n){if(typeof n=="boolean")return n;if(!isNaN(n))return parseFloat(n);if(typeof n=="string")return n;if(n&&(typeof n==="undefined"?"undefined":_typeof(n))=="object")return n.value;return n}var LispDebugExpressions={"-":function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;var sum=raw_value(list[1]);for(var i=2;i<list.length;i++){sum=sum-raw_value(list[i])}node.value=sum;node.ready=true;break;default:throw"Invalid index for -"}},"!=":function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;var n=raw_value(list[1]);var v=raw_value(list[2]);node.value=n!=v;node.ready=true;break;default:throw"Invalid index for !="}},"+":function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;var sum=0;for(var i=1;i<list.length;i++){sum=sum+raw_value(list[i])}node.value=sum;node.ready=true;break;default:throw"Invalid index for +"}},"<":function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;var n=raw_value(list[1]);var v=raw_value(list[2]);node.value=n<v;node.ready=true;break;default:throw"Invalid index for <"}},"<=":function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;var n=raw_value(list[1]);var v=raw_value(list[2]);node.value=n<=v;node.ready=true;break;default:throw"Invalid index for <="}},"=":function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;var n=list[1];var v=raw_value(list[2]);ctx[n.vref]=v;node.ready=true;break;default:throw"Invalid index for ="}},"==":function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;var n=raw_value(list[1]);var v=raw_value(list[2]);node.value=n==v;node.ready=true;break;default:throw"Invalid index for =="}},">":function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;var n=raw_value(list[1]);var v=raw_value(list[2]);node.value=n>v;node.ready=true;break;default:throw"Invalid index for >"}},">=":function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;var n=raw_value(list[1]);var v=raw_value(list[2]);node.value=n>=v;node.ready=true;break;default:throw"Invalid index for >="}},add_to_dom:function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;var id=raw_value(list[1]);var dom=document.getElementById(id);if(dom){var t=dom.innerHTML;var sum=t;var p=node.parent;for(var i=2;i<p.args.length;i++){sum=sum+raw_value(p.args[i])}dom.innerHTML=sum;node.value=sum;node.ready=true}break;default:throw"Invalid index for add_to_dom"}},create_js_obj:function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;node.value={};node.ready=true;break;default:throw"Invalid index for create_js_obj"}},debug:function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;debugger;node.ready=true;break;default:throw"Invalid index for debug"}},def:function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;for(var i=1;i<list.length;i+=2){var n=list[i];var v=raw_value(list[i+1]);ctx.__def(n.vref,n.type);ctx[n.vref]=v}node.ready=true;break;default:throw"Invalid index for def"}},defn:function defn(node,ctx){switch(node.index){case 0:var p=node.parent;var the_value;var list=p.args;var f_name=list[1];var f_value=list.slice(2);the_value={lisp:true,is_fn:true,children:f_value};ctx.__def(f_name.vref,f_name.type);ctx[f_name.vref]=the_value;p.ready=true;node.ready=true;break;default:throw"Invalid index for defn"}},first:function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;var seq=raw_value(list[1]);node.value=seq.children[0];node.ready=true;break;default:throw"Invalid index for first"}},fn:function _fn(node,ctx){switch(node.index){case 0:var p=node.parent;var the_value;var list=p.args;var f_name=list[1];var f_value=list.slice(1);the_value={lisp:true,is_fn:true,children:f_value,ctx:ctx};p.ready=true;node.ready=true;node.value=the_value;break;default:throw"Invalid index for fn"}},get_key:function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;var obj=raw_value(list[1]);var key=raw_value(list[2]);node.value=obj[key];node.ready=true;break;default:throw"Invalid index for get_key"}},has_key:function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;var obj=raw_value(list[1]);var key=raw_value(list[2]);node.value=typeof obj[key]!="undefined";node.ready=true;break;default:throw"Invalid index for has_key"}},if:function _if(node){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=2;node.running=true;break;case 1:var cond_value=raw_value(node.parent.args[1]);if(cond_value===true){node.ask_eval=true;node.starting_from=2;node.eval_end_index=3}else{if(node.parent.args[3]){node.ask_eval=true;node.starting_from=3;node.eval_end_index=4}else{node.ready=true;node.value=false}}break;case 2:var cond_value=raw_value(node.parent.args[1]);if(cond_value===true){node.value=raw_value(node.parent.args[2])}else{if(node.parent.args[3]){node.value=raw_value(node.parent.args[3])}}node.ready=true}},join:function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;var sum="";for(var i=1;i<list.length;i++){sum=sum+raw_value(list[i])}node.value=sum;node.ready=true;break;default:throw"Invalid index for join"}},rest:function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;var seq=raw_value(list[1]);the_value={lisp:true,children:seq.children.slice(1)};node.value=the_value;node.ready=true;break;default:throw"Invalid index for rest"}},second:function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;var seq=raw_value(list[1]);node.value=seq.children[1];node.ready=true;break;default:throw"Invalid index for second"}},set_key:function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;var obj=raw_value(list[1]);var key=raw_value(list[2]);node.value=obj[key]=raw_value(list[3]);node.ready=true;break;default:throw"Invalid index for set_key"}},while:function _while(node){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=2;node.running=true;break;case 1:var cond_value=raw_value(node.parent.args[1]);if(cond_value===true){node.ask_eval=true;node.starting_from=2;node.eval_end_index=3}else{debugger;node.ready=true;node.value=raw_value(node.parent.args[2])}break;case 2:node.index=-1}}};if(!_glob["Jinx"])_glob["Jinx"]={};_glob["Jinx"].LispDebugExpressions=LispDebugExpressions;function start_lisp_to_js(p_node,ctx,wr){wr.out("// external context should be given as parameter __ctx__ ",true);wr.out("(function(__ctx__) {",true);wr.indent(1);wr.out("var __local_rest = [];",true);wr.out("var __join = function(a) { return Array.prototype.concat.apply([], a) };",true);create_js_code(p_node,ctx,wr);wr.indent(-1);wr.out("})",true)}function create_js_code(p_node,ctx,wr,is_body){if(!ctx)ctx=Jinx.CreateContext();var code="";if((typeof p_node==="undefined"?"undefined":_typeof(p_node))!="object"){if(typeof p_node=="string"){wr.out('"'+p_node+'"');return}if(!isNaN(p_node)){wr.out(""+p_node);return}wr.out(""+p_node);return}if(p_node.vref){if(p_node.vref=="&"){throw"Rest expression should not be processed as a variable"}var var_type=ctx[p_node.vref];if(var_type.external){wr.out("__ctx__['"+p_node.vref+"']");return}wr.out(p_node.vref);return}if(!p_node.children)return;if(p_node.literal){var obj;var _ret=function(){var parse_literal_to_obj=function parse_literal_to_obj(node){if(typeof node=="boolean")return node;if(typeof node=="string")return node;if(!isNaN(node))return node;if((typeof node==="undefined"?"undefined":_typeof(node))=="object"){if(node.vref){var o={vref:node.vref,type:node.type};if(node.type_def)o.type_def=parse_literal_to_obj(node.type_def);return o}var o={lisp:true};o.children=node.children.map(function(n){return parse_literal_to_obj(n)});return o}};obj=parse_literal_to_obj(p_node);wr.out(JSON.stringify(obj));return{v:void 0}}();if((typeof _ret==="undefined"?"undefined":_typeof(_ret))==="object")return _ret.v}var fc=p_node.children[0];if(fc&&fc.vref=="defmacro"){return}if(fc&&fc.vref=="defn"){wr.out("function ");wr.out(p_node.children[1].vref);wr.out("(");var args_list=p_node.children[2];var the_rest_index=-1;args_list.children.forEach(function(a,i){if(a.vref=="&"){the_rest_index=i;return}if(i>0)wr.out(",");wr.out(a.vref);ctx.__def(a.vref,a.type);ctx[a.vref]={type:a.type,cnt:0,external:false,param:true}});var body_of=p_node.children[3];wr.out(") {",true);wr.indent(1);if(the_rest_index!=-1){wr.out("var __local_rest = Array.prototype.slice.call(arguments, "+the_rest_index+")",true)}else{}wr.out("return (",true);wr.indent(1);create_js_code(body_of,ctx,wr);wr.out("",true);wr.indent(-1);wr.out(")",true);wr.out("",true);wr.indent(-1);wr.out("}",true);return}if(fc&&fc.vref=="use"){var n=p_node.children[1];ctx.__def(n.vref,n.type);ctx[n.vref]={type:n.type,cnt:0,external:true};return}if(fc&&fc.vref=="def"){var n=p_node.children[1];ctx.__def(n.vref,n.type);ctx[n.vref]={type:n.type,cnt:0,external:false};wr.out("var ");wr.out(p_node.children[1].vref);wr.out(" = (");create_js_code(p_node.children[2],ctx,wr);wr.out(");",true);return}if(fc&&fc.vref=="fn"){wr.out("(function ");wr.out("(");var args_list=p_node.children[1];args_list.children.forEach(function(a){wr.out(a.vref);ctx.__def(a.vref,a.type);ctx[a.vref]={type:a.type,cnt:0,external:false,param:true}});var body_of=p_node.children[2];wr.out(") {",true);wr.indent(1);wr.out("return (",true);wr.indent(1);create_js_code(body_of,ctx,wr);wr.out("",true);wr.indent(-1);wr.out(")",true);wr.out("",true);wr.indent(-1);wr.out("})",true);return}if(fc&&fc.vref){var compiler_fn=Jinx.LispCompilerExpressions;var fn=compiler_fn[fc.vref];if(fn){fn(p_node,ctx,wr);return}if(p_node.children.length==1){create_js_code(p_node.children[0],ctx,wr);return}var had_spread_operator=false;for(var i=1;i<p_node.children.length;i++){var arg=p_node.children[i];if((typeof arg==="undefined"?"undefined":_typeof(arg))=="object"&&arg.vref=="&"){had_spread_operator=true;continue}}if(had_spread_operator){wr.out(fc.vref+".apply(this, __join( [");for(var i=1;i<p_node.children.length;i++){if(i==1){wr.indent(1)}if(p_node.children.length>3){if(i>1){wr.out(",",true)}}else{if(i>1){wr.out(",")}}var param_value=p_node.children[i];if((typeof param_value==="undefined"?"undefined":_typeof(param_value))=="object"&&param_value.vref=="&"){wr.out("__local_rest");continue}wr.out("");create_js_code(p_node.children[i],ctx,wr);wr.out("")}if(i>1){wr.indent(-1)}wr.out("]))",true)}else{wr.out(fc.vref+"(");for(var i=1;i<p_node.children.length;i++){if(i==1){wr.indent(1)}if(p_node.children.length>3){if(i>1){wr.out(",",true)}}else{if(i>1){wr.out(",")}}wr.out("");create_js_code(p_node.children[i],ctx,wr);wr.out("")}if(i>1){wr.indent(-1)}wr.out(")",true)}return}if(p_node.children){var last=p_node.children.length-1;var first_child=p_node.children[0];if(first_child&&first_child.children){
var lambda=first_child.children[0];if(lambda&&lambda.vref=="fn"){create_js_code(first_child,ctx,wr);for(var i=1;i<p_node.children.length;i++){if(i>1)wr.out(",");wr.out("(");create_js_code(p_node.children[i],ctx,wr);wr.out(")")}return}}if(p_node.children.length==1){create_js_code(p_node.children[0],ctx,wr);return}wr.out("(function (){",true);wr.indent(1);p_node.children.forEach(function(n,i){if(i>0)wr.out(";",true);if(i==last){if(is_variable_def(n)){}else{wr.out("return ")}}create_js_code(n,ctx,wr,true,i==last)});wr.indent(-1);wr.out("}())",true)}function call_operator(name,p_node){var had_spread_operator=false;for(var i=1;i<p_node.children.length;i++){var arg=p_node.children[i];if((typeof arg==="undefined"?"undefined":_typeof(arg))=="object"&&arg.vref=="&"){had_spread_operator=true;continue}}if(!had_spread_operator){if(name=="inc_operator"){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" + ")}create_js_code(p_node.children[i],ctx,wr)}return}}if(had_spread_operator){wr.out(name+".apply(this, __join([")}else{wr.out(name+"(")}for(var i=1;i<p_node.children.length;i++){if(i==1){wr.indent(1)}if(p_node.children.length>3){if(i>1){wr.out(",",true)}}else{if(i>1){wr.out(",")}}var param_value=p_node.children[i];if((typeof param_value==="undefined"?"undefined":_typeof(param_value))=="object"&&param_value.vref=="&"){wr.out("__local_rest");continue}wr.out("");create_js_code(p_node.children[i],ctx,wr);wr.out("")}if(i>1){wr.indent(-1)}if(had_spread_operator){wr.out("]))",true)}else{wr.out(")")}}}function push_error(node,err){if(!node.errors){node.errors=[]}node.errors.push(err);if(ctx){ctx.__all_errors__.push({node:node,err:err})}}function get_first_child(node){if(is_object(node)&&node.children)return node.children[0]}function is_object(node){return node&&(typeof node==="undefined"?"undefined":_typeof(node))=="object"}function is_assigment(node){if(is_object(node)){if(is_function_call(node)){}}}function is_defined_function(name,ctx){var r=ctx[name];if(!r){push_error(node,"Undeclared function : "+name);return false}if(!is_function_def(r)){push_error(node,"Undeclared function: "+name);return false}return true}function get_fn_name(node){if(is_function_def(node)){return node.children[1].vref}}function get_fn_type(node){if(is_function_def(node)){return node.children[1].type}}function is_fn_def_valid(node){if(is_function_def(node)){try{var name=get_fn_name(node);if(!name){push_error(node,"Invalid name for a function :"+name)}node.children[2].children.map(function(n){return n.vref});if(node.children.length>4){push_error(node.children[4],"Invalid function definition: function parts after function body are not evaluated")}return true}catch(e){push_error(node,"Invalid function");return false}}return false}function get_fn_body(node){if(is_function_def(node)){try{var body=node.children[3];var fc=body.children[0];return body}catch(e){push_error(node,"Invalid function body")}}}function get_fn_args(node){if(is_function_def(node)){try{return node.children[2].children}catch(e){push_error(node,"Invalid fn args")}}}function is_raw_value(node){if(typeof node=="string")return true;if(!isNaN(node))return true;if(typeof node=="boolean")return true;return false}function is_function_def(node){var fc=get_first_child(node);if(is_object(fc)&&fc.vref){if(fc.vref=="fn")return true;if(fc.vref=="defn")return true}}function is_single_value_list(node){var fc=get_first_child(node);if(fc){if(is_function_def(node)||is_variable_def(node)||is_function_call(node)){return false}if(node.children&&node.children.length==1){return true}}return false}function is_another_list(node){var fc=get_first_child(node);if(fc){if(is_function_def(node)||is_variable_def(node)||is_function_call(node)){return false}if(node.children&&node.children.length>1){return true}}return false}function is_variable_def(node){var fc=get_first_child(node);if(is_object(fc)&&fc.vref){if(fc.vref=="def")return true;if(fc.vref=="let")return true}}function is_lambda_function_call(node){var fc=get_first_child(node);if(is_object(fc)){if(fc.vref&&node.children.length>1){return false}if(fc.vref=="fn"||fc.vref=="=>")return true}return true}function is_function_call(node){if(is_variable_def(node))return false;if(is_function_def(node))return false;var fc=get_first_child(node);if(is_object(fc)){if(fc.vref&&node.children.length>1){return true}}}if(!_glob["Jinx"])_glob["Jinx"]={};_glob["Jinx"].CompileLispToJS=start_lisp_to_js})(window);(function(_glob){var _typeof2=typeof Symbol==="function"&&_typeof(Symbol.iterator)==="symbol"?function(obj){return typeof obj==="undefined"?"undefined":_typeof(obj)}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj==="undefined"?"undefined":_typeof(obj)};function raw_value(n){if(typeof n=="boolean")return n;if(!isNaN(n))return parseFloat(n);if(typeof n=="string")return n;if(n&&(typeof n==="undefined"?"undefined":_typeof(n))=="object")return n.value;return n}function lisp_debugger_run(node,ctx){var active_node=node;var active_ctx=node.ctx||ctx;var active_fn=null;var max_loops=1e6;var iter_cnt=0;var b_has_debugger=false;while(active_node){var start_active_node=function start_active_node(){active_node.index=-1;active_node.running=true;active_node.ready=false;active_node._exit_after=false;active_node.ask_expand=false;active_node.ask_eval=false;active_node._eval_rest=false;if(!active_node.ctx)active_node.ctx=active_ctx};var exit_active_node=function exit_active_node(){active_node.running=false;var p=active_node.parent;if(p){p.value=active_node.value;active_node=p;return false}else{if(active_node._onComplete){active_node._onComplete(active_node)}return true}};var handle_eval_params_request=function handle_eval_params_request(){if(!active_node.parent)throw"Can not evalate without parent!";var p=active_node.parent;p.ctx=active_node.ctx;p._eval_rest=true;p._expand_args=true;p._eval_index=active_node.starting_from-1;p._eval_end_index=active_node.eval_end_index;p._exit_after=false;p._continue=active_node;active_node=p};var evaluate_sequence_item=function evaluate_sequence_item(){active_node._eval_index++;if(active_node._eval_index>=active_node._eval_end_index||active_node._eval_index>=active_node.args.length){if(active_node._prepare_fn){active_node._prepare_fn=false;var param_list=active_node._fn_node.children[0];if(!param_list){throw"There was no parameter list for "+active_node._fn_name}for(var i=0;i<param_list.children.length;i++){var name=param_list.children[i];if(name.vref=="&"){var ref_list=active_node.args.slice(i+1).map(function(v){return raw_value(v)});active_node._fn_node.ctx.__def("&");active_node._fn_node.ctx[name.vref]=ref_list;break}var myChild=active_node.args[i+1];active_node._fn_node.ctx.__def(name.vref);active_node._fn_node.ctx[name.vref]=raw_value(myChild)}var fn_node=active_node._fn_node;var fn_body=fn_node.children[1];if(!fn_body){throw"function without function body: "+active_node._fn_name}active_node._eval_rest=false;active_node._eval_index=0;active_node._exit_after=true;fn_body.parent=active_node;fn_body.running=false;fn_body.ctx=active_node._fn_node.ctx;active_node=fn_body;active_node._expand_args=true;return}var c=active_node._continue;c.ask_eval=false;c.ask_expand=false;active_node._eval_rest=false;active_node._eval_index=0;active_node._exit_after=true;active_node=c;return}var pick_current=active_node.args[active_node._eval_index];if(!isNaN(pick_current)){return}if(typeof pick_current=="string"){return}if((typeof pick_current==="undefined"?"undefined":_typeof(pick_current))=="object"){if(pick_current.vref&&(!pick_current.children||pick_current.children.length==0)){pick_current.value=active_node.ctx[pick_current.vref];return}pick_current.ctx=active_node.ctx;active_node=pick_current;active_node.running=false;return}throw"was not able to evaluate value while preparing to a call"};var active_ctx=active_node.ctx||ctx;if(b_has_debugger){if(iter_cnt==1){if(active_node.ctx.__noDebugger){}else{if(typeof lisp_debugger_step!="undefined"){lisp_debugger_step(active_node,function(){lisp_debugger_run(active_node)});return}}}}iter_cnt++;if(max_loops--<0){throw"max loops overflow"}if(!active_node.running){start_active_node();continue}if(active_node.ready||active_node._exit_after){if(exit_active_node())return;continue}if(!active_node.ctx){if(active_node.parent&&active_node.parent.ctx){active_node.ctx=active_node.parent.ctx}else{throw"no context during node run"}}if(active_node._expand_args){expand_sequence(active_node,active_node.ctx);active_node._expand_args=false}if(active_node._expand_parent_args){expand_sequence(active_node.parent,active_node.ctx);active_node._expand_parent_args=false}if(active_node.ask_eval){handle_eval_params_request();continue}active_node.index++;if(active_node._eval_rest){evaluate_sequence_item();continue}if(active_node.fn){active_node.fn(active_node,active_node.ctx);continue}if(active_node.quasi){active_node.value=expand_quasi(active_node,null,active_node.ctx);active_node.ready=true;continue}if(active_node.literal){active_node.value=copy_sequence(active_node,null,null);active_node.ready=true;continue}if(active_node.index==0){if(active_node.children){var first_child=active_node.children[0];if((typeof first_child==="undefined"?"undefined":_typeof(first_child))!="object"){active_node.value=first_child;active_node.ready=true;continue}if(first_child.fn){first_child.ctx=active_node.ctx;active_node=first_child;continue}if(first_child.vref){if(first_child.vref=="use"){active_node.ready=true;continue}if(first_child.vref=="defmacro"){active_node.ready=true;continue}if(first_child.vref=="=>"){active_node._eval_rest=true;active_node._expand_args=true;active_node._eval_index=0;active_node._fn_name="lambda";active_node._prepare_fn=true;active_node._fn_node={lisp:true,children:active_node.children.slice(1)};active_node._fn_param_index=-1;active_node._fn_node.ctx=active_node.ctx.__fork();active_node._fn_node.parent=active_node;continue}var fn_name=Jinx.LispDebugExpressions[first_child.vref];if(fn_name){first_child.fn=fn_name;active_node=first_child;active_node.ctx=active_ctx;active_node._expand_parent_args=true;continue}var test_fn=active_node.ctx[first_child.vref];if(test_fn.lisp){active_node._eval_rest=true;active_node._expand_args=true;active_node._eval_index=0;active_node._fn_name=first_child.vref;active_node._prepare_fn=true;if(test_fn.ctx){var new_ctx=test_fn.ctx;if(test_fn.children[1].running){new_ctx=new_ctx.__fork()}}else{var new_ctx=active_node.ctx.__fork()}active_node._fn_node=create_function(test_fn,active_node,new_ctx);active_node._fn_param_index=-1;active_node._fn_node.ctx=new_ctx;active_node._fn_node.parent=active_node;continue}if(first_child.vref){active_node.value=active_node.ctx[first_child.vref];active_node.ready=true;continue}console.log(active_node);console.log(first_child);throw"Not finished..."}else{first_child.ctx=active_node.ctx;active_node=first_child;continue}}else{if(active_node.vref){active_node.value=active_node.ctx[active_node.vref];active_node.ready=true;continue}throw"did not know what to do with the node!!!"}}else{if(active_node.children){if(active_node.children&&active_node.index==1){var first_child=active_node.children[0];if(first_child.value&&_typeof(first_child.value)=="object"&&first_child.value.is_fn){active_node._eval_rest=true;active_node._expand_args=true;active_node._eval_index=0;active_node._fn_name="lambda";active_node._prepare_fn=true;if(first_child.value.ctx){var new_ctx=first_child.value.ctx;if(test_fn.children[1].running){new_ctx=new_ctx.__fork()}}else{var new_ctx=active_node.ctx.__fork()}active_node._fn_node=create_function(first_child.value,active_node,new_ctx);active_node._fn_param_index=-1;active_node._fn_node.ctx=new_ctx;active_node._fn_node.parent=active_node;continue}}if(active_node.children.length<=active_node.index){if(active_node.children.length>0){var last_ch=active_node.children[active_node.children.length-1];active_node.value=last_ch.value}active_node.ready=true;continue}else{var ch=active_node.children[active_node.index];ch.ctx=active_node.ctx;active_node=ch;continue}}else{throw"did not know what to do with the node!!!"}}}function expand_sequence(node,ctx){if(!node)return;if((typeof node==="undefined"?"undefined":_typeof(node))!="object")return;var list=node.children;if(!list)return;for(var i=0;i<list.length;i++){if(_typeof2(list[i])=="object"){if(list[i].vref=="&"){var begin_list=list.slice(0,i);var end_list=list.slice(i+1);var new_list=begin_list;var other_list=ctx["&"];if(other_list&&other_list.length){new_list=new_list.concat(other_list)}new_list=new_list.concat(end_list);node.args=new_list;return}}}node.args=node.children}function create_function(node,parent,ctx){if(node.children[1].running){return copy_sequence(node,parent,ctx)}return node}function copy_sequence(node,parent,ctx){if(typeof node=="boolean")return node;if(typeof node=="string")return node;if(!isNaN(node))return node;if((typeof node==="undefined"?"undefined":_typeof(node))=="object"){if(node.vref){return{vref:node.vref,parent:parent}}var obj={__sp:node.__sp,__ep:node.__ep,lisp:true,ctx:ctx,parent:parent,is_fn:node.is_fn};obj.children=node.children.map(function(ch){return copy_sequence(ch,obj,ctx)});return obj}throw"Object copy failed"}function flatmap_array(a){return[].concat.apply([],a)}function expand_quasi(node,parent,ctx){if(typeof node=="boolean")return node;if(typeof node=="string")return node;if(!isNaN(node))return node;if((typeof node==="undefined"?"undefined":_typeof(node))=="object"){if(node.vref){if(node.vref.charCodeAt(0)==44){if(node.vref.charCodeAt(1)==64){var obj=ctx[node.vref.substring(2)];if((typeof obj==="undefined"?"undefined":_typeof(obj))=="object"&&obj.children){return obj.children.slice()}return[]}var exp_value=ctx[node.vref.substring(1)];return exp_value}return{vref:node.vref,parent:parent}}var obj={__sp:node.__sp,__ep:node.__ep,lisp:true,ctx:ctx,parent:parent,is_fn:node.is_fn};obj.children=flatmap_array(node.children.map(function(ch){return expand_quasi(ch,obj,ctx)}));return obj}throw"Object copy failed"}}if(!_glob["Jinx"])_glob["Jinx"]={};_glob["Jinx"].LispDebugRunner=lisp_debugger_run})(window);(function(_glob){function raw_value(n){if(typeof n=="boolean")return n;if(!isNaN(n))return parseFloat(n);if(typeof n=="string")return n;if(n&&(typeof n==="undefined"?"undefined":_typeof(n))=="object")return n.value;return n}var LispCompilerExpressions={"-":function _(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" - ")}create_js_code(p_node.children[i],ctx,wr)}return},"!=":function _(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" != ")}create_js_code(p_node.children[i],ctx,wr)}return},"+":function _(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" + ")}create_js_code(p_node.children[i],ctx,wr)}return},"+:(_:int(_:int _:int))":function _Int_Int_Int(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" + ")}create_js_code(p_node.children[i],ctx,wr)}return},"+:(_:double(_:double _:double))":function _Double_Double_Double(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" + ")}create_js_code(p_node.children[i],ctx,wr)}return},"+:(_:string(_:string _:string))":function _String_String_String(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" + ")}create_js_code(p_node.children[i],ctx,wr)}return},"+:(_:double(_:int _:int))":function _Double_Int_Int(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" + ")}create_js_code(p_node.children[i],ctx,wr)}return},"<":function _(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" < ")}create_js_code(p_node.children[i],ctx,wr)}return},"<=":function _(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" <= ")}create_js_code(p_node.children[i],ctx,wr)}return},"=":function _(p_node,ctx,wr){create_js_code(p_node.children[1],ctx,wr);wr.out("=");create_js_code(p_node.children[2],ctx,wr);return},"==":function _(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" == ")}create_js_code(p_node.children[i],ctx,wr)}return},">":function _(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" > ")}create_js_code(p_node.children[i],ctx,wr)}return},">=":function _(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" >= ")}create_js_code(p_node.children[i],ctx,wr)}return},create_js_obj:function create_js_obj(p_node,ctx,wr){wr.out("{}")},first:function first(p_node,ctx,wr){wr.out("((");create_js_code(p_node,ctx,wr);wr.out(").children[0])");return},get_key:function get_key(p_node,ctx,wr){create_js_code(p_node.children[1],ctx,wr);wr.out("[");create_js_code(p_node.children[2],ctx,wr);wr.out("]");return},has_key:function has_key(p_node,ctx,wr){wr.out("(");create_js_code(p_node.children[1],ctx,wr);wr.out("[");create_js_code(p_node.children[2],ctx,wr);wr.out("]");wr.out(" != undefined ) ");return},if:function _if(p_node,ctx,wr){wr.out("(");create_js_code(p_node.children[1],ctx,wr);wr.out(" ? ");create_js_code(p_node.children[2],ctx,wr);wr.out(" : ");if(p_node.children[3]){create_js_code(p_node.children[3],ctx,wr)}else{wr.out(" null ")}wr.out(")")},join:function join(p_node,ctx,wr){wr.out("[");for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(",")}create_js_code(p_node.children[i],ctx,wr)}wr.out("].join('')");return},rest:function rest(p_node,ctx,wr){wr.out("{ lisp:true, children : (");create_js_code(p_node,ctx,wr);wr.out(").children.slice(1) }");return},second:function second(p_node,ctx,wr){wr.out("((");create_js_code(p_node,ctx,wr);wr.out(").children[1])");return},set_key:function set_key(p_node,ctx,wr){wr.out("(");create_js_code(p_node.children[1],ctx,wr);wr.out("[");create_js_code(p_node.children[2],ctx,wr);wr.out("] = ");create_js_code(p_node.children[3],ctx,wr);wr.out(")");return},while:function _while(p_node,ctx,wr){wr.out("(function() {");wr.indent(1);wr.out("",true);wr.out("var __result;",true);wr.out("while(");create_js_code(p_node.children[1],ctx,wr);wr.out(") {",true);wr.indent(1);wr.out("__result = ");create_js_code(p_node.children[2],ctx,wr);wr.out("",true);wr.indent(-1);wr.out("}",true);wr.out("return __result;");wr.indent(-1);wr.out("}())",true)}};if(!_glob["Jinx"])_glob["Jinx"]={};_glob["Jinx"].LispCompilerExpressions=LispCompilerExpressions;function start_lisp_to_js(p_node,ctx,wr){wr.out("// external context should be given as parameter __ctx__ ",true);wr.out("(function(__ctx__) {",true);wr.indent(1);wr.out("var __local_rest = [];",true);wr.out("var __join = function(a) { return Array.prototype.concat.apply([], a) };",true);create_js_code(p_node,ctx,wr);wr.indent(-1);wr.out("})",true)}function create_js_code(p_node,ctx,wr,is_body){if(!ctx)ctx=Jinx.CreateContext();var code="";if((typeof p_node==="undefined"?"undefined":_typeof(p_node))!="object"){if(typeof p_node=="string"){wr.out('"'+p_node+'"');return}if(!isNaN(p_node)){wr.out(""+p_node);return}wr.out(""+p_node);return}if(p_node.vref){if(p_node.vref=="&"){throw"Rest expression should not be processed as a variable"}var var_type=ctx[p_node.vref];if(var_type.external){wr.out("__ctx__['"+p_node.vref+"']");return}wr.out(p_node.vref);return}if(!p_node.children)return;if(p_node.literal){var obj;var _ret2=function(){var parse_literal_to_obj=function parse_literal_to_obj(node){if(typeof node=="boolean")return node;if(typeof node=="string")return node;if(!isNaN(node))return node;if((typeof node==="undefined"?"undefined":_typeof(node))=="object"){if(node.vref){var o={vref:node.vref,type:node.type};if(node.type_def)o.type_def=parse_literal_to_obj(node.type_def);return o}var o={lisp:true};o.children=node.children.map(function(n){return parse_literal_to_obj(n)});return o}};obj=parse_literal_to_obj(p_node);wr.out(JSON.stringify(obj));return{v:void 0}}();if((typeof _ret2==="undefined"?"undefined":_typeof(_ret2))==="object")return _ret2.v}var fc=p_node.children[0];if(fc&&fc.vref=="defmacro"){return}if(fc&&fc.vref=="import"){var name_node=p_node.children[1];if(name_node.ns&&name_node.ns.length>1){var dict_name=name_node.ns[0];ctx.__def(dict_name,"dict");if(!ctx[dict_name]){ctx[name_node.ns[0]]={type:"dictionary",cnt:0,import:true,value:{}}}var f_name=name_node.ns[1];var obj=ctx[name_node.ns[0]];obj[f_name]={type:"function",cnt:0,import:true,signature:sig}}else{var f_name=name_node.vref;var sig=get_node_signature(name_node);ctx.__def(f_name,"function");ctx[f_name]={type:"function",cnt:0,import:true,signature:sig}}return}if(fc&&fc.vref=="defn"){wr.out("function ");wr.out(p_node.children[1].vref);wr.out("(");var args_list=p_node.children[2];var the_rest_index=-1;args_list.children.forEach(function(a,i){if(a.vref=="&"){the_rest_index=i;return}if(i>0)wr.out(",");wr.out(a.vref);ctx.__def(a.vref,a.type);ctx[a.vref]={type:a.type,cnt:0,external:false,param:true}});var body_of=p_node.children[3];wr.out(") {",true);wr.indent(1);if(the_rest_index!=-1){wr.out("var __local_rest = Array.prototype.slice.call(arguments, "+the_rest_index+")",true)}else{}wr.out("return (",true);wr.indent(1);create_js_code(body_of,ctx,wr);wr.out("",true);wr.indent(-1);wr.out(")",true);wr.out("",true);wr.indent(-1);wr.out("}",true);return}if(fc&&fc.vref=="use"){var n=p_node.children[1];ctx.__def(n.vref,n.type);ctx[n.vref]={type:n.type,cnt:0,external:true};return}if(fc&&fc.vref=="def"){var n=p_node.children[1];ctx.__def(n.vref,n.type);ctx[n.vref]={type:n.type,cnt:0,external:false};wr.out("var ");wr.out(p_node.children[1].vref);wr.out(" = (");create_js_code(p_node.children[2],ctx,wr);wr.out(");",true);return}if(fc&&fc.vref=="fn"){wr.out("(function ");wr.out("(");var args_list=p_node.children[1];args_list.children.forEach(function(a){wr.out(a.vref);ctx.__def(a.vref,a.type);ctx[a.vref]={type:a.type,cnt:0,external:false,param:true}});var body_of=p_node.children[2];wr.out(") {",true);wr.indent(1);wr.out("return (",true);wr.indent(1);create_js_code(body_of,ctx,wr);wr.out("",true);wr.indent(-1);wr.out(")",true);wr.out("",true);wr.indent(-1);wr.out("})",true);return}if(fc&&fc.vref){var compiler_fn=Jinx.LispCompilerExpressions;var fn=compiler_fn[fc.vref];if(fn){fn(p_node,ctx,wr);return}if(p_node.children.length==1){create_js_code(p_node.children[0],ctx,wr);return}var had_spread_operator=false;for(var i=1;i<p_node.children.length;i++){var arg=p_node.children[i];if((typeof arg==="undefined"?"undefined":_typeof(arg))=="object"&&arg.vref=="&"){had_spread_operator=true;continue}}if(had_spread_operator){wr.out(fc.vref+".apply(this, __join( [");for(var i=1;i<p_node.children.length;i++){if(i==1){wr.indent(1)}if(p_node.children.length>3){if(i>1){wr.out(",",true)}}else{if(i>1){wr.out(",")}}var param_value=p_node.children[i];if((typeof param_value==="undefined"?"undefined":_typeof(param_value))=="object"&&param_value.vref=="&"){wr.out("__local_rest");continue}wr.out("");create_js_code(p_node.children[i],ctx,wr);wr.out("")}if(i>1){wr.indent(-1)}wr.out("]))",true)}else{if(fc.ns&&fc.ns.length>1){var f_name=fc.ns[1];var obj=ctx[fc.ns[0]];var f_def=obj[f_name];wr.out("__ctx__['"+fc.ns[0]+"']['"+fc.ns[1]+"'](")}else{var f_def=ctx[fc.vref];if(f_def&&f_def.import){wr.out("__ctx__['"+fc.vref+"'](")}else{wr.out(fc.vref+"(")}}for(var i=1;i<p_node.children.length;i++){if(i==1){wr.indent(1)}if(p_node.children.length>3){if(i>1){wr.out(",",true)}}else{if(i>1){wr.out(",")}}wr.out("");create_js_code(p_node.children[i],ctx,wr);wr.out("")}if(i>1){wr.indent(-1)}wr.out(")",true)}return}if(p_node.children){var last=p_node.children.length-1;var first_child=p_node.children[0];if(first_child&&first_child.children){var lambda=first_child.children[0];if(lambda&&lambda.vref=="fn"){create_js_code(first_child,ctx,wr);for(var i=1;i<p_node.children.length;i++){if(i>1)wr.out(",");wr.out("(");create_js_code(p_node.children[i],ctx,wr);wr.out(")")}return}}if(p_node.children.length==1){create_js_code(p_node.children[0],ctx,wr);return}wr.out("(function (){",true);wr.indent(1);p_node.children.forEach(function(n,i){if(i>0)wr.out(";",true);if(i==last){if(is_variable_def(n)){}else{wr.out("return ")}}create_js_code(n,ctx,wr,true,i==last)});wr.indent(-1);wr.out("}())",true)}function call_operator(name,p_node){var had_spread_operator=false;for(var i=1;i<p_node.children.length;i++){var arg=p_node.children[i];if((typeof arg==="undefined"?"undefined":_typeof(arg))=="object"&&arg.vref=="&"){had_spread_operator=true;continue}}if(!had_spread_operator){if(name=="inc_operator"){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" + ")}create_js_code(p_node.children[i],ctx,wr)}return}}if(had_spread_operator){wr.out(name+".apply(this, __join([")}else{wr.out(name+"(")}for(var i=1;i<p_node.children.length;i++){if(i==1){wr.indent(1)}if(p_node.children.length>3){if(i>1){wr.out(",",true)}}else{if(i>1){wr.out(",")}}var param_value=p_node.children[i];if((typeof param_value==="undefined"?"undefined":_typeof(param_value))=="object"&&param_value.vref=="&"){wr.out("__local_rest");continue}wr.out("");create_js_code(p_node.children[i],ctx,wr);wr.out("")}if(i>1){wr.indent(-1)}if(had_spread_operator){wr.out("]))",true)}else{wr.out(")")}}}function push_error(node,err){if(!node.errors){node.errors=[]}node.errors.push(err);if(ctx){ctx.__all_errors__.push({node:node,err:err})}}function get_first_child(node){if(is_object(node)&&node.children)return node.children[0]}function is_object(node){return node&&(typeof node==="undefined"?"undefined":_typeof(node))=="object"}function is_assigment(node){if(is_object(node)){if(is_function_call(node)){}}}function get_node_signature(node){if(node.signature)return node.signature;if(node.type&&!node.type_def&&node.vref&&(!node.children||node.children.length==0)){return node.type}if(is_raw_value(node)){return detect_value_type(node)}if(node.type_def){var def=node.type_def;var call_sig="(_:";var fc=def.children[0];call_sig+=get_node_signature(fc);var args=def.children[1];call_sig+="(";args.children.forEach(function(a,i){if(i>0)call_sig+=" ";call_sig+="_:"+get_node_signature(a)});call_sig+="))";return call_sig}return"_"}function is_defined_function(name,ctx){var r=ctx[name];if(!r){push_error(node,"Undeclared function : "+name);return false}if(!is_function_def(r)){push_error(node,"Undeclared function: "+name);return false}return true}function get_fn_name(node){if(is_function_def(node)){return node.children[1].vref}}function get_fn_type(node){if(is_function_def(node)){return node.children[1].type}}function is_fn_def_valid(node){if(is_function_def(node)){try{var name=get_fn_name(node);if(!name){push_error(node,"Invalid name for a function :"+name)}node.children[2].children.map(function(n){return n.vref});if(node.children.length>4){push_error(node.children[4],"Invalid function definition: function parts after function body are not evaluated")}return true}catch(e){push_error(node,"Invalid function");return false}}return false}function get_fn_body(node){if(is_function_def(node)){try{var body=node.children[3];var fc=body.children[0];return body}catch(e){push_error(node,"Invalid function body")}}}function get_fn_args(node){if(is_function_def(node)){try{return node.children[2].children}catch(e){push_error(node,"Invalid fn args")}}}function is_raw_value(node){if(typeof node=="string")return true;if(!isNaN(node))return true;if(typeof node=="boolean")return true;return false}function is_lambda_function_def(node){var fc=get_first_child(node);if(is_object(fc)&&fc.vref){if(fc.vref=="fn")return true}}function is_function_def(node){var fc=get_first_child(node);if(is_object(fc)&&fc.vref){if(fc.vref=="defn")return true}}function is_single_value_list(node){var fc=get_first_child(node);if(fc){if(is_function_def(node)||is_variable_def(node)||is_function_call(node)){return false}if(node.children&&node.children.length==1){return true}}return false}function is_another_list(node){var fc=get_first_child(node);if(fc){if(is_function_def(node)||is_variable_def(node)||is_function_call(node)){return false}if(node.children&&node.children.length>1){return true}}return false}function is_variable_def(node){var fc=get_first_child(node);if(is_object(fc)&&fc.vref){if(fc.vref=="def")return true;if(fc.vref=="let")return true}}function is_lambda_function_call(node){var fc=get_first_child(node);if(is_object(fc)){if(fc.vref&&node.children.length>1){return false}if(fc.vref=="fn"||fc.vref=="=>")return true}return true}function is_function_call(node){if(is_variable_def(node))return false;if(is_function_def(node))return false;var fc=get_first_child(node);if(is_object(fc)){if(fc.vref&&node.children.length>1){return true}}}if(!_glob["Jinx"])_glob["Jinx"]={};_glob["Jinx"].CompileLispToJS=start_lisp_to_js})(window);(function(_glob){function raw_value(n){if(typeof n=="boolean")return n;if(!isNaN(n))return parseFloat(n);if(typeof n=="string")return n;if(n&&(typeof n==="undefined"?"undefined":_typeof(n))=="object")return n.value;return n}function start_lisp_macro_espansion(p_node,ctx){if(!ctx)ctx=Jinx.CreateContext();return create_macro_expansion(p_node,ctx)}function create_macro_expansion(p_node,ctx,wr,is_body){if((typeof p_node==="undefined"?"undefined":_typeof(p_node))!="object"){return}if(p_node.vref){return}if(!p_node.children)return;if(p_node.literal){return}var fc=p_node.children[0];if(fc&&fc.vref=="defmacro"){var macro_name=p_node.children[1].vref;ctx.__def(macro_name);ctx[macro_name]=p_node;return}if(fc&&fc.vref=="use"){return}if(fc&&fc.vref=="def"){var change=create_macro_expansion(p_node.children[2],ctx);if(change)p_node.children.splice(2,1,change);return}if(fc&&fc.vref=="fn"){var body_of=p_node.children[2];var change=create_macro_expansion(body_of,ctx);if(change)p_node.children.splice(2,1,change);return}if(fc&&fc.vref){var macro_node=ctx[fc.vref];if(macro_node){var subCtx=Jinx.CreateContext();var macro_args=macro_node.children[2];for(var i=0;i<macro_args.children.length;i++){var arg=macro_args.children[i];if(arg.vref=="&"){subCtx.__def(arg.vref);subCtx[arg.vref]={lisp:true,children:p_node.children.slice(i+1)};break}subCtx.__def(arg.vref);subCtx[arg.vref]=p_node.children[i+1]}var old_p=macro_node.parent;macro_node.parent=null;var macro_body=macro_node.children[3];macro_body.ctx=subCtx;macro_body.running=false;Jinx.LispDebugRunner(macro_body,subCtx);console.log("macro run is now complete");var sweep_parents=function sweep_parents(node,parent){if(node&&(typeof node==="undefined"?"undefined":_typeof(node))=="object"){if(parent)node.parent=parent;if(node.children){node.children.forEach(function(n){sweep_parents(n,node)})}}};var new_node=macro_node.value;sweep_parents(new_node);macro_node.parent=old_p;return new_node}return}if(p_node.children){for(var i=0;i<p_node.children.length;i++){var ch=p_node.children[i];var new_node=create_macro_expansion(ch,ctx);if(new_node){new_node.parent=p_node;p_node.children.splice(i,1,new_node)}}}}function push_error(node,err){if(!node.errors){node.errors=[]}node.errors.push(err);if(ctx){ctx.__all_errors__.push({node:node,err:err})}}function get_first_child(node){if(is_object(node)&&node.children)return node.children[0]}function is_object(node){return node&&(typeof node==="undefined"?"undefined":_typeof(node))=="object"}function is_assigment(node){if(is_object(node)){if(is_function_call(node)){}}}function is_defined_function(name,ctx){var r=ctx[name];if(!r){push_error(node,"Undeclared function : "+name);return false}if(!is_function_def(r)){push_error(node,"Undeclared function: "+name);return false}return true}function get_fn_name(node){if(is_function_def(node)){return node.children[1].vref}}function get_fn_type(node){if(is_function_def(node)){return node.children[1].type}}function is_fn_def_valid(node){if(is_function_def(node)){try{var name=get_fn_name(node);if(!name){push_error(node,"Invalid name for a function :"+name)}node.children[2].children.map(function(n){return n.vref});if(node.children.length>4){push_error(node.children[4],"Invalid function definition: function parts after function body are not evaluated")}return true}catch(e){push_error(node,"Invalid function");return false}}
return false}function get_fn_body(node){if(is_function_def(node)){try{var body=node.children[3];var fc=body.children[0];return body}catch(e){push_error(node,"Invalid function body")}}}function get_fn_args(node){if(is_function_def(node)){try{return node.children[2].children}catch(e){push_error(node,"Invalid fn args")}}}function is_raw_value(node){if(typeof node=="string")return true;if(!isNaN(node))return true;if(typeof node=="boolean")return true;return false}function is_function_def(node){var fc=get_first_child(node);if(is_object(fc)&&fc.vref){if(fc.vref=="fn")return true;if(fc.vref=="defn")return true}}function is_single_value_list(node){var fc=get_first_child(node);if(fc){if(is_function_def(node)||is_variable_def(node)||is_function_call(node)){return false}if(node.children&&node.children.length==1){return true}}return false}function is_another_list(node){var fc=get_first_child(node);if(fc){if(is_function_def(node)||is_variable_def(node)||is_function_call(node)){return false}if(node.children&&node.children.length>1){return true}}return false}function is_variable_def(node){var fc=get_first_child(node);if(is_object(fc)&&fc.vref){if(fc.vref=="def")return true;if(fc.vref=="let")return true}}function is_lambda_function_call(node){var fc=get_first_child(node);if(is_object(fc)){if(fc.vref&&node.children.length>1){return false}if(fc.vref=="fn"||fc.vref=="=>")return true}return true}function is_function_call(node){if(is_variable_def(node))return false;if(is_function_def(node))return false;var fc=get_first_child(node);if(is_object(fc)){if(fc.vref&&node.children.length>1){return true}}}if(!_glob["Jinx"])_glob["Jinx"]={};_glob["Jinx"].LispMacroExpansion=start_lisp_macro_espansion})(window);(function(_glob){function raw_value(n){if(typeof n=="boolean")return n;if(!isNaN(n))return parseFloat(n);if(typeof n=="string")return n;if(n&&(typeof n==="undefined"?"undefined":_typeof(n))=="object")return n.value;return n}var LispDebugExpressions={"-":{},"!=":{},"+":{"(_:int(_:int _:int))":function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;var sum=0;for(var i=1;i<list.length;i++){sum=sum+raw_value(list[i])}node.value=sum;node.ready=true;break;default:throw"Invalid index for +"}},"(_:double(_:double _:double))":function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;var sum=0;for(var i=1;i<list.length;i++){sum=sum+raw_value(list[i])}node.value=sum;node.ready=true;break;default:throw"Invalid index for +"}},"(_:string(_:string _:string))":function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;var sum="";for(var i=1;i<list.length;i++){sum=sum+raw_value(list[i])}node.value=sum;node.ready=true;break;default:throw"Invalid index for +"}},"(_:double(_:int _:int))":function _fn(node,ctx){switch(node.index){case 0:node.ask_expand=true;node.ask_eval=true;node.starting_from=1;node.eval_end_index=node.parent.args.length;node.running=true;break;case 1:var p=node.parent;var list=p.args;var sum=0;for(var i=1;i<list.length;i++){sum=sum+raw_value(list[i])}node.value=sum;node.ready=true;break;default:throw"Invalid index for +"}}},"<":{},"<=":{},"=":{},"==":{},">":{},">=":{},add_to_dom:{},create_js_obj:{},debug:{},def:{},defn:{},first:{},fn:{},get_key:{},has_key:{},if:{},join:{},rest:{},second:{},set_key:{},while:{}};if(!_glob["Jinx"])_glob["Jinx"]={};_glob["Jinx"].LispTypedFns=LispDebugExpressions})(window);(function(_glob){function raw_value(n){if(typeof n=="boolean")return n;if(!isNaN(n))return parseFloat(n);if(typeof n=="string")return n;if(n&&(typeof n==="undefined"?"undefined":_typeof(n))=="object")return n.value;return n}Number.isInteger=Number.isInteger||function(value){return typeof value==="number"&&isFinite(value)&&Math.floor(value)===value};function bind_return_values(node,ctx){}function lisp_node_preprocess(node,ctx,is_body){if(!node.evalCnt){node.evalCnt=1}else{node.evalCnt++}if(!ctx){ctx=Jinx.CreateContext();ctx.__def("__all_errors__");ctx.__all_errors__=[];ctx.__def("__solved_calls__");ctx.__solved_calls__=[];ctx.__def("__unsolved_calls__");ctx.__unsolved_calls__=[];var fns=Jinx.LispTypedFns;Object.keys(fns).forEach(function(name){var impls=fns[name];ctx.__def(name);ctx[name]={};Object.keys(impls).forEach(function(sign){var fn=impls[sign];ctx[name][sign]={ctx:ctx,node:null,fn:fn}})})}if(is_raw_value(node)){return ctx}node._ctx=ctx;if(is_another_list(node)){var last_ch=node.children[node.children.length-1];if(last_ch){if(node.limited_rvtypes){if(is_raw_value(last_ch)){return ctx}last_ch.limited_rvtypes=node.limited_rvtypes.slice();lisp_node_preprocess(last_ch,last_ch._ctx);node.possible_types=last_ch.possible_types.slice();return ctx}}node.children.forEach(function(n){lisp_node_preprocess(n,ctx,is_body)});return ctx}if(is_struct_def(node)){var n=node.children[1];ctx.__def("struct::"+n.vref,"struct");ctx["struct::"+n.vref]={def:node,type:"struct",cnt:0};return ctx}if(is_variable_def(node)){var def_type="";try{var n=node.children[1];ctx.__def(n.vref,n.type);ctx[n.vref]={name:n.vref,type:n.type,cnt:0,value_node:node.children[2],eval_source:node,ctx:ctx};node.eval_target=ctx[n.vref];def_type=n.type;var theValue=node.children[2];if(is_raw_value(theValue)){ctx[n.vref].type=detect_value_type(theValue);def_type=detect_value_type(theValue)}else{if((typeof theValue==="undefined"?"undefined":_typeof(theValue))=="object"){theValue.expectedValueNode=node.children[1]}}}catch(e){push_error(node,"Invalid variable definition ")}var def_body=node.children[2];if(node.limited_rvtypes){def_body.limited_rvtypes=node.limited_rvtypes.slice()}lisp_node_preprocess(def_body,ctx);if(!def_type){var v_res=def_body;if(is_raw_value(v_res)){var the_type=detect_value_type(v_res);node.children[1].type=the_type;ctx[n.vref].type=the_type;node.possible_types=[the_type]}else{ctx[n.vref].possible_evals=v_res.possible_evals;ctx[n.vref].possible_types=v_res.possible_types;if(v_res.solvedType){node.children[1].type=v_res.solvedType;ctx[n.vref].type=v_res.solvedType}node.possible_types=def_body.possible_types.slice();if(def_body.possible_types&&def_body.possible_types.length==1){if(!ctx[n.vref].type)ctx[n.vref].type=def_body.possible_types[0]}}}else{if(def_body.possible_types){if(def_body.possible_types.length>1){console.log("LIMIT: TRIGGERING RE-EVAL of the possible types");console.log(node,def_body,def_body.possible_types);def_body.limited_rvtypes=[def_type];lisp_node_preprocess(def_body,def_body._ctx)}node.possible_types=def_body.possible_types.slice();ctx[n.vref].possible_types=def_body.possible_types.slice()}}return ctx}if(is_lambda_function_def(node)){try{var argsCtx=ctx.__fork();var args=node.children[1].children;args.forEach(function(a){if(a.type=="fn"){argsCtx.__def(a.vref);argsCtx[a.vref]={cnt:0,type:a.type,args:[]};return}argsCtx.__def(a.vref);argsCtx[a.vref]={cnt:0,type:a.type}});var body=node.children[2];lisp_node_preprocess(body,argsCtx,true);args.forEach(function(a){if(argsCtx[a.vref].cnt==0){push_error(a,"Function variable "+a.vref+" not used")}});return ctx}catch(e){push_error(node,"Invalid lambda function definition ")}}if(is_function_def(node)){try{if(!is_fn_def_valid(node)){push_error(node,"Invalid function definition ")}var name=get_fn_name(node);var is_typed=is_fn_typed(node);console.log(">> defined function ",name,is_typed);var sig=create_fn_signature(node);console.log("signature could be: ",sig);console.log("body sig: ",get_node_signature(node.children[2]));if(!is_typed){if(!ctx[name]){ctx.__def(name,node);ctx[name]={}}if(!ctx[name][sig]){ctx[name][sig]={node:node,ctx:ctx}}else{console.log("ERROR: function defined "+name+":"+sig);push_error(node,"Function "+name+":"+sig+" already defined!")}return ctx}ctx.__def(name,get_fn_type(node));var nameDef=node.children[1];ctx[name]={cnt:0,type:"function",return_type:nameDef.type,args:get_fn_args(node)};var argsCtx=ctx.__fork();var args=get_fn_args(node);args.forEach(function(a){if(a.type=="fn"){argsCtx.__def(a.vref);argsCtx[a.vref]={cnt:0,type:a.type,args:[]};return}argsCtx.__def(a.vref);argsCtx[a.vref]={cnt:0,type:a.type}});var body=get_fn_body(node);lisp_node_preprocess(body,argsCtx,true);args.forEach(function(a){if(argsCtx[a.vref].cnt==0){push_error(a,"Function variable "+a.vref+" not used")}});return ctx}catch(e){push_error(node,"Invalid function definition ")}}if(is_function_call(node)){try{var called_function=node.children[0].vref;console.log("---------------------------------------------------");console.log("calling function ",called_function);if(called_function=="import"){return ctx}var b_args_defined=true;for(var i=1;i<node.children.length;i++){var param=node.children[i];if(is_raw_value(param)){if(!detect_value_type(param)){b_args_defined=false;continue}else{continue}}if(param.vref){var vdef=ctx[param.vref];if(vdef.type){}else{b_args_defined=false;continue}}else{console.log("ERROR, can not figure the param ",param)}}var call_sig="_:";var retval_defined=true;if(node.expectedValueNode){console.log("had expected value ",node.expectedValueNode);call_sig+=node.expectedValueNode.type||"_"}else{console.log("no expected value");call_sig+="_";retval_defined=false}var sig="";for(var i=1;i<node.children.length;i++){var param=node.children[i];if(i>1)sig+=" ";if(is_raw_value(param)){sig+="_:"+detect_value_type(param);continue}if(param.vref){var vdef=ctx[param.vref];if(vdef.type){sig+="_:"+vdef.type;continue}else{if(vdef.possible_types){console.log("POSSIBLE TYPES ",vdef,vdef.possible_types)}sig+="_:_";continue}}}var does_match_param=function does_match_param(index,value){var param=node.children[index+1];var sig="";if(value=="_")return true;if(is_raw_value(param)){sig=detect_value_type(param);if(sig==value)return true;return false}if(param.vref){var vdef=ctx[param.vref];if(vdef.type){return vdef.type==value}else{if(vdef.possible_types){var list=vdef.possible_types;for(var i=0;i<list.length;i++){if(list[i]==value)return true}}}}if(param.possible_types){var list=param.possible_types;for(var i=0;i<list.length;i++){if(list[i]==value)return true}}console.log("WARNING; not match, no possible values: ",value,param);return false};var could_match_rv=function could_match_rv(value){if(value=="_")return true;if(node.children[0]&&node.children[0].type){if(value==node.children[0].type)return true;return false}if(node.expectedValueNode&&node.expectedValueNode.type){if(value==node.expectedValueNode.type)return true;return false}else{if(node.limited_rvtypes){for(var i=0;i<node.limited_rvtypes.length;i++){if(node.limited_rvtypes[i]==value)return true}return false}return true}};var b_found=false;if(node.expectedValueNode&&node.expectedValueNode.type){if(node.limited_rvtypes){var b_was=false;for(var i=0;i<node.limited_rvtypes.length;i++){if(node.limited_rvtypes[i]==node.expectedValueNode.type){b_was=true}}if(!b_was){console.log("ERROR: expexted type and limited type did not match",node);node.possible_types=[];return ctx}}var signature="(_:"+node.expectedValueNode.type+"("+sig+"))";var fn_base=ctx[called_function];if(fn_base){var fnData=fn_base[signature];if(fnData){node.fn=fnData.fn;b_found=true;console.log("**** did match signature "+signature+"*****");console.log(signature);console.log(fnData);node.possible_types=[node.expectedValueNode.type]}}}if(!b_found){node.possible_solutions=[];node.possible_types=[];if(true){console.log("******************************************************");console.log("**** could evaluate templates for this function ******");var tpl_defs=ctx[called_function];console.log("called_function "+called_function+" -> ",tpl_defs);if(tpl_defs){var possible_evals=[];var possible_types=[];var possible_solutions=[];var arg_pos_values=[];for(var ii=1;ii<node.children.length;ii++){var param=node.children[ii];if(!is_raw_value(param)){lisp_node_preprocess(param,ctx)}}Object.keys(tpl_defs).forEach(function(key){var current_def=JMLParser(key);var curr_filter=current_def.children[1].children;if(!could_match_rv(current_def.children[0].type)){return}var b_args_match=true;for(var ii=0;ii<curr_filter.length;ii++){var test_arg=curr_filter[ii];if(!does_match_param(ii,test_arg.type)){return}}for(var ii=0;ii<curr_filter.length;ii++){if(!arg_pos_values[ii])arg_pos_values[ii]=[];var list=arg_pos_values[ii];var test_arg=curr_filter[ii];if(list.indexOf(test_arg.type)<0){list.push(test_arg.type)}}});console.log("arg_pos_values",arg_pos_values);for(var ii=1;ii<node.children.length;ii++){var param=node.children[ii];if(!is_raw_value(param)){if(param.possible_types&&ii>=1&&arg_pos_values[ii-1]){if(param.possible_types.length>arg_pos_values[ii-1].length){param.limited_rvtypes=arg_pos_values[ii-1].slice();lisp_node_preprocess(param,ctx);console.log("could limit ",param,"to",arg_pos_values[ii-1])}}}}Object.keys(tpl_defs).forEach(function(key){var current_def=JMLParser(key);console.log(called_function,key," current_def",current_def);var curr_filter=current_def.children[1].children;if(!could_match_rv(current_def.children[0].type)){return}var b_args_match=true;for(var ii=0;ii<curr_filter.length;ii++){var test_arg=curr_filter[ii];if(!does_match_param(ii,test_arg.type)){return}}var orig_fn_def=tpl_defs[key];if(orig_fn_def.fn){var new_def={fn:orig_fn_def.fn,node:orig_fn_def,type:current_def.children[0].type};if(node.limited_rvtypes){var b_was=false;for(var i=0;i<node.limited_rvtypes.length;i++){if(node.limited_rvtypes[i]==new_def.type)b_was=true}if(!b_was){console.log("WARNING: double check maybe faield");return}}console.log("Just pushing the found fn ",key,new_def);possible_evals.push(new_def);possible_types.push(new_def.type);possible_solutions.push(new_def);return}var fn_node=orig_fn_def.node;var fn_ctx=orig_fn_def.ctx.__fork();var fn_def=copy_sequence(fn_node,null,fn_ctx);console.log("copy of the function: ",fn_def);console.log("TODO: copy arguments to the function");copy_call_args_types_to_func(node,fn_def,ctx);console.log("---> trying to preprosess");console.log(node);var fn_body=fn_def.children[3];console.log(fn_body);var args=fn_def.children[2];args.children.forEach(function(a){fn_ctx.__def(a.vref);fn_ctx[a.vref]={type:a.type,cnt:0}});console.log("=========================================");console.log("=========================================");if(node.expectedValueNode){fn_body.expectedValueNode={type:node.expectedValueNode.type}}if(node.limited_rvtypes){fn_body.limited_rvtypes=node.limited_rvtypes.slice()}lisp_node_preprocess(fn_body,fn_ctx);if(fn_body.children){var last_ch=fn_body.children[fn_body.children.length-1];if(last_ch){console.log("LAST : ",last_ch);if(last_ch.possible_types){fn_body.possible_types=last_ch.possible_types.slice()}}}console.log(fn_def);var the_body=fn_def.children[3];var fn_meta={fn:the_body.fn,node:fn_def,type:the_body.solvedType};possible_evals.push(fn_meta);possible_solutions.push(fn_meta);if(the_body.solvedType){possible_types.push(the_body.solvedType)}else{if(the_body.possible_types){the_body.possible_types.forEach(function(t){if(possible_types.indexOf(t)<0)possible_types.push(t)})}}if(!fn_node.expand)fn_node.expand=[];fn_node.expand.push(fn_meta)});console.log("--> finished the function eval for node ",node);if(possible_evals.length==1){console.log("Just one match, all is GOOD!");var eval_data=possible_evals[0];node.fn=eval_data.fn;node.solvedType=eval_data.solvedType;if(eval_data.node&&eval_data.node.children){eval_data.node.children[0].type=eval_data.solvedType}node.possible_evals=possible_evals;ctx.__solved_calls__.push(node);if(node.__unsolved){var idx=ctx.__unsolved_calls__.indexOf(node);ctx.__unsolved_calls__.splice(idx,1)}}else{node.possible_evals=possible_evals;console.log(node);node.__unsolved=true;ctx.__unsolved_calls__.push(node)}node.possible_types=possible_types;console.log("=========================================");console.log("=========================================")}else{console.log("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");console.log("ERROR: arguments are not defined and could not find the function "+called_function)}}else{console.log("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");console.log("ERROR: arguments are not defined and could not find the function...."+called_function)}}else{}if(node.parent){if(is_variable_def(node.parent)){}}if(!node.fn){console.log("--> funtion not defined error here");console.log(node);push_error(node,"Function "+called_function+" not defined",ctx);return ctx}}catch(e){console.log(e);push_error(node,"Evaluating function call failed")}return ctx}if(node.vref){if(ctx[node.vref]){var v_info=ctx[node.vref];if(node.limited_rvtypes){if(v_info.eval_source){v_info.eval_source.limited_rvtypes=node.limited_rvtypes.slice();lisp_node_preprocess(v_info.eval_source,v_info.eval_source._ctx);var s=v_info.eval_source;if(s.type){node.possible_types=[s.type]}else{node.possible_types=s.possible_types.slice()}return ctx}}console.log("node.vref ",v_info);node.value=v_info;if(v_info.type){node.possible_types=[v_info.type]}else{node.possible_types=v_info.possible_types.slice()}v_info.cnt++}else{push_error(node,"Variable "+node.vref+" was not defined before use ")}return ctx}if(node.children&&node.children.length==1){if(node.limited_rvtypes){var fc=node.children[0];fc.limited_rvtypes=node.limited_rvtypes.slice();lisp_node_preprocess(fc,fc._ctx);node.possible_types=fc.possible_types.slice();return ctx}lisp_node_preprocess(node.children[0],ctx)}return ctx;function get_node_signature(node){if(node.signature)return node.signature;if(node.type&&!node.type_def&&node.vref&&(!node.children||node.children.length==0)){return node.type}if(is_raw_value(node)){return detect_value_type(node)}if(node.type_def){var def=node.type_def;var call_sig="(_:";var fc=def.children[0];call_sig+=get_node_signature(fc);var args=def.children[1];call_sig+="(";args.forEach(function(a,i){if(i>0)call_sig+=" ";call_sig+="_:"+get_node_signature(a)});call_sig+="))";return call_sig}if(node.literal)return"literal";if(node.quasi)return"quasiquote";if(node.children&&node.children.length>0){if(is_function_def(node)){return"defn"}if(is_lambda_function_def(node)){var def=node;var call_sig="(_:";var fc=def.children[0];call_sig+=get_node_signature(fc);var args=def.children[1];call_sig+="(";args.forEach(function(a,i){if(i>0)call_sig+=" ";call_sig+="_:"+get_node_signature(a)});call_sig+="))";return call_sig}if(is_variable_def(node))return"def";return"form"}return"_"}function detect_value_type(param){if(typeof param=="string"){return"string"}if(typeof param=="boolean"){return"boolean"}if(!isNaN(param)){if(Number.isInteger(param)){return"int"}return"double"}return"void"}function push_error(node,err){if(!node.errors){node.errors=[]}node.errors.push(err);if(ctx){ctx.__all_errors__.push({node:node,err:err})}}function get_first_child(node){if(is_object(node)&&node.children)return node.children[0]}function is_object(node){return node&&(typeof node==="undefined"?"undefined":_typeof(node))=="object"}function is_assigment(node){if(is_object(node)){if(is_function_call(node)){}}}function is_defined_function(name,ctx){var r=ctx[name];if(!r){push_error(node,"Undeclared function : "+name);return false}if(!is_function_def(r)){push_error(node,"Undeclared function: "+name);return false}return true}function get_fn_name(node){if(is_function_def(node)){return node.children[1].vref}}function get_fn_type(node){if(is_function_def(node)){return node.children[1].type}}function is_fn_def_valid(node){if(is_function_def(node)){try{var name=get_fn_name(node);if(!name){push_error(node,"Invalid name for a function :"+name)}node.children[2].children.map(function(n){return n.vref});if(node.children.length>4){push_error(node.children[4],"Invalid function definition: function parts after function body are not evaluated")}return true}catch(e){push_error(node,"Invalid function");return false}}return false}function get_fn_body(node){if(is_function_def(node)){try{var body=node.children[3];var fc=body.children[0];return body}catch(e){push_error(node,"Invalid function body")}}}function get_fn_args(node){if(is_function_def(node)){try{return node.children[2].children}catch(e){push_error(node,"Invalid fn args")}}}function is_fn_typed(node){try{if(node.children[0].type){var args=node.children[2];var all_defined=true;console.log("is_fn_typed",args);args.children.forEach(function(a){if(!a.type&&!a.type_def){all_defined=false}if(a.type=="_")all_defined=false});return all_defined}return false}catch(e){return false}}function is_struct_def(node){var fc=get_first_child(node);if(is_object(fc)&&fc.vref){if(fc.vref=="struct")return true}}function is_raw_value(node){if(typeof node=="string")return true;if(!isNaN(node))return true;if(typeof node=="boolean")return true;return false}function is_lambda_function_def(node){var fc=get_first_child(node);if(is_object(fc)&&fc.vref){if(fc.vref=="fn")return true}}function is_function_def(node){var fc=get_first_child(node);if(is_object(fc)&&fc.vref){if(fc.vref=="defn")return true}}function create_fn_signature(node){var sig="(_:"+(node.children[0].type||"_")+"(";var args=node.children[2];for(var i=0;i<args.children.length;i++){var param=args.children[i];if(i>0)sig+=" ";if(is_raw_value(param)){sig+="_:"+detect_value_type(param)}if(param.vref){if(param.type){sig+="_:"+param.type;continue}else{sig+="_:_"}}}sig+="))";return sig}function is_single_value_list(node){var fc=get_first_child(node);if(fc){if(is_function_def(node)||is_variable_def(node)||is_function_call(node)){return false}if(node.children&&node.children.length==1){return true}}return false}function is_another_list(node){var fc=get_first_child(node);if(fc){if(is_function_def(node)||is_variable_def(node)||is_function_call(node)){return false}if(node.children&&node.children.length>1){return true}}return false}function is_variable_def(node){var fc=get_first_child(node);if(is_object(fc)&&fc.vref){if(fc.vref=="def")return true;if(fc.vref=="let")return true}}function is_lambda_function_call(node){var fc=get_first_child(node);if(is_object(fc)){if(fc.vref&&node.children.length>1){return false}if(fc.vref=="fn"||fc.vref=="=>")return true}return true}function is_function_call(node){if(is_variable_def(node))return false;if(is_function_def(node))return false;if(is_lambda_function_def(node))return false;var fc=get_first_child(node);if(is_object(fc)){if(fc.vref&&node.children.length>1){return true}}}function copy_call_args_types_to_func(callerNode,toFunc,callerCtx){var func_args=toFunc.children[2];for(var i=1;i<callerNode.children.length;i++){var param=callerNode.children[i];if(is_raw_value(param)){var typename=detect_value_type(param);func_args.children[i-1].type=typename;continue}if(param.vref){var vdef=callerCtx[param.vref];if(vdef.type){func_args.children[i-1].type=vdef.type}else{continue}}else{console.log("ERROR, can not figure the param ",param)}}}function copy_sequence(node,parent,ctx){if(typeof node=="boolean")return node;if(typeof node=="string")return node;if(!isNaN(node))return node;if((typeof node==="undefined"?"undefined":_typeof(node))=="object"){if(node.vref){return{vref:node.vref,type:node.type,type_def:node.type_def,parent:parent}}var obj={__sp:node.__sp,__ep:node.__ep,lisp:true,ctx:ctx,parent:parent,is_fn:node.is_fn,type:node.type,type_def:node.type_def};obj.children=node.children.map(function(ch){return copy_sequence(ch,obj,ctx)});return obj}throw"Object copy failed"}}if(!_glob["Jinx"])_glob["Jinx"]={};_glob["Jinx"].LispPreparser=lisp_node_preprocess})(window);(function(_glob){function raw_value(n){if(typeof n=="boolean")return n;if(!isNaN(n))return parseFloat(n);if(typeof n=="string")return n;if(n&&(typeof n==="undefined"?"undefined":_typeof(n))=="object")return n.value;return n}var LispCompilerExpressions={__type__:function __type__(v,wr){var test="";if(typeof v=="string"){test=v}else{test=v.type}switch(test){case"int":wr.out("int");break;case"double":wr.out("double");break;case"string":wr.out("String");break;case"boolean":wr.out("boolean");break;default:if(test)wr.out(test)}},"=":{"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){for(var i=1;i<=2;i++){if(i>1){wr.out(" = ")}create_code.call(this,p_node.children[i],ctx,wr)}wr.out(";",true);return}},"+":{"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" + ")}create_code.call(this,p_node.children[i],ctx,wr)}return}},"<=":{"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" <= ")}create_code.call(this,p_node.children[i],ctx,wr)}return}},">=":{"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" >= ")}create_code.call(this,p_node.children[i],ctx,wr)}return}},"!=":{"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" != ")}create_code.call(this,p_node.children[i],ctx,wr)}return}},break:{"(_:int(_:string _:_))":function _Int_String__(p_node,ctx,wr){wr.out("break;",true)}},continue:{"(_:int(_:string _:_))":function _Int_String__(p_node,ctx,wr){wr.out("continue;",true)}},print:{"(_:int(_:string _:_))":function _Int_String__(p_node,ctx,wr){ctx.__import("java.io.*");wr.out("System.out.println(String.valueOf(");create_code.call(this,p_node.children[1],ctx,wr);wr.out("));",true)}},for:{"(_:int(_:string _:_))":function _Int_String__(p_node,ctx,wr){var list_name=p_node.children[1];var item_name=p_node.children[2];var index_name=p_node.children[3];wr.out("for( int ");create_code.call(this,index_name,ctx,wr);wr.out(" = 0; i < ");create_code.call(this,list_name,ctx,wr);wr.out(".size(); ");create_code.call(this,index_name,ctx,wr);wr.out("++) {",true);wr.indent(1);wr.out(item_name.type+" ");create_code.call(this,item_name,ctx,wr);wr.out(" = ");create_code.call(this,list_name,ctx,wr);wr.out(".get(");create_code.call(this,index_name,ctx,wr);wr.out(");",true);create_code.call(this,p_node.children[4],ctx,wr);wr.indent(-1);wr.out("}",true)}},array_length:{"(_:int(_:string _:_))":function _Int_String__(p_node,ctx,wr){var var_name=p_node.children[1];wr.out(var_name.vref);wr.out(".size()")}},strlen:{"(_:int(_:string _:_))":function _Int_String__(p_node,ctx,wr){var var_name=p_node.children[1];wr.out(var_name.vref);wr.out(".length()")}},call:{"(_:_(_:string _:_))":function ___String__(p_node,ctx,wr){var var_name=p_node.children[1];var method_name=p_node.children[2];var args=p_node.children[3];wr.out(var_name.vref);wr.out("."+method_name.vref+"(");args.children.forEach(function(arg,i){if(i>0)wr.out(", ");create_code.call(this,arg,ctx,wr)});wr.out(")");if(!ctx.__expression)wr.out(";",true)}},"null?":{"(_:_(_:string))":function ___String(p_node,ctx,wr){var var_name=p_node.children[1];wr.out("(");wr.out(var_name.vref);wr.out(" == ");wr.out(" null ");wr.out(")")}},"!null?":{"(_:_(_:string))":function ___String(p_node,ctx,wr){var var_name=p_node.children[1];wr.out("(");wr.out(var_name.vref);wr.out(" != ");wr.out(" null ");wr.out(")")}},has:{"(_:_(_:string))":function ___String(p_node,ctx,wr){var var_name=p_node.children[1];var key_name=p_node.children[2];wr.out(var_name.vref);wr.out(".containsKey(");create_code.call(this,key_name,ctx,wr);wr.out(")")}},get:{"(_:_(_:string))":function ___String(p_node,ctx,wr){var var_name=p_node.children[1];var key_name=p_node.children[2];wr.out(var_name.vref);wr.out(".get(");create_code.call(this,key_name,ctx,wr);wr.out(")")}},set:{"(_:_(_:string _:_))":function ___String__(p_node,ctx,wr){var var_name=p_node.children[1];var key_name=p_node.children[2];var value=p_node.children[3];wr.out(var_name.vref);wr.out(".put(");create_code.call(this,key_name,ctx,wr);wr.out(",");create_code.call(this,value,ctx,wr);wr.out(");",true)}},new:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){var var_name=p_node.children[1];var args=p_node.children[2];wr.out(" new ");wr.out(var_name.vref);wr.out("(");args.children.forEach(function(arg,i){if(i>0)wr.out(", ");wr.out(" ");create_code.call(this,arg,ctx,wr)});wr.out(")")}},itemAt:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){var var_name=p_node.children[1];var index_name=p_node.children[2];wr.out(var_name.vref);wr.out(".get(");create_code.call(this,index_name,ctx,wr);wr.out(")")}},removeLast:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){var var_name=p_node.children[1];wr.out(var_name.vref);wr.out(".remove(");wr.out(var_name.vref);wr.out(".size() - 1");wr.out(");",true)}},push:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){var var_name=p_node.children[1];var index_pos=p_node.children[2];wr.out(var_name.vref);wr.out(".add(");create_code.call(this,index_pos,ctx,wr);wr.out(");",true)}},charAt:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){var var_name=p_node.children[1];var index_pos=p_node.children[2];wr.out(var_name.vref);wr.out(".charAt(");create_code.call(this,index_pos,ctx,wr);wr.out(")")}},substring:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){var var_name=p_node.children[1];var start_pos=p_node.children[2];var end_pos=p_node.children[3];wr.out(var_name.vref);wr.out(".substring(");create_code.call(this,start_pos,ctx,wr);wr.out(",");create_code.call(this,end_pos,ctx,wr);wr.out(")")}},DefList:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){var v=p_node.children[1];LispCompilerExpressions.__type__(v,wr);wr.out(" ");wr.out(v.vref);wr.out(";",true)}},def:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){var v=p_node.children[1];ctx.__def(v.vref);ctx[v.vref]={node:p_node};if(ctx.__in_class_body){wr.out("public ")}if(v.type=="hash"){ctx.__import("java.util.*");var a_type=v.array_type=="any"?"Object":v.array_type;wr.out("Map<");LispCompilerExpressions.__type__(v.key_type,wr);wr.out(",");switch(a_type){case"int":wr.out("Integer");break;case"double":wr.out("Double");break;case"boolean":wr.out("Boolean");break;default:LispCompilerExpressions.__type__(a_type,wr)}wr.out("> ");wr.out(v.vref);if(!ctx.__in_class_body){wr.out(" = ");wr.out("new HashMap<");LispCompilerExpressions.__type__(v.key_type,wr);wr.out(",");switch(a_type){case"int":wr.out("Integer");break;case"double":wr.out("Double");break;case"boolean":wr.out("Boolean");break;default:LispCompilerExpressions.__type__(a_type,wr)}wr.out(">");wr.out("();",true)}else{wr.out(";",true);ctx.__constructor_creators.push(function(wr){wr.out(v.vref+" = ");wr.out("new HashMap<");LispCompilerExpressions.__type__(v.key_type,wr);wr.out(",");switch(a_type){case"int":wr.out("Integer");break;case"double":wr.out("Double");break;case"boolean":wr.out("Boolean");break;default:LispCompilerExpressions.__type__(a_type,wr)}wr.out(">");wr.out("();",true)})}return}if(v.type=="array"){ctx.__import("java.util.*");var a_type=v.array_type=="any"?"Object":v.array_type;wr.out("ArrayList<");LispCompilerExpressions.__type__(a_type,wr);wr.out("> ");wr.out(v.vref);if(!ctx.__in_class_body){wr.out(" = ");wr.out("new ArrayList<");LispCompilerExpressions.__type__(a_type,wr);wr.out(">");wr.out("();",true)}else{wr.out(";",true);ctx.__constructor_creators.push(function(wr){wr.out(v.vref+" = ");wr.out("new ArrayList<");LispCompilerExpressions.__type__(a_type,wr);wr.out(">");wr.out("();",true)})}return}LispCompilerExpressions.__type__(v,wr);wr.out(" ");wr.out(v.vref);var value=p_node.children[2];if(typeof value!="undefined"){if(ctx.__in_class_body&&!is_raw_value(value)){ctx.__constructor_creators.push(function(wr){wr.out(v.vref+" = ");create_code.call(this,value,ctx,wr)})}else{wr.out(" = ");if(!isNaN(value)){if(Number.isInteger(value)){if(v.type=="double"){wr.out(value+".0")}else{wr.out(value+"")}}else{wr.out(value+"")}}else{create_code.call(this,value,ctx,wr)}}}wr.out(";",true)}},Constructor:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){ctx.__constructor_params=p_node.children[1]
;ctx.__constructor_code=p_node.children[2]}},PublicVar:{"(_:_(_:string _:form))":function ___String_Form(p_node,ctx,wr){wr.out("public ");var v=p_node.children[1];LispCompilerExpressions.__type__(v,wr);wr.out(" ");wr.out(v.vref);wr.out(";",true)}},PublicMethod:{"(_:_(_:string args:form body:form))":function ___StringArgsFormBodyForm(p_node,ctx,wr){ctx=ctx.__fork();ctx.__def("__in_class_body");ctx.__def("__in_method");ctx.__in_class_body=false;ctx.__in_method=true;wr.out("",true);var v=p_node.children[1];wr.out("public ");var v=p_node.children[1];LispCompilerExpressions.__type__(v,wr);wr.out(" ");wr.out(v.vref);var vars_list=p_node.children[2];wr.out("(");vars_list.children.forEach(function(arg,i){if(i>0)wr.out(", ");LispCompilerExpressions.__type__(arg,wr);wr.out(" ");wr.out(arg.vref)});wr.out(")");wr.out(" {",true);wr.indent(1);create_code.call(this,p_node.children[3],ctx,wr);wr.indent(-1);wr.out("}",true);wr.out("",true)}},CreateClass:{"(_:_(_:string _:form))":function ___String_Form(p_node,ctx,wr){var _this3=this;ctx=ctx.__fork();var v=p_node.children[1];var class_name=v.vref;var c_info=ctx["class::"+class_name];ctx.__def("__class_name");ctx.__class_name=class_name;ctx.__def("__constructor_code");ctx.__constructor_code=new writer;ctx.__constructor_code.indent(2);ctx.__def("__constructor_creators");ctx.__constructor_creators=[];ctx.__def("__constructor_params");ctx.__constructor_params=null;ctx.__def("__constructor_code");ctx.__constructor_code=null;var imports_tag;var imported={};ctx.__import=function(lib_name){if(!imported[lib_name]){imports_tag.out("import "+lib_name+";",true)}imported[lib_name]=true};this.openFile("java/",class_name+".java",function(wr){imports_tag=wr.tag("imports");wr.out("",true);wr.out("public class ");wr.out(class_name);if(c_info.__extends){ctx.__def("__extends");ctx.__extends={class_list:c_info.__extends.list};var cnt=c_info.__extends.node.children[1].children.length;if(cnt){wr.out(" extends ");c_info.__extends.list.forEach(function(name,i){if(i)wr.out(", ");wr.out(name)})}}wr.out(" {",true);wr.out("",true);ctx.__def("__in_class_body");ctx.__in_class_body=true;wr.indent(1);create_code.call(_this3,p_node.children[2],ctx,wr);wr.out("",true);wr.out("public "+class_name+"(");if(ctx.__constructor_params){ctx.__constructor_params.children.forEach(function(arg,i){if(i>0)wr.out(", ");LispCompilerExpressions.__type__(arg,wr);wr.out(" ");wr.out(arg.vref)})}wr.out("){",true);wr.indent(1);ctx.__constructor_creators.forEach(function(cc){cc.call(this,wr)}.bind(_this3));if(ctx.__constructor_code){create_code.call(_this3,ctx.__constructor_code,ctx,wr)}wr.indent(-1);wr.out("}",true);wr.indent(-1);ctx.__in_class_body=false;wr.out("}",true)})}},create_js_obj:function create_js_obj(p_node,ctx,wr){wr.out("{}")},if:{"(_:_(_:boolean _:form _form))":function ___Boolean_Form_form(p_node,ctx,wr){wr.out("if(");create_code.call(this,p_node.children[1],ctx,wr);wr.out(") {",true);wr.indent(1);create_code.call(this,p_node.children[2],ctx,wr);wr.indent(-1);wr.out("}");if(p_node.children[3]){wr.out(" else {",true);wr.indent(1);create_code.call(this,p_node.children[3],ctx,wr);wr.out("",true);wr.indent(-1);wr.out("}")}wr.out("",true)}},return:{"(_:_(_:_))":function ____(p_node,ctx,wr){wr.out("return ");ctx.__expression=true;create_code.call(this,p_node.children[1],ctx,wr);ctx.__expression=false;wr.out(";",true)}},while:{"(_:_(_:booleam _:form))":function ___Booleam_Form(p_node,ctx,wr){wr.out("while(");create_code.call(this,p_node.children[1],ctx,wr);wr.out(") {",true);wr.indent(1);create_code.call(this,p_node.children[2],ctx,wr);wr.indent(-1);wr.out("}",true)}}};var simple_expressions=["==","<",">","!=",">=","<="];simple_expressions.forEach(function(expr){LispCompilerExpressions[expr]={"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){var first_node=p_node.children[1];var second_node=p_node.children[2];if(first_node.type=="string"||typeof first_node=="string"){ctx.__expression=true;switch(expr){case"==":create_code.call(this,first_node,ctx,wr);wr.out(".equals(");create_code.call(this,second_node,ctx,wr);wr.out(")");return;default:throw"Operator "+expr+" for strings is not defined"}ctx.__expression=false}ctx.__expression=true;for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" "+expr+" ")}create_code.call(this,p_node.children[i],ctx,wr)}ctx.__expression=false;return}}});var simple_expressions=["&&","||"];simple_expressions.forEach(function(expr){LispCompilerExpressions[expr]={"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){ctx.__expression=true;for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" "+expr+" ")}wr.out("(");create_code.call(this,p_node.children[i],ctx,wr);wr.out(")")}ctx.__expression=false;return}}});var num_operators=["*","+","-","/","%"];num_operators.forEach(function(expr){LispCompilerExpressions[expr]={"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){ctx.__expression=true;for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" "+expr+" ")}wr.out("(");create_code.call(this,p_node.children[i],ctx,wr);wr.out(")")}ctx.__expression=false;return}}});var math_lib=["sin","cos","tan","atan","log","abs","acos","asin","floor","round","sqrt"];math_lib.forEach(function(expr){LispCompilerExpressions[expr]={"(_:double(_:double))":function _fn(p_node,ctx,wr){ctx.__expression=true;ctx.__import("java.lang.Math");wr.out("Math."+expr+"(");create_code.call(this,p_node.children[1],ctx,wr);wr.out(")");ctx.__expression=false;return}}});if(!_glob["Jinx"])_glob["Jinx"]={};_glob["Jinx"].LispCompilerExpressions=LispCompilerExpressions;function start_lisp_to_code(p_node,ctx,wr,LangExpressions){var _this4=this;if(LangExpressions){Object.keys(LangExpressions).forEach(function(k){LispCompilerExpressions[k]=LangExpressions[k]})}if(!this.openFile){this._openFiles=[];this.openFile=function(path,filename,cb){var wr=new writer;var list=_this4._openFiles.filter(function(f){return f.path==path&&f.filename==filename});if(list.length){var oldFile=list[0];var oldIndex=_this4._openFiles.indexOf(oldFile);if(oldIndex>=0)_this4._openFiles.splice(oldIndex,1)}_this4._openFiles.push({wr:wr,path:path,filename:filename});cb(wr)}}collect_methods(p_node,ctx);create_code.call(this,p_node,ctx,wr)}function collect_methods(node,ctx,classObj){if(is_function_call(node)){var fc=node.children[0];var name=node.children[1];if(fc.vref=="CreateClass"){ctx.__def("class::"+name.vref);var o={name:name.vref};if(node&&node.children){node.children.forEach(function(n){collect_methods(n,ctx,o)})}ctx["class::"+name.vref]=o;return}if(fc.vref=="Constructor"){classObj["Constructor"]={args:node.children[1]}}if(fc.vref=="Extends"){classObj.__extends={node:fc.parent};classObj.__extends.list=fc.parent.children[1].children.map(function(ext,i){return ext.vref})}if(fc.vref=="PublicMethod"){classObj[name.vref]={args:node.children[2]}}}if(node&&node.children){node.children.forEach(function(n){collect_methods(n,ctx,classObj)})}}function create_code(p_node,ctx,wr,is_body){if(!ctx)ctx=Jinx.CreateContext();var code="";if((typeof p_node==="undefined"?"undefined":_typeof(p_node))!="object"){if(typeof p_node=="string"){wr.out('"'+p_node+'"');return}if(!isNaN(p_node)){wr.out(""+p_node);return}wr.out(""+p_node);return}if(p_node.vref){if(p_node.vref=="&"){throw"Rest expression should not be processed as a variable"}var var_type=ctx[p_node.vref];if(var_type){if(var_type.external){wr.out("__ctx__['"+p_node.vref+"']");return}}wr.out(p_node.vref);return}if(!p_node.children)return;if(p_node.literal){var obj;var _ret3=function(){var parse_literal_to_obj=function parse_literal_to_obj(node){if(typeof node=="boolean")return node;if(typeof node=="string")return node;if(!isNaN(node))return node;if((typeof node==="undefined"?"undefined":_typeof(node))=="object"){if(node.vref){var o={vref:node.vref,type:node.type};if(node.type_def)o.type_def=parse_literal_to_obj(node.type_def);return o}var o={lisp:true};o.children=node.children.map(function(n){return parse_literal_to_obj(n)});return o}};obj=parse_literal_to_obj(p_node);wr.out(JSON.stringify(obj));return{v:void 0}}();if((typeof _ret3==="undefined"?"undefined":_typeof(_ret3))==="object")return _ret3.v}var fc=p_node.children[0];if(fc&&fc.vref=="defmacro"){return}if(fc&&fc.vref=="Extends"){return}if(fc&&fc.vref=="import"){var name_node=p_node.children[1];if(name_node.ns&&name_node.ns.length>1){var dict_name=name_node.ns[0];ctx.__def(dict_name,"dict");if(!ctx[dict_name]){ctx[name_node.ns[0]]={type:"dictionary",cnt:0,import:true,value:{}}}var f_name=name_node.ns[1];var obj=ctx[name_node.ns[0]];obj[f_name]={type:"function",cnt:0,import:true,signature:sig}}else{var f_name=name_node.vref;var sig=get_node_signature(name_node);ctx.__def(f_name,"function");ctx[f_name]={type:"function",cnt:0,import:true,signature:sig}}return}if(fc&&fc.vref=="defn"){wr.out("function ");wr.out(p_node.children[1].vref);wr.out("(");var args_list=p_node.children[2];var the_rest_index=-1;args_list.children.forEach(function(a,i){if(a.vref=="&"){the_rest_index=i;return}if(i>0)wr.out(",");wr.out(a.vref);ctx.__def(a.vref,a.type);ctx[a.vref]={type:a.type,cnt:0,external:false,param:true}});var body_of=p_node.children[3];wr.out(") {",true);wr.indent(1);if(the_rest_index!=-1){wr.out("var __local_rest = Array.prototype.slice.call(arguments, "+the_rest_index+")",true)}else{}wr.out("return (",true);wr.indent(1);create_code.call(this,body_of,ctx,wr);wr.out("",true);wr.indent(-1);wr.out(")",true);wr.out("",true);wr.indent(-1);wr.out("}",true);return}if(fc&&fc.vref=="use"){var n=p_node.children[1];ctx.__def(n.vref,n.type);ctx[n.vref]={type:n.type,cnt:0,external:true};return}if(fc&&fc.vref=="fn"){wr.out("(function ");wr.out("(");var args_list=p_node.children[1];args_list.children.forEach(function(a){wr.out(a.vref);ctx.__def(a.vref,a.type);ctx[a.vref]={type:a.type,cnt:0,external:false,param:true}});var body_of=p_node.children[2];wr.out(") {",true);wr.indent(1);wr.out("return (",true);wr.indent(1);create_code.call(this,body_of,ctx,wr);wr.out("",true);wr.indent(-1);wr.out(")",true);wr.out("",true);wr.indent(-1);wr.out("})",true);return}if(fc&&fc.vref){var compiler_fn=Jinx.LispCompilerExpressions;var fn=compiler_fn[fc.vref];if(fn){var variants=Object.keys(fn);if(variants.length==1){var key1=variants[0];var c_fn=fn[key1];c_fn.call(this,p_node,ctx,wr);return}throw"Can not yet handle multiple signatures"}if(p_node.children.length==1){create_code.call(this,p_node.children[0],ctx,wr);return}var had_spread_operator=false;for(var i=1;i<p_node.children.length;i++){var arg=p_node.children[i];if((typeof arg==="undefined"?"undefined":_typeof(arg))=="object"&&arg.vref=="&"){had_spread_operator=true;continue}}if(had_spread_operator){wr.out(fc.vref+".apply(this, __join( [");for(var i=1;i<p_node.children.length;i++){if(i==1){wr.indent(1)}if(p_node.children.length>3){if(i>1){wr.out(",",true)}}else{if(i>1){wr.out(",")}}var param_value=p_node.children[i];if((typeof param_value==="undefined"?"undefined":_typeof(param_value))=="object"&&param_value.vref=="&"){wr.out("__local_rest");continue}wr.out("");create_code.call(this,p_node.children[i],ctx,wr);wr.out("")}if(i>1){wr.indent(-1)}wr.out("]))",true)}else{if(fc.ns&&fc.ns.length>1){var f_name=fc.ns[1];var obj=ctx[fc.ns[0]];var f_def=obj[f_name];wr.out("__ctx__['"+fc.ns[0]+"']['"+fc.ns[1]+"'](")}else{var f_def=ctx[fc.vref];if(f_def&&f_def.import){wr.out("__ctx__['"+fc.vref+"'](")}else{wr.out(fc.vref+"(")}}for(var i=1;i<p_node.children.length;i++){if(i==1){wr.indent(1)}if(p_node.children.length>3){if(i>1){wr.out(",",true)}}else{if(i>1){wr.out(",")}}wr.out("");create_code.call(this,p_node.children[i],ctx,wr);wr.out("")}if(i>1){wr.indent(-1)}wr.out(")",true)}return}if(p_node.children){var last=p_node.children.length-1;var first_child=p_node.children[0];if(first_child&&first_child.children){var lambda=first_child.children[0];if(lambda&&lambda.vref=="fn"){create_code.call(this,first_child,ctx,wr);for(var i=1;i<p_node.children.length;i++){if(i>1)wr.out(",");wr.out("(");create_code.call(this,p_node.children[i],ctx,wr);wr.out(")")}return}}if(p_node.children.length==1){create_code.call(this,p_node.children[0],ctx,wr);return}p_node.children.forEach(function(n,i){if(i==last){if(is_variable_def(n)){}else{}}create_code.call(this,n,ctx,wr,true,i==last)}.bind(this))}function call_operator(name,p_node){var had_spread_operator=false;for(var i=1;i<p_node.children.length;i++){var arg=p_node.children[i];if((typeof arg==="undefined"?"undefined":_typeof(arg))=="object"&&arg.vref=="&"){had_spread_operator=true;continue}}if(!had_spread_operator){if(name=="inc_operator"){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" + ")}create_code.call(this,p_node.children[i],ctx,wr)}return}}if(had_spread_operator){wr.out(name+".apply(this, __join([")}else{wr.out(name+"(")}for(var i=1;i<p_node.children.length;i++){if(i==1){wr.indent(1)}if(p_node.children.length>3){if(i>1){wr.out(",",true)}}else{if(i>1){wr.out(",")}}var param_value=p_node.children[i];if((typeof param_value==="undefined"?"undefined":_typeof(param_value))=="object"&&param_value.vref=="&"){wr.out("__local_rest");continue}wr.out("");create_code.call(this,p_node.children[i],ctx,wr);wr.out("")}if(i>1){wr.indent(-1)}if(had_spread_operator){wr.out("]))",true)}else{wr.out(")")}}}function push_error(node,err){if(!node.errors){node.errors=[]}node.errors.push(err);if(ctx){ctx.__all_errors__.push({node:node,err:err})}}function get_first_child(node){if(is_object(node)&&node.children)return node.children[0]}function is_object(node){return node&&(typeof node==="undefined"?"undefined":_typeof(node))=="object"}function is_assigment(node){if(is_object(node)){if(is_function_call(node)){}}}function get_node_signature(node){if(node.signature)return node.signature;if(node.type&&!node.type_def&&node.vref&&(!node.children||node.children.length==0)){return node.type}if(is_raw_value(node)){return detect_value_type(node)}if(node.type_def){var def=node.type_def;var call_sig="(_:";var fc=def.children[0];call_sig+=get_node_signature(fc);var args=def.children[1];call_sig+="(";args.children.forEach(function(a,i){if(i>0)call_sig+=" ";call_sig+="_:"+get_node_signature(a)});call_sig+="))";return call_sig}return"_"}function is_defined_function(name,ctx){var r=ctx[name];if(!r){push_error(node,"Undeclared function : "+name);return false}if(!is_function_def(r)){push_error(node,"Undeclared function: "+name);return false}return true}function get_fn_name(node){if(is_function_def(node)){return node.children[1].vref}}function get_fn_type(node){if(is_function_def(node)){return node.children[1].type}}function is_fn_def_valid(node){if(is_function_def(node)){try{var name=get_fn_name(node);if(!name){push_error(node,"Invalid name for a function :"+name)}node.children[2].children.map(function(n){return n.vref});if(node.children.length>4){push_error(node.children[4],"Invalid function definition: function parts after function body are not evaluated")}return true}catch(e){push_error(node,"Invalid function");return false}}return false}function get_fn_body(node){if(is_function_def(node)){try{var body=node.children[3];var fc=body.children[0];return body}catch(e){push_error(node,"Invalid function body")}}}function get_fn_args(node){if(is_function_def(node)){try{return node.children[2].children}catch(e){push_error(node,"Invalid fn args")}}}function is_raw_value(node){if(typeof node=="string")return true;if(!isNaN(node))return true;if(typeof node=="boolean")return true;return false}function is_lambda_function_def(node){var fc=get_first_child(node);if(is_object(fc)&&fc.vref){if(fc.vref=="fn")return true}}function is_function_def(node){var fc=get_first_child(node);if(is_object(fc)&&fc.vref){if(fc.vref=="defn")return true}}function is_single_value_list(node){var fc=get_first_child(node);if(fc){if(is_function_def(node)||is_variable_def(node)||is_function_call(node)){return false}if(node.children&&node.children.length==1){return true}}return false}function is_another_list(node){var fc=get_first_child(node);if(fc){if(is_function_def(node)||is_variable_def(node)||is_function_call(node)){return false}if(node.children&&node.children.length>1){return true}}return false}function is_variable_def(node){var fc=get_first_child(node);if(is_object(fc)&&fc.vref){if(fc.vref=="def")return true;if(fc.vref=="let")return true}}function is_lambda_function_call(node){var fc=get_first_child(node);if(is_object(fc)){if(fc.vref&&node.children.length>1){return false}if(fc.vref=="fn"||fc.vref=="=>")return true}return true}function is_function_call(node){if(is_variable_def(node))return false;if(is_function_def(node))return false;var fc=get_first_child(node);if(is_object(fc)){if(fc.vref&&node.children.length>1){return true}}}if(!_glob["Jinx"])_glob["Jinx"]={};_glob["Jinx"].CompileLispToCode=start_lisp_to_code})(window);(function(_glob){function raw_value(n){if(typeof n=="boolean")return n;if(!isNaN(n))return parseFloat(n);if(typeof n=="string")return n;if(n&&(typeof n==="undefined"?"undefined":_typeof(n))=="object")return n.value;return n}var LispCompilerExpressions={__type__:function __type__(v,wr){var test="";if(typeof v=="string"){test=v}else{test=v.type}switch(test){case"int":wr.out("int");break;case"double":wr.out("double");break;case"string":wr.out("string");break;case"boolean":wr.out("bool");break;default:if(test)wr.out(test)}},"=":{"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){for(var i=1;i<=2;i++){if(i>1){wr.out(" = ")}create_code.call(this,p_node.children[i],ctx,wr)}wr.out(";",true);return}},"+":{"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" + ")}create_code.call(this,p_node.children[i],ctx,wr)}return}},"<=":{"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" <= ")}create_code.call(this,p_node.children[i],ctx,wr)}return}},">=":{"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" >= ")}create_code.call(this,p_node.children[i],ctx,wr)}return}},"!=":{"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" != ")}create_code.call(this,p_node.children[i],ctx,wr)}return}},DefList:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){var v=p_node.children[1];LispCompilerExpressions.__type__(v,wr);wr.out(" ");wr.out(v.vref);wr.out(";",true)}},new:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){var var_name=p_node.children[1];var args=p_node.children[2];wr.out(" new ");wr.out(var_name.vref);wr.out("(");args.children.forEach(function(arg,i){if(i>0)wr.out(", ");wr.out(" ");wr.out(arg.vref)});wr.out(")")}},push:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){var var_name=p_node.children[1];var index_pos=p_node.children[2];wr.out(var_name.vref);wr.out(".Add(");create_code.call(this,index_pos,ctx,wr);wr.out(")",true)}},charAt:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){var var_name=p_node.children[1];var index_pos=p_node.children[2];wr.out(var_name.vref);wr.out("[");create_code.call(this,index_pos,ctx,wr);wr.out("]")}},def:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){var v=p_node.children[1];ctx.__def(v.vref);ctx[v.vref]={node:p_node};if(ctx.__in_class_body){wr.out("public ")}if(v.type=="array"){ctx.__import("System.Collections.Generic");wr.out("List<"+v.array_type+"> ");wr.out(v.vref);if(!ctx.__in_class_body){wr.out(" = ");wr.out("new List<"+v.array_type+">();",true)}else{wr.out(";",true);ctx.__constructor_creators.push(function(wr){wr.out(v.vref+" = ");wr.out("new List<"+v.array_type+">();",true)})}return}LispCompilerExpressions.__type__(v,wr);wr.out(" ");wr.out(v.vref);var value=p_node.children[2];if(typeof value!="undefined"){if(ctx.__in_class_body&&!is_raw_value(value)){ctx.__constructor_creators.push(function(wr){wr.out(v.vref+" = ");create_code.call(this,value,ctx,wr)})}else{wr.out(" = ");if(!isNaN(value)){if(Number.isInteger(value)){if(v.type=="double"){wr.out(value+".0")}else{wr.out(value)}}else{wr.out(value)}}else{create_code.call(this,value,ctx,wr)}}}wr.out(";",true)}},Constructor:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){ctx.__constructor_params=p_node.children[1];ctx.__constructor_code=p_node.children[2]}},PublicVar:{"(_:_(_:string _:form))":function ___String_Form(p_node,ctx,wr){wr.out("public ");var v=p_node.children[1];LispCompilerExpressions.__type__(v,wr);wr.out(" ");wr.out(v.vref);wr.out(";",true)}},PublicMethod:{"(_:_(_:string args:form body:form))":function ___StringArgsFormBodyForm(p_node,ctx,wr){ctx=ctx.__fork();ctx.__def("__in_class_body");ctx.__def("__in_method");ctx.__in_class_body=false;ctx.__in_method=true;wr.out("",true);var v=p_node.children[1];wr.out("public ");var v=p_node.children[1];LispCompilerExpressions.__type__(v,wr);wr.out(" ");wr.out(v.vref);var vars_list=p_node.children[2];wr.out("(");vars_list.children.forEach(function(arg,i){if(i>0)wr.out(", ");LispCompilerExpressions.__type__(arg,wr);wr.out(" ");wr.out(arg.vref)});wr.out(")");wr.out(" {",true);wr.indent(1);create_code.call(this,p_node.children[3],ctx,wr);wr.out("",true);wr.indent(-1);wr.out("}",true);wr.out("",true)}},CreateClass:{"(_:_(_:string _:form))":function ___String_Form(p_node,ctx,wr){var _this5=this;ctx=ctx.__fork();var v=p_node.children[1];var class_name=v.vref;ctx.__def("__class_name");ctx.__class_name=class_name;ctx.__def("__constructor_code");ctx.__constructor_code=new writer;ctx.__constructor_code.indent(2);ctx.__def("__constructor_creators");ctx.__constructor_creators=[];ctx.__def("__constructor_params");ctx.__constructor_params=null;ctx.__def("__constructor_code");ctx.__constructor_code=null;ctx.__def("__import");var imports_tag;function start_class(wr){imports_tag=wr.tag("imports");wr.out("\n\nnamespace Ranger\n{",true);wr.indent(1)}var imported={};ctx.__import=function(lib_name){if(!imported[lib_name]){imports_tag.out("using "+lib_name+";",true)}imported[lib_name]=true};function end_class(wr){wr.indent(-1);wr.out("}",true)}this.openFile("csharp/",class_name+".cs",function(wr){start_class(wr);ctx.__import("System");ctx.__import("System.Dynamic");wr.out("// C# code",true);wr.out("public class ");wr.out(class_name);wr.out(" {",true);wr.out("",true);ctx.__def("__in_class_body");ctx.__in_class_body=true;wr.indent(1);create_code.call(_this5,p_node.children[2],ctx,wr);wr.out("",true);wr.out("public "+class_name+"(");if(ctx.__constructor_params){ctx.__constructor_params.children.forEach(function(arg,i){if(i>0)wr.out(", ");LispCompilerExpressions.__type__(arg,wr);wr.out(" ");wr.out(arg.vref)})}wr.out("){",true);wr.indent(1);ctx.__constructor_creators.forEach(function(cc){cc.call(this,wr)}.bind(_this5));if(ctx.__constructor_code){create_code.call(_this5,ctx.__constructor_code,ctx,wr)}wr.indent(-1);wr.out("}",true);wr.indent(-1);ctx.__in_class_body=false;wr.out("}",true);end_class(wr)})}},create_js_obj:function create_js_obj(p_node,ctx,wr){wr.out("{}")},if:{"(_:_(_:boolean _:form _form))":function ___Boolean_Form_form(p_node,ctx,wr){wr.out("if(");create_code.call(this,p_node.children[1],ctx,wr);wr.out(") {",true);wr.indent(1);create_code.call(this,p_node.children[2],ctx,wr);wr.indent(-1);wr.out("}");if(p_node.children[3]){wr.out(" else {",true);wr.indent(1);create_code.call(this,p_node.children[3],ctx,wr);wr.out("",true);wr.indent(-1);wr.out("}")}wr.out("",true)}},return:{"(_:_(_:_))":function ____(p_node,ctx,wr){wr.out("return ");create_code.call(this,p_node.children[1],ctx,wr);wr.out(";",true)}},while:{"(_:_(_:booleam _:form))":function ___Booleam_Form(p_node,ctx,wr){wr.out("while(");create_code.call(this,p_node.children[1],ctx,wr);wr.out(") {",true);wr.indent(1);create_code.call(this,p_node.children[2],ctx,wr);wr.indent(-1);wr.out("}")}}};var simple_expressions=["==","<",">","!=",">=","<="];simple_expressions.forEach(function(expr){LispCompilerExpressions[expr]={"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" "+expr+" ")}create_code.call(this,p_node.children[i],ctx,wr)}return}}});var simple_expressions=["&&","||"];simple_expressions.forEach(function(expr){LispCompilerExpressions[expr]={"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" "+expr+" ")}wr.out("(");create_code.call(this,p_node.children[i],ctx,wr);wr.out(")")}return}}});var num_operators=["*","+","-","/","%"];num_operators.forEach(function(expr){LispCompilerExpressions[expr]={"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" "+expr+" ")}wr.out("(");create_code.call(this,p_node.children[i],ctx,wr);wr.out(")")}return}}});var math_lib=["sin","cos","tan","atan","log","abs","acos","asin","floor","round","sqrt"];function ucfirst(string){return string.charAt(0).toUpperCase()+string.slice(1)}math_lib.forEach(function(expr){LispCompilerExpressions[expr]={"(_:double(_:double))":function _fn(p_node,ctx,wr){ctx.__import("System");wr.out("Math."+ucfirst(expr)+"(");create_code.call(this,p_node.children[1],ctx,wr);wr.out(")");return}}});function start_lisp_to_code(p_node,ctx,wr,LangExpressions){var _this6=this;if(LangExpressions){Object.keys(LangExpressions).forEach(function(k){LispCompilerExpressions[k]=LangExpressions[k]})}if(!this.openFile){this._openFiles=[];this.openFile=function(path,filename,cb){var wr=new writer;var list=_this6._openFiles.filter(function(f){return f.path==path&&f.filename==filename});if(list.length){var oldFile=list[0];var oldIndex=_this6._openFiles.indexOf(oldFile);if(oldIndex>=0)_this6._openFiles.splice(oldIndex,1)}_this6._openFiles.push({wr:wr,path:path,filename:filename});cb(wr)}}create_code.call(this,p_node,ctx,wr)}function create_code(p_node,ctx,wr,is_body){if(!ctx)ctx=Jinx.CreateContext();var code="";if((typeof p_node==="undefined"?"undefined":_typeof(p_node))!="object"){if(typeof p_node=="string"){wr.out('"'+p_node+'"');return}if(!isNaN(p_node)){wr.out(""+p_node);return}wr.out(""+p_node);return}if(p_node.vref){if(p_node.vref=="&"){throw"Rest expression should not be processed as a variable"}var var_type=ctx[p_node.vref];if(var_type){if(var_type.external){wr.out("__ctx__['"+p_node.vref+"']");return}}wr.out(p_node.vref);return}if(!p_node.children)return;if(p_node.literal){var obj;var _ret4=function(){var parse_literal_to_obj=function parse_literal_to_obj(node){if(typeof node=="boolean")return node;if(typeof node=="string")return node;if(!isNaN(node))return node;if((typeof node==="undefined"?"undefined":_typeof(node))=="object"){if(node.vref){var o={vref:node.vref,type:node.type};if(node.type_def)o.type_def=parse_literal_to_obj(node.type_def);return o}var o={lisp:true};o.children=node.children.map(function(n){return parse_literal_to_obj(n)});return o}};obj=parse_literal_to_obj(p_node);wr.out(JSON.stringify(obj));return{v:void 0}}();if((typeof _ret4==="undefined"?"undefined":_typeof(_ret4))==="object")return _ret4.v}var fc=p_node.children[0];if(fc&&fc.vref=="defmacro"){return}if(fc&&fc.vref=="import"){var name_node=p_node.children[1];if(name_node.ns&&name_node.ns.length>1){var dict_name=name_node.ns[0];ctx.__def(dict_name,"dict");if(!ctx[dict_name]){ctx[name_node.ns[0]]={type:"dictionary",cnt:0,import:true,value:{}}}var f_name=name_node.ns[1];var obj=ctx[name_node.ns[0]];obj[f_name]={type:"function",cnt:0,import:true,signature:sig}}else{var f_name=name_node.vref;var sig=get_node_signature(name_node);ctx.__def(f_name,"function");ctx[f_name]={type:"function",cnt:0,import:true,signature:sig}}return}if(fc&&fc.vref=="defn"){wr.out("function ");wr.out(p_node.children[1].vref);wr.out("(");var args_list=p_node.children[2];var the_rest_index=-1;args_list.children.forEach(function(a,i){if(a.vref=="&"){the_rest_index=i;return}if(i>0)wr.out(",");wr.out(a.vref);ctx.__def(a.vref,a.type);ctx[a.vref]={type:a.type,cnt:0,external:false,param:true}});var body_of=p_node.children[3];wr.out(") {",true);wr.indent(1);if(the_rest_index!=-1){wr.out("var __local_rest = Array.prototype.slice.call(arguments, "+the_rest_index+")",true)}else{}wr.out("return (",true);wr.indent(1);create_code.call(this,body_of,ctx,wr);wr.out("",true);wr.indent(-1);wr.out(")",true);wr.out("",true);wr.indent(-1);wr.out("}",true);return}if(fc&&fc.vref=="use"){var n=p_node.children[1];ctx.__def(n.vref,n.type);ctx[n.vref]={type:n.type,cnt:0,external:true};return}if(fc&&fc.vref=="fn"){wr.out("(function ");wr.out("(");var args_list=p_node.children[1];args_list.children.forEach(function(a){wr.out(a.vref);ctx.__def(a.vref,a.type);ctx[a.vref]={type:a.type,cnt:0,external:false,param:true}});var body_of=p_node.children[2];wr.out(") {",true);wr.indent(1);wr.out("return (",true);wr.indent(1);create_code.call(this,body_of,ctx,wr);wr.out("",true);wr.indent(-1);wr.out(")",true);wr.out("",true);wr.indent(-1);wr.out("})",true);return}if(fc&&fc.vref){var compiler_fn=LispCompilerExpressions;var fn=compiler_fn[fc.vref];if(fn){var variants=Object.keys(fn);if(variants.length==1){var key1=variants[0];var c_fn=fn[key1];c_fn.call(this,p_node,ctx,wr);return}throw"Can not yet handle multiple signatures"}if(p_node.children.length==1){create_code.call(this,p_node.children[0],ctx,wr);return}var had_spread_operator=false;for(var i=1;i<p_node.children.length;i++){var arg=p_node.children[i];if((typeof arg==="undefined"?"undefined":_typeof(arg))=="object"&&arg.vref=="&"){had_spread_operator=true;continue}}if(had_spread_operator){wr.out(fc.vref+".apply(this, __join( [");for(var i=1;i<p_node.children.length;i++){if(i==1){wr.indent(1)}if(p_node.children.length>3){if(i>1){wr.out(",",true)}}else{if(i>1){wr.out(",")}}var param_value=p_node.children[i];if((typeof param_value==="undefined"?"undefined":_typeof(param_value))=="object"&&param_value.vref=="&"){wr.out("__local_rest");continue}wr.out("");create_code.call(this,p_node.children[i],ctx,wr);wr.out("")}if(i>1){wr.indent(-1)}wr.out("]))",true)}else{if(fc.ns&&fc.ns.length>1){var f_name=fc.ns[1];var obj=ctx[fc.ns[0]];var f_def=obj[f_name];wr.out("__ctx__['"+fc.ns[0]+"']['"+fc.ns[1]+"'](")}else{var f_def=ctx[fc.vref];if(f_def&&f_def.import){wr.out("__ctx__['"+fc.vref+"'](")}else{wr.out(fc.vref+"(")}}for(var i=1;i<p_node.children.length;i++){if(i==1){wr.indent(1)}if(p_node.children.length>3){if(i>1){wr.out(",",true)}}else{if(i>1){wr.out(",")}}wr.out("");create_code.call(this,p_node.children[i],ctx,wr);wr.out("")}if(i>1){wr.indent(-1)}wr.out(")",true)}return}if(p_node.children){var last=p_node.children.length-1;var first_child=p_node.children[0];if(first_child&&first_child.children){var lambda=first_child.children[0];if(lambda&&lambda.vref=="fn"){create_code.call(this,first_child,ctx,wr);for(var i=1;i<p_node.children.length;i++){if(i>1)wr.out(",");wr.out("(");create_code.call(this,p_node.children[i],ctx,wr);wr.out(")")}return}}if(p_node.children.length==1){create_code.call(this,p_node.children[0],ctx,wr);return}p_node.children.forEach(function(n,i){if(i==last){if(is_variable_def(n)){}else{}}create_code.call(this,n,ctx,wr,true,i==last)}.bind(this))}function call_operator(name,p_node){var had_spread_operator=false;for(var i=1;i<p_node.children.length;i++){var arg=p_node.children[i];if((typeof arg==="undefined"?"undefined":_typeof(arg))=="object"&&arg.vref=="&"){had_spread_operator=true;continue}}if(!had_spread_operator){if(name=="inc_operator"){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" + ")}create_code.call(this,p_node.children[i],ctx,wr)}return}}if(had_spread_operator){wr.out(name+".apply(this, __join([")}else{wr.out(name+"(")}for(var i=1;i<p_node.children.length;i++){if(i==1){wr.indent(1)}if(p_node.children.length>3){if(i>1){wr.out(",",true)}}else{if(i>1){wr.out(",")}}var param_value=p_node.children[i];if((typeof param_value==="undefined"?"undefined":_typeof(param_value))=="object"&&param_value.vref=="&"){wr.out("__local_rest");continue}wr.out("");create_code.call(this,p_node.children[i],ctx,wr);wr.out("")}if(i>1){wr.indent(-1)}if(had_spread_operator){wr.out("]))",true)}else{wr.out(")")}}}function push_error(node,err){if(!node.errors){node.errors=[]}node.errors.push(err);if(ctx){ctx.__all_errors__.push({
node:node,err:err})}}function get_first_child(node){if(is_object(node)&&node.children)return node.children[0]}function is_object(node){return node&&(typeof node==="undefined"?"undefined":_typeof(node))=="object"}function is_assigment(node){if(is_object(node)){if(is_function_call(node)){}}}function get_node_signature(node){if(node.signature)return node.signature;if(node.type&&!node.type_def&&node.vref&&(!node.children||node.children.length==0)){return node.type}if(is_raw_value(node)){return detect_value_type(node)}if(node.type_def){var def=node.type_def;var call_sig="(_:";var fc=def.children[0];call_sig+=get_node_signature(fc);var args=def.children[1];call_sig+="(";args.children.forEach(function(a,i){if(i>0)call_sig+=" ";call_sig+="_:"+get_node_signature(a)});call_sig+="))";return call_sig}return"_"}function is_defined_function(name,ctx){var r=ctx[name];if(!r){push_error(node,"Undeclared function : "+name);return false}if(!is_function_def(r)){push_error(node,"Undeclared function: "+name);return false}return true}function get_fn_name(node){if(is_function_def(node)){return node.children[1].vref}}function get_fn_type(node){if(is_function_def(node)){return node.children[1].type}}function is_fn_def_valid(node){if(is_function_def(node)){try{var name=get_fn_name(node);if(!name){push_error(node,"Invalid name for a function :"+name)}node.children[2].children.map(function(n){return n.vref});if(node.children.length>4){push_error(node.children[4],"Invalid function definition: function parts after function body are not evaluated")}return true}catch(e){push_error(node,"Invalid function");return false}}return false}function get_fn_body(node){if(is_function_def(node)){try{var body=node.children[3];var fc=body.children[0];return body}catch(e){push_error(node,"Invalid function body")}}}function get_fn_args(node){if(is_function_def(node)){try{return node.children[2].children}catch(e){push_error(node,"Invalid fn args")}}}function is_raw_value(node){if(typeof node=="string")return true;if(!isNaN(node))return true;if(typeof node=="boolean")return true;return false}function is_lambda_function_def(node){var fc=get_first_child(node);if(is_object(fc)&&fc.vref){if(fc.vref=="fn")return true}}function is_function_def(node){var fc=get_first_child(node);if(is_object(fc)&&fc.vref){if(fc.vref=="defn")return true}}function is_single_value_list(node){var fc=get_first_child(node);if(fc){if(is_function_def(node)||is_variable_def(node)||is_function_call(node)){return false}if(node.children&&node.children.length==1){return true}}return false}function is_another_list(node){var fc=get_first_child(node);if(fc){if(is_function_def(node)||is_variable_def(node)||is_function_call(node)){return false}if(node.children&&node.children.length>1){return true}}return false}function is_variable_def(node){var fc=get_first_child(node);if(is_object(fc)&&fc.vref){if(fc.vref=="def")return true;if(fc.vref=="let")return true}}function is_lambda_function_call(node){var fc=get_first_child(node);if(is_object(fc)){if(fc.vref&&node.children.length>1){return false}if(fc.vref=="fn"||fc.vref=="=>")return true}return true}function is_function_call(node){if(is_variable_def(node))return false;if(is_function_def(node))return false;var fc=get_first_child(node);if(is_object(fc)){if(fc.vref&&node.children.length>1){return true}}}if(!_glob["Jinx"])_glob["Jinx"]={};_glob["Jinx"].CompileLispToCSharp=start_lisp_to_code})(window);(function(_glob){function raw_value(n){if(typeof n=="boolean")return n;if(!isNaN(n))return parseFloat(n);if(typeof n=="string")return n;if(n&&(typeof n==="undefined"?"undefined":_typeof(n))=="object")return n.value;return n}function swift_var_ref(node,ctx,wr){if(node.ns&&node.ns.length>1){var vn=node.ns[0];wr.out(vn);var v_info=ctx[vn];if(v_info&&v_info.optional)wr.out("!");wr.out(".");wr.out(node.ns[1])}else{if(node.vref){if(node.vref=="this"){wr.out("self");return}wr.out(node.vref);var v_info=ctx[node.vref];if(v_info&&v_info.optional)wr.out("!")}}}var LispCompilerExpressions={__type__:function __type__(v,wr){var test="";if(typeof v=="string"){test=v}else{test=v.type}switch(test){case"char":wr.out("UInt32");break;case"int":wr.out("Int");break;case"double":wr.out("Double");break;case"string":wr.out("String");break;case"boolean":wr.out("Bool");break;default:if(test)wr.out(test)}},"=":{"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){var to_node=p_node.children[1];if(to_node.ns&&to_node.ns.length>1){swift_var_ref(to_node,ctx,wr)}else{wr.out(to_node.vref)}wr.out(" = ");create_code.call(this,p_node.children[2],ctx,wr);wr.out(";",true);return}},"+":{"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" + ")}create_code.call(this,p_node.children[i],ctx,wr)}return}},"<=":{"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" <= ")}create_code.call(this,p_node.children[i],ctx,wr)}return}},">=":{"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" >= ")}create_code.call(this,p_node.children[i],ctx,wr)}return}},"!=":{"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" != ")}create_code.call(this,p_node.children[i],ctx,wr)}return}},DefList:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){var v=p_node.children[1];LispCompilerExpressions.__type__(v,wr);wr.out(" ");wr.out(v.vref);wr.out(";",true)}},break:{"(_:int(_:string _:_))":function _Int_String__(p_node,ctx,wr){wr.out("break;",true)}},continue:{"(_:int(_:string _:_))":function _Int_String__(p_node,ctx,wr){wr.out("continue;",true)}},print:{"(_:int(_:string _:_))":function _Int_String__(p_node,ctx,wr){wr.out("print(");create_code.call(this,p_node.children[1],ctx,wr);wr.out(");",true)}},itemAt:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){var var_name=p_node.children[1];var index_name=p_node.children[2];swift_var_ref(var_name,ctx,wr);wr.out("[");create_code.call(this,index_name,ctx,wr);wr.out("]")}},removeLast:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){var var_name=p_node.children[1];swift_var_ref(var_name,ctx,wr);wr.out(".removeLast(");wr.out(");",true)}},for:{"(_:int(_:string _:_))":function _Int_String__(p_node,ctx,wr){var list_name=p_node.children[1];var item_name=p_node.children[2];var index_name=p_node.children[3];ctx=ctx.__fork();ctx.__def(item_name.vref);ctx[item_name.vref]={node:item_name};wr.out("for ");create_code.call(this,item_name,ctx,wr);wr.out(" in ");create_code.call(this,list_name,ctx,wr);wr.out(" {",true);wr.indent(1);create_code.call(this,p_node.children[4],ctx,wr);wr.indent(-1);wr.out("}",true)}},array_length:{"(_:int(_:string _:_))":function _Int_String__(p_node,ctx,wr){var var_name=p_node.children[1];swift_var_ref(var_name,ctx,wr);wr.out(".count")}},strlen:{"(_:int(_:string _:_))":function _Int_String__(p_node,ctx,wr){var var_name=p_node.children[1];wr.out(var_name.vref);wr.out(".characters.count")}},substring:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){var var_name=p_node.children[1];var start_pos=p_node.children[2];var end_pos=p_node.children[3];var var_info=ctx[var_name.vref];wr.out(var_name.vref);if(var_info.optional)wr.out("!");wr.out(".substring(with: ");wr.out(var_name.vref);if(var_info.optional)wr.out("!");wr.out(".index(");wr.out(var_name.vref);if(var_info.optional)wr.out("!");wr.out(".startIndex");wr.out(",offsetBy:");create_code.call(this,start_pos,ctx,wr);wr.out(")");wr.out("..<");wr.out(var_name.vref);if(var_info.optional)wr.out("!");wr.out(".index(");wr.out(var_name.vref);if(var_info.optional)wr.out("!");wr.out(".startIndex");wr.out(",offsetBy:");create_code.call(this,end_pos,ctx,wr);wr.out(")");wr.out(")")}},call:{"(_:_(_:string _:_))":function ___String__(p_node,ctx,wr){var var_name=p_node.children[1];var method_name=p_node.children[2];var args=p_node.children[3];var obj_info=ctx[var_name.vref];var c_info;if(obj_info){c_info=ctx["class::"+obj_info.node.type]}else{console.error("No info about ",var_name.vref)}if(var_name.vref=="this"){wr.out("self")}else{wr.out(var_name.vref)}var info=ctx[var_name.vref];if(info&&info.optional){wr.out("!")}wr.out("."+method_name.vref+"(");var method_info=c_info[method_name.vref];args.children.forEach(function(arg,i){if(i>0)wr.out(", ");if(method_info){var a=method_info.args.children[i];if(a){wr.out(a.vref+":")}}create_code.call(this,arg,ctx,wr)});wr.out(")");if(!ctx.__expression)wr.out(";",true)}},"null?":{"(_:_(_:string))":function ___String(p_node,ctx,wr){var var_name=p_node.children[1];wr.out("(");wr.out(var_name.vref);wr.out(" == ");wr.out(" nil ");wr.out(")")}},"!null?":{"(_:_(_:string))":function ___String(p_node,ctx,wr){var var_name=p_node.children[1];wr.out("(");wr.out(var_name.vref);wr.out(" != ");wr.out(" nil ");wr.out(")")}},has:{"(_:_(_:string))":function ___String(p_node,ctx,wr){var var_name=p_node.children[1];var key_name=p_node.children[2];wr.out("(");swift_var_ref(var_name,ctx,wr);wr.out("[");create_code.call(this,key_name,ctx,wr);wr.out("] != nil )")}},get:{"(_:_(_:string))":function ___String(p_node,ctx,wr){var var_name=p_node.children[1];var key_name=p_node.children[2];swift_var_ref(var_name,ctx,wr);var info=ctx[var_name.vref];if(info&&info.optional){wr.out("!")}wr.out("[");create_code.call(this,key_name,ctx,wr);wr.out("]!")}},set:{"(_:_(_:string _:_))":function ___String__(p_node,ctx,wr){var var_name=p_node.children[1];var key_name=p_node.children[2];var value=p_node.children[3];swift_var_ref(var_name,ctx,wr);wr.out(".updateValue(");create_code.call(this,value,ctx,wr);wr.out(",forKey:");create_code.call(this,key_name,ctx,wr);wr.out(")");if(!ctx.__expression)wr.out(";",true)}},new:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){var var_name=p_node.children[1];var args=p_node.children[2];var c_info=ctx["class::"+var_name.vref];var method_info=c_info["Constructor"];wr.out(" ");wr.out(var_name.vref);wr.out("(");args.children.forEach(function(a,i){if(i>0)wr.out(", ");if(method_info){var ar=method_info.args.children[i];if(ar){wr.out(ar.vref+":")}}create_code.call(this,a,ctx,wr)});wr.out(")")}},push:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){var var_name=p_node.children[1];var index_pos=p_node.children[2];swift_var_ref(var_name,ctx,wr);wr.out(".append(");create_code.call(this,index_pos,ctx,wr);wr.out(")",true)}},charAt:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){var var_name=p_node.children[1];var index_pos=p_node.children[2];var var_info=ctx[var_name.vref];wr.out(var_name.vref);if(var_info.optional)wr.out("!");wr.out("[");swift_var_ref(var_name,ctx,wr);wr.out(".index(");swift_var_ref(var_name,ctx,wr);wr.out(".startIndex, offsetBy: ");create_code.call(this,index_pos,ctx,wr);wr.out(")");wr.out("].unicodeScalarCodePoint()")}},def:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){var v=p_node.children[1];ctx.__def(v.vref);ctx[v.vref]={node:v};if(ctx.__in_class_body){}if(v.type=="hash"){var a_type=v.array_type=="any"?"any":v.array_type;wr.out("var ");wr.out(v.vref);wr.out(" = ");wr.out("[");LispCompilerExpressions.__type__(v.key_type,wr);wr.out(":");LispCompilerExpressions.__type__(a_type,wr);wr.out("]");wr.out("();",true);return}if(v.type=="array"){wr.out("var ");wr.out(v.vref);wr.out(" = ");wr.out("[");LispCompilerExpressions.__type__(v.array_type,wr);wr.out("]();",true);return}if(ctx.__in_class_body){wr.out("var ")}else{wr.out("var ")}wr.out(v.vref);wr.out(":");LispCompilerExpressions.__type__(v,wr);var value=p_node.children[2];if(typeof value!="undefined"){wr.out(" = ");create_code.call(this,value,ctx,wr)}else{wr.out("?");ctx[v.vref].optional=true}wr.out(";",true)}},Constructor:{"(_:_(_:form))":function ___Form(p_node,ctx,wr){ctx.__constructor_params=p_node.children[1];ctx.__constructor_code=p_node.children[2]}},PublicVar:{"(_:_(_:string _:form))":function ___String_Form(p_node,ctx,wr){wr.out("public ");var v=p_node.children[1];LispCompilerExpressions.__type__(v,wr);wr.out(" ");wr.out(v.vref);wr.out(";",true)}},PublicMethod:{"(_:_(_:string args:form body:form))":function ___StringArgsFormBodyForm(p_node,ctx,wr){ctx=ctx.__fork();ctx.__def("__in_class_body");ctx.__def("__in_method");ctx.__in_class_body=false;ctx.__in_method=true;wr.out("",true);if(ctx.__extends){var list=ctx.__extends.class_list;var func_name=p_node.children[1].vref;list.forEach(function(ext_class){var c_info=ctx["class::"+ext_class];if(c_info[func_name]){wr.out("override ")}})}var v=p_node.children[1];wr.out("func ");var v=p_node.children[1];wr.out(" ");wr.out(v.vref);var vars_list=p_node.children[2];wr.out("(");vars_list.children.forEach(function(arg,i){if(i>0)wr.out(", ");wr.out(arg.vref);wr.out(":");LispCompilerExpressions.__type__(arg,wr);ctx.__def(arg.vref);ctx[arg.vref]={node:arg}});wr.out(")");if(v.type!="void"){wr.out(" -> ");LispCompilerExpressions.__type__(v,wr)}wr.out(" {",true);wr.indent(1);create_code.call(this,p_node.children[3],ctx,wr);wr.indent(-1);wr.out("}",true);wr.out("",true)}},CreateClass:{"(_:_(_:string _:form))":function ___String_Form(p_node,ctx,wr){var _this7=this;ctx=ctx.__fork();var v=p_node.children[1];var class_name=v.vref;var c_info=ctx["class::"+class_name];ctx.__def("__class_name");ctx.__class_name=class_name;ctx.__def("__constructor_code");ctx.__constructor_code=new writer;ctx.__constructor_code.indent(2);ctx.__def("__constructor_creators");ctx.__constructor_creators=[];ctx.__def("__constructor_params");ctx.__constructor_params=null;ctx.__def("__constructor_code");ctx.__constructor_code=null;ctx.__def("__import");var imports_tag;function start_class(wr){imports_tag=wr.tag("imports")}var imported={};ctx.__import=function(lib_name){if(!imported[lib_name]){imports_tag.out("import "+lib_name+";",true)}imported[lib_name]=true};function end_class(wr){}this.openFile("swift/",class_name+".swift",function(wr){start_class(wr);ctx.__def("this");ctx["this"]={node:{type:class_name}};ctx.__import("Foundation");wr.out("",true);wr.out("class ");wr.out(class_name);if(c_info.__extends){ctx.__def("__extends");ctx.__extends={class_list:c_info.__extends.list};var cnt=c_info.__extends.node.children[1].children.length;if(cnt){wr.out(" : ");c_info.__extends.list.forEach(function(name,i){if(i)wr.out(", ");wr.out(name)})}}wr.out(" {",true);ctx.__def("__in_class_body");ctx.__in_class_body=true;wr.indent(1);create_code.call(_this7,p_node.children[2],ctx,wr);wr.out("",true);if(c_info.__extends)wr.out("override ");wr.out("init(");if(ctx.__constructor_params){ctx.__constructor_params.children.forEach(function(arg,i){if(i>0)wr.out(", ");wr.out(arg.vref);wr.out(":");LispCompilerExpressions.__type__(arg,wr)})}wr.out("){",true);wr.indent(1);ctx.__constructor_creators.forEach(function(cc){cc.call(this,wr)}.bind(_this7));if(ctx.__constructor_code){create_code.call(_this7,ctx.__constructor_code,ctx,wr)}wr.indent(-1);wr.out("}",true);wr.indent(-1);ctx.__in_class_body=false;wr.out("}",true);end_class(wr)})}},create_js_obj:function create_js_obj(p_node,ctx,wr){wr.out("{}")},if:{"(_:_(_:boolean _:form _form))":function ___Boolean_Form_form(p_node,ctx,wr){wr.out("if(");create_code.call(this,p_node.children[1],ctx,wr);wr.out(") {",true);wr.indent(1);create_code.call(this,p_node.children[2],ctx,wr);wr.indent(-1);wr.out("}");if(p_node.children[3]){wr.out(" else {",true);wr.indent(1);create_code.call(this,p_node.children[3],ctx,wr);wr.out("",true);wr.indent(-1);wr.out("}")}wr.out("",true)}},return:{"(_:_(_:_))":function ____(p_node,ctx,wr){wr.out("return ");ctx.__expression=true;create_code.call(this,p_node.children[1],ctx,wr);ctx.__expression=false;wr.out(";",true)}},while:{"(_:_(_:booleam _:form))":function ___Booleam_Form(p_node,ctx,wr){wr.out("while(");create_code.call(this,p_node.children[1],ctx,wr);wr.out(") {",true);wr.indent(1);create_code.call(this,p_node.children[2],ctx,wr);wr.indent(-1);wr.out("}",true)}}};var simple_expressions=["==","<",">","!=",">=","<="];simple_expressions.forEach(function(expr){LispCompilerExpressions[expr]={"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){ctx.__expression=true;for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" "+expr+" ")}create_code.call(this,p_node.children[i],ctx,wr)}ctx.__expression=false;return}}});var simple_expressions=["&&","||"];simple_expressions.forEach(function(expr){LispCompilerExpressions[expr]={"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){ctx.__expression=true;for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" "+expr+" ")}wr.out("(");create_code.call(this,p_node.children[i],ctx,wr);wr.out(")")}ctx.__expression=false;return}}});var num_operators=["*","+","-","/","%"];num_operators.forEach(function(expr){LispCompilerExpressions[expr]={"(_:int(_:int _:int))":function _fn(p_node,ctx,wr){ctx.__expression=true;for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" "+expr+" ")}wr.out("(");create_code.call(this,p_node.children[i],ctx,wr);wr.out(")")}ctx.__expression=false;return}}});var math_lib=["sin","cos","tan","atan","log","abs","acos","asin","floor","round","sqrt"];math_lib.forEach(function(expr){LispCompilerExpressions[expr]={"(_:double(_:double))":function _fn(p_node,ctx,wr){ctx.__expression=true;ctx.__import("Foundation");wr.out(expr+"(");create_code.call(this,p_node.children[1],ctx,wr);wr.out(")");ctx.__expression=false;return}}});function start_lisp_to_code(p_node,ctx,wr,LangExpressions){var _this8=this;if(LangExpressions){Object.keys(LangExpressions).forEach(function(k){LispCompilerExpressions[k]=LangExpressions[k]})}if(!this.openFile){this._openFiles=[];this.openFile=function(path,filename,cb){var wr=new writer;var list=_this8._openFiles.filter(function(f){return f.path==path&&f.filename==filename});if(list.length){var oldFile=list[0];var oldIndex=_this8._openFiles.indexOf(oldFile);if(oldIndex>=0)_this8._openFiles.splice(oldIndex,1)}_this8._openFiles.push({wr:wr,path:path,filename:filename});cb(wr)}}collect_methods(p_node,ctx);create_code.call(this,p_node,ctx,wr)}function create_code(p_node,ctx,wr,is_body){if(!ctx)ctx=Jinx.CreateContext();var code="";if((typeof p_node==="undefined"?"undefined":_typeof(p_node))!="object"){if(typeof p_node=="string"){wr.out('"'+p_node+'"');return}if(!isNaN(p_node)){wr.out(""+p_node);return}wr.out(""+p_node);return}if(p_node.vref){if(p_node.vref=="&"){throw"Rest expression should not be processed as a variable"}var var_type=ctx[p_node.vref];if(var_type){if(var_type.external){wr.out("__ctx__['"+p_node.vref+"']");return}}swift_var_ref(p_node,ctx,wr);return}if(!p_node.children)return;if(p_node.literal){var obj;var _ret5=function(){var parse_literal_to_obj=function parse_literal_to_obj(node){if(typeof node=="boolean")return node;if(typeof node=="string")return node;if(!isNaN(node))return node;if((typeof node==="undefined"?"undefined":_typeof(node))=="object"){if(node.vref){var o={vref:node.vref,type:node.type};if(node.type_def)o.type_def=parse_literal_to_obj(node.type_def);return o}var o={lisp:true};o.children=node.children.map(function(n){return parse_literal_to_obj(n)});return o}};obj=parse_literal_to_obj(p_node);wr.out(JSON.stringify(obj));return{v:void 0}}();if((typeof _ret5==="undefined"?"undefined":_typeof(_ret5))==="object")return _ret5.v}var fc=p_node.children[0];if(fc&&fc.vref=="defmacro"){return}if(fc&&fc.vref=="Extends"){return}if(fc&&fc.vref=="import"){var name_node=p_node.children[1];if(name_node.ns&&name_node.ns.length>1){var dict_name=name_node.ns[0];ctx.__def(dict_name,"dict");if(!ctx[dict_name]){ctx[name_node.ns[0]]={type:"dictionary",cnt:0,import:true,value:{}}}var f_name=name_node.ns[1];var obj=ctx[name_node.ns[0]];obj[f_name]={type:"function",cnt:0,import:true,signature:sig}}else{var f_name=name_node.vref;var sig=get_node_signature(name_node);ctx.__def(f_name,"function");ctx[f_name]={type:"function",cnt:0,import:true,signature:sig}}return}if(fc&&fc.vref=="defn"){wr.out("function ");wr.out(p_node.children[1].vref);wr.out("(");var args_list=p_node.children[2];var the_rest_index=-1;args_list.children.forEach(function(a,i){if(a.vref=="&"){the_rest_index=i;return}if(i>0)wr.out(",");wr.out(a.vref);ctx.__def(a.vref,a.type);ctx[a.vref]={type:a.type,cnt:0,external:false,param:true}});var body_of=p_node.children[3];wr.out(") {",true);wr.indent(1);if(the_rest_index!=-1){wr.out("var __local_rest = Array.prototype.slice.call(arguments, "+the_rest_index+")",true)}else{}wr.out("return (",true);wr.indent(1);create_code.call(this,body_of,ctx,wr);wr.out("",true);wr.indent(-1);wr.out(")",true);wr.out("",true);wr.indent(-1);wr.out("}",true);return}if(fc&&fc.vref=="use"){var n=p_node.children[1];ctx.__def(n.vref,n.type);ctx[n.vref]={type:n.type,cnt:0,external:true};return}if(fc&&fc.vref=="fn"){wr.out("(function ");wr.out("(");var args_list=p_node.children[1];args_list.children.forEach(function(a){wr.out(a.vref);ctx.__def(a.vref,a.type);ctx[a.vref]={type:a.type,cnt:0,external:false,param:true}});var body_of=p_node.children[2];wr.out(") {",true);wr.indent(1);wr.out("return (",true);wr.indent(1);create_code.call(this,body_of,ctx,wr);wr.out("",true);wr.indent(-1);wr.out(")",true);wr.out("",true);wr.indent(-1);wr.out("})",true);return}if(fc&&fc.vref){var compiler_fn=LispCompilerExpressions;var fn=compiler_fn[fc.vref];if(fn){var variants=Object.keys(fn);if(variants.length==1){var key1=variants[0];var c_fn=fn[key1];c_fn.call(this,p_node,ctx,wr);return}throw"Can not yet handle multiple signatures"}if(p_node.children.length==1){create_code.call(this,p_node.children[0],ctx,wr);return}var had_spread_operator=false;for(var i=1;i<p_node.children.length;i++){var arg=p_node.children[i];if((typeof arg==="undefined"?"undefined":_typeof(arg))=="object"&&arg.vref=="&"){had_spread_operator=true;continue}}if(had_spread_operator){wr.out(fc.vref+".apply(this, __join( [");for(var i=1;i<p_node.children.length;i++){if(i==1){wr.indent(1)}if(p_node.children.length>3){if(i>1){wr.out(",",true)}}else{if(i>1){wr.out(",")}}var param_value=p_node.children[i];if((typeof param_value==="undefined"?"undefined":_typeof(param_value))=="object"&&param_value.vref=="&"){wr.out("__local_rest");continue}wr.out("");create_code.call(this,p_node.children[i],ctx,wr);wr.out("")}if(i>1){wr.indent(-1)}wr.out("]))",true)}else{if(fc.ns&&fc.ns.length>1){var f_name=fc.ns[1];var obj=ctx[fc.ns[0]];var f_def=obj[f_name];wr.out("__ctx__['"+fc.ns[0]+"']['"+fc.ns[1]+"'](")}else{var f_def=ctx[fc.vref];if(f_def&&f_def.import){wr.out("__ctx__['"+fc.vref+"'](")}else{wr.out(fc.vref+"(")}}for(var i=1;i<p_node.children.length;i++){if(i==1){wr.indent(1)}if(p_node.children.length>3){if(i>1){wr.out(",",true)}}else{if(i>1){wr.out(",")}}wr.out("");create_code.call(this,p_node.children[i],ctx,wr);wr.out("")}if(i>1){wr.indent(-1)}wr.out(")",true)}return}if(p_node.children){var last=p_node.children.length-1;var first_child=p_node.children[0];if(first_child&&first_child.children){var lambda=first_child.children[0];if(lambda&&lambda.vref=="fn"){create_code.call(this,first_child,ctx,wr);for(var i=1;i<p_node.children.length;i++){if(i>1)wr.out(",");wr.out("(");create_code.call(this,p_node.children[i],ctx,wr);wr.out(")")}return}}if(p_node.children.length==1){create_code.call(this,p_node.children[0],ctx,wr);return}p_node.children.forEach(function(n,i){if(i==last){if(is_variable_def(n)){}else{}}create_code.call(this,n,ctx,wr,true,i==last)}.bind(this))}function call_operator(name,p_node){var had_spread_operator=false;for(var i=1;i<p_node.children.length;i++){var arg=p_node.children[i];if((typeof arg==="undefined"?"undefined":_typeof(arg))=="object"&&arg.vref=="&"){had_spread_operator=true;continue}}if(!had_spread_operator){if(name=="inc_operator"){for(var i=1;i<p_node.children.length;i++){if(i>1){wr.out(" + ")}create_code.call(this,p_node.children[i],ctx,wr)}return}}if(had_spread_operator){wr.out(name+".apply(this, __join([")}else{wr.out(name+"(")}for(var i=1;i<p_node.children.length;i++){if(i==1){wr.indent(1)}if(p_node.children.length>3){if(i>1){wr.out(",",true)}}else{if(i>1){wr.out(",")}}var param_value=p_node.children[i];if((typeof param_value==="undefined"?"undefined":_typeof(param_value))=="object"&&param_value.vref=="&"){wr.out("__local_rest");continue}wr.out("");create_code.call(this,p_node.children[i],ctx,wr);wr.out("")}if(i>1){wr.indent(-1)}if(had_spread_operator){wr.out("]))",true)}else{wr.out(")")}}}function collect_methods(node,ctx,classObj){if(is_function_call(node)){var fc=node.children[0];var name=node.children[1];if(fc.vref=="CreateClass"){ctx.__def("class::"+name.vref);var o={name:name.vref};if(node&&node.children){node.children.forEach(function(n){collect_methods(n,ctx,o)})}ctx["class::"+name.vref]=o;return}if(fc.vref=="Constructor"){classObj["Constructor"]={args:node.children[1]}}if(fc.vref=="Extends"){classObj.__extends={node:fc.parent};classObj.__extends.list=fc.parent.children[1].children.map(function(ext,i){return ext.vref})}if(fc.vref=="PublicMethod"){classObj[name.vref]={args:node.children[2]}}}if(node&&node.children){node.children.forEach(function(n){collect_methods(n,ctx,classObj)})}}function push_error(node,err){if(!node.errors){node.errors=[]}node.errors.push(err);if(ctx){ctx.__all_errors__.push({node:node,err:err})}}function get_first_child(node){if(is_object(node)&&node.children)return node.children[0]}function is_object(node){return node&&(typeof node==="undefined"?"undefined":_typeof(node))=="object"}function is_assigment(node){if(is_object(node)){if(is_function_call(node)){}}}function get_node_signature(node){if(node.signature)return node.signature;if(node.type&&!node.type_def&&node.vref&&(!node.children||node.children.length==0)){return node.type}if(is_raw_value(node)){return detect_value_type(node)}if(node.type_def){var def=node.type_def;var call_sig="(_:";var fc=def.children[0];call_sig+=get_node_signature(fc);var args=def.children[1];call_sig+="(";args.children.forEach(function(a,i){if(i>0)call_sig+=" ";call_sig+="_:"+get_node_signature(a)});call_sig+="))";return call_sig}return"_"}function is_defined_function(name,ctx){var r=ctx[name];if(!r){push_error(node,"Undeclared function : "+name);return false}if(!is_function_def(r)){push_error(node,"Undeclared function: "+name);return false}return true}function get_fn_name(node){if(is_function_def(node)){return node.children[1].vref}}function get_fn_type(node){if(is_function_def(node)){return node.children[1].type}}function is_fn_def_valid(node){if(is_function_def(node)){try{var name=get_fn_name(node);if(!name){push_error(node,"Invalid name for a function :"+name)}node.children[2].children.map(function(n){return n.vref});if(node.children.length>4){push_error(node.children[4],"Invalid function definition: function parts after function body are not evaluated")}return true}catch(e){push_error(node,"Invalid function");return false}}return false}function get_fn_body(node){if(is_function_def(node)){try{var body=node.children[3];var fc=body.children[0];return body}catch(e){push_error(node,"Invalid function body")}}}function get_fn_args(node){if(is_function_def(node)){try{return node.children[2].children}catch(e){push_error(node,"Invalid fn args")}}}function is_raw_value(node){if(typeof node=="string")return true;if(!isNaN(node))return true;if(typeof node=="boolean")return true;return false}function is_lambda_function_def(node){var fc=get_first_child(node);if(is_object(fc)&&fc.vref){if(fc.vref=="fn")return true}}function is_function_def(node){var fc=get_first_child(node);if(is_object(fc)&&fc.vref){if(fc.vref=="defn")return true}}function is_single_value_list(node){var fc=get_first_child(node);if(fc){if(is_function_def(node)||is_variable_def(node)||is_function_call(node)){return false}if(node.children&&node.children.length==1){return true}}return false}function is_another_list(node){var fc=get_first_child(node);if(fc){if(is_function_def(node)||is_variable_def(node)||is_function_call(node)){return false}if(node.children&&node.children.length>1){return true}}return false}function is_variable_def(node){var fc=get_first_child(node);if(is_object(fc)&&fc.vref){if(fc.vref=="def")return true;if(fc.vref=="let")return true}}function is_lambda_function_call(node){var fc=get_first_child(node);if(is_object(fc)){if(fc.vref&&node.children.length>1){return false}if(fc.vref=="fn"||fc.vref=="=>")return true}return true}function is_function_call(node){if(is_variable_def(node))return false;if(is_function_def(node))return false;var fc=get_first_child(node);if(is_object(fc)){if(fc.vref&&node.children.length>1){return true}}}if(!_glob["Jinx"])_glob["Jinx"]={};_glob["Jinx"].CompileLispToSwift=start_lisp_to_code})(window);
