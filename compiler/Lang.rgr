language {

    name "Ranger"

    ; ============================================================================
    ; RANGER LANGUAGE DEFINITION FILE
    ; ============================================================================
    ;
    ; This file defines the core language operators and their target-specific
    ; implementations (templates) for each supported compilation target.
    ;
    ; TEMPLATE SYSTEM OVERVIEW
    ; ------------------------
    ; Each operator has a "templates" block with target-specific implementations.
    ; Templates use special commands to generate code:
    ;
    ;   (e N)       - Emit expression at argument position N (1-based)
    ;   (block N)   - Emit a code block at argument position N
    ;   (typeof N)  - Emit the type name of argument N
    ;   nl          - Newline
    ;   I           - Increase indentation
    ;   i           - Decrease indentation
    ;   "string"    - Literal string output
    ;   (imp "x")   - Add import statement for module/header "x"
    ;   (polyfill "location" "code") - Add polyfill code at specified location
    ;   (create_polyfill "code")     - Legacy: add polyfill to "utilities" location
    ;
    ; POLYFILL LOCATIONS
    ; ------------------
    ; The (polyfill "location" "code") command places helper code at these locations:
    ;
    ;   "imports"       - At the very top, with import statements
    ;   "after_imports" - After imports, before class definitions
    ;   "utilities"     - After class definitions (DEFAULT for create_polyfill)
    ;   "file_end"      - At the very end of the file
    ;
    ; Use "after_imports" for global variables that classes depend on.
    ; Polyfills are deduplicated - identical code won't be added twice.
    ;
    ; ============================================================================

    ; compilation targets might be defined here like this
    targets {
        ; short     common name     file extension
        es5         ES5             js 
        es6         JavaScript      js
        java7       Java7           java
        kotlin      Kotlin          kt
        scala       Scala           scala
        cpp         Cpp             cpp
        csharp      CSharp          cs
        swift3      Swift3          swift
        swift6      Swift6          swift
        ts          TypeScript      ts
        flow        Flow            flow
        go          Golang          go
        php         PHP             php
        python      Python          py
        nim         Nim             nim
    }

    toplevel_keywords (class systemclass Constructor fn sfn Import Extend Enum def let operators)
    annotation_keywors (weak strong lives temp)
    
    ; transformations for the reserved words for function names or other keywords
    reserved_words {
        * {
            map FnMap
            forEach forEachItem
            self _self
            func _func
        }
        cpp {
            operator _operator
            static _static
            union _union
            bool _bool
            ref _ref
            class _class
            new _new
            delete _delete
            template _template
            namespace _namespace
            virtual _virtual
            public _public
            private _private
            protected _protected
        }
        go {
            type _type
            range _range
        }
        rust {
            type r#type
            static r#static
            ref r#ref
            union r#union
            bool r#bool
            impl r#impl
        }
        swift3 {
            operator _operator
            static _static
            init _init
        }
        swift6 {
            operator _operator
            static _static
            init _init
        }
        python {
            str _str
            int _int
            float _float
            bool _bool
            list _list
            dict _dict
            set _set
            tuple _tuple
            type _type
            id _id
            len _len
            range _range
            print _print
            input _input
            open _open
            file _file
            filter _filter
            sum _sum
            min _min
            max _max
            abs _abs
            round _round
            sorted _sorted
            reversed _reversed
            enumerate _enumerate
            zip _zip
            any _any
            all _all
            iter _iter
            next _next
            object _object
            bytes _bytes
            complex _complex
            property _property
            classmethod _classmethod
            staticmethod _staticmethod
            super _super
            format _format
            hash _hash
            help _help
            hex _hex
            oct _oct
            bin _bin
            chr _chr
            ord _ord
            repr _repr
            ascii _ascii
            eval _eval
            exec _exec
            compile _compile
            globals _globals
            locals _locals
            vars _vars
            dir _dir
            getattr _getattr
            setattr _setattr
            hasattr _hasattr
            delattr _delattr
            isinstance _isinstance
            issubclass _issubclass
            callable _callable
            slice _slice
            frozenset _frozenset
            memoryview _memoryview
            bytearray _bytearray
        }
    }

    
    commands {

        random        _:double () {
            templates {
                es6 ('Math.random()')
            }
        }

        cast _:S  (arg:T target@(noeval):S) {
            templates {
                ranger ("(cast " (e 1) " " (e 2) ":" (typeof 2) " )")
                ts ( (e 1) " as " (typeof 2) )
                es6 ( (e 1) )
                java7 ( "((" (typeof 2) ")" (e 1) ")" )
                swift3 ( (e 1) " as " (typeof 2) "" )
                cpp ( "mpark::get<" (typeof 2) ">(" (e 1) ")" 
                
                    (plugin 'makefile' ((dep 'variant.hpp' 'https://github.com/mpark/variant/releases/download/v1.2.2/variant.hpp')))            
                )
                go ( (e 1) ".(" (typeof 2) ")" )
                php ( (e 1) )
            }
        }        

        random        _:int ( min:int max:int) {
            templates {
                es6 ('Math.floor(Math.random()*(' (e 2) ' - ' (e 1)' + 1) + ' (e 1)')')
            }
        }
        

        if_javascript _:void ( code:block ) @doc('run this code only in JavaScript') {
            templates {
                es6 ( (block 1))
                * ()
            }
        }

        if_go _:void ( code:block ) @doc('run this code only for Golang target') {
            templates {
                go ( (block 1))
                * ()
            }
        }

        if_java _:void ( code:block ) @doc('run this code only for Java target') {
            templates {
                java7 ( (block 1))
                * ()
            }
        }

        if_swift _:void ( code:block ) @doc('run this code only for Swift target') {
            templates {
                swift3 ( (block 1))
                * ()
            }
        }

        if_php _:void ( code:block ) @doc('run this code only for PHP target') {
            templates {
                php ( (block 1))
                * ()
            }
        }

        if_cpp _:void ( code:block ) @doc('run this code only for C++ target') {
            templates {
                cpp ( (block 1))
                * ()
            }
        }

        if_csharp _:void ( code:block ) @doc('run this code only for C# target') {
            templates {
                csharp ( (block 1))
                * ()
            }
        }

        if_scala _:void ( code:block ) @doc('run this code only for Scala target') {
            templates {
                scala ( (block 1))
                * ()
            }
        }

        has _:boolean (str:string) @doc('If string value is greater than > 0') {
            templates {
                * @macro(true) ('( (strlen ' (e 1) ') > 0 )')
            }
        }

        ; compiler options...
        has_option _:boolean ( name:string ) {
            templates {
                * @macro(true) ( "((strlen \"" (optional_option 1)  "\" ) > 0)")
            }
            doc "Returns true if compiler setting `name` has been enabled"
        }
        get_option _:string ( name:string ) {
            templates {
                * @macro(true) ( "\"" (optional_option 1)  "\"")
            }
            doc "Returns compiler setting `name`"
        }
        get_required_option _:string ( n:string ) {
            templates {
                * @macro(true) ( "\"" (required_option 1)  "\"")
            }
        }

        sha256 _:string (input:string) {
            templates {
                ranger ( "(sha256 " (e 1) ")")
                es6 ("require('crypto').createHash('sha256').update(" (e 1) ").digest('hex')")
                cpp ( "picosha2::hash256_hex_string(" (e 1) ")"
                    (imp "\"picosha2.h\"")
                    (install_file "picosha2.h")
                    (plugin 'makefile' (  (dep 'picosha2.h' 'https://github.com/okdshin/PicoSHA2/blob/master/picosha2.h'  ) ) )                    
                )
; fmt.Printf("sha256:\t%x\n", sha_256.Sum(nil))
                go ( "_r_md5(" (e 1) ")" 
    (create_polyfill
"
func _r_md5(value string) string {
	h := sha256.Sum256([]byte(value))
	return fmt.Sprintf(\"%x\", h[:])
}
"    
    )            
                (imp "crypto/sha256") (imp "fmt")) 
                php( "hash('sha256', " (e 1) ")")
            }
        }

        md5 _:string (input:string) {
            templates {
                ranger ( "(md5 " (e 1) ")")
                es6 ("require('crypto').createHash('md5').update(" (e 1) ").digest('hex')")
            }
        }
        
        nullify   _:void (ptr@(optional):T) @doc('Clears the optional value to empty state') {
            templates {
                ranger ( "(nullify " (e 1) ")")
                es6 ( (e 1) " = undefined;" nl)
                java7 ( (e 1) " = null;" nl)
                cpp ( (e 1) "= NULL;" nl)
                go ( (e 1) " = nil;" nl )
                php ( 'unset(' (e 1) ');' nl)
            }
        }

        ; immutable operators, maybe used by the compiler...
        ; https://github.com/Workiva/go-datastructures
        create_immutable_array _@(immutable):[T] () {
            templates {
                es6 ("require('immutable').List() /** imm **/")
                go ("seq.NewList()")
            }
        }
        create_immutable_hash _@(immutable):[K:T] () {
            templates {
                es6 ("require('immutable').Map()")
                go ("seq.NewHashMap()")
            }
        }

        M_PI mathPi:double () {
            templates {
                es6 ("Math.PI")
                go ( "math.Pi" (imp "math"))                                
                swift3 ( "Double.pi" (imp "Foundation"))   
                java7 ( "Math.PI" (imp "java.lang.Math"))         
                php ("pi()")        
                cpp ("M_PI" (imp "<math.h>"))               
            }
        }

        fabs fabs:double ( v:double ) {
            templates {
                es6 ("Math.abs(" (e 1) ")")
                go ( "math.Abs(" (e 1) ")" (imp "math"))                                
                swift3 ( "abs(" (e 1) ")" (imp "Foundation"))   
                java7 ( "Math.abs(" (e 1) ")" (imp "java.lang.Math"))       
                php ( "abs(" (e 1) ")")      
                cpp ("fabs(" (e 1) ")" (imp "<cmath>"))                       
            }
        }
        tan tan:double ( v:double ) {
            templates {
                es6 ("Math.tan(" (e 1) ")")
                go ( "math.Tan(" (e 1) ")" (imp "math"))                                
                swift3 ( "tan(" (e 1) ")" (imp "Foundation"))   
                java7 ( "Math.tan(" (e 1) ")" (imp "java.lang.Math"))     
                php ( "tan(" (e 1) ")")     
                cpp ("tan(" (e 1) ")" (imp "<math.h>"))                          
            }
        }

        golang_wait waiter:void (seconds:double ) {
            templates {
                go ( "time.Sleep(time.Duration(" (e 1) " * float64(time.Second) )) " (imp "time") )
                * ()
            }
        }

        wait cmdWait:void ( seconds:double ) {
            templates {
                es6 ( "" )
                * ()
            }
        }

        wait cmdWait:void ( seconds:double after:block) {
            templates {
                es6 ( "setTimeout( () => { " nl I (block 2) i nl " }, 1000 * " (e 1) ")" )
                go ( "go func() {" nl I "time.Sleep(time.Duration(" (e 1) " * float64(time.Second) )) " nl (block 2) i nl "}()" nl (imp "time") )
                cpp ( "std::this_thread::sleep_for(std::chrono::milliseconds((int)(" (e 1) " * 1000)));" nl (block 2) nl (imp "<chrono>" ) (imp "<thread>" ) )
                php ( "sleep(" (e 1) ");" nl (block 2) nl )
                swift3 ( "usleep(UInt32(1000000*" (e 1) "));" nl (block 2) nl )
                java7 (

    "new Thread() {" nl I
        "@Override" nl
        "public void run() {" nl I
            "try {" nl I
                "Thread.sleep( (long) (1000 *" (e 1) "));" nl
                "getActivity().runOnUiThread(new Runnable(){" nl
                    "@Override" nl
                    "public void run() {" nl I                    
                        (block 2)
                    nl i "}"
                    nl i 
                "});"
                nl i
            "} catch (Exception e) {" nl I
                "System.err.println(e);" nl i
            "}" nl i
        "}" nl i
    "}.start();" nl

                )
            }
        }
        

        ; Profiling
        timer           cmdTimerBlock:void (name:string code:block) {
            templates {
                ; start := time.Now()
                go ( (defvar _start:int) "for {" nl I nl (varname _start) " := time.Now()" nl (block 2) nl "fmt.Println(" (e 1) ", time.Since(" (varname _start) ") )" nl "break;" i nl "}" (imp "time") (imp "fmt") )
                swift3 ( "do {" nl I nl "let _start = CFAbsoluteTimeGetCurrent()" nl (block 2) nl "print(" (e 1) ", CFAbsoluteTimeGetCurrent() - _start )" i nl "}" (imp "CoreFoundation") )
                es6 ( "console.time(" (e 1) ");" nl (block 2) nl "console.timeEnd(" (e 1) ");" )
                php ( nl "$time_start = microtime(true);" nl (block 2) nl "$time_end = microtime(true);" nl "echo(" (e 1) ".($time_end - $time_start).\"\\n\");" nl)
                java7 (
                    nl "long startTime = System.nanoTime();" nl
                    (block 2 )
                    nl "long elapsedTime = System.nanoTime() - startTime;" nl
                    nl "System.out.println( " (e 1) "+ String.valueOf((double)elapsedTime / 1000000000.0));" nl 
                )
                ranger ( nl "timer " (e 1) " {" nl I (block 2) i nl "}" nl)
                cpp ( ( imp "<ctime>" )
                    nl "std::clock_t __begin = std::clock();" nl
                    (block 2)
                    nl "std::clock_t __end = std::clock();"       
                    nl "std::cout << " (e 1) " << \" : \" << ( double(__end - __begin) / CLOCKS_PER_SEC ) << std::endl;" nl          
                )
                * ( (block 2) )
            }
        }

        env_var cmdEnvVar@(optional):string ( name:string ) {
            templates {
                php ("getenv(" (e 1) ") === FALSE ? NULL : getenv(" (e 1) ")" )
                go (
        "r_io_get_env(" (e 1) ")"
        (imp "os") 
(create_polyfill "
// polyfill for reading environment variable
func r_io_get_env( name string) *GoNullable {
   res := new(GoNullable);
   value := os.Getenv(name)
   if len(value) > 0 {
     res.has_value = true
     res.value = value
   } else {
     res.has_value = false
   }
   return res 
}
")
    )
                es6 ("process.env[" (e 1) "]")
                cpp ( "std::getenv(" (e 1) ".c_str()) ? std::string(std::getenv(" (e 1) ".c_str())) : std::string(\"\")" (imp "<cstdlib>") )
                ; * ("/* environment variable reading not implemented */")
            }
        }   

        ; Command line arguments
        shell_arg             cmdArg:string (index:int) {
            templates {
                cpp ( "std::string(__g_argv[" (e 1) " + 1])")
                php ( "$argv[" (e 1) " + 1]" )
                java7 ( "args[" (e 1) "]")
                csharp ('Environment.GetCommandLineArgs()[' (e 1) ' + 1]' (imp "System"))
                go ( "os.Args[" (e 1) " + 1]"  (imp "os"))
                swift3 ("CommandLine.arguments[" (e 1) " + 1]")
                swift6 ("CommandLine.arguments[" (e 1) " + 1]")
                es6 ( "process.argv[ 2 + " (e 1) "]")
                rust ( "std::env::args().nth((" (e 1) " + 1) as usize).unwrap_or_default()")
                ranger ("( shell_arg " (e 1) " )")
            }
        }

        shell_arg_cnt         cmdArg:int () @doc("return the number of arguments for command line utility") {
            templates {
                cpp ( "__g_argc - 1")
                swift3 ("CommandLine.arguments.count - 1")
                swift6 ("CommandLine.arguments.count - 1")
                csharp ('Environment.GetCommandLineArgs().Length - 1' (imp "System"))                
                php ( "(count($argv) - 1)" )
                java7 ( "args.length")
                go ( "int64( len( os.Args) - 1 )"  (imp "os"))
                es6 ( "(process.argv.length - 2)" )
                rust ( "(std::env::args().len() as i64 - 1)")
                ranger ("( shell_arg_cnt )")
            }
        }        

        ; I/O
        normalize cmdArg:string ( arg:string ) {
            templates {
                es6 ( 'require("path").normalize(' (e 1) ')')
                ranger ("( normalize " (e 1) " )")
                * ( "\"./\"")
            }
        }   

        path_dirname cmdArg:string ( arg:string ) {
            templates {
                es6 ( 'require("path").dirname(' (e 1) ')')
                ranger ("( path_dirname " (e 1) " )")
                * ( "\"./\"")
            }
        }   

        install_directory         cmdArg:string () {
            templates {
                es6 ( "__dirname" )
                ranger ("( install_directory )")
                * ( "\"./\"")
            }
        }   

        current_directory         cmdArg:string () {
            templates {
                es6 ( "process.cwd()" )
                csharp( "Directory.GetCurrentDirectory()" (imp "System") (imp "System.IO"))
                ranger ("( current_directory )")
                cpp ( "__cpp_curr_dir()"
(imp "<stdio.h>")
(create_polyfill
"

#ifdef _MSC_VER
    #include <direct.h>
    #define __RGetCurrentDir _getcwd
#else
    #include <unistd.h>
    #define __RGetCurrentDir getcwd
#endif

std::string __cpp_curr_dir() {
    char cCurrentPath[FILENAME_MAX];
    if (!__RGetCurrentDir(cCurrentPath, sizeof(cCurrentPath)))
        {
            return \"\";
        }
    cCurrentPath[sizeof(cCurrentPath) - 1] = '\\0';
    std::string result(cCurrentPath);
    return result;
}
"
)

                )
                * ( "\".\"")
            }
        }               

        file_exists          cmdIsDir:boolean (path:string filename:string) {
            templates {
                cpp ( "r_cpp_file_exists( " (e 1) " + std::string(\"/\") + " (e 2) ")" (imp "<sys/stat.h>") (imp "<string>")
(create_polyfill "
bool r_cpp_file_exists(std::string name) 
{
  struct stat buffer;
  return (stat (name.c_str(), &buffer) == 0);
}    
    ") )
                swift3 ( "r_file_exists(fileName:" (e 1) " + \"/\" + " (e 2) " )" 

(create_polyfill "
func r_file_exists ( fileName:String ) -> Bool {
    let fileManager = FileManager.default
    var isDir : ObjCBool = false
    if fileManager.fileExists(atPath: fileName, isDirectory:&isDir) {
        if isDir.boolValue {
            return false
        } else {
            return true
        }
    } else {
        return false
    }    
}
    ")                    
                )
                es6 ("require(\"fs\").existsSync(" (e 1) " + \"/\" + " (e 2) " )")
                ranger ("( file_exists " (e 1) " + \"/\" + " (e 2) "  )")
                java7 ( "new File(" (e 1) " + '/' + " (e 2) ").exists()" (imp "java.io.File") )
                php ( "file_exists(" (e 1) ".'/'." (e 2) ")" )
                go ( "r_file_exists(" (e 1) ", " (e 2) ")"
(create_polyfill
"
func r_file_exists(pathName string, fileName string) bool {
    if _, err := os.Stat(pathName + \"/\" + fileName); os.IsNotExist(err) {
        return false
    }
    return true
}
"
)                    
                )
                rust ( "std::path::Path::new(&format!(\"{}/{}\", " (e 1) ", " (e 2) ")).exists()" )
           }
        }

        dir_exists          cmdIsDir:boolean (path:string) {
            templates {
                csharp ( "false /* dir_exists not implemented */ ")
                scala ( "false /* dir_exists not implemented */ ")
                swift3 ( "r_dir_exists( dirName: " (e 1) ")" 

(create_polyfill "
func r_dir_exists ( dirName:String ) -> Bool {
    let fileManager = FileManager.default
    var isDir : ObjCBool = false
    if fileManager.fileExists(atPath: dirName, isDirectory:&isDir) {
        if isDir.boolValue {
            return true
        } else {
            return false
        }
    } else {
        return false
    }    
}
    ")                    
                )
                cpp ( "r_cpp_dir_exists( " (e 1) " )" (imp "<sys/stat.h>") (imp "<string>")
(create_polyfill "
bool  r_cpp_dir_exists(std::string name) 
{
  struct stat buffer;
  return (stat (name.c_str(), &buffer) == 0);
}    
    ") )                 
                java7 ( "new File(" (e 1) ").exists()" (imp "java.io.File") )
                es6 ("require(\"fs\").existsSync( " (e 1) " )")
                ranger ("( dir_exists " (e 1) " )")
                php ( "is_dir(" (e 1) ")" )
                go ( "r_dir_exists(" (e 1) ")"
(create_polyfill
"
func r_dir_exists(pathName string) bool {
    if _, err := os.Stat(pathName); os.IsNotExist(err) {
        return false
    }
    return true
}
"
)                    
                )                        
           }
        }

        ; Returns the file modification time as Unix timestamp (seconds since epoch)
        file_mtime          cmdFileMTime:int (path:string filename:string) {
            templates {
                go ( "r_file_mtime(" (e 1) ", " (e 2) ")"
(create_polyfill
"
func r_file_mtime(pathName string, fileName string) int64 {
    info, err := os.Stat(pathName + \"/\" + fileName)
    if err != nil {
        return 0
    }
    return info.ModTime().Unix()
}
"
)                    
                )
                es6 ( "require('fs').statSync(" (e 1) " + '/' + " (e 2) ").mtimeMs" )
                ranger ( "(file_mtime " (e 1) " " (e 2) ")" )
           }
        }

        create_dir          cmdCreateDir:void (path:string) {
            templates {
                scala ( "/* create_dir not implemented */ ")
                csharp ( "/* create_dir not implemented */ ")

                cpp ( "r_cpp_create_dir( " (e 1) " );" nl (imp "<sys/stat.h>") (imp "<sys/types.h>") (imp "<string>")
(create_polyfill "
void  r_cpp_create_dir(std::string name) 
{
  mkdir( name.c_str(), S_IRWXU | S_IRWXG | S_IROTH | S_IXOTH );
}    
    ") )
                swift3 ( nl )        
                php (  nl "mkdir(" (e 1) ");" nl )
                es6 ("require(\"fs\").mkdirSync( " (e 1) ")")
                go ( nl "_ = os.Mkdir( " (e 1 ) " , os.ModePerm)" nl (imp "os") )

                ranger ( nl "create_dir " (e 1) nl)
                java7 ( nl "createDir(" (e 1) ");" nl  
                    (imp "java.io.File")
(create_polyfill "
static void createDir(String path) 
{
    try{
        File theDir = new File(path);
        if (!theDir.exists()) {
            theDir.mkdir();
        }
    } catch(SecurityException se) {

    }
}    
    ") )    

           }
        }
; try text.write(to: path, atomically: false, encoding: String.Encoding.utf8)
        write_file          cmdWriteFile:void (path:string file:string data:string) {
            templates {
                scala ( "/* write_file not implemented */ ")
                csharp ( "/* write_file not implemented */ ")

                swift3 ("r_write_file(dirName: " (e 1) " + \"/\" + " (e 2) ", dataToWrite: " (e 3) ") " 

(create_polyfill "
func r_write_file ( dirName:String, dataToWrite:String ) {
    do {
        let fileManager = FileManager.default
        let url = NSURL(fileURLWithPath: fileManager.currentDirectoryPath)
        let path = url.appendingPathComponent(dirName)
        try dataToWrite.write(to:path!, atomically: false, encoding: String.Encoding.utf8)
    } catch {

    }
}
    ")                  
                
                ) 
                swift6 ("r_write_file(dirName: " (e 1) " + \"/\" + " (e 2) ", dataToWrite: " (e 3) ") " 
                    (imp "Foundation")
(create_polyfill "
func r_write_file ( dirName:String, dataToWrite:String ) {
    do {
        let fileManager = FileManager.default
        let url = URL(fileURLWithPath: fileManager.currentDirectoryPath)
        let path = url.appendingPathComponent(dirName)
        try dataToWrite.write(to:path, atomically: false, encoding: .utf8)
    } catch {

    }
}
    ")                  
                
                ) 
                cpp_old ( nl "/* write file not yet implemented */" nl)

                cpp ( "r_cpp_write_file( " (e 1) " , " (e 2) " , " (e 3) "  );" nl (imp "<iostream>") (imp "<string>") (imp "<fstream>")
(create_polyfill "
void  r_cpp_write_file(std::string path, std::string filename, std::string text) 
{
  std::ofstream outputFile;
  outputFile.open(path + \"/\" + filename);
  outputFile << text;
  outputFile.close();
}    
    ") )                
                ranger ( nl "write_file " (e 1) " " (e 2) " " (e 3) nl)
                es6 ("require(\"fs\").writeFileSync( " 
                        (e 1) " + \"/\"  + " (e 2) ", " (e 3) ")")

                php (  nl "file_put_contents(" (e 1) ".'/'." (e 2) " , " (e 3) ");" nl )


                java7 ( nl "writeFile(" (e 1) " + \"/\" + " (e 2) " , " (e 3)" );" nl  
                    (imp "java.io.PrintWriter")
(create_polyfill "
static void writeFile(String path, String text) 
{
    try{
        PrintWriter out = new PrintWriter( path);
        out.print( text );
        out.close();
    } catch ( FileNotFoundException e) {

    }
}    
    ") )                        
                        

                go ( "r_write_text_file(" (e 1) ", " (e 2) ", " (e 3) ")"
                     (imp "os")
(create_polyfill
"
func r_write_text_file(pathName string, fileName string, txtData string)  {
    f, e := os.Create(pathName + \"/\" + fileName)
    if e != nil {
        panic(e)
    }
    defer f.Close()

    _ , err := f.WriteString(txtData)
    if err != nil {
        panic(err)
    }
    f.Sync()
}
"
) )  

                rust ( "r_write_file(&" (e 1) ", &" (e 2) ", &" (e 3) ");" nl
(create_polyfill "
fn r_write_file(path: &str, filename: &str, data: &str) {
    let full_path = format!(\"{}/{}\", path, filename);
    let _ = std::fs::write(full_path, data);
}
"))

            }
        }

        async_read_file  _@(optional async):string (path:string filename:string) {
            templates {
                es6 @flags('typescript') ( "await (new Promise<string>(resolve => { require('fs').readFile( " (e 1) " + '/' + " (e 2) " , 'utf8', (err,data)=>{ resolve(data) }) } ))" )
                es6 ( "await (new Promise(resolve => { require('fs').readFile( " (e 1) " + '/' + " (e 2) " , 'utf8', (err,data)=>{ resolve(data) }) } ))" )
            }
        }

        read_file        cmdReadFile@(optional async):string (path:string filename:string) {

            templates {
                ts ( "await (new Promise<string>(resolve => { require('fs').readFile( " (e 1) " + '/' + " (e 2) " , 'utf8', (err,data)=>{ resolve(data) }) } ))" )
                es6 ( "await (new Promise(resolve => { require('fs').readFile( " (e 1) " + '/' + " (e 2) " , 'utf8', (err,data)=>{ resolve(data) }) } ))" )
                ranger (  "(read_file " (e 1) " " (e 2) ")" )
                cpp ( "r_cpp_readFile( " (e 1) " , " (e 2) ")" (imp "<fstream>")
(create_polyfill "
std::string  r_cpp_readFile(std::string path, std::string filename) 
{
  std::ifstream ifs(path + \"/\" + filename);
  std::string content( (std::istreambuf_iterator<char>(ifs) ),
                       (std::istreambuf_iterator<char>()    ) );
  return content;
}    
    ")                        
            
                )
                php ("file_get_contents(" (e 1) " . \"/\" . " (e 2) ") " )
                swift3 ("r_read_file(dirName: " (e 1) " + \"/\" + " (e 2) ") " 
(create_polyfill "
func r_read_file ( dirName:String ) -> String? {
    let res: String?
    do {
        res = try String(contentsOfFile:dirName)
    } catch {
        res = nil
    }
    return res
}
    ")                                  
                )
                swift6 ("r_read_file(dirName: " (e 1) " + \"/\" + " (e 2) ") " 
                    (imp "Foundation")
(create_polyfill "
func r_read_file ( dirName:String ) -> String? {
    let res: String?
    do {
        res = try String(contentsOfFile:dirName, encoding: .utf8)
    } catch let error {
        print(\"Error reading file: \\(dirName)\")
        print(\"Error: \\(error.localizedDescription)\")
        res = nil
    }
    return res
}
    ")                                  
                )
                java7 ( "readFile(" (e 1) " + \"/\" + " (e 2) " , StandardCharsets.UTF_8 )"  
                    (imp "java.nio.file.Paths") 
                    (imp "java.io.File")
                    (imp "java.nio.file.Files") 
                    (imp 'java.io.IOException')
                    (imp "java.nio.charset.Charset")
                    (imp "java.nio.charset.StandardCharsets")
(create_polyfill "
static String readFile(String path, Charset encoding) 
{
  try {
    byte[] encoded = Files.readAllBytes(Paths.get(path));
    return new String(encoded, encoding);
  } catch(IOException e) { 
    return \"\";
  }
}    
    ")                        
                        
                        )
                scala ( "Try(Source.fromFile(" (e 1) " + \"/\" + " (e 2) ").getLines.mkString).toOption" (imp "scala.io.Source") (imp "scala.util.Try"))
                go (  "r_io_read_file(" (e 1) ", " (e 2) ")" (imp "io/ioutil")
(create_polyfill "

// polyfill for reading files
func r_io_read_file( path string , fileName string ) *GoNullable {
   res := new(GoNullable);
   if v, err := ioutil.ReadFile(path + \"/\" + fileName); err == nil {
     res.has_value = true
     res.value = string(v)
   } else {
     res.has_value = false
   }
   return res 
}
"))
                rust ( "r_read_file(&" (e 1) ", &" (e 2) ")"
(create_polyfill "
fn r_read_file(path: &str, filename: &str) -> Option<String> {
    let full_path = format!(\"{}/{}\", path, filename);
    std::fs::read_to_string(full_path).ok()
}
"))
                es6 ( "(require('fs').readFileSync( " (e 1) " + '/' + " (e 2) " , 'utf8'))" )
            }
        }

        =               cmdAssign@(moves@( 2 1 ) ):void            ( immutable_left@(immutable):T immutable_right@(immutable):T )  { 
            templates { 
                ranger ( nl (e 1) " = " (e 2) nl )  
                scala ( nl (e 1) " = " (e 2)   nl )   
                go ( (custom _ ) )   
                rust ( (custom _) )           
                * ( nl (e 1) " = " (e 2) ";" nl ) 
            } 
        }   
        
        =               cmdAssign@(moves@( 2 1 ) ):void            ( left:T right:T )  { 
            templates { 
                ranger ( nl (e 1) " = " (e 2) nl )  
                scala ( nl (e 1) " = " (e 2) nl )   
                go ( (custom _ ) )      
                rust ( (custom _) )        
                * ( nl (e 1) " = " (e 2) ";" nl ) 
            } 
        }   

      


        =               cmdAssign@(moves@( 2 1 ) ):void            ( left@(optional):T right:T )  { 
            templates { 
                ranger ( nl (e 1) " = " (e 2) nl ) 
                scala ( nl (e 1) " = Some(" (e 2) ")" nl )  
                swift ( nl (e 1) " = Optional(" (e 2) ");" nl )   
                java7 ( nl (e 1) " = " (e 2) ";" nl )   
                go ( nl (goset 1) ".value = " (e 2) ";" nl nl (goset 1) ".has_value = true; /* detected as non-optional */" nl )  
                cpp ( nl ( e 1) "  = " (e 2) ";" nl )
                rust ( (custom _) )
                * ( nl (e 1) " = " (e 2) ";" nl ) 
            } 
        }           

        =               cmdAssign@(moves@( 2 1 ) ):void            ( left@(optional):T right@(optional):T )  { 
            templates { 
                ranger ( nl (e 1) " = " (e 2) nl ) 
                scala ( nl (e 1) " = " (e 2) nl )      
                go ( nl (goset 1) ".value = " (e 2) ".value;" nl nl (goset 1) ".has_value = false; " nl 
                    "if " (goset 1) ".value != nil {" nl I (goset 1) ".has_value = true" nl i "}" nl
                    )  
                cpp ( nl ( e 1) "  = " (e 2) ";" nl )   
                java7 ( nl (e 1) " = " (e 2) ";" nl )
                rust ( (custom _) )
                * ( nl (e 1) " = " (e 2) ";" nl ) 
            } 
        }  

        empty       cmdEmpty@(optional):T        ( node@(ignore):T ) {
            templates {
                scala ( "Option.empty[(" (e 1) ")" )
                swift3 (  "nil" )
                csharp ( "(" (typeof 1) "?)" (e 1)  )
                cpp ( (e 1) )
                java7 ( "Optional.of(" (e 1 ) ")")
                go ( (e 1 ) )
                * ( "undefined")
            }
        }

        wrap       cmdWrap@(optional):T        ( arg:T ) {
            templates {
                ranger ( "( wrap " (e 1) ")" ) 
                scala ( "Some(" (e 1) ")" )
                swift3 (  "Optional(" (e 1) ")" )
                csharp ( "(" (typeof 1) "?)" (e 1)  )
                cpp ( (e 1) )
                java7 ( (e 1 ))
                go ( (e 1 ) )
                php ( (e 1 ) )
                * ( (e 1) )
            }
        }

        !       _:boolean        ( arg:boolean ) {
            templates {
                * @macro(true) (`(false == (` (e 1)`))`)
            }
        }


        !!       cmdUnwrap:T        ( arg@(optional):T ) {
            templates {
                ranger ( "( unwrap " (e 1) ")" )
                scala ( (e 1) ".get" )
                csharp ( (e 1) ".Value" )
                java7 ( (e 1) ".get()" )
                rust ( (e 1) ".unwrap()" )
                php ( (e 1 ) )
                kotlin ( (e 1) "!!" )
                swift3 ( (e 1) "!" )
                swift6 ( (e 1) "!" )
                go ( (e 1) ".value.(" (typeof 1) ")" )
                cpp ( (e 1) )

                * ( (e 1) )
            }
        }        

        unwrap       cmdUnwrap:int        ( arg@(optional):int ) {
            templates {
                cpp ( "/*unwrap int*/" (e 1) ".value" )
            }
        } 
        unwrap       cmdUnwrap:double        ( arg@(optional):double ) {
            templates {
                cpp ( "/*unwrap dbl*/" (e 1) ".value" )
            }
        }        

        unwrap       cmdUnwrap:T        ( arg@(optional):T ) {
            templates {
                ranger ( "( unwrap " (e 1) ")" )
                scala ( (e 1) ".get" )
                csharp ( (e 1) )
                java7 ( (e 1) )
                rust ( (custom _) )
                php ( (e 1 ) )
                kotlin ( (e 1) "!!" )
                swift3 ( (e 1) "!" )
                swift6 ( (e 1) "!" )
                go ( (e 1) ".value.(" (typeof 1) ")" )
                cpp ( (e 1) )

                * ( (e 1) )
            }
        }



        ; TODO: could be varname@(mutable), but the compiler may not be able to determine the
        ; mutability before the code has been processed through... 

        def             cmdDef:void            ( varname:[T] )  { 
            templates { 
                * ( nl "var " (nameof 1) " = [];" nl )
            } 
        }     

        def             cmdDef:void            ( varname:[K:T] )  { 
            templates { 
                * ( nl "var " (nameof 1) " = {};" nl )
            } 
        }     


        def             cmdDef:void            ( varname:T )  { 
            templates { 
                scala@(mutable) ( nl "var " (e 1) ":" (typeof 1 ) " /* mutable uninitialized value */" nl ) 
                scala ( nl "val " (e 1) ":" (typeof 1 ) " /* immutable uninitialized value */" nl )    
                java7 (nl (typeof 1) " " (e 1) ";" nl)             
                es6@(mutable) ( nl "let " (e 1) ";" nl ) 
                es5@(mutable) ( nl "var " (e 1) ";" nl ) 
                * ( nl "const " (e 1) ";" nl ) 
            } 
        }      

        def             cmdDef:void            ( varname:T value:T )  { 
            templates { 
                scala@(mutable) ( nl "var " (e 1) ":" (typeof 1 )" = " (e 2) " /* mutable value */" nl ) 
                scala ( nl "val " (e 1) ":" (typeof 1 )" = " (e 2) " /* immutable value */" nl ) 
                java7 (nl (typeof 1) " " (e 1) " = " (e 2) ";" nl)
                es6@(mutable) ( nl "let " (e 1) " = " (e 2) ";" nl )
                es6 ( nl "const " (e 1) " = " (e 2) ";" nl )
                * ( nl "var " (e 1) " = " (e 2) ";" nl )
            } 
        }     
        def             cmdDef:void            ( varname@(mutable):T value:T )  { 
            templates { 
                scala( nl "var " (e 1) ":" (typeof 1 )" = " (e 2) " /* mutable def value */" nl ) 
                java7 (nl (typeof 1) " " (e 1) " = " (e 2) ";" nl)
                es6 ( nl "let " (e 1) " = " (e 2) ";" nl )
                * ( nl "var " (e 1) " = " (e 2) ";" nl )
            } 
        }      
        
        return  cmdReturn@(returns@(1)):void          ( value:T ) {
            templates {
                go ( (custom _) )
            }
        }

        return  cmdReturn@(optional returns@(1)):void          ( value@(optional):T ) {
            templates {
                java7 ( (custom _) )
                scala( (custom _) )
                rust ( (custom _) )
                ranger ( nl "return " (e 1) nl ) 
                go ( (custom _) )
                * ( "return " (ifa 1 ";") (e 1) (eif _) ";" )
            }
        }        
                
        return  cmdReturn@(returns@(1)):void          ( value:T ) {
            templates {
                ranger ( nl "return " (e 1) nl ) 
                scala( (custom _ ) )
                rust ( (custom _) )
                go ( (custom _) )
                * ( "return " (ifa 1 ";") (e 1) (eif _) ";" )
            }
        }       

        return  cmdReturn@(returns):void          ( ) {
            templates {
                cpp ( (custom _ ) )
                scala ( (custon _) )
                ranger ( nl "return" nl ) 
                go ( (custom _) )
                * ( "return;" )
            }
        }        
         

        =               cmdAssign:void            ( left@(optional):T right:T )  { 
            templates {
                ranger ( nl (e 1) " = " (e 2) nl ) 
                scala ( nl (e 1) " = Some(" (e 2) " ) " nl )
                rust ( (custom _) )
                * ( nl (e 1) " = " (e 2) ";" nl ) 
            } 
        }      

        =               cmdAssign:void            ( left:T right@(optional):T )  { 
            templates {
                ranger ( nl (e 1) " = " (e 2) nl ) 
                swift3 (  nl (e 1) " = Optional(" (e 2) ")" )
                rust ( (custom _) )
                scala ( nl (e 1) " = " (e 2) ".get /* scala optional assigment of values * / " nl )                 
                * ( nl (e 1) " = " (e 2) ";" nl ) 
            } 
        }      

        =               cmdAssign:void            ( left@(optional):T right@(optional):T )  { 
            templates {
                ranger ( nl (e 1) " = " (e 2) nl ) 
                scala ( nl (e 1) " = " (e 2) " /* scala optional assigment of values * / " nl )
                rust ( (custom _) )
                * ( nl (e 1) " = " (e 2) ";" nl ) 
            } 
        }      
        

        ; numeric - operations
        -               cmdMinusOp:double            ( left:double right:double )  { templates { * ( (e 1) " - " (e 2) ) } }      
        -               cmdMinusOp:int            ( left:int right:int )  { templates { * ( (e 1) " - " (e 2) ) } }      

        ; numeric + operations
        +               cmdPlusOp:double             ( left:double right:double ) { templates { * ( (e 1) " + " (e 2) ) } }

        ; random tests, remove these later:
        +               cmdUnwrappingPlusOp:int                ( left:int right@(optional):int ) {
                        
            code {
                return left + (unwrap right)
            }

        }

        +               cmdPlusOp:int                ( left:int right@(optional):int ) { 
            templates { * ( (e 1) " + " (e 2) "? /* optional add*/" ) } 
        }
        
        +               cmdPlusOp:int                ( left@(mutable):int right@(optional):int ) { 
            templates { * ( (e 1) " + " (e 2) "? /* optional add*/" ) } 
        }
        +               cmdPlusOp:int                ( left@(mutable):int right:int ) { templates { * ( (e 1) " + " (e 2)  ) } }
        +               cmdPlusOp:int                ( left@(mutable):int right:int ) { templates { * ( (e 1) " + " (e 2)  ) } }

        ; random tests end
        +               cmdPlusOp:int                ( left:int right:int ) { templates { * ( (e 1) " + " (e 2)  ) } }

        ; string + operations
        +               cmdPlusOp:string             ( left:string right:enum ) { 
            templates { 
                    go ( "strings.Join([]string{ " (e 1) ",strconv.FormatInt(" (e 2) ", 10) }, \"\")" (imp "strings") (imp "strconv"))
                    swift3 ( (e 1) " + String(" (e 2)")" )
                    swift6 ( (e 1) " + String(" (e 2)")" )
                    rust ( "[" (e 1) " , (" (e 2)".to_string()) ].join(\"\")" )
                    php ( (e 1) " . " (e 2) ) 
                    cpp ( (e 1 ) " + std::to_string(" (e 2) ")")
                    * ( (e 1) " + " (e 2) ) 
                } 
            }

        +               cmdPlusOp:string             ( left:string right:string ) { 
            templates { 
                go ( (e 1) " + " (e 2) ) 
                go.v2 ( "strings.Join([]string{ " (e 1) "," (e 2) " }, \"\")" (imp "strings"))
                php ( (e 1) " . " (e 2) )
                rust ( "[&*" (e 1) ", &*" (e 2) "].concat()" )
                * ( (e 1) " + " (e 2) ) 
            } 
        }
        
        +               cmdPlusOp:string             ( left:string right:double ) { 
                templates { 
                    go ( "strings.Join([]string{ " (e 1) ",strconv.FormatFloat(" (e 2) ",'f', 6, 64) }, \"\")" (imp "strings") (imp "strconv"))
                    rust ( "[" (e 1) " , (" (e 2)".to_string()) ].join(\"\")" )
                    swift3 ( (e 1) " + String(" (e 2)")" )
                    swift6 ( (e 1) " + String(" (e 2)")" )
                    kotlin ( (e 1) " + " (e 2)".toString()" )
                    cpp ( (e 1 ) " + std::to_string(" (e 2) ")")
                    php ( (e 1) " . " (e 2) ) 
                    python ( (e 1) " + str(" (e 2) ")" )
                    * ( (e 1) " + " (e 2) ) 
                } 
        }
        ; Go;
        ; strconv.Itoa
        +               cmdPlusOp:string             ( left:string right:int ) { 
                templates { 
                    go ( "strings.Join([]string{ " (e 1) ",strconv.FormatInt(" (e 2) ", 10) }, \"\")" (imp "strings") (imp "strconv"))
                    swift3 ( (e 1) " + String(" (e 2)")" )
                    swift6 ( (e 1) " + String(" (e 2)")" )
                    kotlin ( (e 1) " + " (e 2)".toString()" )
                    rust ( "[" (e 1) " , (" (e 2)".to_string()) ].join(\"\")" )
                    cpp ( (e 1 ) " + std::to_string(" (e 2) ")")
                    php ( (e 1) " . " (e 2) ) 
                    python ( (e 1) " + str(" (e 2) ")" )
                    * ( (e 1) " + " (e 2) ) 
                } 
        }

        %  _:int (left:int right:int) {
            templates {
                * ( (e 1) " % " (e 2) )
            }
        }

        ; ============================================================================
        ; Bitwise operators for integer manipulation
        ; ============================================================================

        ; Bitwise AND
        bit_and  _:int (left:int right:int) {
            templates {
                es6 ( "(" (e 1) " & " (e 2) ")" )
                go ( "int64(" (e 1) " & " (e 2) ")" )
                rust ( "((" (e 1) ") & (" (e 2) "))" )
                cpp ( "((" (e 1) ") & (" (e 2) "))" )
                java7 ( "((" (e 1) ") & (" (e 2) "))" )
                python ( "((" (e 1) ") & (" (e 2) "))" )
                swift6 ( "(Int64(" (e 1) ") & Int64(" (e 2) "))" )
                csharp ( "((" (e 1) ") & (" (e 2) "))" )
                * ( "((" (e 1) ") & (" (e 2) "))" )
            }
        }

        ; Bitwise OR
        bit_or  _:int (left:int right:int) {
            templates {
                es6 ( "(" (e 1) " | " (e 2) ")" )
                go ( "int64(" (e 1) " | " (e 2) ")" )
                rust ( "((" (e 1) ") | (" (e 2) "))" )
                cpp ( "((" (e 1) ") | (" (e 2) "))" )
                java7 ( "((" (e 1) ") | (" (e 2) "))" )
                python ( "((" (e 1) ") | (" (e 2) "))" )
                swift6 ( "(Int64(" (e 1) ") | Int64(" (e 2) "))" )
                csharp ( "((" (e 1) ") | (" (e 2) "))" )
                * ( "((" (e 1) ") | (" (e 2) "))" )
            }
        }

        ; Bitwise XOR
        bit_xor  _:int (left:int right:int) {
            templates {
                es6 ( "(" (e 1) " ^ " (e 2) ")" )
                go ( "int64(" (e 1) " ^ " (e 2) ")" )
                rust ( "((" (e 1) ") ^ (" (e 2) "))" )
                cpp ( "((" (e 1) ") ^ (" (e 2) "))" )
                java7 ( "((" (e 1) ") ^ (" (e 2) "))" )
                python ( "((" (e 1) ") ^ (" (e 2) "))" )
                swift6 ( "(Int64(" (e 1) ") ^ Int64(" (e 2) "))" )
                csharp ( "((" (e 1) ") ^ (" (e 2) "))" )
                * ( "((" (e 1) ") ^ (" (e 2) "))" )
            }
        }

        ; Bitwise NOT (ones complement)
        bit_not  _:int (value:int) {
            templates {
                es6 ( "(~" (e 1) ")" )
                go ( "int64(^" (e 1) ")" )
                rust ( "(!" (e 1) ")" )
                cpp ( "(~" (e 1) ")" )
                java7 ( "(~" (e 1) ")" )
                python ( "(~" (e 1) ")" )
                swift6 ( "(~Int64(" (e 1) "))" )
                csharp ( "(~" (e 1) ")" )
                * ( "(~" (e 1) ")" )
            }
        }

        ; Bit shift left
        bit_shl  _:int (value:int count:int) {
            templates {
                es6 ( "(" (e 1) " << " (e 2) ")" )
                go ( "int64(" (e 1) " << uint(" (e 2) "))" )
                rust ( "((" (e 1) ") << (" (e 2) "))" )
                cpp ( "((" (e 1) ") << (" (e 2) "))" )
                java7 ( "((" (e 1) ") << (" (e 2) "))" )
                python ( "((" (e 1) ") << (" (e 2) "))" )
                swift6 ( "(Int64(" (e 1) ") << Int64(" (e 2) "))" )
                csharp ( "((" (e 1) ") << (int)(" (e 2) "))" )
                * ( "((" (e 1) ") << (" (e 2) "))" )
            }
        }

        ; Bit shift right (arithmetic/signed)
        bit_shr  _:int (value:int count:int) {
            templates {
                es6 ( "(" (e 1) " >> " (e 2) ")" )
                go ( "int64(" (e 1) " >> uint(" (e 2) "))" )
                rust ( "((" (e 1) ") >> (" (e 2) "))" )
                cpp ( "((" (e 1) ") >> (" (e 2) "))" )
                java7 ( "((" (e 1) ") >> (" (e 2) "))" )
                python ( "((" (e 1) ") >> (" (e 2) "))" )
                swift6 ( "(Int64(" (e 1) ") >> Int64(" (e 2) "))" )
                csharp ( "((" (e 1) ") >> (int)(" (e 2) "))" )
                * ( "((" (e 1) ") >> (" (e 2) "))" )
            }
        }

        ; Bit shift right unsigned (logical)
        bit_ushr  _:int (value:int count:int) {
            templates {
                es6 ( "(" (e 1) " >>> " (e 2) ")" )
                go ( "int64(uint64(" (e 1) ") >> uint(" (e 2) "))" )
                rust ( "(((" (e 1) ") as u64 >> (" (e 2) ")) as i64)" )
                cpp ( "(int64_t)((uint64_t)(" (e 1) ") >> (" (e 2) "))" )
                java7 ( "((" (e 1) ") >>> (" (e 2) "))" )
                python ( "((" (e 1) " & 0xFFFFFFFF) >> (" (e 2) "))" )
                swift6 ( "Int64(bitPattern: UInt64(bitPattern: Int64(" (e 1) ")) >> UInt64(" (e 2) "))" )
                csharp ( "(int)((uint)(" (e 1) ") >> (int)(" (e 2) "))" )
                * ( "(" (e 1) " >>> " (e 2) ")" )
            }
        }

        ; ============================================================================
                
        +               cmdPlusOp:string             ( left:double right:string ) { 
            templates { 
                    swift3 ( "String(" (e 1) ") + " (e 2) )
                    swift6 ( "String(" (e 1) ") + " (e 2) )
                    kotlin ( (e 1) ".toString() + " (e 2) )
                    * ( (e 1) " + " (e 2) ) 
                    php ( (e 1) " . " (e 2) ) 
                    rust ( "format!(\"{}{}\", " (e 1) ", " (e 2) ")" )
                } 
            }

        +               cmdPlusOp:string             ( left:int right:string    ) { 
                    templates { 
                    go ( "strings.Join([]string{ strconv.FormatInt(" (e 1) ", 10)," (e 2) " }, \"\")" (imp "strings") (imp "strconv"))
                    swift3 ( "String(" (e 1) ") + " (e 2) )
                    swift6 ( "String(" (e 1) ") + " (e 2) )
                    kotlin ( (e 1) ".toString() + " (e 2) )
                    rust ( "format!(\"{}{}\", " (e 1) ", " (e 2) ")" )
                    cpp ( "std::to_string(" (e 1) ") + " (e 2) )
                    php ( (e 1) " . " (e 2) ) 
                    python ( "str(" (e 1) ") + " (e 2) )
                    * ( (e 1) " + " (e 2) ) 
                    } }


        *               cmdMulOp:double         ( left:double right:double ) { templates { * ( (e 1) " * " (e 2) ) } }
        *               cmdMulOp:int            ( left:int right:int ) { templates { * ( (e 1) " * " (e 2) ) } }

        /               cmdDivOp:double         ( left:double right:double ) { templates { * ( (e 1) " / " (e 2) ) } }
        /               cmdDivOp:double         ( left:int right:int ) { templates { 
            go ( "float64(" (e 1) ") / float64(" (e 2) ")" )
            rust ( "(" (e 1) " as f64) / (" (e 2) " as f64)" )
            * ( (e 1) " / " (e 2) ) 
        } }

        ; optional string operator...
        ||              _:string         ( left:string right:string ) @doc('selects the first string if length > 0, else the second...') { 
            templates { 
                ranger ( '(|| (' (e 1) ') (' (e 1) ') )')
                * @macro(true) ( '(? ( (strlen ' (e 1) ') > 0 ) (' (e 1) ')  (' (e 2) ') )' ) 
            } 
        }        
        

        ?               cmdTernary:T         ( condition:boolean  left:T right:T ) { 
            templates { 
                ranger ( '(? '(e 1) ' ' (e 2)' ' (e 3) ' )')
                go ( '(func() ' (typeof 2) ' { if ' (e 1) ' { return ' (e 2) ' } else { return ' (e 3) '} }())' )  
                cpp ( '(' (e 1) " ? " (e 2) " : " (e 3) ')' ) 
                scala ( '( if (' (e 1) ")  " (e 2) " else " (e 3) ')' ) 
                python ( '(' (e 2) " if " (e 1) " else " (e 3) ')' ) 
                rust ( 'if ' (e 1) ' { ' (e 2) ' } else { ' (e 3) ' }' )
                * ( (e 1) " ? " (e 2) " : " (e 3) ) 
            } 
        }


        ??               elvis:T         ( left@(optional):T right:T ) { 
            templates { 
                * @macro(true) ( '(? (!null? ' (e 1) ') (unwrap ' (e 1) ') ' (e 2) ')' ) 
            } 
        }        

        =               cmdAssign:void          ( target:vref expr:expression ) {
            templates {
                ranger ( nl (e 1) " = " (e 2) nl )  
                go ( (custom _ ) )
                rust ( (custom _) )
                scala ( (e 1) " = " (e 2) )   ; <-- scala does not require ; here                
                * ( (e 1) " = " (e 2) ";" )
            }
        }




        int2double      cmdIntToDouble:double            ( value:int ) { 
                templates {
                    ranger ( "(int2double " (e 1) ")" ) 
                    * ( "parseFloat(" (e 1) ")" ) 
                } 
        }

        gitdoc      cmdGitDoc:void            ( value:string ) { 
                templates { 
                    * ( "/* git doc */" ) 
                } 
        }




; TODO: add the rest ....(case ("sin" "cos" "tan" "atan" "log" "abs" "acos" "asin" "floor" "round" "sqrt")
        ;"<cmath>"

        ceil        _:int          (  value:double )  {
            templates {
                ranger ( "(ceil " (e 1) ")" ) 
                swift3 ( "ceil(" (e 1) ")" (imp "Foundation"))               
                cpp ( "ceil(" (e 1) ")" (imp "<cmath>"))
                csharp ( "Math.Ceil(" (e 1) ")" (imp "System"))    
                go ( "math.Ceil(" (e 1) ")" (imp "math"))                                
                php ( "ceil(" (e 1) ")" )    
                rust ( "" (e 1) ".ceil()" )                
                scala ( "math.ceil(" (e 1) ")" (imp "scala.math"))                
                java7 ( "Math.ceil(" (e 1) ")" (imp "java.lang.Math"))
                * ( "Math.ceil(" (e 1) ")")
            }
        }

        floor        _:int          (  value:double )  {
            templates {
                ranger ( "(floor " (e 1) ")" ) 
                swift3 ( "Int(floor(" (e 1) "))" (imp "Foundation"))               
                cpp ( "(int)floor(" (e 1) ")" (imp "<cmath>"))
                csharp ( "(int)Math.Floor(" (e 1) ")" (imp "System"))    
                go ( "int64(math.Floor(" (e 1) "))" (imp "math"))                                
                php ( "floor(" (e 1) ")" )    
                rust ( "" (e 1) ".floor() as i64" )                
                scala ( "math.floor(" (e 1) ").toInt" (imp "scala.math"))                
                java7 ( "(int)Math.floor(" (e 1) ")" (imp "java.lang.Math"))
                * ( "Math.floor(" (e 1) ")")
            }
        }

        asin        cmdCos:double          (  value:double )  {
            templates {
                ranger ( "(asin " (e 1) ")" ) 
                swift3 ( "asin(" (e 1) ")" (imp "Foundation"))               
                cpp ( "asin(" (e 1) ")" (imp "<cmath>"))
                csharp ( "Math.Asin(" (e 1) ")" (imp "System"))    
                go ( "math.Asin(" (e 1) ")" (imp "math"))                                
                php ( "asin(" (e 1) ")" )    
                rust ( "" (e 1) ".asin()" )                
                scala ( "math.asin(" (e 1) ")" (imp "scala.math"))                
                java7 ( "Math.asin(" (e 1) ")" (imp "java.lang.Math"))
                * ( "Math.asin(" (e 1) ")")
            }
        }
        


        acos        cmdCos:double          (  value:double )  {
            templates {
                ranger ( "(acos " (e 1) ")" ) 
                swift3 ( "acos(" (e 1) ")" (imp "Foundation"))               
                cpp ( "acos(" (e 1) ")" (imp "<cmath>"))
                csharp ( "Math.Acos(" (e 1) ")" (imp "System"))    
                go ( "math.Acos(" (e 1) ")" (imp "math"))                                
                php ( "acos(" (e 1) ")" )    
                rust ( "" (e 1) ".acos()" )                
                scala ( "math.acos(" (e 1) ")" (imp "scala.math"))                
                java7 ( "Math.acos(" (e 1) ")" (imp "java.lang.Math"))
                * ( "Math.acos(" (e 1) ")")
            }
        }

        cos        cmdCos:double          (  value:double )  {
            templates {
                ranger ( "(cos " (e 1) ")" )
                swift3 ( "cos(" (e 1) ")" (imp "Foundation"))               
                cpp ( "cos(" (e 1) ")" (imp "<cmath>"))
                csharp ( "Math.Cos(" (e 1) ")" (imp "System"))    
                go ( "math.Cos(" (e 1) ")" (imp "math"))                                
                php ( "cos(" (e 1) ")" )    
                rust ( "" (e 1) ".cos()" )                
                scala ( "math.cos(" (e 1) ")" (imp "scala.math"))                
                java7 ( "Math.cos(" (e 1) ")" (imp "java.lang.Math"))
                * ( "Math.cos(" (e 1) ")")
            }
        }
        
        sin        cmdSin:double          (  value:double )  {
            templates {
                ranger ( "(sin " (e 1) ")" )
                swift3 ( "sin(" (e 1) ")" (imp "Foundation"))               
                cpp ( "sin(" (e 1) ")" (imp "<cmath>"))
                csharp ( "Math.Sin(" (e 1) ")" (imp "System"))    
                go ( "math.Sin(" (e 1) ")" (imp "math"))                                
                php ( "sin(" (e 1) ")" )    
                rust ( "" (e 1) ".sin()" )                
                scala ( "math.sin(" (e 1) ")" (imp "scala.math"))                
                java7 ( "Math.sin(" (e 1) ")" (imp "java.lang.Math"))
                * ( "Math.sin(" (e 1) ")")
            }
        }

        sqrt        cmdSqrt:double          (  value:double )  {
            templates {
                ranger ( "(sqrt " (e 1) ")" )
                swift3 ( "sqrt(" (e 1) ")" (imp "Foundation"))               
                cpp ( "sqrt(" (e 1) ")" (imp "<cmath>"))
                csharp ( "Math.Sqrt(" (e 1) ")" (imp "System"))                                
                php ( "sqrt(" (e 1) ")" )                
                go ( "math.Sqrt(" (e 1) ")" (imp "math"))  
                rust ( "" (e 1) ".sqrt()" )  
                scala ( "math.sqrt(" (e 1) ")" (imp "scala.math"))                
                java7 ( "Math.sqrt(" (e 1) ")" (imp "java.lang.Math"))
                rust ( (e 1) ".sqrt()" )
                * ( "Math.sqrt(" (e 1) ")")
            }
        }        

        if              cmdIf:void              ( condition:boolean then_block:block else@(keyword) else_block:block )  {
            templates {
                rust @macro(true) ('if ' (e 1) ' { ' (block 2)' } else { '(block 4) ' }' )
                * @macro(true) ('if (' (e 1) ' ) { ' (block 2)' } { '(block 4) ' }' )
            }
        }        
        if!              cmdIf:void              ( condition:boolean then_block:block else@(keyword) else_block:block )  {
            templates {
                rust @macro(true) ('if false == ' (e 1) ' { ' (block 2)' } else { '(block 4) ' }' )
                * @macro(true) ('if (false == (' (e 1) ' ) ) { ' (block 2)' } { '(block 4) ' }' )
            }
        }        

        if!              cmdIf:void              ( condition:boolean then_block:block else_block:block )  {
            templates {
                rust @macro(true) ('if false == ' (e 1) ' { ' (block 2)' } else { '(block 3) ' }' )
                * @macro(true) ('if (false == (' (e 1) ' ) ) { ' (block 2)' } { '(block 3) ' }' )
            }
        }        

        if!              cmdIf:void              ( condition:boolean then_block:block )  {
            templates {
                rust @macro(true) ('if false == ' (e 1) ' { ' (block 2) ' } ' )
                * @macro(true) ('if (false == (' (e 1) ' ) ) { ' (block 2) ' } ' )
            }
        }        
        

        if              cmdIf:void              ( condition:boolean then_block:block else_block:block )  {
            templates {
                ranger ( "if (" (e 1) " ) {" I nl (block 2) i nl "}" (ifa 3) " {" I nl (block 3) i "}" nl)
                rust ( "if  " (e 1) " {" I nl (block 2) i nl "}" (ifa 3) " else {" I nl (block 3) i "}" nl)
                go ( "if  " (e 1) " {" I nl (block 2) i nl "}" (ifa 3) " else {" I nl (block 3) i "}" nl)
                python ( "if " (e 1) ":" I nl (block 2) i nl "else:" I nl (block 3) i nl)
                * ( "if ( " (e 1) " ) {" I nl (block 2) i nl "}" (ifa 3) " else {" I nl (block 3) i "}" nl)
            }
        }        
        
        if              cmdIf:void              ( condition:boolean then_block:block )  {
            templates {
                ranger ( "if (" (e 1) ") {" I nl (block 2) nl i "}" nl )
                rust ( "if  " (e 1) " {" I nl (block 2) nl i "}" nl )
                go ( "if  " (e 1) " {" I nl (block 2) nl i "}" nl )
                python ( "if " (e 1) ":" I nl (block 2) nl i nl )
                * ( "if ( " (e 1) " ) {" I nl (block 2) nl i "}" nl )
            }
        }

        if              cmdIf:void              ( condition@(optional):int then_block:block )  {
            templates {
                cpp ( "if ( " (e 1) ".has_value ) {" nl I (block 2) i nl "}" nl )
            }
        }  

        if              cmdIf:void              ( condition@(optional):double then_block:block )  {
            templates {
                cpp ( "if ( " (e 1) ".has_value ) {" nl I (block 2) i nl "}" nl )
            }
        }        

        if              cmdIf:void              ( condition@(optional):T then_block:block )  {
            templates {
                ranger ( "if ( " (e 1) ") ) {" I nl (block 2) i nl "} {" nl I (block 3) i "}" nl)
                scala ( "if ( " (e 1) ".isDefined ) {" nl I (block 2) i nl "}" nl )
                swift3 ( "if ( " (e 1) " != nil ) {" nl I (block 2) i nl "}" nl )
                kotlin ( "if ( " (e 1) " != null ) {" nl I (block 2) i nl "}" nl )
                java7 ( "if ( " (e 1) ".isPresent()) {" nl I (block 2) i nl "}" nl )
                csharp ( "if ( " (e 1) ".HasValue) {" nl I (block 2) i nl "}" nl )
                ; go ( "" (e 1 ) " == nil " ) 
                ; is_some
                php ( "if ( isset( " (e 1) " ) ) {" nl I (block 2) i nl "}" nl )
                go ( "if ( " (e 1) ".has_value) {" nl I (block 2) i nl "}" nl )
                cpp ( "if ( " (e 1) " != NULL ) {" nl I (block 2) i nl "}" nl )
                rust ( "if " (e 1) ".is_some() {" nl I (block 2) i nl "}" nl )
                python ( "if " (e 1) " is not None:" nl I (block 2) i nl )
                * ( "if ( typeof(" ( e 1 ) ") != \"undefined\" ) {" nl I (block 2) i nl "}" nl )

            }
        }

        if              cmdIf:void              ( condition@(optional):T then_block:block else_block )  {
            templates {
                ranger ( "if ( " (e 1) " ) {" I nl (block 2) i nl "} {" nl I (block 3) i "}" nl)
                php ( "if ( isset(" (e 1) ") ) {" I nl (block 2) i nl "} else {" nl I (block 3) i "}" nl)
                scala ( "if ( " (e 1) ".isDefined ) {" I nl (block 2) i nl "} else {" nl I (block 3) i "}" nl)
                java7 ( "if ( " (e 1) ".isPresent() ) {" I nl (block 2) i nl "} else {" nl I (block 3) i "}" nl)
                csharp ( "if ( " (e 1) ".HasValue ) {" I nl (block 2) i nl "} else {" nl I (block 3) i "}" nl)
                kotlin ( "if ( " (e 1) " != null ) {" I nl (block 2) i nl "} else {" nl I (block 3) i "}" nl)
                rust ( "if " (e 1) ".is_some() {" I nl (block 2) i nl "} else {" nl I (block 3) i "}" nl)
                swift3 ( "if ( " (e 1) " != nil ) {" I nl (block 2) i nl "} else {" nl I (block 3) i "}" nl)
                go ( "if ( " (e 1) ".has_value ) {" I nl (block 2) i nl "} else {" nl I (block 3) i "}" nl)
                cpp ( "if ( " (e 1) " != NULL ) {" I nl (block 2) i nl "} else {" nl I (block 3) i "}" nl)
                python ( "if " (e 1) " is not None:" I nl (block 2) i nl "else:" I nl (block 3) i nl)
                * ( "if ( typeof(" ( e 1 ) ") != \"undefined\" ) {" I nl (block 2) i nl "} else {" nl I (block 3) i "}" nl)
            }
        }
        switch          cmdSwitch:void          ( condition:char case_list:block )  {
            templates {
                go ( "switch (int64(" (e 1) " )) { " I (block 2) i "}" )
            }
        }       

        switch          cmdSwitch:void          ( condition:T case_list:block )  {
            templates {
                swift3 ( (custom _ ) )
            }
        } 

        switch          cmdSwitch:void          ( condition:int case_list:block )  {
            templates {
                scala ( (e 1) " match { " I (block 2) i "}" )
                kotlin ( "when (" (e 1) ") { " I (block 2) i "}" )
                * ( "switch (" (e 1) " ) { " I (block 2) i "}" )
            }
        }       

        case        cmdCase:void          (  condition:char case_block:block )  {
            templates {
                ranger ( nl "case " (e 1)" { " nl I (block 2) i nl "}" )
                scala ( nl "case " (e 1)" => " nl I (block 2) nl i )
                swift3 ( nl "case " (e 1)" : " nl I (block 2) nl i )
                java7 ( nl "case " (e 1)" : " nl I (java_case 2) nl i )
                
                es6 ( nl "case " (e 1)" : " nl I (java_case 2) nl i )

                go ( nl "case " (e 1)" : " nl I (block 2) nl i )
                kotlin ( nl (e 1) " -> {" nl I (block 2) nl i "}" )
                cpp ( nl "case " (e 1)" : " nl I "{" nl I (block 2) nl "break;" i nl "}" i )
                * ( nl "case " (e 1)" : " nl I (block 2) nl "break;" i )
            }
        }         

        case        cmdCase:void          (  condition:int case_block:block )  {
            templates {
                ranger ( nl "case " (e 1)" { " nl I (block 2) i nl "}" )
                scala ( nl "case " (e 1)" => " nl I (block 2) nl i )
                swift3 ( nl "case " (e 1)" : " nl I (block 2) nl i )
                java7 ( nl "case " (e 1)" : " nl I (java_case 2) nl i )
                go ( nl "case " (e 1)" : " nl I (block 2) nl i )
                kotlin ( nl (e 1) " -> {" nl I (block 2) nl i "}" )
                cpp ( nl "case " (e 1)" : " nl I "{" nl I (block 2) nl "break;" i nl "}" i )
                es6 ( nl "case " (e 1)" : " nl I (java_case 2) nl i )
                * ( nl "case " (e 1)" : " nl I (block 2) nl "break;" i )
            }
        }      

        switch          cmdSwitch:void          ( condition:string case_list:block )  {
            templates {
                cpp ( (custom _) )                                
                scala ( (e 1) " match { " I (block 2) i "}" )
                kotlin ( "when (" (e 1) ") { " I (block 2) i "}" )
                * ( "switch (" (e 1) " ) { " I (block 2) i "}" )
            }
        }             

        switch          cmdSwitch:void          ( condition:T case_list:block )  {
            templates {

                scala ( (e 1) " match { " I (block 2) i "}" )
                kotlin ( "when (" (e 1) ") { " I (block 2) i "}" )
                * ( "switch (" (e 1) " ) { " I (block 2) i "}" )
            }
        }       

        case        cmdCase:void          (  condition:T case_block:block )  {
            templates {
                ranger ( nl "case " (e 1)" { " nl I (block 2) i nl "}" )
                scala ( nl "case " (e 1)" => " nl I (block 2) nl i )
                swift3 ( nl "case " (e 1)" : " nl I (block 2) nl i )
                java7 ( nl "case " (e 1)" : " nl I (java_case 2) nl i )
                go ( nl "case " (e 1)" : " nl I (block 2) nl i )
                kotlin ( nl (e 1) " -> {" nl I (block 2) nl i "}" )
                es6 ( nl "case " (e 1)" : " nl I (java_case 2) nl i )
                cpp ( nl "case " (e 1)" : " nl I "{" nl I (block 2) nl "break;" i nl "}" i )
                * ( nl "case " (e 1)" : " nl I (block 2) nl "break;" i )
            }
        }        

        default        cmdDefault:void          (  default_block:block )  {
            templates {
                ranger ( nl "default { " nl I (block 1) i nl "}" )
                scala ( nl "case _ => " nl I (block 1) nl i )
                go ( nl "default: " nl I (block 1) nl i )
                kotlin ( nl "else  -> { " nl I (block 2) nl i "}" )
                java7 ( nl "default: " nl I (java_case 1) nl i )
                * ( nl "default: " nl I (block 1) nl "break;" i )
            }
        }
        


        break           cmdBreak:void          ( )  {
            templates {
                ranger  ( nl "break" nl )
                scala ( nl "__break__.break;" nl )
                * ( nl "break;" nl )
            }
        }

        break           cmdBreak:void          ( _:T )  {
            templates {
                ranger  ( nl "break" nl )
                scala ( nl "__break__.break;" nl )
                * ( nl "break;" nl )
            }
        }

        continue        cmdContinue:void          ( )  {
            templates {
                ranger  ( nl "continue " nl )
                scala ( nl "__continue__.break;" nl )
                * ( nl "continue;" nl )
            }
        }
        
        continue        cmdContinue:void          ( _:T)  {
            templates {
                ranger  ( nl "continue " nl )
                scala ( nl "__continue__.break;" nl )
                * ( nl "continue;" nl )
            }
        }


        while           cmdWhile:void          ( condition@(loopcondition):boolean whileLoop@(loopblock):block )  {
            templates {
                go ( "for " (e 1) " {" I nl (block 2) nl i "}" )
                scala ( 
                    (forkctx _ ) (def 2) (def 3) 
                    "try {" nl I
                    "val __break__ = new Breaks;" nl
                    "__break__.breakable { " 
                        nl I 
                            "while (" (e 1) ") {" nl
                                I
                                "val __continue__ = new Breaks;" nl
                                "__continue__.breakable {" nl
                                    I nl (block 2) nl i 
                                "}" nl i
                            "}"
                        i nl
                    "}" nl
                    i nl "} " nl
                    (imp "scala.util.control._")
                )
                python ( "while " (e 1) ":" nl I (block 2) i nl )
                rust ( "while " (e 1) " {" nl I (block 2) i nl "}" )
                * ( "while (" (e 1) ") {" nl I (block 2) i nl "}" )
            }
        }


        make         cmdArrayLiteral:[T] ( typeDef@(ignore):[T] size:int repeatItem:T ) {
            templates {
                csharp ( "new " (typeof 1) "( new " (r_atype 1) "[" (e 2)"])")
                swift3 ( "" (typeof 1)"(repeating:" (e 3) ", count:" (e 2) ")" )
                ranger ( "(make  _:" (typeof 1) " " (e 2) ")" )
                go ( "make(" (typeof 1) "," (e 2) ")" )
                cpp (  (typeof 1) "(" (e 2) ")")
                ; new ArrayList<Double>( Arrays.asList( new Double[len_2] ) );
                java7 (  "new " (typeof 1) "( Arrays.asList( new " (r_atype 1) "[" (e 2) "]))")
                java7 ( "new " (typeof 1) "(" (e 2) ")")
                es6 ( "new Array(" (e 2) ")")                
                * ( "[" (comma 2) "]")
            }
        }

        []         cmdArrayLiteral:[T] ( typeDef@(noeval):T listOf:expression ) {
            templates {
                ranger ( "([] _:" (typeof 1) "(" (list 2) "))")
                go ( "[]" (typeof 1) "{" (comma 2) "}")
                cpp ( "r_make_vector_from_array( ( " (typeof 1) "[] ) {" (comma 2) "} )"

(create_polyfill               
"template< typename T, size_t N >
std::vector<T> r_make_vector_from_array( const T (&data)[N] )
{
    return std::vector<T>(data, data+N);
}")                
                )
                scala( "collection.mutable.ArrayBuffer(" (comma 2) ")")
                csharp ( "new List<" (typeof 1) ">{" (comma 2) "}")
                java7 ( (imp "java.util.*") "new ArrayList<" (typeof 1) ">(Arrays.asList( new " (typeof 1)" [] {" (comma 2) "})) " )
                * ( "[" (comma 2) "]")
            }
        }
        null?       cmdIsNotNull:boolean        ( arg@(optional):int ) {
            templates {
                cpp ((e 1) ".has_value == false")     
            }
        }  
        null?       cmdIsNotNull:boolean        ( arg@(optional):double ) {
            templates {
                cpp ((e 1) ".has_value == false")     
            }
        }               
        null?       cmdIsNotNull:boolean        ( arg@(optional):string ) {
            templates {
                cpp ((e 1) ".empty()")     
            }
        }               

        null?       cmdIsNull:boolean        ( arg@(optional):T ) {
            templates {
                ranger ("(null? " (e 1) ")")
                php ( "(!isset(" (e 1) "))")                                
                cpp ((e 1) " == NULL")                                
                swift3 ((e 1) " == nil")  
                swift6 ((e 1) " == nil")  
                java7 ( (e 1) " == null")  
                scala ((e 1) ".isDefined == false ")  
                csharp ((e 1) " == null ")  
                rust ((e 1) ".is_none()")  
                go ( "!" (goset 1 ) ".has_value " )             
                kotlin ((e 1) "== null")     
                es6 (  "typeof(" ( e 1 ) ") === \"undefined\"")
                python ((e 1) " is None")
                * ((e 1) "== null")
            }
        }   
        !null?       cmdIsNotNull:boolean        ( arg@(optional):int ) {
            templates {
                cpp ((e 1) ".has_value")     
            }
        }  
        !null?       cmdIsNotNull:boolean        ( arg@(optional):double ) {
            templates {
                cpp ((e 1) ".has_value")     
            }
        }               
        !null?       cmdIsNotNull:boolean        ( arg@(optional):string ) {
            templates {
                cpp ((e 1) ".empty() == false ")     
            }
        }               

        !null?       cmdIsNotNull:boolean        ( arg@(optional):T ) {
            templates {
                ranger ("(!null? " (e 1) ")")
                php ( "(isset(" (e 1) "))")
                scala ((e 1) ".isDefined")  
                swift3 ((e 1) " != nil ")     
                swift6 ((e 1) " != nil ")     
                cpp ((e 1) " != NULL ")     
                java7 ((e 1) " != null ")   
                csharp ("" (e 1) " != null")
                rust ((e 1) ".is_some()")     
                kotlin ((e 1) " != null")     
                go (  (goset 1 ) ".has_value" )
                python ('(' (e 1) ' is not None)')
                * ('(typeof(' ( e 1 ) ') !== "undefined" && ' (e 1) ' != null ) ')
            }
        }        

        error_msg   _:string () {
            templates {
                ranger ( "(error_msg   )")
                go ( "\"\"" )
                es6 ( "( e.toString())" )
                php ( "( $e->getMessage())" )
                java7 ( "( e.getMessage())" )
                cpp ( " \"unspecified error\" " )
            }
        }

        throw        cmdThrow@(throws):void          (  eInfo:string  )  {
            templates {
                ranger ( nl "throw "  (e 1)  nl )
                go ( nl "panic(" (e 1) ")" nl)
                php ( "throw new Exception(" (e 1) ");")
                csharp ( "throw new ConfigurationErrorsException(" (e 1) ");" (imp "System.Configuration"))
                java7 ( "throw new IllegalArgumentException(" (e 1) ");")
                swift3 ( 
                    nl "throw "  (e 1) ";" nl 
(create_polyfill 
"
extension String: Error {}
"
)                    
                )
                scala ( "throw new customException(" (e 1) ")"

(create_polyfill
"
case class customException(smth:String)  extends Exception
")                    
                )
                * ( nl "throw "  (e 1) ";" nl )
            }
        }
        
        throw        cmdThrow@(throws):void          (  eInfo:T  )  {
            templates {
                ranger ( nl "throw "  (e 1)  nl )
                * ( nl "throw "  (e 1) ";" nl )
            }
        }        

        try          cmdTry:void          (  try_block@(try_block):block catch_block:block  )  {
            templates {
                ranger ( nl "try {" nl I (block 1) i nl "} {" nl I (block 2) i nl "}" nl )  
                csharp ( nl "try {" nl I (block 1) i nl "} catch( Exception e ) {" nl I (block 2) i nl "}" nl )               
                php ( nl "try {" nl I (block 1) i nl "} catch( Exception $e) {" nl I (block 2) i nl "}" nl )               
                scala ( (custom _ ) )
                scala ( 
                    
                    nl "try {" nl I (block 1) i nl "} catch {" nl
                    I
                    "case rv:ScalaReturnValue => {" nl I
                        "throw new ScalaReturnValue(rv.value)"  nl i
                    "}" nl
                    i
                 nl I nl "case e: Exception => {" nl I (block 2) i nl "}" i nl "}" nl )
                java7 ( nl "try {" nl I (block 1) i nl "} catch( Exception e) {" nl I (block 2) i nl "}" nl (imp 'java.io.IOException') )
                go ( (custom _) )
;                go ( "(func () { " nl I "defer func() {" nl I "if r:= recover(); r != nil {" nl I (block 2) i nl "}" nl i "}()" nl (block 1) nl i "})()" nl )  ;"
                ; with swift there is no do without try...
                swift3 ( "do {" nl I (block 1) i nl "} catch { " nl I (block 2) i nl "}" )
                cpp ( nl "try {" nl I (block 1) i nl "} catch( ... ) {" nl I (block 2) i nl "}" nl )
                * ( nl "try {" nl I (block 1) i nl "} catch(e) {" nl I (block 2) i nl "}" nl )
            }
        }
               

        ; T.name is a bit of a problem ??        
        for             cmdFor@(newcontext):void          ( list:[T] item@(define):T indexName@(define ignore):int repeat_block:block)  {
            templates {
                ranger ( nl "for " (e 1) " " (e 2) ":" (typeof 2) " " (e 3)" {" nl I (block 4) nl i "}" )
                swift3 ( (forkctx _ ) (def 2) (def 3) nl "for ( " (swift_rc 3) " , " (e 2) " ) in " (e 1) ".enumerated() {" nl I (block 4) nl i "}" )
                swift6 ( (forkctx _ ) (def 2) (def 3) nl "for (" (e 3) ", " (e 2) ") in " (e 1) ".enumerated() {" nl I (block 4) nl i "}" )
                kotlin ( (forkctx _ ) (def 2) (def 3) "for ( " (e 3) " in " (e 1) ".indices ) {" nl I "val " (e 2) " = " (e 1) "[" (e 3) "]" nl (block 4) nl i "}" )

                ; Use index-based loop for Rust with cloned item - no reassignment needed as item is cloned
                rust ( (forkctx _ ) (def 2) (def 3) "for " (e 3) " in 0.." (e 1) ".len() {" nl I "let mut " (e 2) " = " (e 1) "[" (e 3) " as usize].clone();" nl (block 4) nl i "}" )     

                ; idea of go for macro implementation, not working yet...         
                go_idea  @macro(true) (nl 
                "def cnt:int 0" nl
                "def " (e 3) ":int -1" nl
                "while (cnt < (array_length " (e 1) ")) {" nl I
                    (e 3) " =  " (e 3) " + 1" nl
                    " cnt =  cnt + 1" nl
                    "def " (e 2) ":" (typeof 2) " (itemAt " (e 1) " (cnt - 1) );" nl     
                    (block 4) nl
                    i
                "}" nl
                )
                go    (  (def 2) (def 3) "var " (e 3) " int64 = 0;  " nl "for ; " (e 3) " < int64(len(" (e 1) ")) ; " (e 3) "++ {" nl I nl (e 2) " := " (e 1) "[" (e 3) "];" nl (block 4) nl i "}" )

                php    ( (forkctx _ ) (def 2) (def 3) "for ( " (e 3) " = 0; " (e 3) " < count(" (e 1) "); " (e 3) "++) {" nl I (e 2) " = " (e 1) "[" (e 3) "];" nl (block 4) nl i "}" )
                java7 ( (forkctx _ ) (def 2) (def 3) "for ( int " (e 3) " = 0; " (e 3) " < " (e 1) ".size(); " (e 3) "++) {" nl I (typeof 2) " " (e 2) " = " (e 1) ".get(" (e 3) ");" nl (block 4) nl i "}" )
                csharp ( (forkctx _ ) (def 2) (def 3) "for ( int " (e 3) " = 0; " (e 3) " < " (e 1) ".Count; " (e 3) "++) {" nl I (typeof 2) " " (e 2) " = " (e 1) "[" (e 3) "];" nl (block 4) nl i "}" )
                scala ( (custom _) )      
                cpp ( (forkctx _ ) (def 2) (def 3) "for ( int " (e 3) " = 0; " (e 3) " != (int)(" (e 1) ".size()); " (e 3) "++) {" nl 
                            I (typeof 2) " " (e 2) " = " (e 1) ".at(" (e 3) ");" nl (block 4) nl i "}" )          
                cpp.old ( (forkctx _ ) (def 2) (def 3) "for ( std::vector< " (typeof 2) ">::size_type " (e 3) " = 0; " (e 3) " != " (e 1) ".size(); " (e 3) "++) {" nl 
                            I (typeof 2) " " (e 2) " = " (e 1) ".at(" (e 3) ");" nl (block 4) nl i "}" )          
                python ( (forkctx _ ) (def 2) (def 3) "for " (e 3) ", " (e 2) " in enumerate(" (e 1) "):" nl I (block 4) nl i )
                * ( (forkctx _ ) (def 2) (def 3) "for ( let " (e 3) " = 0; " (e 3) " < " (e 1) ".length; " (e 3) "++) {" nl I "var " (e 2) " = " (e 1) "[" (e 3) "];" nl (block 4) nl i "}" )
            }
        }

        
        for             cmdFor@(newcontext):void          ( hash:[string:T] item@(define):T itemName@(define ignore):string repeat_block:block)  {
            templates {
                es6 ("for( var " (e 3) " in " (e 1) ") {" nl I "if(" (e 1) ".hasOwnProperty(" (e 3) ")) {" 
                        nl I "var " (e 2) " = " (e 1) "[" (e 3) "] " nl (block 4) 
                        nl i "} }"
                     )
            }
        }    

        for             cmdFor@(newcontext):void          ( hash:[string:T] itemName@(define ignore):string repeat_block:block)  {
            templates {
                es6 ("for( var " (e 2) " in " (e 1) ") {" nl I "if(" (e 1) ".hasOwnProperty(" (e 2) ")) {" 
                        nl I (block 3) 
                        nl i "} " nl i "}"
                     )
            }
        }              

        trim             cmdTrim:string          ( value:string ) { 
            templates {
                ranger ( "(trim " (e 1 ) ")")                
                swift3 ( (e 1 ) ".trimmingCharacters(in: CharacterSet.whitespacesAndNewlines)" (imp "Foundation"))                
                swift6 ( (e 1 ) ".trimmingCharacters(in: CharacterSet.whitespacesAndNewlines)" (imp "Foundation"))                
                php ( "trim(" (e 1 ) ")")
                cpp ( "r_cpp_trim( " (e 1) ")" (imp "<cctype>") (imp "<string>") (imp "<algorithm>")
(create_polyfill "
inline std::string  r_cpp_trim(std::string &s) 
{
   auto wsfront=std::find_if_not(s.begin(),s.end(),[](int c){return std::isspace(c);});
   auto wsback=std::find_if_not(s.rbegin(),s.rend(),[](int c){return std::isspace(c);}).base();
   return (wsback<=wsfront ? std::string() : std::string(wsfront,wsback));
}    
    ") )  
                scala ( (e 1) ".trim" )
                csharp ( (e 1) ".Trim()" (imp "System"))
                go ("strings.TrimSpace(" (e 1) ")" (imp "strings"))
                python ( (e 1) ".strip()" )
                rust ( (e 1) ".trim().to_string()" )
                * ( (e 1) ".trim()" )
            }            
        }                 

        ; trim_right - removes whitespace from the right side of string
        trim_right       cmdTrimRight:string       ( value:string ) { 
            templates {
                ranger ( "(trim_right " (e 1 ) ")")                
                swift3 ( (e 1 ) ".trimmingCharacters(in: .whitespaces)" (imp "Foundation"))                
                swift6 ( (e 1 ) ".trimmingCharacters(in: .whitespaces)" (imp "Foundation"))                
                php ( "rtrim(" (e 1 ) ")")
                cpp ( "r_trim_right( " (e 1) ")" (imp "<string>") (imp "<algorithm>")
(create_polyfill "
inline std::string r_trim_right(const std::string& s) {
    auto end = std::find_if(s.rbegin(), s.rend(), [](unsigned char ch) { return !std::isspace(ch); }).base();
    return std::string(s.begin(), end);
}
") )  
                scala ( (e 1) ".replaceAll(\"\\\\s+$\", \"\")" )
                csharp ( (e 1) ".TrimEnd()" (imp "System"))
                go ("strings.TrimRight(" (e 1) ", \" \\t\\n\\r\")" (imp "strings"))
                kotlin ( (e 1) ".trimEnd()" )
                java7 ( (e 1) ".replaceAll(\"\\\\s+$\", \"\")" )
                python ( (e 1) ".rstrip()" )
                rust ( (e 1) ".trim_end().to_string()" )
                * ( (e 1) ".trimEnd()" )
            }            
        }

;         wr.out (").to[collection.mutable.ArrayBuffer]" false
; kotlin could use also something like: .split(Regex("(?<=[!?])|(?=[!?])"))
; swift : .components(separatedBy:
        strsplit       cmdSplit:[string]       ( strToSplit:string delimiter:string ) { 
            templates {
                ranger ( "( strsplit " (e 1) " " (e 2) " )")
                ; TODO: C++ version, requires perhaps external lib to do it directly to vector<std::string>
                scala ( (e 1) ".split(" (e 2) ").to[collection.mutable.ArrayBuffer]")  
                csharp ( 
(create_polyfill 
"
  public static List<String>  __Split( String str, String token ) {
      if( token.Length == 0 ) {
        List<String> res = new List<String>();
        foreach (Char c in str) {
          res.Append( c.ToString() );
        }
        return res;
      }
      return ( (List<String>)str.Split(token[0]).ToList() );
  }

"

)                    
                    
                    "__Split(" (e 1) ", " (e 2) ")" (imp 'System.Linq'))
                swift3 ( (e 2) ".characters.count == 0 ? Array(" (e 1) ".characters).map { String($0) } : " (e 1) ".components( separatedBy : " (e 2) ")" (imp "Foundation"))
                swift6 ( (e 2) ".count == 0 ? Array(" (e 1) ").map { String($0) } : " (e 1) ".components( separatedBy : " (e 2) ")" (imp "Foundation"))
                java7( "new ArrayList<String>(Arrays.asList(" (e 1) ".split(" (e 2) ")))" )
                php ( "strlen(" (e 2) ") == 0 ? str_split(" (e 1) ") : " "explode(" (e 2) ", " (e 1) ")")               
                go ("strings.Split(" (e 1) ", " (e 2) ")" (imp "strings"))

                cpp ( "r_str_split( " (e 1) ", " (e 2) ")"          (imp "<sstream>") (imp "<iterator>")

(create_polyfill
"
std::vector<std::string> r_str_split(std::string data, std::string token) {
    std::vector<std::string> output;
    size_t pos = std::string::npos; 
    if(token.length() == 0) {
        for(std::string::iterator it = data.begin(); it != data.end(); ++it) {
            output.push_back( std::string( it, it + 1) );
        }        
        return output;
    }
    do
    {
        pos = data.find(token);
        output.push_back(data.substr(0, pos));
        if (std::string::npos != pos)
            data = data.substr(pos + token.size());
    } while (std::string::npos != pos);
    return output;
}
"
)   
                )

                python ( (e 1) ".split(" (e 2) ") if " (e 2) " else list(" (e 1) ")" )
                rust ( (e 1) ".split(&*" (e 2) ").map(|s| s.to_string()).collect::<Vec<String>>()" )
                * ( (e 1) ".split(" (e 2) ")")
            }
        }

        strlen       cmdStrlen:int       ( text:string ) { 
            templates {
                ranger ( "( strlen (" (e 1 ) "))")
                cpp ( '(int)('(e 1) ".length())") 
                java7 ( (e 1) ".length()") 
                scala ( (e 1) ".length()")  
                swift3 ( (e 1) ".characters.count")  
                swift6 ( (e 1) ".count")  
                csharp ( (e 1) ".Length")
                php ( "strlen(" (e 1) ")") 
                go ( "int64(len([]rune(" (e 1) ")))")
                python ( "len(" (e 1) ")")
                rust ( (e 1) ".chars().count() as i64")
                * ( (e 1) ".length")
            }
        }

        ; String s = new String(a, 2, 4)
        
        ; C#
        ; Encoding.ASCII.GetString(bytes)
        ; System.Buffer.BlockCopy(str.ToCharArray(), 0, bytes, 0, bytes.Length);
        ; new List<string>(Source).GetRange(2, 2).ToArray();

        ; scala:
        ; new String(array.map(_.toChar)))
        ; array.slice()

        ; swift:
        ; String(data: Data(bytes: s[sp ..< i]) , encoding: .utf8)!

        substring   cmdSubstring:string       ( text:charbuffer start:int end:int ) { 
            templates {
                ranger ( "(substring " (e 1) " " (e 2) " " (e 3) ")") 
                csharp ( "Encoding.UTF.GetString(new List<byte>(" (e 1) ").GetRange(" (e 2) ", " (e 3) ").toArray())")
                scala ( "new String(" (e 1) ".slice(" (e 2) ", " (e 3) ").map(_.toChar) )")
                java7 ( "new String(" (e 1) "," (e 2) ", " (e 3) " - " (e 2) " )")
                swift3 ( "String(data: Data(bytes:" (e 1) "[" (e 2) " ..< " (e 3) "]), encoding: .utf8)!"  (imp "Foundation"))
                swift6 ( "String(data: Data(" (e 1) "[" (e 2) " ..< " (e 3) "]), encoding: .utf8)!"  (imp "Foundation"))
                kotlin ( "String(" (e 1) "," (e 2) ", " (e 3) " - " (e 2) " )")           
                go ( "fmt.Sprintf(\"%s\", " (e 1) "[" (e 2) ":" (e 3) "])"               
                 (imp "fmt")
                )
                cpp ( "std::string( " (e 1) " + " (e 2) ", " (e 3) " - " (e 2) " )")
                php ( "substr(" (e 1) ", " (e 2) ", " (e 3) " - " (e 2) ")") 
                * ( (e 1) ".substring(" (e 2) ", " (e 3) " )")
            }
        }

        to_string bufferToString:string       ( text:charbuffer ) { 
            templates {      
                ranger ( "(to_string " (e 1) ")")
                go ( "string(" (e 1) ")" )
                * ( (e 1) )
            }
        }     

        toString   bufferToString:string       ( text:charbuffer ) { 
            templates {      
                go ( "string(" (e 1) ")" )
                * ( (e 1) )
            }
        }        

        to_charbuffer      cmdToCharBuffer:charbuffer       ( text:string ) { 
            templates {
                ranger ( "(to_charbuffer " (e 1) ")") 
                swift3 ( "Array(" (e 1) ".utf8)" )
                scala ( (e 1) ".toCharArray.map(_.toByte)")
                java7 ( (e 1) ".getBytes()" )
                csharp ( "Encoding.ASCII.GetBytes(" (e 1) ")")
                kotlin ( (e 1 ) ".toCharArray()" )
                rust ( (e 1) ".into_bytes()")
                cpp ( (e 1) ".c_str()")
                php ( (e 1) )
                go("[]byte(" (e 1) ")")
                * ( (e 1) )
            }
        }

        ; ============================================================================
        ; BINARY BUFFER OPERATIONS
        ; ============================================================================
        ; These operators provide cross-platform binary buffer manipulation.
        ; The 'buffer' type maps to: ArrayBuffer (JS), []byte (Go), Vec<u8> (Rust),
        ; std::vector<uint8_t> (C++), byte[] (Java), bytearray (Python)
        ; ============================================================================

        ; Allocate a new buffer of specified size (zero-filled)
        buffer_alloc    cmdBufferAlloc:buffer    ( size:int ) {
            templates {
                ranger ( "(buffer_alloc " (e 1) ")" )
                es6 ( "(function(){ var b = new ArrayBuffer(" (e 1) "); b._view = new DataView(b); return b; })()" )
                go ( "make([]byte, " (e 1) ")" )
                rust ( "vec![0u8; " (e 1) " as usize]" )
                cpp ( "std::vector<uint8_t>(" (e 1) ", 0)" (imp "<vector>") (imp "<cstdint>") )
                java7 ( "new byte[(int)" (e 1) "]" )
                python ( "bytearray(" (e 1) ")" )
                swift6 ( "[UInt8](repeating: 0, count: Int(" (e 1) "))" )
                csharp ( "new byte[" (e 1) "]" )
            }
        }

        ; Get the length of a buffer in bytes
        buffer_length   cmdBufferLength:int      ( buf:buffer ) {
            templates {
                ranger ( "(buffer_length " (e 1) ")" )
                es6 ( (e 1) ".byteLength" )
                go ( "int64(len(" (e 1) "))" )
                rust ( (e 1) ".len() as i64" )
                cpp ( "static_cast<int64_t>(" (e 1) ".size())" )
                java7 ( (e 1) ".length" )
                python ( "len(" (e 1) ")" )
                swift6 ( "Int64(" (e 1) ".count)" )
                csharp ( (e 1) ".Length" )
            }
        }

        ; Read a single byte at offset (returns 0-255)
        buffer_get      cmdBufferGet:int         ( buf:buffer offset:int ) {
            templates {
                ranger ( "(buffer_get " (e 1) " " (e 2) ")" )
                es6 ( (e 1) "._view.getUint8(" (e 2) ")" )
                go ( "int64(" (e 1) "[" (e 2) "])" )
                rust ( (e 1) "[(" (e 2) ") as usize] as i64" )
                cpp ( "static_cast<int64_t>(" (e 1) "[" (e 2) "])" )
                java7 ( "((" (e 1) "[(int)" (e 2) "] & 0xFF))" )
                python ( (e 1) "[" (e 2) "]" )
                swift6 ( "Int64(" (e 1) "[Int(" (e 2) ")])" )
                csharp ( "((int)" (e 1) "[" (e 2) "])" )
            }
        }

        ; Write a single byte at offset (value should be 0-255)
        buffer_set      cmdBufferSet:void        ( buf:buffer offset:int value:int ) {
            templates {
                ranger ( "(buffer_set " (e 1) " " (e 2) " " (e 3) ")" )
                es6 ( (e 1) "._view.setUint8(" (e 2) ", " (e 3) ")" )
                go ( (e 1) "[" (e 2) "] = byte(" (e 3) ")" )
                rust ( (e 1) "[(" (e 2) ") as usize] = " (e 3) " as u8" )
                cpp ( (e 1) "[" (e 2) "] = static_cast<uint8_t>(" (e 3) ")" )
                java7 ( (e 1) "[(int)" (e 2) "] = (byte)" (e 3) )
                python ( (e 1) "[" (e 2) "] = " (e 3) )
                swift6 ( (e 1) "[Int(" (e 2) ")] = UInt8(" (e 3) ")" )
                csharp ( (e 1) "[" (e 2) "] = (byte)" (e 3) )
            }
        }

        ; Convert string to buffer (UTF-8 encoded)
        buffer_from_string  cmdBufferFromString:buffer  ( str:string ) {
            templates {
                ranger ( "(buffer_from_string " (e 1) ")" )
                es6 ( "(function(s){ var b = new ArrayBuffer(s.length); var v = new Uint8Array(b); for(var i=0;i<s.length;i++)v[i]=s.charCodeAt(i); b._view = new DataView(b); return b; })(" (e 1) ")" )
                go ( "[]byte(" (e 1) ")" )
                rust ( (e 1) ".as_bytes().to_vec()" )
                cpp ( "std::vector<uint8_t>(" (e 1) ".begin(), " (e 1) ".end())" )
                java7 ( (e 1) ".getBytes(java.nio.charset.StandardCharsets.UTF_8)" )
                python ( "bytearray(" (e 1) ", 'utf-8')" )
                swift6 ( "Array(" (e 1) ".utf8)" )
                csharp ( "System.Text.Encoding.UTF8.GetBytes(" (e 1) ")" )
            }
        }

        ; Convert buffer to string (UTF-8 decoded)
        buffer_to_string    cmdBufferToString:string    ( buf:buffer ) {
            templates {
                ranger ( "(buffer_to_string " (e 1) ")" )
                es6 ( "(function(b){ var v = new Uint8Array(b); return String.fromCharCode.apply(null, v); })(" (e 1) ")" )
                go ( "string(" (e 1) ")" )
                rust ( "String::from_utf8_lossy(&" (e 1) ").to_string()" )
                cpp ( "std::string(" (e 1) ".begin(), " (e 1) ".end())" )
                java7 ( "new String(" (e 1) ", java.nio.charset.StandardCharsets.UTF_8)" )
                python ( (e 1) ".decode('utf-8')" )
                swift6 ( "String(bytes: " (e 1) ", encoding: .utf8) ?? \"\"" )
                csharp ( "System.Text.Encoding.UTF8.GetString(" (e 1) ")" )
            }
        }

        ; Convert buffer to Base64 encoded string
        buffer_to_base64    cmdBufferToBase64:string    ( buf:buffer ) {
            templates {
                ranger ( "(buffer_to_base64 " (e 1) ")" )
                es6 ( "Buffer.from(" (e 1) ").toString('base64')" )
                go ( "base64.StdEncoding.EncodeToString(" (e 1) ")" (imp "encoding/base64") )
                rust ( "base64::encode(&" (e 1) ")" )
                cpp ( "r_buffer_to_base64(" (e 1) ")" (imp "<string>") (imp "<vector>")
(create_polyfill "
std::string r_buffer_to_base64(const std::vector<uint8_t>& data) {
    static const char* chars = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\";
    std::string result;
    size_t i = 0;
    while (i < data.size()) {
        uint32_t n = data[i++] << 16;
        if (i < data.size()) n |= data[i++] << 8;
        if (i < data.size()) n |= data[i++];
        result += chars[(n >> 18) & 0x3F];
        result += chars[(n >> 12) & 0x3F];
        result += (i > data.size() + 1) ? '=' : chars[(n >> 6) & 0x3F];
        result += (i > data.size()) ? '=' : chars[n & 0x3F];
    }
    return result;
}
")
                )
                java7 ( "java.util.Base64.getEncoder().encodeToString(" (e 1) ")" )
                python ( "base64.b64encode(" (e 1) ").decode('ascii')" (imp "base64") )
                swift6 ( "Data(" (e 1) ").base64EncodedString()" (imp "Foundation") )
                csharp ( "Convert.ToBase64String(" (e 1) ")" )
            }
        }

        ; Write buffer to a binary file
        buffer_write_file   cmdBufferWriteFile:void     ( path:string filename:string buf:buffer ) {
            templates {
                ranger ( "(buffer_write_file " (e 1) " " (e 2) " " (e 3) ")" )
                es6 ( "require('fs').writeFileSync(" (e 1) " + '/' + " (e 2) ", Buffer.from(" (e 3) "))" )
                go ( "os.WriteFile(" (e 1) " + \"/\" + " (e 2) ", " (e 3) ", 0644)" (imp "os") )
                rust ( "std::fs::write(format!(\"{}/{}\", " (e 1) ", " (e 2) "), &" (e 3) ").unwrap()" )
                cpp ( "r_buffer_write_file(" (e 1) ", " (e 2) ", " (e 3) ")" (imp "<fstream>") (imp "<vector>")
(create_polyfill "
void r_buffer_write_file(const std::string& path, const std::string& filename, const std::vector<uint8_t>& data) {
    std::ofstream file(path + \"/\" + filename, std::ios::binary);
    file.write(reinterpret_cast<const char*>(data.data()), data.size());
}
")
                )
                java7 ( "java.nio.file.Files.write(java.nio.file.Paths.get(" (e 1) " + \"/\" + " (e 2) "), " (e 3) ")" )
                python ( "open(" (e 1) " + '/' + " (e 2) ", 'wb').write(" (e 3) ")" )
                swift6 ( "try? Data(" (e 3) ").write(to: URL(fileURLWithPath: " (e 1) " + \"/\" + " (e 2) "))" (imp "Foundation") )
                csharp ( "System.IO.File.WriteAllBytes(" (e 1) " + \"/\" + " (e 2) ", " (e 3) ")" )
            }
        }

        ; Read a binary file into a buffer
        buffer_read_file    cmdBufferReadFile:buffer    ( path:string filename:string ) {
            templates {
                ranger ( "(buffer_read_file " (e 1) " " (e 2) ")" )
                es6 ( "(function(){ var b = require('fs').readFileSync(" (e 1) " + '/' + " (e 2) "); var ab = new ArrayBuffer(b.length); var v = new Uint8Array(ab); for(var i=0;i<b.length;i++)v[i]=b[i]; ab._view = new DataView(ab); return ab; })()" )
                go ( "func() []byte { d, _ := os.ReadFile(filepath.Join(" (e 1) ", " (e 2) ")); return d }()" (imp "os") (imp "path/filepath") )
                rust ( "std::fs::read(format!(\"{}/{}\", " (e 1) ", " (e 2) ")).unwrap_or_default()" )
                cpp ( "r_buffer_read_file(" (e 1) ", " (e 2) ")" (imp "<fstream>") (imp "<vector>") (imp "<iterator>")
(create_polyfill "
std::vector<uint8_t> r_buffer_read_file(const std::string& path, const std::string& filename) {
    std::ifstream file(path + \"/\" + filename, std::ios::binary);
    return std::vector<uint8_t>(std::istreambuf_iterator<char>(file), std::istreambuf_iterator<char>());
}
")
                )
                java7 ( "java.nio.file.Files.readAllBytes(java.nio.file.Paths.get(" (e 1) " + \"/\" + " (e 2) "))" )
                python ( "bytearray(open(" (e 1) " + '/' + " (e 2) ", 'rb').read())" )
                swift6 ( "(try? Data(contentsOf: URL(fileURLWithPath: " (e 1) " + \"/\" + " (e 2) "))).map { Array($0) } ?? []" (imp "Foundation") )
                csharp ( "System.IO.File.ReadAllBytes(" (e 1) " + \"/\" + " (e 2) ")" )
            }
        }

        ; Copy bytes from source buffer to destination buffer
        buffer_copy     cmdBufferCopy:void       ( dest:buffer destOffset:int src:buffer srcOffset:int length:int ) {
            templates {
                ranger ( "(buffer_copy " (e 1) " " (e 2) " " (e 3) " " (e 4) " " (e 5) ")" )
                es6 ( "(function(d,dOff,s,sOff,len){ var dv = new Uint8Array(d); var sv = new Uint8Array(s); for(var i=0;i<len;i++) dv[dOff+i]=sv[sOff+i]; })(" (e 1) "," (e 2) "," (e 3) "," (e 4) "," (e 5) ")" )
                go ( "copy(" (e 1) "[" (e 2) ":], " (e 3) "[" (e 4) ":" (e 4) "+" (e 5) "])" )
                rust ( (e 1) "[" (e 2) " as usize..(" (e 2) "+" (e 5) ") as usize].copy_from_slice(&" (e 3) "[" (e 4) " as usize..(" (e 4) "+" (e 5) ") as usize])" )
                cpp ( "std::copy(" (e 3) ".begin()+" (e 4) ", " (e 3) ".begin()+" (e 4) "+" (e 5) ", " (e 1) ".begin()+" (e 2) ")" (imp "<algorithm>") )
                java7 ( "System.arraycopy(" (e 3) ", (int)" (e 4) ", " (e 1) ", (int)" (e 2) ", (int)" (e 5) ")" )
                python ( (e 1) "[" (e 2) ":" (e 2) "+" (e 5) "] = " (e 3) "[" (e 4) ":" (e 4) "+" (e 5) "]" )
                swift6 ( (e 1) ".replaceSubrange(Int(" (e 2) ")..<Int(" (e 2) "+" (e 5) "), with: " (e 3) "[Int(" (e 4) ")..<Int(" (e 4) "+" (e 5) ")])" )
                csharp ( "Array.Copy(" (e 3) ", (int)" (e 4) ", " (e 1) ", (int)" (e 2) ", (int)" (e 5) ")" )
            }
        }

        ; Fill buffer with a byte value
        buffer_fill     cmdBufferFill:void       ( buf:buffer value:int start:int end:int ) {
            templates {
                ranger ( "(buffer_fill " (e 1) " " (e 2) " " (e 3) " " (e 4) ")" )
                es6 ( "(function(b,v,s,e){ var arr = new Uint8Array(b); for(var i=s;i<e;i++) arr[i]=v; })(" (e 1) "," (e 2) "," (e 3) "," (e 4) ")" )
                go ( "for i := " (e 3) "; i < " (e 4) "; i++ { " (e 1) "[i] = byte(" (e 2) ") }" )
                rust ( (e 1) "[" (e 3) " as usize.." (e 4) " as usize].fill(" (e 2) " as u8)" )
                cpp ( "std::fill(" (e 1) ".begin()+" (e 3) ", " (e 1) ".begin()+" (e 4) ", static_cast<uint8_t>(" (e 2) "))" (imp "<algorithm>") )
                java7 ( "java.util.Arrays.fill(" (e 1) ", (int)" (e 3) ", (int)" (e 4) ", (byte)" (e 2) ")" )
                python ( (e 1) "[" (e 3) ":" (e 4) "] = [" (e 2) "] * (" (e 4) " - " (e 3) ")" )
                swift6 ( (e 1) ".replaceSubrange(Int(" (e 3) ")..<Int(" (e 4) "), with: repeatElement(UInt8(" (e 2) "), count: Int(" (e 4) "-" (e 3) ")))" )
                csharp ( "Array.Fill(" (e 1) ", (byte)" (e 2) ", (int)" (e 3) ", (int)(" (e 4) "-" (e 3) "))" )
            }
        }

        ; Create a slice/copy of a buffer range
        buffer_slice    cmdBufferSlice:buffer    ( buf:buffer start:int end:int ) {
            templates {
                ranger ( "(buffer_slice " (e 1) " " (e 2) " " (e 3) ")" )
                es6 ( "(function(b,s,e){ var slice = b.slice(s,e); slice._view = new DataView(slice); return slice; })(" (e 1) "," (e 2) "," (e 3) ")" )
                go ( "append([]byte{}, " (e 1) "[" (e 2) ":" (e 3) "]...)" )
                rust ( (e 1) "[" (e 2) " as usize.." (e 3) " as usize].to_vec()" )
                cpp ( "std::vector<uint8_t>(" (e 1) ".begin()+" (e 2) ", " (e 1) ".begin()+" (e 3) ")" )
                java7 ( "java.util.Arrays.copyOfRange(" (e 1) ", (int)" (e 2) ", (int)" (e 3) ")" )
                python ( "bytearray(" (e 1) "[" (e 2) ":" (e 3) "])" )
                swift6 ( "Array(" (e 1) "[Int(" (e 2) ")..<Int(" (e 3) ")])" )
                csharp ( (e 1) "[((int)" (e 2) ")..((int)" (e 3) ")]" )
            }
        }

        ; ============================================================================
        ; INT_BUFFER TYPE - Fixed-size integer array for performance-critical code
        ; ============================================================================
        ; Similar to buffer but for int64 values instead of bytes.
        ; Use for lookup tables, IDCT coefficients, etc. where size is known at init.
        ; Go: []int64, C++: std::vector<int64_t>, ES6: Int32Array, etc.
        ; ============================================================================

        ; Allocate a new int_buffer of specified size (zero-filled)
        int_buffer_alloc    cmdIntBufferAlloc:int_buffer    ( size:int ) {
            templates {
                ranger ( "(int_buffer_alloc " (e 1) ")" )
                es6 ( "new Int32Array(" (e 1) ")" )
                go ( "make([]int64, " (e 1) ")" )
                rust ( "vec![0i64; " (e 1) " as usize]" )
                cpp ( "std::vector<int64_t>(" (e 1) ", 0)" (imp "<vector>") (imp "<cstdint>") )
                java7 ( "new long[(int)" (e 1) "]" )
                python ( "[0] * " (e 1) )
                swift6 ( "[Int64](repeating: 0, count: Int(" (e 1) "))" )
                csharp ( "new long[" (e 1) "]" )
            }
        }

        ; Get the length of an int_buffer
        int_buffer_length   cmdIntBufferLength:int      ( buf:int_buffer ) {
            templates {
                ranger ( "(int_buffer_length " (e 1) ")" )
                es6 ( (e 1) ".length" )
                go ( "int64(len(" (e 1) "))" )
                rust ( (e 1) ".len() as i64" )
                cpp ( "static_cast<int64_t>(" (e 1) ".size())" )
                java7 ( (e 1) ".length" )
                python ( "len(" (e 1) ")" )
                swift6 ( "Int64(" (e 1) ".count)" )
                csharp ( (e 1) ".Length" )
            }
        }

        ; Read an int64 at index
        int_buffer_get      cmdIntBufferGet:int         ( buf:int_buffer index:int ) {
            templates {
                ranger ( "(int_buffer_get " (e 1) " " (e 2) ")" )
                es6 ( (e 1) "[" (e 2) "]" )
                go ( (e 1) "[" (e 2) "]" )
                rust ( (e 1) "[(" (e 2) ") as usize]" )
                cpp ( (e 1) "[" (e 2) "]" )
                java7 ( (e 1) "[(int)" (e 2) "]" )
                python ( (e 1) "[" (e 2) "]" )
                swift6 ( (e 1) "[Int(" (e 2) ")]" )
                csharp ( (e 1) "[" (e 2) "]" )
            }
        }

        ; Write an int64 at index
        int_buffer_set      cmdIntBufferSet:void        ( buf:int_buffer index:int value:int ) {
            templates {
                ranger ( "(int_buffer_set " (e 1) " " (e 2) " " (e 3) ")" )
                es6 ( (e 1) "[" (e 2) "] = " (e 3) )
                go ( (e 1) "[" (e 2) "] = " (e 3) )
                rust ( (e 1) "[(" (e 2) ") as usize] = " (e 3) )
                cpp ( (e 1) "[" (e 2) "] = " (e 3) )
                java7 ( (e 1) "[(int)" (e 2) "] = " (e 3) )
                python ( (e 1) "[" (e 2) "] = " (e 3) )
                swift6 ( (e 1) "[Int(" (e 2) ")] = " (e 3) )
                csharp ( (e 1) "[" (e 2) "] = " (e 3) )
            }
        }

        ; Fill int_buffer with a value in range [start, end)
        int_buffer_fill     cmdIntBufferFill:void       ( buf:int_buffer value:int start:int end:int ) {
            templates {
                ranger ( "(int_buffer_fill " (e 1) " " (e 2) " " (e 3) " " (e 4) ")" )
                es6 ( (e 1) ".fill(" (e 2) ", " (e 3) ", " (e 4) ")" )
                go ( "for i := " (e 3) "; i < " (e 4) "; i++ { " (e 1) "[i] = " (e 2) " }" )
                rust ( (e 1) "[" (e 3) " as usize.." (e 4) " as usize].fill(" (e 2) ")" )
                cpp ( "std::fill(" (e 1) ".begin()+" (e 3) ", " (e 1) ".begin()+" (e 4) ", " (e 2) ")" (imp "<algorithm>") )
                java7 ( "java.util.Arrays.fill(" (e 1) ", (int)" (e 3) ", (int)" (e 4) ", " (e 2) ")" )
                python ( (e 1) "[" (e 3) ":" (e 4) "] = [" (e 2) "] * (" (e 4) " - " (e 3) ")" )
                swift6 ( (e 1) ".replaceSubrange(Int(" (e 3) ")..<Int(" (e 4) "), with: repeatElement(" (e 2) ", count: Int(" (e 4) "-" (e 3) ")))" )
                csharp ( "Array.Fill(" (e 1) ", " (e 2) ", (int)" (e 3) ", (int)(" (e 4) "-" (e 3) "))" )
            }
        }

        ; Copy ints from source to destination
        int_buffer_copy     cmdIntBufferCopy:void       ( dest:int_buffer destOffset:int src:int_buffer srcOffset:int length:int ) {
            templates {
                ranger ( "(int_buffer_copy " (e 1) " " (e 2) " " (e 3) " " (e 4) " " (e 5) ")" )
                es6 ( (e 1) ".set(" (e 3) ".subarray(" (e 4) ", " (e 4) "+" (e 5) "), " (e 2) ")" )
                go ( "copy(" (e 1) "[" (e 2) ":], " (e 3) "[" (e 4) ":" (e 4) "+" (e 5) "])" )
                rust ( (e 1) "[" (e 2) " as usize..(" (e 2) "+" (e 5) ") as usize].copy_from_slice(&" (e 3) "[" (e 4) " as usize..(" (e 4) "+" (e 5) ") as usize])" )
                cpp ( "std::copy(" (e 3) ".begin()+" (e 4) ", " (e 3) ".begin()+" (e 4) "+" (e 5) ", " (e 1) ".begin()+" (e 2) ")" (imp "<algorithm>") )
                java7 ( "System.arraycopy(" (e 3) ", (int)" (e 4) ", " (e 1) ", (int)" (e 2) ", (int)" (e 5) ")" )
                python ( (e 1) "[" (e 2) ":" (e 2) "+" (e 5) "] = " (e 3) "[" (e 4) ":" (e 4) "+" (e 5) "]" )
                swift6 ( (e 1) ".replaceSubrange(Int(" (e 2) ")..<Int(" (e 2) "+" (e 5) "), with: " (e 3) "[Int(" (e 4) ")..<Int(" (e 4) "+" (e 5) ")])" )
                csharp ( "Array.Copy(" (e 3) ", (int)" (e 4) ", " (e 1) ", (int)" (e 2) ", (int)" (e 5) ")" )
            }
        }

        ; TODO: int_buffer_from requires variadic argument support in Ranger operators
        ; Create int_buffer from literal values - for cleaner initialization of lookup tables
        ; Usage: def cosTable:int_buffer (int_buffer_from 1024 1004 946 851 724 569 392 200)
        ; int_buffer_from    cmdIntBufferFrom:int_buffer    ( listOf:expression ) {
        ;     templates {
        ;         ranger ( "(int_buffer_from " (list 1) ")" )
        ;         es6 ( "new Int32Array([" (comma 1) "])" )
        ;         go ( "[]int64{" (comma 1) "}" )
        ;         rust ( "vec![" (comma 1) "]" )
        ;         cpp ( "std::vector<int64_t>{" (comma 1) "}" (imp "<vector>") (imp "<cstdint>") )
        ;         java7 ( "new long[]{" (comma 1) "}" )
        ;         python ( "[" (comma 1) "]" )
        ;         swift6 ( "[" (comma 1) "] as [Int64]" )
        ;         csharp ( "new long[]{" (comma 1) "}" )
        ;     }
        ; }

        ; ============================================================================
        ; DOUBLE_BUFFER TYPE - Fixed-size float64 array for performance-critical code
        ; ============================================================================
        ; Similar to int_buffer but for float64/double values.
        ; Use for DSP, signal processing, matrix operations, etc.
        ; Go: []float64, C++: std::vector<double>, ES6: Float64Array, etc.
        ; ============================================================================

        ; Allocate a new double_buffer of specified size (zero-filled)
        double_buffer_alloc    cmdDoubleBufferAlloc:double_buffer    ( size:int ) {
            templates {
                ranger ( "(double_buffer_alloc " (e 1) ")" )
                es6 ( "new Float64Array(" (e 1) ")" )
                go ( "make([]float64, " (e 1) ")" )
                rust ( "vec![0.0f64; " (e 1) " as usize]" )
                cpp ( "std::vector<double>(" (e 1) ", 0.0)" (imp "<vector>") )
                java7 ( "new double[(int)" (e 1) "]" )
                python ( "[0.0] * " (e 1) )
                swift6 ( "[Double](repeating: 0.0, count: Int(" (e 1) "))" )
                csharp ( "new double[" (e 1) "]" )
            }
        }

        ; Get the length of a double_buffer
        double_buffer_length   cmdDoubleBufferLength:int      ( buf:double_buffer ) {
            templates {
                ranger ( "(double_buffer_length " (e 1) ")" )
                es6 ( (e 1) ".length" )
                go ( "int64(len(" (e 1) "))" )
                rust ( (e 1) ".len() as i64" )
                cpp ( "static_cast<int64_t>(" (e 1) ".size())" )
                java7 ( (e 1) ".length" )
                python ( "len(" (e 1) ")" )
                swift6 ( "Int64(" (e 1) ".count)" )
                csharp ( (e 1) ".Length" )
            }
        }

        ; Read a double at index
        double_buffer_get      cmdDoubleBufferGet:double         ( buf:double_buffer index:int ) {
            templates {
                ranger ( "(double_buffer_get " (e 1) " " (e 2) ")" )
                es6 ( (e 1) "[" (e 2) "]" )
                go ( (e 1) "[" (e 2) "]" )
                rust ( (e 1) "[(" (e 2) ") as usize]" )
                cpp ( (e 1) "[" (e 2) "]" )
                java7 ( (e 1) "[(int)" (e 2) "]" )
                python ( (e 1) "[" (e 2) "]" )
                swift6 ( (e 1) "[Int(" (e 2) ")]" )
                csharp ( (e 1) "[" (e 2) "]" )
            }
        }

        ; Write a double at index
        double_buffer_set      cmdDoubleBufferSet:void        ( buf:double_buffer index:int value:double ) {
            templates {
                ranger ( "(double_buffer_set " (e 1) " " (e 2) " " (e 3) ")" )
                es6 ( (e 1) "[" (e 2) "] = " (e 3) )
                go ( (e 1) "[" (e 2) "] = " (e 3) )
                rust ( (e 1) "[(" (e 2) ") as usize] = " (e 3) )
                cpp ( (e 1) "[" (e 2) "] = " (e 3) )
                java7 ( (e 1) "[(int)" (e 2) "] = " (e 3) )
                python ( (e 1) "[" (e 2) "] = " (e 3) )
                swift6 ( (e 1) "[Int(" (e 2) ")] = " (e 3) )
                csharp ( (e 1) "[" (e 2) "] = " (e 3) )
            }
        }

        ; Fill double_buffer with a value in range [start, end)
        double_buffer_fill     cmdDoubleBufferFill:void       ( buf:double_buffer value:double start:int end:int ) {
            templates {
                ranger ( "(double_buffer_fill " (e 1) " " (e 2) " " (e 3) " " (e 4) ")" )
                es6 ( (e 1) ".fill(" (e 2) ", " (e 3) ", " (e 4) ")" )
                go ( "for i := " (e 3) "; i < " (e 4) "; i++ { " (e 1) "[i] = " (e 2) " }" )
                rust ( (e 1) "[" (e 3) " as usize.." (e 4) " as usize].fill(" (e 2) ")" )
                cpp ( "std::fill(" (e 1) ".begin()+" (e 3) ", " (e 1) ".begin()+" (e 4) ", " (e 2) ")" (imp "<algorithm>") )
                java7 ( "java.util.Arrays.fill(" (e 1) ", (int)" (e 3) ", (int)" (e 4) ", " (e 2) ")" )
                python ( (e 1) "[" (e 3) ":" (e 4) "] = [" (e 2) "] * (" (e 4) " - " (e 3) ")" )
                swift6 ( (e 1) ".replaceSubrange(Int(" (e 3) ")..<Int(" (e 4) "), with: repeatElement(" (e 2) ", count: Int(" (e 4) "-" (e 3) ")))" )
                csharp ( "Array.Fill(" (e 1) ", " (e 2) ", (int)" (e 3) ", (int)(" (e 4) "-" (e 3) "))" )
            }
        }

        ; Copy doubles from source to destination
        double_buffer_copy     cmdDoubleBufferCopy:void       ( dest:double_buffer destOffset:int src:double_buffer srcOffset:int length:int ) {
            templates {
                ranger ( "(double_buffer_copy " (e 1) " " (e 2) " " (e 3) " " (e 4) " " (e 5) ")" )
                es6 ( (e 1) ".set(" (e 3) ".subarray(" (e 4) ", " (e 4) "+" (e 5) "), " (e 2) ")" )
                go ( "copy(" (e 1) "[" (e 2) ":], " (e 3) "[" (e 4) ":" (e 4) "+" (e 5) "])" )
                rust ( (e 1) "[" (e 2) " as usize..(" (e 2) "+" (e 5) ") as usize].copy_from_slice(&" (e 3) "[" (e 4) " as usize..(" (e 4) "+" (e 5) ") as usize])" )
                cpp ( "std::copy(" (e 3) ".begin()+" (e 4) ", " (e 3) ".begin()+" (e 4) "+" (e 5) ", " (e 1) ".begin()+" (e 2) ")" (imp "<algorithm>") )
                java7 ( "System.arraycopy(" (e 3) ", (int)" (e 4) ", " (e 1) ", (int)" (e 2) ", (int)" (e 5) ")" )
                python ( (e 1) "[" (e 2) ":" (e 2) "+" (e 5) "] = " (e 3) "[" (e 4) ":" (e 4) "+" (e 5) "]" )
                swift6 ( (e 1) ".replaceSubrange(Int(" (e 2) ")..<Int(" (e 2) "+" (e 5) "), with: " (e 3) "[Int(" (e 4) ")..<Int(" (e 4) "+" (e 5) ")])" )
                csharp ( "Array.Copy(" (e 3) ", (int)" (e 4) ", " (e 1) ", (int)" (e 2) ", (int)" (e 5) ")" )
            }
        }

        ; TODO: double_buffer_from requires variadic argument support in Ranger operators
        ; Create double_buffer from literal values - for cleaner initialization of lookup tables
        ; Usage: def table:double_buffer (double_buffer_from 1.0 2.0 3.0 4.0)
        ; double_buffer_from    cmdDoubleBufferFrom:double_buffer    ( listOf:expression ) {
        ;     templates {
        ;         ranger ( "(double_buffer_from " (list 1) ")" )
        ;         es6 ( "new Float64Array([" (comma 1) "])" )
        ;         go ( "[]float64{" (comma 1) "}" )
        ;         rust ( "vec![" (comma 1) "]" )
        ;         cpp ( "std::vector<double>{" (comma 1) "}" (imp "<vector>") )
        ;         java7 ( "new double[]{" (comma 1) "}" )
        ;         python ( "[" (comma 1) "]" )
        ;         swift6 ( "[" (comma 1) "] as [Double]" )
        ;         csharp ( "new double[]{" (comma 1) "}" )
        ;     }
        ; }

        to_int      cmdToInt:int       ( value:double ) { 
            templates {
                ranger ( "(to_int " (e 1) ")") 
                csharp ( "(int)" (e 1 ) "" )
                swift3 ( "Int(" (e 1 ) ")" )
                kotlin ( (e 1 ) ".toInt()" )
                scala ( (e 1 ) ".toInt" )
                rust ( (e 1 ) " as i64 " )
                go ( "int64(" (e 1) ")")
                php ( "floor(" (e 1) ")")
                java7 ( "Double.valueOf(" (e 1) ").intValue()")
                cpp ( "(int)floor( " (e 1) ")" (imp "<math.h>"))
                * ( "Math.floor( " (e 1) ")" )
            }
        }        

        to_int      cmdToInt:int       ( ch:char ) { 
            templates {
                ranger ( "(to_int " (e 1) ")") 
                csharp ( "(int)" (e 1 ) "" )
                swift3 ( "Int(" (e 1 ) ")" )
                kotlin ( (e 1 ) ".toInt()" )
                scala ( (e 1 ) ".toInt" )
                rust ( (e 1 ) " as i64 " )
                go ( "int64(" (e 1) ")")
                php ( (e 1) )
                * ( (e 1) )
            }
        }        
        
        to_int cmdToInt@(optional):int (txt:string) {
            templates {
                * @macro(true) ("str2int(" (e 1) ")")
            }
        }

        ; Length
        length      cmdLength:int       ( buffer:charbuffer ) { 
            templates {
                ranger ( "(length " (e 1) ")") 
                csharp ( (e 1 ) ".Length" )
                kotlin ( (e 1 ) ".size" )
                scala ( (e 1 ) ".length" )
                swift3 ( (e 1 ) ".count" )
                rust ( (e 1 ) ".len()" )
                java7 ( (e 1 ) ".length" )
                cpp( "strlen( " (e 1) " )" (imp "<cstring>"))
                go ( "int64(len(" (e 1 ) "))")
                php ( "strlen(" (e 1 ) ")")
                * ( (e 1) ".length" )
            }
        }          

        substring      _:string       ( text:string position:int ) {
            templates {
                ramger ('(end ' (e 1) ' ' (e 2) ')' )
                * @macro(true) ('(substring '(e 1)' ' (e 2) ' (strlen ' (e 1) '))')
            } 
        }

        max _:int (left:int right:int) {
            templates {
                * @macro(true) ('(?  (' (e 1) ' < ' (e 2)' ) ' (e 2) ' ' (e 1) ')')
            }
        }


        at      _:string       ( text:string position:int ) { 
            templates {
                ranger ( '(at ' (e 1) ' ' ( e 2 ) ')')
                cpp ( 'r_utf8_char_at(' (e 1) ', ' (e 2) ')'
(create_polyfill '
std::string r_utf8_char_at(const std::string& str, int pos_i)
{
    unsigned int pos ((unsigned int)pos_i);
    unsigned int c, i, ix, q;
    for (q=0, i=0, ix=str.length(); i < ix; i++, q++)
    {
        if (q==pos){
            c = (unsigned char) str[i];
            int char_len = 1;
            if(c<=127) char_len = 1;
            else if ((c & 0xE0) == 0xC0) char_len = 2;
            else if ((c & 0xF0) == 0xE0) char_len = 3;
            else if ((c & 0xF8) == 0xF0) char_len = 4;
            else return "";
            return str.substr(i, char_len);
        }
        c = (unsigned char) str[i];
        if(c<=127) i+=0;
        else if ((c & 0xE0) == 0xC0) i+=1;
        else if ((c & 0xF0) == 0xE0) i+=2;
        else if ((c & 0xF8) == 0xF0) i+=3;
        else return "";
    }
    return "";
}
')
                )    
                csharp ( (e 1) ".Substring(" (e 2) ", 1)")
                php ( "substr(" (e 1) ", " (e 2) ", 1)")               
                java7 ( (e 1) ".substring(" (e 2) ", " (e 2) " + 1)")  
                kotlin ( (e 1) ".substring(" (e 2) ", " (e 2) " + 1)")  
                scala ( (e 1) "(" (e 2) ")")    
                go ( "string([]rune(" (e 1) ")[" (e 2) "])")  

                swift3 ( (imp 'Foundation') (e 1) "[" (e 1) ".index(" (e 1) ".startIndex, offsetBy:" (e 2) ")..<" (e 1) ".index(" (e 1) ".startIndex, offsetBy:" (e 2) " + 1)]" )
                swift6 ( "String(" (e 1) "[" (e 1) ".index(" (e 1) ".startIndex, offsetBy:" (e 2) ")])" )
                
                ; swift3 ( 'Int( ( NSString(string: ' (e 1) ' ) ).character( at: ' (e 2) ' ) )')
                ; swift3 ( (imp 'Foundation')  (e 1) '.substring(from: ' (e 1) '.index(' (e 1) '.startIndex, offsetBy: ' (e 2) ' + 1), to: ' (e 1) '.index(' (e 1) '.startIndex, offsetBy: ' (e 2) ' + 1))')    
                rust ( (e 1) ".chars().nth(" (e 2) " as usize).map(|c| c.to_string()).unwrap_or_default()")
                * ( (e 1) '[' (e 2) ']')
            }
        }                

        charAt      cmdCharAt:int       ( text:string position:int ) { 
            templates {
                ranger ( "(charAt " (e 1) " " ( e 2 ) ")")
                cpp ( (e 1) ".at(" (e 2) ")")    
                csharp ( (e 1) "[" (e 2) "]")
                php ( "ord(" (e 1) "[" (e 2) "])")               
                java7 ( "(int)" (e 1) ".charAt(" (e 2) ")")  
                kotlin ( (e 1) "[" (e 2) "]")    
                scala ( (e 1) "(" (e 2) ")")    
                go ( "int64([]rune(" (e 1) ")[" (e 2) "])")  
                swift3 ( "Int( ( NSString(string: " (e 1) " ) ).character( at: " (e 2) " ) )")
                swift3 ( "Int( String( " (e 1) ".characters[" (e 1) ".index(" (e 1) ".startIndex, offsetBy: " (e 2) ")]))!")
                swift6 ( "Int(" (e 1) "[" (e 1) ".index(" (e 1) ".startIndex, offsetBy: " (e 2) ")].asciiValue ?? 0)")
                python ( "ord(" (e 1) "[" (e 2) "])")
                rust ( (e 1) ".chars().nth(" (e 2) " as usize).unwrap_or('\\0') as i64")
                * ( (e 1) ".charCodeAt(" (e 2) " )")
            }
        }        

        ; https://stackoverflow.com/questions/41690156/how-to-get-the-keys-as-string-array-from-map-in-go-lang
        ; https://stackoverflow.com/questions/110157/how-to-retrieve-all-keys-or-values-from-a-stdmap-and-put-them-into-a-vector
        keys        _:[string]           ( map:[string:T] ) {
            templates {
                ranger ("(keys " (e 1) ")")
                java7 ( "new ArrayList<>(" (e 1) ".keySet())")
                swift3 ("Array(" (e 1) ".keys)")
                swift6 ("Array(" (e 1) ".keys)")
                scala ( (e 1) ".keys.to[collection.mutable.ArrayBuffer]")
                php ("array_keys(" (e 1) ")")
                es6 ( "Object.keys(" (e 1) ")")
                csharp ( "new List<String>(" (e 1) ".Keys)")
                python ( "list(" (e 1) ".keys())" )
                cpp (
                    "r_get_keys_of_map<" (r_atype 1) ">(" (e 1) ")"
(create_polyfill
"
template< typename T >
std::vector<std::string> r_get_keys_of_map(  std::map<std::string, T> orig_map )  { 
    std::vector<std::string> res;
    for(auto it = orig_map.begin(); it != orig_map.end(); ++it) {
        res.push_back(it->first);
    }
    return res;
}"  (imp "<string>") (imp "<vector>") (imp "<map>"))                  
                    

                )
                go ("(func() []string {" nl I
                        "keys := reflect.ValueOf(" (e 1) ").MapKeys()" nl
                        "strkeys := make([]string, len(keys))" nl
                        "for i := 0; i < len(keys); i++ {" nl I
                          "strkeys[i] = keys[i].String()" nl i "}" nl
                        "return strkeys" nl i "})()"
                    (imp "reflect"))
            }
        } 

        charAt      cmdCharAt:char       ( text:charbuffer position:int ) { 
            templates {
                ranger ( "(charAt " (e 1) " " ( e 2 ) ")")
                cpp ( (e 1) "[" (e 2) "]")    
                csharp ( (e 1) "[" (e 2) "]")
                php ( "ord(" (e 1) "[" (e 2) "])")               
                java7 ( (e 1) "[" (e 2) "]")  
                kotlin ( (e 1) "[" (e 2) "]")    
                scala ( (e 1) "(" (e 2) ")")    
                go ( (e 1) "[" (e 2) "]")  
                swift3 ( (e 1) "[" (e 2) "]")    
                * ( (e 1) ".charCodeAt(" (e 2) " )")
            }
        }

        substring   cmdSubstring:string       ( text:string start:int end:int ) { 
            templates {
                ranger ( '(substring ' (e 1) ' ' (e 2) ' ' (e 3) ')')
                cpp.old ( '' (e 1) '.substr(' (e 2) ', ' (e 3) ' - ' (e 2) ')' )
                cpp ( 'r_utf8_substr('(e 1) ', ' (e 2) ', ' (e 3) ' - ' (e 2) ')'
(create_polyfill '
std::string r_utf8_substr(const std::string& str, int start_i, int leng_i)
{
    unsigned int start ((unsigned int)start_i);
    unsigned int leng ((unsigned int)leng_i);
    if (leng==0) { return ""; }
    unsigned int c, i, ix, q, min= (unsigned int) std::string::npos, max=(unsigned int)std::string::npos;
    for (q=0, i=0, ix=str.length(); i < ix; i++, q++)
    {
        if (q==start){ min=i; }
        if (q<=start+leng || leng==std::string::npos){ max=i; }
        c = (unsigned char) str[i];
        if(c<=127) i+=0;
        else if ((c & 0xE0) == 0xC0) i+=1;
        else if ((c & 0xF0) == 0xE0) i+=2;
        else if ((c & 0xF8) == 0xF0) i+=3;
        else return ""; //invalid utf8
    }
    if (q<=start+leng || leng==std::string::npos){ max=i; }
    if (min==std::string::npos || max==std::string::npos) { return ""; }
    return str.substr(min, max - min);
}
')                
                
                )    
                csharp ( (e 1) ".Substring(" (e 2) ", " (e 3) " - " (e 2) " )")
                php ( "substr(" (e 1) ", " (e 2) ", " (e 3) " - " (e 2) ")")    
                go ( "string([]rune(" (e 1) ")[" (e 2) ":" (e 3) "])")               
                swift3 ( (e 1) "[" (e 1) ".index(" (e 1) ".startIndex, offsetBy:" (e 2) ")..<" (e 1) ".index(" (e 1) ".startIndex, offsetBy:" (e 3) ")]" )
                swift6 ( "String(" (e 1) "[" (e 1) ".index(" (e 1) ".startIndex, offsetBy:" (e 2) ")..<" (e 1) ".index(" (e 1) ".startIndex, offsetBy:" (e 3) ")])" )
                python ( (e 1) "[" (e 2) ":" (e 3) "]" )
                rust ( (e 1) ".chars().skip(" (e 2) " as usize).take((" (e 3) " - " (e 2) ") as usize).collect::<String>()")
                * ( (e 1) ".substring(" (e 2) ", " (e 3) " )")
            }
        }

        ;(charcode "A")
        charcode   cmdCharcode:char       ( text:string ) { 
            templates {
                ranger ( "(charcode " (e 1) ")")
                go ( "[]byte(" (e 1) ")[0]" )
                cpp( (e 1) ".at(0)")
                php ( "ord(" (e 1) ")") 
                java7 ( "((" (e 1) ".getBytes())[0])") 
                swift3 ( "UInt8( (  NSString(string: " (e 1) " )     ).character( at: 0 ) )" (imp "Foundation"))
                swift3 ( "UInt8( String( " (e 1) ".characters[" (e 1) ".startIndex]))! ")  
                * ( (e 1) ".charCodeAt(0)" )
            }
        }

        ccode       cmdCharCode:char ( text:string ) { 
            templates {
                * ( (cc 1) )
            }
        }

        strfromcode   cmdStrFromCode:string       ( code:char ) { 
            templates {
                ranger ( "(strfromcode " (e 1) ")")
                csharp ( "((char)" (e 1) ").toString()") 
                java7 ( "(new String( new char[] {" (e 1) " }))") 
                swift3 ( "(String( Character( UnicodeScalar(" (e 1) " ) )))") 
                php ( "chr(" (e 1) ")") 
                scala ( "(" (e 1) ".toChar)")      
                go ("string([]rune{rune(" (e 1) ")})")      
                cpp ( "std::string(1, char(" (e 1) "))") 
                rust ( "(char::from_u32(" (e 1) " as u32).unwrap_or('\\0').to_string())" )
                * ( "String.fromCharCode(" (e 1) ")")
            }
        }
        

        strfromcode   cmdStrFromCode:string       ( code:int ) { 
            templates {
                ranger ( "(strfromcode " (e 1) ")")
                csharp ( "((char)" (e 1) ").toString()") 
                java7 ( "(new String( Character.toChars(" (e 1) ")))") 
                swift3 ( "(String( Character( UnicodeScalar(" (e 1) " )! )))") 
                php ( "chr(" (e 1) ")") 
                scala ( "(" (e 1) ".toChar)")      
                go ("string([]rune{rune(" (e 1) ")})")        
                cpp ( "std::string(1, char(" (e 1) "))") 
                rust ( "(char::from_u32(" (e 1) " as u32).unwrap_or('\\0').to_string())" )
                * ( "String.fromCharCode(" (e 1) ")")
            }
        }

        ; Raw byte to string - for binary protocols like PDF WinAnsiEncoding
        ; Unlike strfromcode, this produces a single raw byte, not UTF-8 encoded
        rawbytechar   cmdRawByteChar:string       ( code:int ) { 
            templates {
                ranger ( "(rawbytechar " (e 1) ")")
                go ("string([]byte{byte(" (e 1) ")})")
                cpp ( "std::string(1, char(" (e 1) "))") 
                rust ( "String::from_utf8_lossy(&[" (e 1) " as u8]).to_string()" )
                * ( "String.fromCharCode(" (e 1) ")")
            }
        }

        to_string   _:string       ( value:int ) { 
            templates {
                ranger ( "(to_int " (e 1) ")")
                cpp ("std::to_string(" (e 1) ")" (imp "<string>"))
                java7 ( "String.valueOf(" (e 1) " )") 
                php ( "strval(" (e 1) ")") 
                scala ( "(" (e 1) ".toString)")
                go ("strconv.FormatInt(" (e 1) ", 10)" (imp "strconv"))
                swift3 ("String(" (e 1) ")")              
                csharp ( (e 1) ".ToString()" )
                python ( "str(" (e 1) ")" )
                rust ( (e 1) ".to_string()" )
                * ( "(" (e 1) ".toString())")
            }
        }          

        to_string   cmdIntToString:string       ( value:int ) { 
            templates {
                ranger ( "(to_string " (e 1) ")")
                cpp ("std::to_string(" (e 1) ")" (imp "<string>"))
                java7 ( "String.valueOf(" (e 1) " )") 
                php ( "strval(" (e 1) ")") 
                scala ( "(" (e 1) ".toString)")
                go ("strconv.Itoa(" (e 1) ")" (imp "strconv"))
                swift3 ("String(" (e 1) ")")
                swift6 ("String(" (e 1) ")")
                python ( "str(" (e 1) ")" )
                rust ( (e 1) ".to_string()" )
                * ( "(" (e 1) ").toString()")
            }
        }        
        
        ; std::to_string(myDoubleVar);
        double2str   cmdDoubleToString:string       ( value:double ) { 
            templates {
                ranger ( "(double2str " (e 1) ")")
                cpp ("std::to_string(" (e 1) ")" (imp "<string>"))
                java7 ( "String.valueOf(" (e 1) " )") 
                php ( "strval(" (e 1) ")") 
                scala ( "(" (e 1) ".toString)")
                go ("strconv.FormatFloat(" (e 1) ",'f', 6, 64)" (imp "strconv"))
                swift3 ("String(" (e 1) ")")
                swift6 ("String(" (e 1) ")")
                python ( "str(" (e 1) ")" )
                rust ( (e 1) ".to_string()" )
                * ( "(" (e 1) ".toString())")
            }
        }

        to_string  _:string       ( value:double ) { 
            templates {
                ranger ( "(double2str " (e 1) ")")
                cpp ("std::to_string(" (e 1) ")" (imp "<string>"))
                java7 ( "String.valueOf(" (e 1) " )") 
                php ( "strval(" (e 1) ")") 
                scala ( "(" (e 1) ".toString)")
                go ("strconv.FormatFloat(" (e 1) ",'f', 6, 64)" (imp "strconv"))
                swift3 ("String(" (e 1) ")")
                swift6 ("String(" (e 1) ")")
                python ( "str(" (e 1) ")" )
                rust ( (e 1) ".to_string()" )
                * ( "(" (e 1) ".toString())")
            }
        }

        to_string  _:string       ( value:boolean ) { 
            templates {
                ranger ( "(to_string " (e 1) ")")
                cpp ( "(" (e 1) " ? \"true\" : \"false\")" )
                java7 ( "String.valueOf(" (e 1) " )") 
                php ( "(" (e 1) " ? \"true\" : \"false\")") 
                scala ( "(" (e 1) ".toString)")
                go ( "strconv.FormatBool(" (e 1) ")" (imp "strconv"))
                rust ( "(" (e 1) ".to_string())" )
                swift3 ("String(" (e 1) ")")
                swift6 ("String(" (e 1) ")")
                python ( "str(" (e 1) ")" )
                * ( "(" (e 1) ".toString())")
            }
        }

        ; note: this has now different value, it is optional int...
        ; the optionality of the return value should be preserved 
        ; can not do just
        ;   def x:int (10 + (str2int "hello"))
        ; --> optional return value here...

        str2int   cmdStringToInt@(optional):int      ( value:string ) { 
            templates {
                ranger ( "(str2int " (e 1) ")")
                cpp ("cpp_str_to_int(" (e 1) ")" (imp "<string>")
                
(create_polyfill
"
template <class T>
class r_optional_primitive {
  public:
    bool has_value;
    T value;
    r_optional_primitive<T> & operator=(const r_optional_primitive<T> & rhs) {
        has_value = rhs.has_value;
        value = rhs.value;
        return *this;
    }
    r_optional_primitive<T> & operator=(const T a_value) {
        has_value = true;
        value = a_value;
        return *this;
    }
};
"
) 
(create_polyfill
"r_optional_primitive<int> cpp_str_to_int(std::string s) {
    r_optional_primitive<int> result;
    try {
        result.value = std::stoi(s);
        result.has_value = true;
    } catch (...) {
        
    }
    return result;
}"
)                  
                
                )
                java7 ( 
                    "_getIntegerOrNull(" (e 1) " )"
(create_polyfill 
"
static Integer _getIntegerOrNull ( String str ) {
    try {
       return (Integer.parseInt(str));
    } catch ( NumberFormatException e ) {
        return null;
    }
}
"
)                    
                )
                go ("r_str_2_i64(" (e 1) ")"

(create_polyfill
"
func r_str_2_i64(s string) *GoNullable {
   res := new(GoNullable);
   if v, err := strconv.ParseInt(s, 10, 64); err == nil {
     res.has_value = true
     res.value = v
   } else {
     res.has_value = false
   }
   return res
}
"
)                
                
                )
                php ( "is_numeric(" (e 1) ") ? intval(" (e 1) ") : NULL ")
                scala ( "Try(" (e 1) ".toInt).toOption" (imp "scala.util.Try"))
                kotlin (  (e 1) ".toInt()")
                swift3 ("Int(" (e 1) ")")
                swift6 ("Int(" (e 1) ")")
                csharp( "Int32.Parse(" (e 1) ")" )
                rust ( (e 1) ".parse::<i64>().ok()" )
                * ( "isNaN( parseInt(" (e 1) ") ) ? undefined : parseInt(" (e 1) ")")
            }
        }

        str2double   cmdStringToDouble@(optional):double      ( value:string ) { 
            templates {
                ranger ( "(str2double " (e 1) ")")
                cpp ("cpp_str_to_double(" (e 1) ")" (imp "<string>")
(create_polyfill
"
template <class T>
class r_optional_primitive {
  public:
    bool has_value;
    T value;
    r_optional_primitive<T> & operator=(const r_optional_primitive<T> & rhs) {
        has_value = rhs.has_value;
        value = rhs.value;
        return *this;
    }
    r_optional_primitive<T> & operator=(const T a_value) {
        has_value = true;
        value = a_value;
        return *this;
    }
};
"
) 
(create_polyfill
"r_optional_primitive<double> cpp_str_to_double(std::string s) {
    r_optional_primitive<double> result;
    try {
        result.value = std::stod(s);
        result.has_value = true;
    } catch (...) {
        
    }
    return result;
}"
)                  
                
                )
                java7 ( 
                    "_getDoubleOrNull(" (e 1) " )"
(create_polyfill 
"
Double _getDoubleOrNull ( String str ) {
    try {
       return (Double.parseDouble(str));
    } catch ( NullPointerException e ) {
        return null;
    } catch ( NumberFormatException e ) {
        return null;
    }
}
"
)                    
                    ) 
                go ("r_str_2_d64(" (e 1) ")"
                (imp "strconv")
(create_polyfill
"func r_str_2_d64(s string) *GoNullable {
   res := new(GoNullable);
   if v, err := strconv.ParseFloat(s, 64); err == nil {
     res.has_value = true
     res.value = v
   } else {
     res.has_value = false
   }
   return res
}"
)                
                )
                php ( "floatval(" (e 1) ")")
                scala ( "Try(" (e 1) ".toDouble).toOption" (imp "scala.util.Try"))
                kotlin (  (e 1) ".toDouble()")
                swift3 ("Double(" (e 1) ")")
                rust ( (e 1) ".parse::<f64>().ok()" )
                * ( "isNaN( parseFloat(" (e 1) ") ) ? undefined : parseFloat(" (e 1) ")")
            }
        }

        to_double cmdToDbl@(optional):double (value:string) {
            templates {
                * @macro(true) ("str2double(" (e 1) ")")
            }
        }
        
        ; scala: .mkString(
        join             cmdJoin:string          ( array:[string] delimiter:string ) { 
            templates {      
                ranger ( "(join " (e 1) " " (e 2) ")")          
                java7 ( "joinStrings(" (e 1 ) ", " (e 2) ")" 
                    (imp "java.lang.StringBuilder")
(create_polyfill "
static String joinStrings(ArrayList<String> list, String delimiter) 
{
    StringBuilder b = new StringBuilder();
    for(int i=0; i < list.size() ; i++) {
        if( i > 0 ) {
            b.append(delimiter);
        }
        b.append(list.get(i));
    }
    return b.toString();
}    
    ")                               
                
                )

                cpp ( "join( " (e 1) " , " (e 2) ")" (imp "<sstream>") (imp "<string>") (imp "<iostream>")
(create_polyfill "
template <typename T>
std::string join(const T& v, const std::string& delim) {
    std::ostringstream s;
    for (const auto& i : v) {
        if (&i != &v[0]) {
            s << delim;
        }
        s << i;
    }
    return s.str();
}   
    ") )  

                csharp ( "String.Join(" (e 2) ", " (e 1) ")" (imp "System"))
                go ( "strings.Join(" (e 1) ", " (e 2) ")")
                scala ( (e 1) ".mkString(" (e 2) ")" )
                php ( "implode(" (e 2) ", " (e 1) ")")
                swift3 ( (e 1) ".joined(separator:" (e 2) ")")
                swift6 ( (e 1) ".joined(separator:" (e 2) ")")
                * ( (e 1) ".join(" (e 2) ")" )
            }            
        }                 
        
        has             cmdHas:boolean          ( map:[K:T] key:K ) { 
            templates {                
                ranger ( "(has " (e 1) " " (e 2) ")") 
                es5  ( "typeof(" (e 1) "[" (e 2) "] ) != \"undefined\"" )
                es6  ( "( typeof(" (e 1) "[" (e 2) "] ) != \"undefined\" && " (e 1) ".hasOwnProperty(" (e 2) ") )" )
                ts   ( "typeof(" (e 1) "[" (e 2) "] ) != \"undefined\"" )
                flow ( "typeof(" (e 1) "[" (e 2) "] ) != \"undefined\"" )
                cpp ( (e 1) ".count(" (e 2) ") > 0" )
                php ( "array_key_exists(" (e 2) " , " (e 1) " )" )
                java7 ( (e 1) ".containsKey(" (e 2) ")" )
                kotlin ( (e 1) ".containsKey(" (e 2) ")" )
                python ( (e 2) " in " (e 1) )
                go ( 

(macro (nl "func r_has_key_" (r_ktype 1)  "_" (r_atype_fname 1) "( a "  (typeof 1) ", key " (r_ktype 1) " ) bool { " nl I 
    "_, ok := a[key]" nl "return ok" nl i "
}" nl ))                   
                    "r_has_key_" (r_ktype 1)  "_" (r_atype_fname 1) "(" (e 1) ", " (e 2) ")"
                )
                rust ( (e 1 ) ".contains_key(&" (e 2) ")")
                csharp ( (e 1) ".ContainsKey(" (e 2) ")" )
                scala ( (e 1) ".contains(" (e 2) ")" )
                swift3 ( (e 1) "[" (e 2) "] != nil" )
                swift6 ( (e 1) "[" (e 2) "] != nil" )
                * ( (e 1) "[" (e 2) "] != null" )
            }            
        }  

        get             cmdGet@(optional):T          ( a:[T] index:int ) {
            templates {
                es6 ('( ' (e 1) '.length  > ' (e 2)'  && ' (e 2)' >= 0  ?  '(e 1) '[' (e 2)'] : null ) ')
            } 
        }
        

        get             cmdGet@(optional weak):int          ( map:[K:int] key:K ) { 
            templates {
                cpp( "cpp_get_map_int_value<" (r_ktype 1) ">(" (e 1) ", " (e 2) ")"
(create_polyfill
"
template <class T>
class r_optional_primitive {
  public:
    bool has_value;
    T value;
    r_optional_primitive<T> & operator=(const r_optional_primitive<T> & rhs) {
        has_value = rhs.has_value;
        value = rhs.value;
        return *this;
    }
    r_optional_primitive<T> & operator=(const T a_value) {
        has_value = true;
        value = a_value;
        return *this;
    }
};
"
) 
(macro
("
template<typename T>
r_optional_primitive<int> cpp_get_map_int_value( std::map<" (r_ktype 1) ", int> m , " (typeof 2) space "  key) {
    r_optional_primitive<int> result;
    try {
        result.value = m[key];
        result.has_value = true;
    } catch (...) {
        
    }
    return result;
}")
) 

                )
            }
        }
         
        get             cmdGet@(optional weak):T          ( map:[K:T] key:K ) { 
            templates {
                ranger ( "(get " (e 1) " " (e 2) ")")                 
                java7 ( (e 1) ".get(" (e 2) ")" )
                rust ( (e 1) ".get(" (e 2) ")" )

                scala ( (e 1) ".get(" (e 2) ")" )

                ; scala ( (e 1) ".get(" (e 2) ").asInstanceOf[" (atype 1) "]" )

                go ( 

(macro (nl "func r_get_" (r_ktype 1)  "_" (r_atype_fname 1) "( a " (typeof 1) ", key " (r_ktype 1) " ) *GoNullable  { " nl I 
    "res := new(GoNullable)" nl  
    "v, ok := a[key]" nl 
    "if ok { " nl
        I 
          "res.has_value = true" nl
          "res.value = v" nl
          "return res" nl
        i
    "}" nl
    "res.has_value = false" nl
    "return res" nl
i "}" nl ))                   
                    "r_get_" (r_ktype 1)  "_" (r_atype_fname 1) "(" (e 1) ", " (e 2) ")"
                )
                es6 ( "( " (e 1) ".hasOwnProperty(" (e 2) ") ? " (e 1) "[" (e 2) "] : undefined )" )
                * ( (e 1) "[" (e 2) "]" )
            }            
        }                 

        set             cmdSet@(moves@( 3 1 ) ):void          ( array@(mutates):[T] index:int value@( refto@(1) ):T ) { 
            templates {
                ranger ( "set " (e 1) " " (e 2) " " (e 3) )                
                java7 ( (e 1) ".set(" (e 2) ", " (e 3) ");" )
                rust ( (e 1) "[" (e 2) " as usize] = " (e 3) ";" )
                scala ( (e 1) "(" (e 2) ") =  " (e 3)  )
                kotlin ( (e 1) ".set(" (e 2) ", " (e 3) ")" )
                php ( (e 1) "[" (e 2) "] = " (e 3) ";" )
                cpp ( (e 1) "[" (e 2) "] = " (e 3) ";" )
                ; * ( (e 1) "[" (e 2) "] = " (e 3) )
                * ( (e 1) "[" (e 2) "] = " (e 3) ";" )
            }            
        } 
        
        set             cmdSet@(moves@( 3 1 ) ):void          ( map@(mutates):[K:T] key:K value@( refto@(1) ):T ) { 
            templates {
                ranger ( "set " (e 1) " " (e 2) " " (e 3) )                
                java7 ( (e 1) ".put(" (e 2) ", " (e 3) ");" )
                rust ( (e 1) ".insert(" (e 2) ", " (e 3) ");" )
                scala ( (e 1) ".put(" (e 2) ", " (e 3) ")" )
                kotlin ( (e 1) ".set(" (e 2) ", " (e 3) ")" )
                php ( (e 1) "[" (e 2) "] = " (e 3) ";" )
                cpp ( (e 1) "[" (e 2) "] = " (e 3) ";" )
                * ( (e 1) "[" (e 2) "] = " (e 3) ";" )
            }            
        }                 

        lift    cmdLift@(optional):T      ( array:[T] index:int ) { 
            templates {
                ranger ( "(set " (e 1) " " (e 2) ")")
                 cpp ( (e 1) ".at( " (e 2) ")" (imp "<vector>"))   
                 java7 ( (e 1) ".get(" (e 2) ")" )                                 
                 ; lift return optional type => safer                             
                 scala ( (e 1) ".lift(" (e 2) ")" )  
                 swift3 ( (e 1) "[" (e 2) "]" )    
                 * (  (e 1) "[" (e 2) "]" )                                              
            }
        }

        itemAt    cmdItemAt@(weak):T      ( array:[T] index:int ) { 
            templates {
                ranger ( "(itemAt " (e 1) " " (e 2) ")" )
                 cpp ( (e 1) ".at(" (e 2) ")" (imp "<vector>"))   
                 java7 ( (e 1) ".get(" (e 2) ")" )                                 
                 ; lift return optional type => safer                             
                 scala ( (e 1) "(" (e 2) ")" )
                 rust ( (e 1) "[" (e 2) " as usize].clone()" )
                 * ( (e 1) "[" (e 2) "]" )                                              
            }
        }

        indexOf cmdStringIndex:int (str:string key:string) {
            templates {
                php( "strpos(" (e 1) ", " (e 2) ")")
                go ( "int64(strings.Index(" (e 1) ", " (e 2) "))" (imp "strings"))
                es6 ( (e 1) ".indexOf(" (e 2 ) ")" )
                java7 ( (e 1) ".indexOf(" (e 2 ) ")" )
                python ( (e 1) ".find(" (e 2) ")" )
                swift3 ( (e 1) ".range(of:" (e 2) ")?.lowerBound.encodedOffset ?? -1" )
                swift6 ( "(" (e 1) ".range(of:" (e 2) ").map { " (e 1) ".distance(from: " (e 1) ".startIndex, to: $0.lowerBound) } ?? -1)" )
                cpp (
                    "r_string_index_of(" (e 1) " , " (e 2) ")"
(create_polyfill
"
int r_string_index_of( std::string str, std::string key )  { 
    auto n = str.find( key );
    if (n == std::string::npos) {
        return -1;
    }   
    return n;
}
" )                   
                    
                )
                rust ( "(" (e 1) ".find(&*" (e 2) ").map(|i| i as i64).unwrap_or(-1))" )
            }        
        }

        indexOfFrom cmdStringIndexFrom:int (str:string key:string startPos:int) {
            templates {
                php( "(($p = strpos(" (e 1) ", " (e 2) ", " (e 3) ")) !== false ? $p : -1)")
                go ( "func() int64 { idx := strings.Index(" (e 1) "[" (e 3) ":], " (e 2) "); if idx == -1 { return -1 }; return int64(idx) + " (e 3) " }()" (imp "strings"))
                es6 ( (e 1) ".indexOf(" (e 2 ) ", " (e 3) ")" )
                java7 ( (e 1) ".indexOf(" (e 2 ) ", (int)" (e 3) ")" )
                python ( (e 1) ".find(" (e 2) ", " (e 3) ")" )
                swift3 ( "(" (e 1) ".range(of:" (e 2) ", range: " (e 1) ".index(" (e 1) ".startIndex, offsetBy: " (e 3) ")..<" (e 1) ".endIndex).map { " (e 1) ".distance(from: " (e 1) ".startIndex, to: $0.lowerBound) } ?? -1)" )
                swift6 ( "(" (e 1) ".range(of:" (e 2) ", range: " (e 1) ".index(" (e 1) ".startIndex, offsetBy: " (e 3) ")..<" (e 1) ".endIndex).map { " (e 1) ".distance(from: " (e 1) ".startIndex, to: $0.lowerBound) } ?? -1)" )
                cpp (
                    "r_string_index_of_from(" (e 1) " , " (e 2) ", " (e 3) ")"
(create_polyfill
"
int r_string_index_of_from( std::string str, std::string key, int start )  { 
    if (start < 0 || start >= str.length()) return -1;
    auto n = str.find( key, start );
    if (n == std::string::npos) {
        return -1;
    }   
    return n;
}
" )                   
                )
                rust ( "(" (e 1) "[" (e 3) " as usize..].find(&*" (e 2) ").map(|i| (i + " (e 3) " as usize) as i64).unwrap_or(-1))" )
                ranger ( "(indexOfFrom " (e 1) " " (e 2) " " (e 3) ")")
            }        
        }

        lastIndexOf cmdStringLastIndex:int (str:string key:string) {
            templates {
                es6 ( (e 1) ".lastIndexOf(" (e 2 ) ")" )
                java7 ( (e 1) ".lastIndexOf(" (e 2 ) ")" )
                python ( (e 1) ".rfind(" (e 2) ")" )
                go ( "int64(strings.LastIndex(" (e 1) ", " (e 2) "))" (imp "strings"))
                swift3 ( "(" (e 1) ".range(of:" (e 2) ", options: .backwards).map { " (e 1) ".distance(from: " (e 1) ".startIndex, to: $0.lowerBound) } ?? -1)" )
                swift6 ( "(" (e 1) ".range(of:" (e 2) ", options: .backwards).map { " (e 1) ".distance(from: " (e 1) ".startIndex, to: $0.lowerBound) } ?? -1)" )
                php( "strrpos(" (e 1) ", " (e 2) ") !== false ? strrpos(" (e 1) ", " (e 2) ") : -1")
                cpp (
                    "r_string_last_index_of(" (e 1) " , " (e 2) ")"
(create_polyfill
"
int r_string_last_index_of( std::string str, std::string key )  { 
    auto n = str.rfind( key );
    if (n == std::string::npos) {
        return -1;
    }   
    return n;
}
" )                   
                )
                rust ( "(" (e 1) ".rfind(&*" (e 2) ").map(|i| i as i64).unwrap_or(-1))" )
                kotlin ( (e 1) ".lastIndexOf(" (e 2) ")" )
                ranger ( "(lastIndexOf " (e 1) " " (e 2) ")")
            }        
        }

        startsWith _:boolean (str:string prefix:string) {
            templates {
                ranger ( "(startsWith " (e 1) " " (e 2) ")")
                es6 ( (e 1) ".startsWith(" (e 2) ")" )
                java7 ( (e 1) ".startsWith(" (e 2) ")" )
                go ( "strings.HasPrefix(" (e 1) ", " (e 2) ")" (imp "strings"))
                php ( "substr(" (e 1) ", 0, strlen(" (e 2) ")) === " (e 2) )
                swift3 ( (e 1) ".hasPrefix(" (e 2) ")" )
                swift6 ( (e 1) ".hasPrefix(" (e 2) ")" )
                csharp ( (e 1) ".StartsWith(" (e 2) ")" )
                scala ( (e 1) ".startsWith(" (e 2) ")" )
                cpp ( (e 1) ".rfind(" (e 2) ", 0) == 0" )
                kotlin ( (e 1) ".startsWith(" (e 2) ")" )
                python ( (e 1) ".startswith(" (e 2) ")" )
            }
        }

        endsWith _:boolean (str:string suffix:string) {
            templates {
                ranger ( "(endsWith " (e 1) " " (e 2) ")")
                es6 ( (e 1) ".endsWith(" (e 2) ")" )
                java7 ( (e 1) ".endsWith(" (e 2) ")" )
                go ( "strings.HasSuffix(" (e 1) ", " (e 2) ")" (imp "strings"))
                php ( "substr(" (e 1) ", -strlen(" (e 2) ")) === " (e 2) )
                swift3 ( (e 1) ".hasSuffix(" (e 2) ")" )
                swift6 ( (e 1) ".hasSuffix(" (e 2) ")" )
                csharp ( (e 1) ".EndsWith(" (e 2) ")" )
                scala ( (e 1) ".endsWith(" (e 2) ")" )
                cpp ( "r_string_ends_with(" (e 1) ", " (e 2) ")"
(create_polyfill
"
bool r_string_ends_with(const std::string& str, const std::string& suffix) {
    if (suffix.size() > str.size()) return false;
    return str.compare(str.size() - suffix.size(), suffix.size(), suffix) == 0;
}
" )
                )
                kotlin ( (e 1) ".endsWith(" (e 2) ")" )
                python ( (e 1) ".endswith(" (e 2) ")" )
            }
        }

        contains _:boolean (str:string sub:string) {
            templates {
                ranger ( "(contains " (e 1) " " (e 2) ")")
                es6 ( (e 1) ".includes(" (e 2) ")" )
                java7 ( (e 1) ".contains(" (e 2) ")" )
                go ( "strings.Contains(" (e 1) ", " (e 2) ")" (imp "strings"))
                php ( "strpos(" (e 1) ", " (e 2) ") !== false" )
                swift3 ( (e 1) ".contains(" (e 2) ")" )
                swift6 ( (e 1) ".contains(" (e 2) ")" )
                csharp ( (e 1) ".Contains(" (e 2) ")" )
                scala ( (e 1) ".contains(" (e 2) ")" )
                cpp ( (e 1) ".find(" (e 2) ") != std::string::npos" )
                kotlin ( (e 1) ".contains(" (e 2) ")" )
                python ( (e 2) " in " (e 1) )
            }
        }

        replace _:string (str:string oldStr:string newStr:string) {
            templates {
                ranger ( "(replace " (e 1) " " (e 2) " " (e 3) ")")
                es6 ( (e 1) ".replace(" (e 2) ", " (e 3) ")" )
                java7 ( (e 1) ".replace(" (e 2) ", " (e 3) ")" )
                go ( "strings.Replace(" (e 1) ", " (e 2) ", " (e 3) ", 1)" (imp "strings"))
                php ( "str_replace(" (e 2) ", " (e 3) ", " (e 1) ")" )
                swift3 ( (e 1) ".replacingOccurrences(of: " (e 2) ", with: " (e 3) ")" )
                csharp ( (e 1) ".Replace(" (e 2) ", " (e 3) ")" )
                scala ( (e 1) ".replace(" (e 2) ", " (e 3) ")" )
                cpp ( "r_string_replace(" (e 1) ", " (e 2) ", " (e 3) ")"
(create_polyfill
"
std::string r_string_replace(std::string str, const std::string& from, const std::string& to) {
    size_t pos = str.find(from);
    if (pos != std::string::npos) {
        str.replace(pos, from.length(), to);
    }
    return str;
}
" )
                )
                kotlin ( (e 1) ".replace(" (e 2) ", " (e 3) ")" )
                python ( (e 1) ".replace(" (e 2) ", " (e 3) ", 1)" )
            }
        }

        ; array function derived from scala

        indexOf    cmdIndexOf:int      ( array:[T] element:T ) { 
            templates {
                ranger ( "(indexOf " (e 1) " " (e 2) ")")
                 cpp ( "r_arr_index_of<" (typeof 2) ">(" (e 1) ", " (e 2) ")" (imp "<vector>") (imp "<iterator>") (imp "<algorithm>")

(create_polyfill
"
template< typename T >
int r_arr_index_of( std::vector<T> vec, T elem )  { 
    auto it = std::find(vec.begin(),vec.end(),elem);
    if(it!=vec.end()) {
        return it - vec.begin();
    } 
    return -1;
}
" )                   
                 
                 )   
                 cpp ( "std::distance( std::find( " (e 1) ".begin(), " (e 1) ".end(), " (e 2) ") )" (imp "<vector>") (imp "<iterator>"))   
                 rust ( (e 1) ".iter().position( |&r| r == " (e 2) " ).unwrap()" )   
                 php ( "array_search(" (e 2) ", " (e 1) ", true)")
                 go ( "r_indexof_arr_" (rawtype 1)  "(" (e 1) ", " (e 2) ")"
(macro ("func r_indexof_arr_" (rawtype 1)  "( a []"  (ptr 1) (rawtype 1) ", item "  (ptr 1) (rawtype 1) " ) ( int64 ) { " nl I 
    "for i, v := range a {" nl I "if item == v { " nl I "return int64(i) " nl i " } " nl i " } " nl i
    "return -1" nl
"}" nl ))  

                 )
                 swift3( "r_index_of(arr:" (e 1) ", elem:" (e 2)")"
(macro ("
func r_index_of ( arr:" (typeof 1)  " , elem: " (typeof 2) ") -> Int { " nl I
    "if let idx = arr.index(of: elem) { " nl
    "    return idx " nl
    "} else { " nl
    I "    return -1 " nl i
    "}  " nl
    i
"}" nl ) )                
                 )
                 swift6( "r_index_of(arr:" (e 1) ", elem:" (e 2)")"
(macro ("
func r_index_of ( arr:" (typeof 1)  " , elem: " (typeof 2) ") -> Int { " nl I
    "if let idx = arr.firstIndex(of: elem) { " nl
    "    return idx " nl
    "} else { " nl
    I "    return -1 " nl i
    "}  " nl
    i
"}" nl ) )                
                 )
                 python ( (e 1) ".index(" (e 2) ") if " (e 2) " in " (e 1) " else -1" )
                 * ( (e 1) ".indexOf(" (e 2) ")" )                                              
            }
        }

        remove_index    cmdRemoveIndex:void  ( array:[T] index:int ) { 
            templates {
                ranger ( "(remove_index " (e 1) " " (e 2) ")")
                 cpp ( (e 1) ".erase( "(e 1)".begin() + " (e 2) " );")
                 swift3 ( (e 1) ".remove(at:" (e 2)")")
                 php ( "array_splice(" (e 1) ", " (e 2 )", 1);")
                 kotlin ( (e 1) ".removeAt(" (e 2) ")" ) 
                 java7 ( (e 1) ".remove(" (e 2) ")" )
                 scala ( (e 1) ".remove(" (e 2) ")" )
                 go ( (e 1) " = append(" (e 1) "[:" (e 2) "], " (e 1) "[" (e 2) "+1:]...)" )
                 python ( (e 1) ".pop(" (e 2) ")" )
                 * ( (e 1) ".splice(" (e 2) ", 1).pop();" )                                              
            }
        }

        ; https://github.com/golang/go/wiki/SliceTricks
        insert    cmdInsert@(moves@( 2 1 ) ):void  ( array@(mutates):[T] index:int item:T ) { 
            templates {
                 ranger ( nl "insert " (e 1) " " (e 2) " " (e 3) nl)
                 es6 ( (e 1) ".splice(" (e 2) ", 0, " (e 3) ");" )  
                 cpp ( (e 1) ".insert(" (e 1) ".begin() + " (e 2) ", " (e 3) ");")          
                 go( (e 1 ) " = append(" (e 1) "[:" (e 2) "], append(" (typeof 1) "{" (e 3) "}, " (e 1) "[" (e 2) ":]...)...)")   
                 php ( "array_splice(" (e 1) ", " (e 2) ", 0, " (e 3) ");")
                 python ( (e 1) ".insert(" (e 2) ", " (e 3) ")" )
                 rust ( (e 1) ".insert(" (e 2) " as usize, " (e 3) ");")
            }
        }      
        
        remove    cmdRemove@(moves@( 2 1 ) ):void  ( array@(mutates):[T] index:int ) { 
            templates {
                 ranger ( nl "remove " (e 1) " " (e 2) nl)
                 es6 ( (e 1) ".splice(" (e 2) ", 1);" )                                              
            }
        }

        ; Set value at specific index in array
        set_at    cmdSetAt:void  ( array@(mutates):[T] index:int value:T ) { 
            templates {
                 ranger ( nl "set_at " (e 1) " " (e 2) " " (e 3) nl)
                 es6 ( (e 1) "[" (e 2) "] = " (e 3) ";" )
                 go ( (e 1) "[" (e 2) "] = " (e 3) )
                 cpp ( (e 1) "[" (e 2) "] = " (e 3) ";" )
                 swift3 ( (e 1) "[" (e 2) "] = " (e 3) )
                 swift6 ( (e 1) "[" (e 2) "] = " (e 3) )
                 php ( (e 1) "[" (e 2) "] = " (e 3) ";" )
                 python ( (e 1) "[" (e 2) "] = " (e 3) )
                 java7 ( (e 1) ".set(" (e 2) ", " (e 3) ");" )
                 kotlin ( (e 1) "[" (e 2) "] = " (e 3) )
                 csharp ( (e 1) "[" (e 2) "] = " (e 3) ";" )
                 scala ( (e 1) "(" (e 2) ") = " (e 3) )
                 rust ( (e 1) "[" (e 2) " as usize] = " (e 3) ";" )
                 * ( (e 1) "[" (e 2) "] = " (e 3) ";" )
            }
        }

        push    cmdPush@(moves@( 2 1 ) ):void  ( array@(mutates):[T] item:T ) { 
            templates {
                ranger ( nl "push " (e 1) " " (e 2) "" nl)
                 cpp ( (e 1) ".push_back( "(e 2)"  );")
                 swift3 ( (e 1) ".append(" (e 2)")")
                 swift6 ( (e 1) ".append(" (e 2)")")
                 php ( "array_push(" (e 1) ", " (e 2 )");")
                 python ( (e 1) ".append(" (e 2) ")")
                 java7 ( (e 1) ".add(" (e 2) ");" )
                 go ( (custom _) )
                 go ( (e 1) " = append("  (e 1) ","  (e 2) ");" )
                 kotlin ( (e 1) ".add(" (e 2) ");" )
                 csharp ( (e 1) ".Add(" (e 2) ");" ) 
                 scala ( (e 1) ".append(" (e 2) ")" )
                 rust ( (custom _) )
                 rust ( (e 1) ".push(" (e 2) ");" )
                 * ( (e 1) ".push(" (e 2) ");" )                                              
            }
        }

        ; push for string arrays in Rust - converts &str to String
        pushString    cmdPushString@(moves@( 2 1 ) ):void  ( array@(mutates):[string] item:string ) { 
            templates {
                rust ( (e 1) ".push(" (e 2) ".to_string());" )
                 * ( (e 1) ".push(" (e 2) ");" )                                              
            }
        }

        ; think: how to release the strong array
        removeLast  cmdRemoveLast:void  ( array@(mutates):[T] ) { 
            templates {
                ranger ( "removeLast " (e 1) "")
                 cpp ( (e 1) ".pop_back();")
                 swift3 ( (e 1) ".removeLast();")
                 php ( "array_pop(" (e 1) " );")
                 python ( (e 1) ".pop()")
                 java7 ( (e 1) ".remove(" (e 1) ".size() - 1);" )
                 csharp ( "Array.Resize(ref "(e 1) ", " (e 1 )".Length - 1);" ) 
                 scala ( (e 1) ".remove(" (e 1) ".length - 1)" )
                 go ( (custom _) )
                 go ( (e 1) "= " (e 1)"[:len(" (e 1)") - 1]")
                 * ( (e 1) ".pop();" )                                              
            }
        }

        length    cmdArrayLength:int      ( array:[T] ) { 
            templates {
                ranger ( "(length " (e 1) ")")
                 cpp ( (e 1) ".size()" )                                                              
                 swift3 ( (e 1) ".count")
                 php ( "count(" (e 1) ")")
                 python ( "len(" (e 1) ")")
                 java7 ( (e 1) ".size()" )                                                              
                 scala ( (e 1) ".length" )
                 kotlin ( (e 1) ".size" )                                                              
                 * ( (e 1) ".length" )                                              
            }
        }

        length       cmdStrlen:int       ( text:string ) { 
            templates {
                ranger ( "(length " (e 1) ")")
                cpp ( (e 1) ".length()") 
                java7 ( (e 1) ".length()") 
                scala ( (e 1) ".length()")  
                swift3 ( (e 1) ".characters.count")  
                csharp ( (e 1) ".Length")
                python ( "len(" (e 1) ")")
                rust ( (e 1 ) ".len()" )
                go( "int64(len([]rune(" (e 1) ")))")
                php ( "strlen(" (e 1) ")")               
                * ( (e 1) ".length")
            }
        }
        clear    _:void      ( array:[T] ) { 
            templates {
                 ranger ( "(clear " (e 1) ")")
                 cpp ( (e 1) ".clear();" )                                                              
                 swift3 ( (e 1) ".removeAll()")
                 php ( nl (e 1) " = array();" nl)
                 java7 ( (e 1) ".clear();" )                                                              
                 scala ( (e 1) ".clear()" )
                 go ( (e 1) " = " (e 1) "[:0]" )
                 rust ( custom )
                 * ( (e 1) ".length = 0;" nl )                                              
            }
        }

        has    _:boolean      ( array:[T] ) { 
            templates {
                * @macro(true) ('( (array_length ' (e 1) ')  > 0 )')
            }
        }

        last_index    _:int      ( array:[T] ) { 
            templates {
                * @macro(true) ('(array_length ' (e 1) ') - 1')
            }
        }
        last    _:T      ( array:[T] ) { 
            templates {
                * @macro(true) ('(itemAt ' ( e 1 ) ' ( (array_length ' (e 1) ') - 1) )')
            }
        }
        ; first character of the string
        first    _:string      ( str:string ) { 
            templates {
                * @macro(true) ('(at ' (e 1) ' 0)')
            }
        }
        first    _:T      ( array:[T] ) { 
            templates {
                * @macro(true) ('(itemAt ' ( e 1 ) ' 0 )')
            }
        }
        size    _:int      ( array:[T] ) { 
            templates {
                * @macro(true) ('(array_length ' ( e 1 ) ' )')
            }
        }

        at    _:T      ( array:[T] index:int ) { 
            templates {
                * @macro(true) ('(itemAt ' ( e 1 ) ' (' (e 2) ') )')
            }
        }

        ; go sort.slice...
        sort _:[T] ( array:[T] cb:(_:int (left:T right:T))) {
            templates {
                es6 ( (e 1) ".slice().sort(" ( e 2) ")")
                go ( "(func(list " (typeof 1) ") " (typeof 1) " {" nl 
                    I "sort.Slice(" (e 1) ", func(i, j int) bool { " nl
                    I "sortfn := " (e 2) nl
                      "sortval := sortfn(" (e 1)"[i], " (e 1)"[j])" nl
                      "return (sortval < 0)" nl i
                      "})" nl
                      "return list" nl 
                    i "}(" (e 1) "))"
                    (imp "sort"))
            }            
        }

        reverse _:[T] (array:[T]) {
            templates {
                ranger ( '(reverse (' (e 1) '))')
                es6 ( (e 1) ".slice().reverse()")
            }            
        }

        array_length    cmdArrayLength:int      ( array:[T] ) { 
            templates {
                ranger ( "(array_length " (e 1) ")")
                 cpp ( '(int)(' (e 1) ".size())" )                                                              
                 swift3 ( (e 1) ".count")
                 swift6 ( (e 1) ".count")
                 php ( "count(" (e 1) ")")
                 java7 ( (e 1) ".size()" )                                                              
                 scala ( (e 1) ".length" )
                 rust ( "(" (e 1 ) ".len() as i64)" )
                 go ( "int64(len(" (e 1 ) "))" )
                 kotlin ( (e 1) ".size" )       
                 csharp ( (e 1) ".Count")
                 python ( "len(" (e 1) ")" )                                                       
                 * ( (e 1) ".length" )                                              
            }
        }

; vec.erase(vec.begin() + index);
        array_extract    cmdArrayExtract@(strong):T      ( array@(mutates):[T] position:int ) { 
            templates {
                ranger ( "(array_extract " (e 1) " " (e 2) ")")
                 ; TODO: C++ version does not seem to have a clear functino to extrace element from std::vector
                 swift3 ( (e 1) ".remove(at:" (e 2)")")
                 php ( "array_splice(" (e 1) ", " (e 2 )", 1)[0]")
                 go ( "r_m_arr_" (rawtype 1) "_extract(" (e 1) ", " (e 2 )")"

(macro ("func r_m_arr_" (rawtype 1)  "_extract( a "  (typeof 1) ", i int64 ) (" (arraytype 1)  ", " (typeof 1) " ) { " nl I 
    "item := a[i]" nl "res := append(a[:i], a[(i+1):]...)" nl "return item, res " nl i "
}" nl ))                  
                 
                 )

                 cpp ( "r_m_arr_extract<" (typeof 1) ">(" (e 1) ", " (e 2 )")"

(create_polyfill
"template< typename T >
auto r_m_arr_extract( T & a, int i )  { 
    auto elem = a.at(i); 
    a.erase(a.begin() + i);
    return elem;
}" )                  
                 
                 )                 
                 kotlin ( (e 1) ".removeAt(" (e 2) ")" ) 
                 java7 ( "_arr_extract(" (e 1) ", " (e 2) ")" 
(create_polyfill
"
public <T> T _arr_extract( ArrayList<T> list, Integer i )  { 
    T elem = list.get(i); 
    list.remove(i);
    return elem;
}" )                  
                 
                 )
                 scala ( (e 1) ".remove(" (e 2) ")" )
                 * ( (e 1) ".splice(" (e 2) ", 1).pop()" )                                              
            }
        }


        
        print           cmdPrint:void           ( text:string) { 
            templates {
                 ranger ( nl "print " (e 1) nl)
                 cpp (ln "std::cout << " (e 1) " << std::endl;" nl (imp "<iostream>") (imp "<string>"))
                 kotlin ( nl "println( " (e 1) " )" nl )                                              
                 scala ( "println( " (e 1) " )" ) 
                 go ( nl "fmt.Println( " (e 1) " )" nl (imp "fmt")             ) 
                 rust ( nl "println!( \"{}\", " (e 1) " );" nl )                              
                 java7 ( nl "System.out.println(String.valueOf( " (e 1) " ) );" nl (imp "java.io.*"))                              
                 php ( nl "echo( " (e 1) " . \"\\n\");" nl )
                 python ( nl "print(" (e 1) ")" nl )
                 csharp ( nl "Console.WriteLine(" (e 1) ");" nl (imp "System"))
                 swift3 ( nl "print(" (e 1) ")" nl)
                 swift6 ( nl "print(" (e 1) ")" nl)
                 * ( nl "console.log(" (e 1) ");" nl)                                                                
            }
        }

        ; Terminal control operators for console/shell games
        ; Write text without newline
        write           cmdWrite:void           ( text:string) { 
            templates {
                 cpp ( nl "std::cout << " (e 1) " << std::flush;" nl (imp "<iostream>"))
                 go ( nl "fmt.Print( " (e 1) " )" nl (imp "fmt"))
                 rust ( nl "print!(\"{}\", " (e 1) ");" nl)
                 java7 ( nl "System.out.print(String.valueOf(" (e 1) "));" nl)
                 kotlin ( nl "print(" (e 1) ")" nl)
                 php ( nl "echo " (e 1) ";" nl)
                 python ( nl "print(" (e 1) ", end='')" nl)
                 csharp ( nl "Console.Write(" (e 1) ");" nl (imp "System"))
                 swift3 ( nl "print(" (e 1) ", terminator: \"\")" nl)
                 swift6 ( nl "print(" (e 1) ", terminator: \"\")" nl)
                 * ( nl "process.stdout.write(" (e 1) ");" nl)
            }
        }

        ; Clear the terminal screen
        clear_screen    cmdClearScreen:void     () {
            templates {
                 cpp ( nl "std::cout << \"\\x1b[2J\\x1b[H\" << std::flush;" nl (imp "<iostream>"))
                 go ( nl "fmt.Print(\"\\x1b[2J\\x1b[H\")" nl (imp "fmt"))
                 rust ( nl "print!(\"\\x1b[2J\\x1b[H\");" nl)
                 java7 ( nl "System.out.print(\"\\033[2J\\033[H\");" nl)
                 kotlin ( nl "print(\"\\u001b[2J\\u001b[H\")" nl)
                 php ( nl "echo \"\\x1b[2J\\x1b[H\";" nl)
                 python ( nl "print(\"\\x1b[2J\\x1b[H\", end='')" nl)
                 csharp ( nl "Console.Write(\"\\x1b[2J\\x1b[H\");" nl (imp "System"))
                 swift3 ( nl "print(\"\\u{1b}[2J\\u{1b}[H\", terminator: \"\")" nl)
                 swift6 ( nl "print(\"\\u{1b}[2J\\u{1b}[H\", terminator: \"\")" nl)
                 * ( nl "process.stdout.write(\"\\x1b[2J\\x1b[H\");" nl)
            }
        }

        ; Move cursor to position (1-based coordinates)
        move_cursor     cmdMoveCursor:void      ( x:int y:int) {
            templates {
                 cpp ( nl "std::cout << \"\\x1b[\" << (" (e 2) ") << \";\" << (" (e 1) ") << \"H\" << std::flush;" nl (imp "<iostream>"))
                 go ( nl "fmt.Printf(\"\\x1b[%d;%dH\", " (e 2) ", " (e 1) ")" nl (imp "fmt"))
                 rust ( nl "print!(\"\\x1b[{};{}H\", " (e 2) ", " (e 1) ");" nl)
                 java7 ( nl "System.out.print(\"\\033[\" + (" (e 2) ") + \";\" + (" (e 1) ") + \"H\");" nl)
                 kotlin ( nl "print(\"\\u001b[\" + (" (e 2) ") + \";\" + (" (e 1) ") + \"H\")" nl)
                 php ( nl "echo \"\\x1b[\" . (" (e 2) ") . \";\" . (" (e 1) ") . \"H\";" nl)
                 python ( nl "print(f\"\\x1b[{" (e 2) "};{" (e 1) "}H\", end='')" nl)
                 csharp ( nl "Console.Write($\"\\x1b[{" (e 2) "};{" (e 1) "}H\");" nl (imp "System"))
                 swift3 ( nl "print(\"\\u{1b}[\\(" (e 2) ");\\(" (e 1) ")H\", terminator: \"\")" nl)
                 swift6 ( nl "print(\"\\u{1b}[\\(" (e 2) ");\\(" (e 1) ")H\", terminator: \"\")" nl)
                 * ( nl "process.stdout.write(`\\x1b[${" (e 2) "};${" (e 1) "}H`);" nl)
            }
        }

        ; Hide terminal cursor
        hide_cursor     cmdHideCursor:void      () {
            templates {
                 cpp ( nl "std::cout << \"\\x1b[?25l\" << std::flush;" nl (imp "<iostream>"))
                 go ( nl "fmt.Print(\"\\x1b[?25l\")" nl (imp "fmt"))
                 rust ( nl "print!(\"\\x1b[?25l\");" nl)
                 java7 ( nl "System.out.print(\"\\033[?25l\");" nl)
                 kotlin ( nl "print(\"\\u001b[?25l\")" nl)
                 php ( nl "echo \"\\x1b[?25l\";" nl)
                 python ( nl "print(\"\\x1b[?25l\", end='')" nl)
                 csharp ( nl "Console.Write(\"\\x1b[?25l\");" nl (imp "System"))
                 swift3 ( nl "print(\"\\u{1b}[?25l\", terminator: \"\")" nl)
                 swift6 ( nl "print(\"\\u{1b}[?25l\", terminator: \"\")" nl)
                 * ( nl "process.stdout.write(\"\\x1b[?25l\");" nl)
            }
        }

        ; Show terminal cursor
        show_cursor     cmdShowCursor:void      () {
            templates {
                 cpp ( nl "std::cout << \"\\x1b[?25h\" << std::flush;" nl (imp "<iostream>"))
                 go ( nl "fmt.Print(\"\\x1b[?25h\")" nl (imp "fmt"))
                 rust ( nl "print!(\"\\x1b[?25h\");" nl)
                 java7 ( nl "System.out.print(\"\\033[?25h\");" nl)
                 kotlin ( nl "print(\"\\u001b[?25h\")" nl)
                 php ( nl "echo \"\\x1b[?25h\";" nl)
                 python ( nl "print(\"\\x1b[?25h\", end='')" nl)
                 csharp ( nl "Console.Write(\"\\x1b[?25h\");" nl (imp "System"))
                 swift3 ( nl "print(\"\\u{1b}[?25h\", terminator: \"\")" nl)
                 swift6 ( nl "print(\"\\u{1b}[?25h\", terminator: \"\")" nl)
                 * ( nl "process.stdout.write(\"\\x1b[?25h\");" nl)
            }
        }

        ; Listen for keyboard input - callback receives key:string
        ; Creates a global key queue/receiver that poll_keypress can use
        on_keypress     cmdOnKeypress:void      (keyvar:string code:block) {
            templates {
                 es6 ( nl 
                    "global.r_key_queue = [];" nl
                    "const readline = require('readline');" nl
                    "readline.emitKeypressEvents(process.stdin);" nl
                    "if (process.stdin.isTTY) { process.stdin.setRawMode(true); }" nl
                    "process.stdin.on('keypress', (" (e 1) ", data) => {" nl I
                    "if (data && data.ctrl && data.name === 'c') { process.stdout.write('\\x1b[?25h'); process.exit(); }" nl
                    "if (data && data.name) { " (e 1) " = data.name; global.r_key_queue.push(" (e 1) "); }" nl
                    (block 2) 
                    i nl "});" nl
                 )
                 rust ( nl
                    "let (r_key_sender, r_key_receiver) = std::sync::mpsc::channel::<String>();" nl
                    "*R_KEY_RECEIVER.lock().unwrap() = Some(r_key_receiver);" nl
                    "std::thread::spawn(move || {" nl I
                    "r_setup_raw_mode();" nl
                    "loop {" nl I
                    "if let Some(k) = r_read_key() {" nl I
                    "if r_key_sender.send(k).is_err() { break; }" nl
                    i "}" nl
                    i "}" nl
                    i "});" nl
                    (create_polyfill "
use std::io::Read;
use std::sync::Mutex;

static R_KEY_RECEIVER: Mutex<Option<std::sync::mpsc::Receiver<String>>> = Mutex::new(None);

#[cfg(windows)]
fn r_setup_raw_mode() {
    // Windows: nothing needed, we use _getch() which handles raw input
}

#[cfg(unix)]
fn r_setup_raw_mode() {
    use std::process::Command;
    let _ = Command::new(\"stty\").args([\"-F\", \"/dev/tty\", \"cbreak\", \"min\", \"1\", \"-echo\"]).status();
}

#[cfg(windows)]
fn r_read_key() -> Option<String> {
    extern \"C\" {
        fn _getch() -> i32;
        fn _kbhit() -> i32;
    }
    unsafe {
        if _kbhit() == 0 {
            std::thread::sleep(std::time::Duration::from_millis(10));
            return None;
        }
        let ch = _getch();
        if ch == 3 { // Ctrl+C
            print!(\"\\x1b[?25h\");
            std::process::exit(0);
        }
        // Handle Ctrl+key combinations (1-26 map to Ctrl+A through Ctrl+Z)
        if ch >= 1 && ch <= 26 && ch != 3 {
            let letter = (ch as u8 + 96) as char; // Convert to lowercase letter
            return Some(format!(\"ctrl+{}\", letter));
        }
        if ch == 224 || ch == 0 { // Extended key
            let ch2 = _getch();
            return match ch2 {
                72 => Some(\"up\".to_string()),
                80 => Some(\"down\".to_string()),
                75 => Some(\"left\".to_string()),
                77 => Some(\"right\".to_string()),
                71 => Some(\"home\".to_string()),
                79 => Some(\"end\".to_string()),
                73 => Some(\"pageup\".to_string()),
                81 => Some(\"pagedown\".to_string()),
                82 => Some(\"insert\".to_string()),
                83 => Some(\"delete\".to_string()),
                59..=68 => Some(format!(\"f{}\", ch2 - 58)), // F1-F10
                133 => Some(\"f11\".to_string()),
                134 => Some(\"f12\".to_string()),
                _ => None,
            };
        }
        return match ch {
            8 => Some(\"backspace\".to_string()),
            9 => Some(\"tab\".to_string()),
            13 => Some(\"enter\".to_string()),
            27 => Some(\"escape\".to_string()),
            32 => Some(\"space\".to_string()),
            _ => Some((ch as u8 as char).to_string()),
        };
    }
}

#[cfg(unix)]
fn r_read_key() -> Option<String> {
    let mut buffer = [0u8; 6];
    let stdin = std::io::stdin();
    let mut handle = stdin.lock();
    if handle.read(&mut buffer[0..1]).is_ok() {
        if buffer[0] == 3 { // Ctrl+C
            print!(\"\\x1b[?25h\");
            std::process::exit(0);
        }
        // Handle Ctrl+key combinations (1-26 map to Ctrl+A through Ctrl+Z)
        if buffer[0] >= 1 && buffer[0] <= 26 && buffer[0] != 3 {
            let letter = (buffer[0] + 96) as char;
            return Some(format!(\"ctrl+{}\", letter));
        }
        if buffer[0] == 27 { // Escape sequence
            if handle.read(&mut buffer[1..2]).is_ok() && buffer[1] == 91 {
                if handle.read(&mut buffer[2..3]).is_ok() {
                    // Check for extended sequences like F5-F12, etc.
                    if buffer[2] >= 49 && buffer[2] <= 54 {
                        if handle.read(&mut buffer[3..5]).is_ok() {
                            let seq = &buffer[2..5];
                            return match seq {
                                [49, 53, 126] => Some(\"f5\".to_string()),
                                [49, 55, 126] => Some(\"f6\".to_string()),
                                [49, 56, 126] => Some(\"f7\".to_string()),
                                [49, 57, 126] => Some(\"f8\".to_string()),
                                [50, 48, 126] => Some(\"f9\".to_string()),
                                [50, 49, 126] => Some(\"f10\".to_string()),
                                [50, 51, 126] => Some(\"f11\".to_string()),
                                [50, 52, 126] => Some(\"f12\".to_string()),
                                [50, 126, _] => Some(\"insert\".to_string()),
                                [51, 126, _] => Some(\"delete\".to_string()),
                                [53, 126, _] => Some(\"pageup\".to_string()),
                                [54, 126, _] => Some(\"pagedown\".to_string()),
                                _ => Some(\"escape\".to_string()),
                            };
                        }
                    }
                    return match buffer[2] {
                        65 => Some(\"up\".to_string()),
                        66 => Some(\"down\".to_string()),
                        67 => Some(\"right\".to_string()),
                        68 => Some(\"left\".to_string()),
                        70 => Some(\"end\".to_string()),
                        72 => Some(\"home\".to_string()),
                        // F1-F4 on some terminals
                        80 => Some(\"f1\".to_string()),
                        81 => Some(\"f2\".to_string()),
                        82 => Some(\"f3\".to_string()),
                        83 => Some(\"f4\".to_string()),
                        _ => Some(\"escape\".to_string()),
                    };
                }
            }
            return Some(\"escape\".to_string());
        }
        return match buffer[0] {
            8 | 127 => Some(\"backspace\".to_string()),
            9 => Some(\"tab\".to_string()),
            10 | 13 => Some(\"enter\".to_string()),
            32 => Some(\"space\".to_string()),
            _ => Some((buffer[0] as char).to_string()),
        };
    }
    None
}
")
                 )
                 python ( nl
                    "_ = " (e 1) nl
                    "def _keypress_listener():" nl I
                    "global r_key_queue, r_key_lock" nl
                    "import time" nl
                    "if sys.platform == 'win32':" nl I
                    "import msvcrt" nl
                    "while True:" nl I
                    "if msvcrt.kbhit():" nl I
                    "ch = msvcrt.getch()" nl
                    "if ch == b'\\x03': break" nl
                    "if ch in (b'\\x00', b'\\xe0'):" nl I
                    "ch2 = msvcrt.getch()" nl
                    "k = {b'H': 'up', b'P': 'down', b'K': 'left', b'M': 'right'}.get(ch2, '')" nl i
                    "else:" nl I
                    "k = ch.decode('latin-1') if ch != b' ' else 'space'" nl i
                    "if k:" nl I
                    "with r_key_lock:" nl I
                    "r_key_queue.append(k)" nl i i i
                    "else:" nl I
                    "time.sleep(0.01)" nl i i i
                    "else:" nl I
                    "import tty, termios" nl
                    "fd = sys.stdin.fileno()" nl
                    "old = termios.tcgetattr(fd)" nl
                    "try:" nl I
                    "tty.setraw(fd)" nl
                    "while True:" nl I
                    "ch = sys.stdin.read(1)" nl
                    "if ch == '\\x03': break" nl
                    "if ch == '\\x1b':" nl I
                    "ch2 = sys.stdin.read(2)" nl
                    "k = {'[A': 'up', '[B': 'down', '[C': 'right', '[D': 'left'}.get(ch2, 'escape')" nl i
                    "elif ch == ' ':" nl I
                    "k = 'space'" nl i
                    "else:" nl I
                    "k = ch" nl i
                    "with r_key_lock:" nl I
                    "r_key_queue.append(k)" nl i i i
                    "finally:" nl I
                    "termios.tcsetattr(fd, termios.TCSADRAIN, old)" nl i i i
                    "threading.Thread(target=_keypress_listener, daemon=True).start()" nl
                    (imp "threading")
                    (imp "sys")
                    (polyfill "after_imports" "
r_key_queue = []
r_key_lock = threading.Lock()
")
                 )
                 go ( nl
                    "_ = " (e 1) nl
                    "r_key_channel = make(chan string, 100)" nl
                    "go func() {" nl I
                    "r_setup_raw_mode()" nl
                    "for {" nl I
                    "if k := r_read_key(); k != \"\" {" nl I
                    "r_key_channel <- k" nl
                    "time.Sleep(50 * time.Millisecond)" nl
                    i "}" nl
                    i "}" nl i
                    "}()" nl
                    (imp "os")
                    (imp "os/exec")
                    (imp "fmt")
                    (imp "runtime")
                    (imp "syscall")
                    (imp "time")
                    (imp "unsafe")
                    (polyfill "utilities" "
var r_key_channel chan string

var (
	msvcrt = syscall.NewLazyDLL(\"msvcrt.dll\")
	kbhit = msvcrt.NewProc(\"_kbhit\")
	getch = msvcrt.NewProc(\"_getch\")
)

var _ = unsafe.Sizeof(0) // suppress unused import

func r_setup_raw_mode() {
	if runtime.GOOS != \"windows\" {
		exec.Command(\"stty\", \"-F\", \"/dev/tty\", \"cbreak\", \"min\", \"1\").Run()
		exec.Command(\"stty\", \"-F\", \"/dev/tty\", \"-echo\").Run()
	}
}

func r_read_key() string {
	if runtime.GOOS == \"windows\" {
		ret, _, _ := kbhit.Call()
		if ret == 0 {
			time.Sleep(10 * time.Millisecond)
			return \"\"
		}
		ch, _, _ := getch.Call()
		if ch == 3 { // Ctrl+C
			fmt.Print(\"\\x1b[?25h\")
			os.Exit(0)
		}
		if ch == 224 || ch == 0 { // Extended key
			ch2, _, _ := getch.Call()
			switch ch2 {
			case 72:
				return \"up\"
			case 80:
				return \"down\"
			case 75:
				return \"left\"
			case 77:
				return \"right\"
			}
			return \"\"
		}
		switch ch {
		case 8:
			return \"backspace\"
		case 9:
			return \"tab\"
		case 13:
			return \"enter\"
		case 27:
			return \"escape\"
		case 32:
			return \"space\"
		}
		return string(rune(ch))
	}
	var b []byte = make([]byte, 3)
	n, err := os.Stdin.Read(b[:1])
	if err != nil || n == 0 {
		return \"\"
	}
	if b[0] == 3 { // Ctrl+C
		fmt.Print(\"\\x1b[?25h\")
		os.Exit(0)
	}
	if b[0] == 27 { // Escape sequence
		os.Stdin.Read(b[1:3])
		if b[1] == 91 {
			switch b[2] {
			case 65:
				return \"up\"
			case 66:
				return \"down\"
			case 67:
				return \"right\"
			case 68:
				return \"left\"
			}
		}
		return \"escape\"
	}
	switch b[0] {
	case 8, 127:
		return \"backspace\"
	case 9:
		return \"tab\"
	case 10, 13:
		return \"enter\"
	case 32:
		return \"space\"
	}
	return string(b[0])
}
")
                 )
                 cpp ( nl
                    "std::thread([]() {" nl I
                    "r_setup_raw_mode();" nl
                    "while (true) {" nl I
                    "std::string k = r_read_key();" nl
                    "if (!k.empty()) {" nl I
                    "{" nl I
                    "std::lock_guard<std::mutex> lock(r_key_mutex);" nl
                    "r_key_queue.push(k);" nl
                    i "}" nl
                    "std::this_thread::sleep_for(std::chrono::milliseconds(50));" nl
                    i "}" nl
                    i "}" nl i
                    "}).detach();" nl
                    (imp "<thread>")
                    (imp "<mutex>")
                    (imp "<queue>")
                    (polyfill "utilities" "
#include <string>
#include <queue>
#include <mutex>
#include <thread>
#include <chrono>

std::queue<std::string> r_key_queue;
std::mutex r_key_mutex;

#ifdef _WIN32
#include <conio.h>
void r_setup_raw_mode() {}
std::string r_read_key() {
    if (!_kbhit()) {
        std::this_thread::sleep_for(std::chrono::milliseconds(10));
        return \"\";
    }
    int ch = _getch();
    if (ch == 3) { std::cout << \"\\x1b[?25h\"; exit(0); }
    if (ch == 224 || ch == 0) {
        int ch2 = _getch();
        switch (ch2) {
            case 72: return \"up\";
            case 80: return \"down\";
            case 75: return \"left\";
            case 77: return \"right\";
        }
        return \"\";
    }
    switch (ch) {
        case 8: return \"backspace\";
        case 9: return \"tab\";
        case 13: return \"enter\";
        case 27: return \"escape\";
        case 32: return \"space\";
    }
    return std::string(1, (char)ch);
}
#else
#include <termios.h>
#include <unistd.h>
void r_setup_raw_mode() {
    system(\"stty cbreak min 1 -echo\");
}
std::string r_read_key() {
    char buf[3];
    if (read(STDIN_FILENO, buf, 1) <= 0) return \"\";
    if (buf[0] == 3) { std::cout << \"\\x1b[?25h\"; exit(0); }
    if (buf[0] == 27) {
        read(STDIN_FILENO, buf+1, 2);
        if (buf[1] == 91) {
            switch (buf[2]) {
                case 65: return \"up\";
                case 66: return \"down\";
                case 67: return \"right\";
                case 68: return \"left\";
            }
        }
        return \"escape\";
    }
    switch (buf[0]) {
        case 8: case 127: return \"backspace\";
        case 9: return \"tab\";
        case 10: case 13: return \"enter\";
        case 32: return \"space\";
    }
    return std::string(1, buf[0]);
}
#endif
")
                 )
                 swift3 ( nl
                    "_ = " (e 1) nl
                    "r_key_channel = DispatchQueue(label: \"keypress\")" nl
                    "r_key_channel!.async {" nl I
                    "r_setup_raw_mode()" nl
                    "while true {" nl I
                    "if let k = r_read_key(), !k.isEmpty {" nl I
                    "r_key_queue_lock.lock()" nl
                    "r_key_queue.append(k)" nl
                    "r_key_queue_lock.unlock()" nl
                    "Thread.sleep(forTimeInterval: 0.05)" nl
                    i "}" nl
                    i "}" nl i
                    "}" nl
                    (imp "Foundation")
                    (polyfill "after_imports" "
var r_key_channel: DispatchQueue? = nil
var r_key_queue: [String] = []
var r_key_queue_lock = NSLock()

func r_setup_raw_mode() {
    let _ = system(\"stty cbreak min 1 -echo\")
}

func r_read_key() -> String? {
    var buf = [UInt8](repeating: 0, count: 3)
    let n = read(STDIN_FILENO, &buf, 1)
    if n <= 0 { return nil }
    if buf[0] == 3 { // Ctrl+C
        print(\"\\u{1b}[?25h\", terminator: \"\")
        exit(0)
    }
    if buf[0] == 27 { // Escape sequence
        let _ = read(STDIN_FILENO, &buf[1], 2)
        if buf[1] == 91 {
            switch buf[2] {
            case 65: return \"up\"
            case 66: return \"down\"
            case 67: return \"right\"
            case 68: return \"left\"
            default: break
            }
        }
        return \"escape\"
    }
    switch buf[0] {
    case 8, 127: return \"backspace\"
    case 9: return \"tab\"
    case 10, 13: return \"enter\"
    case 32: return \"space\"
    default: return String(UnicodeScalar(buf[0]))
    }
}
")
                 )
                 swift6 ( nl
                    "_ = " (e 1) nl
                    "r_key_channel = DispatchQueue(label: \"keypress\")" nl
                    "r_key_channel!.async {" nl I
                    "r_setup_raw_mode()" nl
                    "while true {" nl I
                    "if let k = r_read_key(), !k.isEmpty {" nl I
                    "r_key_queue_lock.lock()" nl
                    "r_key_queue.append(k)" nl
                    "r_key_queue_lock.unlock()" nl
                    i "}" nl
                    "Thread.sleep(forTimeInterval: 0.01)" nl
                    i "}" nl i
                    "}" nl
                    (imp "Foundation")
                    (polyfill "after_imports" "
var r_key_channel: DispatchQueue? = nil
var r_key_queue: [String] = []
var r_key_queue_lock = NSLock()

#if os(Windows)
@_silgen_name(\"_kbhit\") func _kbhit() -> Int32
@_silgen_name(\"_getch\") func _getch() -> Int32

func r_setup_raw_mode() {
    // No setup needed on Windows
}

func r_read_key() -> String? {
    if _kbhit() == 0 { return nil }
    let ch = _getch()
    if ch == 3 { // Ctrl+C
        print(\"\\u{1b}[?25h\", terminator: \"\")
        exit(0)
    }
    if ch == 224 || ch == 0 { // Extended key
        let ch2 = _getch()
        switch ch2 {
        case 72: return \"up\"
        case 80: return \"down\"
        case 75: return \"left\"
        case 77: return \"right\"
        default: return \"\"
        }
    }
    switch ch {
    case 8: return \"backspace\"
    case 9: return \"tab\"
    case 13: return \"enter\"
    case 27: return \"escape\"
    case 32: return \"space\"
    default: return String(UnicodeScalar(UInt8(ch)))
    }
}
#else
func r_setup_raw_mode() {
    let _ = system(\"stty cbreak min 1 -echo\")
}

func r_read_key() -> String? {
    var buf = [UInt8](repeating: 0, count: 3)
    let n = read(STDIN_FILENO, &buf, 1)
    if n <= 0 { return nil }
    if buf[0] == 3 { // Ctrl+C
        print(\"\\u{1b}[?25h\", terminator: \"\")
        exit(0)
    }
    if buf[0] == 27 { // Escape sequence
        let _ = read(STDIN_FILENO, &buf[1], 2)
        if buf[1] == 91 {
            switch buf[2] {
            case 65: return \"up\"
            case 66: return \"down\"
            case 67: return \"right\"
            case 68: return \"left\"
            default: break
            }
        }
        return \"escape\"
    }
    switch buf[0] {
    case 8, 127: return \"backspace\"
    case 9: return \"tab\"
    case 10, 13: return \"enter\"
    case 32: return \"space\"
    default: return String(UnicodeScalar(buf[0]))
    }
}
#endif
")
                 )
                 kotlin ( nl
                    "r_key_channel = java.util.concurrent.LinkedBlockingQueue<String>()" nl
                    "Thread {" nl I
                    "r_setup_raw_mode()" nl
                    "while (true) {" nl I
                    "val k = r_read_key()" nl
                    "if (k.isNotEmpty()) {" nl I
                    "r_key_channel?.offer(k)" nl
                    i "}" nl
                    i "}" nl i
                    "}.start()" nl
                    (polyfill "after_imports" "
var r_key_channel: java.util.concurrent.BlockingQueue<String>? = null
var r_windows_key_process: Process? = null
var r_windows_key_reader: java.io.BufferedReader? = null

fun r_setup_raw_mode() {
    val os = System.getProperty(\"os.name\").lowercase()
    if (os.contains(\"win\")) {
        // Start a persistent PowerShell process for reading keys
        val pb = ProcessBuilder(\"powershell\", \"-NoProfile\", \"-Command\", 
            \"[Console]::TreatControlCAsInput = \\$true; while(\\$true) { \\$k = \\$host.UI.RawUI.ReadKey('NoEcho,IncludeKeyDown'); [Console]::WriteLine(\\$k.VirtualKeyCode) }\")
        pb.redirectErrorStream(true)
        r_windows_key_process = pb.start()
        r_windows_key_reader = r_windows_key_process?.inputStream?.bufferedReader()
    } else {
        Runtime.getRuntime().exec(arrayOf(\"/bin/sh\", \"-c\", \"stty -F /dev/tty cbreak min 1 -echo\"))
    }
    // Add shutdown hook to restore cursor
    Runtime.getRuntime().addShutdownHook(Thread {
        print(\"\\u001b[?25h\")
        r_windows_key_process?.destroyForcibly()
    })
}

fun r_read_key(): String {
    val os = System.getProperty(\"os.name\").lowercase()
    if (os.contains(\"win\")) {
        // Read from persistent PowerShell process (blocks until key available)
        try {
            val reader = r_windows_key_reader ?: return \"\"
            val line = reader.readLine() ?: return \"\"
            val code = line.trim().toIntOrNull() ?: return \"\"
            if (code == 3 || code == 67) { // Ctrl+C check
                print(\"\\u001b[?25h\")
                r_windows_key_process?.destroyForcibly()
                System.exit(0)
            }
            return when (code) {
                38 -> \"up\"
                40 -> \"down\"
                37 -> \"left\"
                39 -> \"right\"
                32 -> \"space\"
                13 -> \"enter\"
                27 -> \"escape\"
                8 -> \"backspace\"
                9 -> \"tab\"
                else -> if (code in 65..90) code.toChar().lowercase() else \"\"
            }
        } catch (e: Exception) { return \"\" }
    } else {
        // Unix: read from stdin
        try {
            val buf = ByteArray(3)
            val n = System.`in`.read(buf, 0, 1)
            if (n <= 0) return \"\"
            if (buf[0].toInt() == 3) { // Ctrl+C
                print(\"\\u001b[?25h\")
                System.exit(0)
            }
            if (buf[0].toInt() == 27) { // Escape sequence
                System.`in`.read(buf, 1, 2)
                if (buf[1].toInt() == 91) {
                    return when (buf[2].toInt()) {
                        65 -> \"up\"
                        66 -> \"down\"
                        67 -> \"right\"
                        68 -> \"left\"
                        else -> \"escape\"
                    }
                }
                return \"escape\"
            }
            return when (buf[0].toInt()) {
                8, 127 -> \"backspace\"
                9 -> \"tab\"
                10, 13 -> \"enter\"
                32 -> \"space\"
                else -> buf[0].toInt().toChar().toString()
            }
        } catch (e: Exception) { return \"\" }
    }
}
")
                 )
                 * ( nl "// on_keypress not implemented for this target" nl)
            }
        }

        ; Poll for keypress (non-blocking, for use in game loops)
        ; Returns empty string if no key is available
        poll_keypress   cmdPollKey:string       () {
            templates {
                 es6 ( "(global.r_key_queue && global.r_key_queue.length > 0 ? global.r_key_queue.shift() : \"\")" )
                 rust ( 
                    "{" nl I
                    "if let Some(ref recv) = *R_KEY_RECEIVER.lock().unwrap() {" nl I
                    "recv.try_recv().unwrap_or_default()" nl
                    i "} else { String::new() }" nl
                    i "}"
                 )
                 go (
                    "func() string { select { case k := <-r_key_channel: return k; default: return \"\" } }()"
                 )
                 cpp (
                    "[&]() -> std::string { std::lock_guard<std::mutex> lock(r_key_mutex); if (r_key_queue.empty()) return \"\"; std::string k = r_key_queue.front(); r_key_queue.pop(); return k; }()"
                 )
                 python (
                    "(r_key_queue.pop(0) if r_key_queue else \"\")"
                 )
                 swift3 (
                    "{ () -> String in r_key_queue_lock.lock(); defer { r_key_queue_lock.unlock() }; if r_key_queue.isEmpty { return \"\" }; return r_key_queue.removeFirst() }()"
                 )
                 swift6 (
                    "{ () -> String in r_key_queue_lock.lock(); defer { r_key_queue_lock.unlock() }; if r_key_queue.isEmpty { return \"\" }; return r_key_queue.removeFirst() }()"
                 )
                 kotlin (
                    "(r_key_channel?.poll() ?: \"\")"
                 )
                 * ( "\"\"" )
            }
        }

        ; Sleep for specified milliseconds (blocking)
        sleep_ms        cmdSleepMs@(async):void         (ms:int) {
            templates {
                 es6 ( nl "await new Promise(r => setTimeout(r, " (e 1) "));" nl )
                 rust ( nl "std::thread::sleep(std::time::Duration::from_millis(" (e 1) " as u64));" nl )
                 go ( nl "time.Sleep(time.Duration(" (e 1) ") * time.Millisecond)" nl (imp "time"))
                 cpp ( nl "std::this_thread::sleep_for(std::chrono::milliseconds(" (e 1) "));" nl (imp "<chrono>") (imp "<thread>"))
                 java7 ( nl "try { Thread.sleep(" (e 1) "); } catch (InterruptedException e) {}" nl )
                 kotlin ( nl "Thread.sleep(" (e 1) ".toLong())" nl )
                 python ( nl "time.sleep(" (e 1) " / 1000.0)" nl (imp "time"))
                 csharp ( nl "System.Threading.Thread.Sleep(" (e 1) ");" nl )
                 php ( nl "usleep(" (e 1) " * 1000);" nl )
                 swift3 ( nl "usleep(UInt32(" (e 1) " * 1000))" nl )
                 swift6 ( nl "Thread.sleep(forTimeInterval: Double(" (e 1) ") / 1000.0)" nl (imp "Foundation"))
                 * ( nl "// sleep_ms not implemented" nl )
            }
        }

        exit            cmdExit:void            ( code:int) {
            templates {
                 ranger ( nl "exit " (e 1) nl)
                 cpp ( nl "exit(" (e 1) ");" nl (imp "<cstdlib>"))
                 kotlin ( nl "System.exit(" (e 1) ")" nl )
                 scala ( nl "System.exit(" (e 1) ")" nl )
                 go ( nl "os.Exit(" (e 1) ")" nl (imp "os"))
                 rust ( nl "std::process::exit(" (e 1) ");" nl )
                 java7 ( nl "System.exit(" (e 1) ");" nl )
                 php ( nl "exit(" (e 1) ");" nl )
                 python ( nl "sys.exit(" (e 1) ")" nl (imp "sys"))
                 csharp ( nl "Environment.Exit(" (e 1) ");" nl (imp "System"))
                 swift3 ( nl "exit(Int32(" (e 1) "))" nl (imp "Foundation"))
                 * ( nl "process.exit(" (e 1) ");" nl)
            }
        }

        to_lowercase _:string (s:string) {
            templates {
                es6 ((e 1) '.toLowerCase()')
                java7 ((e 1) '.toLowerCase()')
                go ( "strings.ToLower(" (e 1) ")" (imp "strings"))
                php ("strtolower(" (e 1) ")")
                csharp ((e 1) ".ToLower()")
                swift3 ((e 1) ".lowercased()")
                scala ((e 1) ".toLowerCase()")
                python ((e 1) ".lower()")
            }
        }
        to_uppercase _:string (s:string) {
            templates {
                swift3 ( (e 1) ".uppercased()")
                scala ( (e 1 ) ".toUpperCase()" )
                ranger ("(to_uppercase " (e 1) ")")
                es6 ( (e 1) ".toUpperCase()")
                java7 ( (e 1) ".toUpperCase()")
                php( "strtoupper(" (e 1) ")")
                csharp ( (e 1) ".ToUpper()" )
                python ( (e 1) ".upper()" )
                cpp (                     
                    "r_cpp_str_to_uppercase(" (e 1) ")"
                        (imp "<algorithm>")
                        (imp "<string>")
(create_polyfill "
std::string r_cpp_str_to_uppercase(std::string original) 
{
    std::string str = original;
    std::transform(str.begin(), str.end(),str.begin(), ::toupper);  
    return str;
}    
    ") 

                    )
                go ( "strings.ToUpper(" (e 1) ")" (imp "strings"))
            }
        }

        ; ----------------------------------------------------------------------------------------------------------
        ; conversions


        to_double       toDouble:double ( input:int ) {
            templates {
                ranger ("( to_double " (e 1) " )")
                go ("float64( " (e 1) " )")
                es6 ( (e 1) )
                swift3 ("Double(" (e 1) ")")
                scala ( (e 1) '.toDouble')
                java7 ("Double.valueOf(" (e 1) ")")
                cpp ("(double)(" (e 1) ")")
                php ( (e 1) )
                rust ("(" (e 1) " as f64)")
            }
        }

        to_int _:int (value:string) {
            templates {
                php ("intvalue(" (e 1)")")
            }
        }

        ; ----------------------------------------------------------------------------------------------------------

        ==              cmdEqual:boolean ( left:string right:string ) { 
            templates { 
                java7 ( (e 1) ".equals(" (e 2) ")" ) 
                * ( (e 1) " == " (e 2) ) 
            } 
        }

        ==              cmdEqual:boolean ( left:T right:T ) { templates { * ( (e 1) " == " (e 2) ) } }
        ==              cmdEqual:boolean ( left:enum right:enum ) { templates { * ( (e 1) " == " (e 2) ) } }

        ==              cmdEqual:boolean ( left:int right:char ) { 
                templates { 
                    go ( (e 1) " == int64(" (e 2) ")" ) 
                    * ( (e 1) " == " (e 2) ) 
                } 
        }
        ==              cmdEqual:boolean ( left:char right:int ) { 
                templates { 
                    go ( "int64(" (e 1) ") == " (e 2) ) 
                    * ( (e 1) " == " (e 2) ) 
                } 
        }

        ==              cmdEqual:boolean ( left:int right:int ) { templates { * ( (e 1) " == " (e 2) ) } }
        ==              cmdEqual:boolean ( left:double right:double ) { templates { * ( (e 1) " == " (e 2) ) } }
        ==              cmdEqual:boolean ( left:boolean right:boolean ) { templates { * ( (e 1) " == " (e 2) ) } }
        
        
        >               cmdGt:boolean ( left:double right:double ) { templates { * ( (e 1) " > " (e 2) ) } }
        >               cmdGt:boolean ( left:int right:int ) { templates { * ( (e 1) " > " (e 2) ) } }

        ; ----------------------------------------------------------------------------------------------------------
        ; TODO: expression to cast the types comparing to character

        <=               cmdLte:boolean ( left:char right:int ) { 
            templates {
                go ( "int64(" (e 1) ") <= " (e 2) "")                 
                * ( (e 1) " <= " (e 2) ) 
            } 
        }
        <=               cmdLte:boolean ( left:int right:char ) { 
            templates { 
                go ( (e 1) " <= int64(" (e 2) ")")
                * ( (e 1) " <= " (e 2) ) 
            } 
        }
        <=               cmdLte:boolean ( left:char right:char ) { 
            templates { * ( (e 1) " <= " (e 2) ) } 
        }

        <               cmdLt:boolean ( left:int right:char ) { 
            templates {
                go ( (e 1) " < int64(" (e 2) ")")
                * ( (e 1) " < " (e 2) ) 
                } 
        }

        <               cmdLt:boolean ( left:char right:int ) { 
            templates {
                go ( "int64(" (e 1) ") < " (e 2) ) 
                * ( (e 1) " < " (e 2) ) 
            } 
        }

        <               cmdLt:boolean ( left:char right:char ) { 
            templates { * ( (e 1) " < " (e 2) ) } 
        }

        ==               cmdEq:boolean ( left:int right:char ) { 
            templates { * ( (e 1) " == " (e 2) ) } 
        }

        ==               cmdEq:boolean ( left:char right:int ) { 
            templates { * ( (e 1) " == " (e 2) ) } 
        }

        ==               cmdEq:boolean ( left:char right:char ) { 
            templates { * ( (e 1) " == " (e 2) ) } 
        }

        !=               cmdNeq:boolean ( left:string right:string ) { 
            templates { 
                java7 ( "!" (e 1) ".equals(" (e 2) ")") 
                * ( (e 1) " != " (e 2) ) 
            } 
        }        

        !=               cmdNeq:boolean ( left:int right:char ) { 
            templates { 
                go ( (e 1) " != int64(" (e 2) ")" ) 
                * ( (e 1) " != " (e 2) ) 
            } 
        }

        !=               cmdNeq:boolean ( left:char right:int ) { 
            templates { 
                go ( "int64(" (e 1) ") != " (e 2) ) 
                * ( (e 1) " != " (e 2) ) 
            } 
        }

        !=               cmdNeq:boolean ( left:char right:char ) { 
            templates { * ( (e 1) " != " (e 2) ) } 
        }


        !=               cmdNeq:boolean ( left:T right:T ) { 
            templates { * ( (e 1) " != " (e 2) ) } 
        }
        
        >=               cmdGte:boolean ( left:int right:char ) { 
            templates { * ( (e 1) " >= " (e 2) ) } 
        }
        >=               cmdGte:boolean ( left:char right:int ) { 
            templates { 
                go ( "int64(" (e 1) ") >= " (e 2) ) 
                * ( (e 1) " >= " (e 2) ) 
            } 
        }
        >=               cmdGte:boolean ( left:char right:char ) { 
            templates { * ( (e 1) " >= " (e 2) ) } 
        }
        
        >               cmdGt:boolean ( left:int right:char ) { 
            templates { 
                go ( (e 1) " > int64(" (e 2) ")" )
                * ( (e 1) " > " (e 2) ) } 
        }
        >               cmdGt:boolean ( left:char right:int ) { 
            templates { 
                go ( "int64(" (e 1) ") > " (e 2) )                
                * ( (e 1) " > " (e 2) ) } 
        }
        >               cmdGt:boolean ( left:char right:char ) { 
            templates { * ( (e 1) " > " (e 2) ) } 
        }

        ;------------------------------------------------------------------------------------------------------------

        <               cmdLt:boolean ( left:int right:int ) { templates { * ( (e 1) " < " (e 2) ) } }
        <               cmdLt:boolean ( left:double right:double ) { templates { * ( (e 1) " < " (e 2) ) } }

        <=              cmdLte:boolean ( left:int right:int ) { templates { * ( (e 1) " <= " (e 2) ) } }
        <=              cmdLte:boolean ( left:double right:double ) { templates { * ( (e 1) " <= " (e 2) ) } }

        >=              cmdGte:boolean ( left:int right:int ) { templates { * ( (e 1) " >= " (e 2) ) } }
        >=              cmdGte:boolean ( left:double right:double ) { templates { * ( (e 1) " >= " (e 2) ) } }

        ; optional testing
        &&              cmdLogicAnd:boolean ( left@(optional):T right@(optional):S ) { 
            templates { 
                ranger ( "(" (e 1) " && " (e 2) ")" ) 
                scala ( (e 1) ".isDefined  && " (e 2) ".isDefined") 
                csharp ( (e 1) ".HasValue  && " (e 2) ".HasValue") 

                php ( "isset("(e 1) ") && isset(" (e 2) ")") 
                java7 ( (e 1) ".isPresent()  && " (e 2) ".isPresent()") 
                rust ( (e 1) ".is_some()  && " (e 2) ".is_some()") 
                swift3 ( (e 1) " != nil  && " (e 2) " != nil") 
                go ( "" (e 1) ".has_value  && " "" (e 2) ".has_value")
                cpp ( "" (e 1) "!= NULL  && " "" (e 2) " != NULL") 
                kotlin ( (e 1) " != null  && " (e 2) " != null") 
                python ( '(' (e 1) " is not None and " (e 2) " is not None)")

                * ( "typeof(" ( e 1 ) ") != \"undefined\" && typeof(" ( e 2 ) ") != \"undefined\"" ) 
            } 
        }
        &&              cmdLogicAnd:boolean ( left:boolean right@(optional):S ) { 
            templates {
                ranger ( "(" (e 1) " && " (e 2) ")" ) 
                php ( (e 1) " && isset(" (e 2) ")") 
                scala ( (e 1) " && " (e 2) ".isDefined") 
                java7 ( (e 1) " && " (e 2) ".isPresent()") 
                csharp ( (e 1) " && " (e 2) "HasValue") 

                rust ( (e 1) " && " (e 2) ".is_some()") 
                swift3 ( (e 1) " && " (e 2) " != nil") 
                go ( (e 1) " && " "" (e 2) ".has_value") 
                cpp ( (e 1) " && " "" (e 2) "!= NULL ") 
                kotlin ( (e 1) " && " (e 2) " != null") 
                python ( (e 1) " and " (e 2) " is not None") 
                cpp (e 1) " && " (e 2) 
                * ( (e 1) " && " "typeof(" ( e 2 ) ") != \"undefined\"") 
            } 
        }
        &&              cmdLogicAnd:boolean ( left@(optional):T right:boolean ) { 
            templates { 
                ranger ( "(" (e 1) " && " (e 2) ")" ) 
                php ( "isset("(e 1) ") && " (e 2) ) 
                scala ( ""(e 1) ".isDefined && " (e 2) ) 
                java7 ( ""(e 1) ".isPresent() && " (e 2) ) 
                csharp ( ""(e 1) ".HasValue && " (e 2) ) 

                rust ( ""(e 1) ".is_some() && " (e 2) ) 
                swift3 ( ""(e 1) " != nil && " (e 2) ) 
                go ( "" (e 1) ".has_value && " (e 2) ) 
                cpp ( "" (e 1) " != NULL && " (e 2) ) 
                kotlin ( ""(e 1) " != null && " (e 2) ) 
                python ( (e 1) " is not None and " (e 2) ) 
                cpp (e 1) " && " (e 2) 
                * ( "typeof(" ( e 1 ) ") != \"undefined\"" " && " (e 2) ) 
            } 
        }



        &&              cmdLogicAnd:boolean ( left:boolean right:boolean ) { 
            templates { 
                python ( (e 1) " and " (e 2) ) 
                * ( (e 1) " && " (e 2) ) 
            } 
        }
        &&              cmdLogicAnd:boolean ( p1:boolean p2:boolean p3:boolean) { 
            templates { 
                python ( (e 1) " and " (e 2) " and " (e 3) )  
                * ( (e 1) " && " (e 2) " && " (e 3) )  
            } 
        }
        &&              cmdLogicAnd:boolean ( p1:boolean p2:boolean p3:boolean p4:boolean ) { 
            templates { 
                python ( (e 1) " and " (e 2) " and " (e 3) " and " (e 4) )  
                * ( (e 1) " && " (e 2) " && " (e 3) " && " (e 4) )  
            } 
        }
        &&              cmdLogicAnd:boolean ( p1:boolean p2:boolean p3:boolean p4:boolean p5:boolean ) { 
            templates { 
                python ( (e 1) " and " (e 2) " and " (e 3) " and " (e 4) " and " (e 5) ) 
                * ( (e 1) " && " (e 2) " && " (e 3) " && " (e 4) " && " (e 5) ) 
            } 
        }
        &&              cmdLogicAnd:boolean ( p1:boolean p2:boolean p3:boolean p4:boolean p5:boolean p6:boolean ) { templates { * ( (e 1) " && " (e 2) " && " (e 3) " && " (e 4) " && " (e 5) " && " (e 6) ) } }
        &&              cmdLogicAnd:boolean ( p1:boolean p2:boolean p3:boolean p4:boolean p5:boolean p6:boolean p7:boolean ) { templates { * ( (e 1) " && " (e 2) " && " (e 3) " && " (e 4) " && " (e 5) " && " (e 6) " && " (e 7) ) } }

        ||              cmdLogicOr:boolean ( left:boolean right:boolean ) { 
            templates { 
                python ( (e 1) " or " (e 2) ) 
                * ( (e 1) " || " (e 2) ) 
            } 
        }
        ||              cmdLogicOr:boolean ( p1:boolean p2:boolean p3:boolean  ) { 
            templates { 
                python ( (e 1) " or " (e 2) " or " (e 3) ) 
                * ( (e 1) " || " (e 2) " || " (e 3) ) 
            } 
        }
        ||              cmdLogicOr:boolean ( p1:boolean p2:boolean p3:boolean p4:boolean     ) { 
            templates { 
                python ( (e 1) " or " (e 2) " or " (e 3) " or " (e 4) )  
                * ( (e 1) " || " (e 2) " || " (e 3) " || " (e 4) )  
            } 
        }
        ||              cmdLogicOr:boolean ( p1:boolean p2:boolean p3:boolean p4:boolean p5:boolean    ) { 
            templates { 
                python ( (e 1) " or " (e 2) " or " (e 3) " or " (e 4) " or " (e 5) ) 
                * ( (e 1) " || " (e 2) " || " (e 3) " || " (e 4) " || " (e 5) ) 
            } 
        }        
        ||              cmdLogicOr:boolean ( p1:boolean p2:boolean p3:boolean p4:boolean p5:boolean p6:boolean    ) { 
            templates { 
                python ( (e 1) " or " (e 2) " or " (e 3) " or " (e 4) " or " (e 5) " or " (e 6) ) 
                * ( (e 1) " || " (e 2) " || " (e 3) " || " (e 4) " || " (e 5) " || " (e 6) ) 
            } 
        }

        ; ============================================================================
        ; HTTP Request Operators
        ; ============================================================================
        
        http_get_method cmdHttpGetMethod:string (req:HttpRequest) {
            templates {
                go ( (e 1) ".Method" )
                es6 ( (e 1) ".method" )
                * ( "/* http_get_method not implemented */" )
            }
        }
        
        http_get_path cmdHttpGetPath:string (req:HttpRequest) {
            templates {
                go ( (e 1) ".URL.Path" )
                es6 ( (e 1) ".url" )
                * ( "/* http_get_path not implemented */" )
            }
        }
        
        http_get_param cmdHttpGetParam:string (req:HttpRequest name:string) {
            templates {
                go ( (e 1) ".PathValue(" (e 2) ")" )
                es6 ( (e 1) ".params[" (e 2) "]" )
                * ( "/* http_get_param not implemented */" )
            }
        }
        
        http_get_query cmdHttpGetQuery:string (req:HttpRequest name:string) {
            templates {
                go ( (e 1) ".URL.Query().Get(" (e 2) ")" )
                es6 ( (e 1) ".query[" (e 2) "]" )
                * ( "/* http_get_query not implemented */" )
            }
        }
        
        http_get_header cmdHttpGetHeader:string (req:HttpRequest name:string) {
            templates {
                go ( (e 1) ".Header.Get(" (e 2) ")" )
                es6 ( (e 1) ".headers.get(" (e 2) ")" )
                * ( "/* http_get_header not implemented */" )
            }
        }
        
        ; ============================================================================
        ; HTTP Response Operators
        ; ============================================================================
        
        http_set_status cmdHttpSetStatus:void (res:HttpResponse code:int) {
            templates {
                go ( (e 1) ".WriteHeader(int(" (e 2) "))" nl )
                es6 ( (e 1) ".status(" (e 2) ")" nl )
                * ( "/* http_set_status not implemented */" nl )
            }
        }
        
        http_set_header cmdHttpSetHeader:void (res:HttpResponse name:string value:string) {
            templates {
                go ( (e 1) ".Header().Set(" (e 2) ", " (e 3) ")" nl )
                es6 ( (e 1) ".setHeader(" (e 2) ", " (e 3) ")" nl )
                * ( "/* http_set_header not implemented */" nl )
            }
        }
        
        http_send cmdHttpSend:void (res:HttpResponse body:string) {
            templates {
                go ( (e 1) ".Write([]byte(" (e 2) "))" nl )
                es6 ( (e 1) ".send(" (e 2) ")" nl )
                * ( "/* http_send not implemented */" nl )
            }
        }
        
        http_send_bytes cmdHttpSendBytes:void (res:HttpResponse content:charbuffer) {
            templates {
                go ( (e 1) ".Write(" (e 2) ")" nl )
                es6 ( (e 1) ".send(Buffer.from(" (e 2) "))" nl )
                * ( "/* http_send_bytes not implemented */" nl )
            }
        }
        
        http_send_buffer cmdHttpSendBuffer:void (res:HttpResponse content:buffer) {
            templates {
                go ( (e 1) ".Write(" (e 2) ")" nl )
                es6 ( (e 1) ".send(Buffer.from(" (e 2) "))" nl )
                * ( "/* http_send_buffer not implemented */" nl )
            }
        }
        
        ; ============================================================================
        ; SSE (Server-Sent Events) Operators
        ; ============================================================================
        
        sse_send cmdSSESend:void (client:SSEClient event:string data:string) {
            templates {
                go ( 
                    "fmt.Fprintf(" (e 1) ".Writer, \"event: %s\\ndata: %s\\n\\n\", " (e 2) ", " (e 3) ")" nl
                    (e 1) ".Flusher.Flush()" nl
                    (imp "fmt")
                )
                es6 ( (e 1) ".send(" (e 2) ", " (e 3) ")" nl )
                * ( "/* sse_send not implemented */" nl )
            }
        }
        
        sse_is_connected cmdSSEIsConnected:boolean (client:SSEClient) {
            templates {
                go ( (e 1) ".IsConnected" )
                es6 ( (e 1) ".isConnected()" )
                * ( "false /* sse_is_connected not implemented */" )
            }
        }

        ; HTTP Server Lifecycle Operators
        ; These are special operators - the Go writer will detect @(HttpServer) class
        ; and generate route setup code when start is called on HttpServer
        
        ; Start HTTP server - wires up all @(GET), @(POST), @(SSE) routes and starts listening
        ; Usage: start server 8080   OR   start server  (uses default port from annotation)
        ; The Go writer generates http.HandleFunc calls for each annotated method
        start@(moves@( 1 )) cmdHttpServerStart:void (server:HttpServer port:int) {
            templates {
                go ( (custom _) )
                es6 ( (e 1) ".start(" (e 2) ")" )
                * ( "/* start HttpServer not implemented */" )
            }
        }

        ; Stop HTTP server gracefully
        ; Usage: stop server
        stop@(moves@( 1 )) cmdHttpServerStop:void (server:HttpServer) {
            templates {
                go ( (e 1) ".Shutdown(context.Background())" )
                es6 ( (e 1) ".stop()" )
                * ( "/* stop HttpServer not implemented */" )
            }
        }

    }



}

; ============================================================================
; SYSTEM CLASS: buffer
; ============================================================================
; Binary buffer type for low-level byte operations.
; This provides a unified buffer type across all target languages.
; ============================================================================

systemclass buffer {
    es6 ArrayBuffer
    go "[]byte"
    rust "Vec<u8>"
    cpp "std::vector<uint8_t>"
    java7 "byte[]"
    python bytearray
    swift6 "[UInt8]"
    csharp "byte[]"
    kotlin ByteArray
    scala "Array[Byte]"
}

; SYSTEM CLASS: int_buffer
; ============================================================================
; Fixed-size int64 array for performance-critical code.
; Use for lookup tables, DCT coefficients, pixel buffers, etc.
; ============================================================================

systemclass int_buffer {
    es6 Int32Array
    go "[]int64"
    rust "Vec<i64>"
    cpp "std::vector<int64_t>"
    java7 "long[]"
    python list
    swift6 "[Int64]"
    csharp "long[]"
    kotlin LongArray
    scala "Array[Long]"
}

; SYSTEM CLASS: double_buffer
; ============================================================================
; Fixed-size float64 array for performance-critical code.
; Use for DSP, signal processing, matrix operations, etc.
; ============================================================================

systemclass double_buffer {
    es6 Float64Array
    go "[]float64"
    rust "Vec<f64>"
    cpp "std::vector<double>"
    java7 "double[]"
    python list
    swift6 "[Double]"
    csharp "double[]"
    kotlin DoubleArray
    scala "Array[Double]"
}

; ============================================================================
; SYSTEM CLASSES: HTTP Server Types
; ============================================================================
; HTTP server types for building web servers and APIs.
; These are used with the @(HttpServer) annotation system.
; See PLAN_HTTP.md for details.
; ============================================================================

; HTTP Request object - represents an incoming HTTP request
systemclass HttpRequest {
    es6 Request
    go "*http.Request" ((imp '"net/http"'))
}

; HTTP Response Writer - for writing HTTP responses
systemclass HttpResponse {
    es6 Response
    go "http.ResponseWriter" ((imp '"net/http"'))
}

; Server-Sent Events client - for SSE streaming connections
systemclass SSEClient {
    es6 SSEClient
    go "*SSEClient"
}

; HTTP Server instance - for server control
systemclass HttpServer {
    es6 Server
    go "*http.Server" ((imp '"net/http"'))
}
