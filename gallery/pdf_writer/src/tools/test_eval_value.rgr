; =============================================================================
; Unit Tests for EvalValue
; =============================================================================
; Run with: npm run evaltest:compile && npm run evaltest:run

Import "../jsx/EvalValue.rgr"

class TestEvalValue {
    def passed:int 0
    def failed:int 0
    
    fn expectTrue:void (condition:boolean msg:string) {
        if condition {
            print "  ✓ " + msg
            passed = passed + 1
        } {
            print "  ✗ FAIL: " + msg
            failed = failed + 1
        }
    }
    
    fn expectFalse:void (condition:boolean msg:string) {
        if (condition == false) {
            print "  ✓ " + msg
            passed = passed + 1
        } {
            print "  ✗ FAIL: " + msg
            failed = failed + 1
        }
    }
    
    fn expectStrEq:void (actual:string expected:string msg:string) {
        if (actual == expected) {
            print "  ✓ " + msg
            passed = passed + 1
        } {
            print "  ✗ FAIL: " + msg + " (got '" + actual + "')"
            failed = failed + 1
        }
    }
    
    fn expectNumEq:void (actual:double expected:double msg:string) {
        if (actual == expected) {
            print "  ✓ " + msg
            passed = passed + 1
        } {
            print "  ✗ FAIL: " + msg + " (got " + (to_string actual) + ")"
            failed = failed + 1
        }
    }
    
    fn header:void (name:string) {
        print ""
        print "=== " + name + " ==="
    }
    
    fn summary:void () {
        print ""
        print "================================"
        print "Tests: " + (to_string (passed + failed))
        print "Passed: " + (to_string passed)
        print "Failed: " + (to_string failed)
        print "================================"
    }
    
    sfn m@(main):void () {
        def t:TestEvalValue (new TestEvalValue())
        
        ; ===================================================================
        ; Test constructors and type checks
        ; ===================================================================
        
        t.header("Null value")
        def nullVal:EvalValue (EvalValue.null())
        t.expectTrue(nullVal.isNull(), "isNull() returns true")
        t.expectFalse(nullVal.isNumber(), "isNumber() returns false")
        t.expectStrEq(nullVal.toString(), "null", "toString() returns 'null'")
        t.expectFalse(nullVal.toBool(), "toBool() returns false")
        
        t.header("Number values")
        def num1:EvalValue (EvalValue.number(42.0))
        t.expectTrue(num1.isNumber(), "isNumber() returns true")
        t.expectNumEq(num1.numberValue, 42.0, "numberValue is 42.0")
        t.expectStrEq(num1.toString(), "42", "toString() returns '42'")
        t.expectTrue(num1.toBool(), "toBool() returns true for non-zero")
        
        def num2:EvalValue (EvalValue.number(0.0))
        t.expectFalse(num2.toBool(), "toBool() returns false for zero")
        
        def num3:EvalValue (EvalValue.number(3.14))
        t.expectNumEq(num3.numberValue, 3.14, "numberValue is 3.14")
        
        def num4:EvalValue (EvalValue.fromInt(100))
        t.expectNumEq(num4.numberValue, 100.0, "fromInt creates correct value")
        
        t.header("String values")
        def str1:EvalValue (EvalValue.string("hello"))
        t.expectTrue(str1.isString(), "isString() returns true")
        t.expectStrEq(str1.stringValue, "hello", "stringValue is 'hello'")
        t.expectStrEq(str1.toString(), "hello", "toString() returns 'hello'")
        t.expectTrue(str1.toBool(), "toBool() returns true for non-empty string")
        
        def str2:EvalValue (EvalValue.string(""))
        t.expectFalse(str2.toBool(), "toBool() returns false for empty string")
        
        t.header("Boolean values")
        def bool1:EvalValue (EvalValue.boolean(true))
        t.expectTrue(bool1.isBoolean(), "isBoolean() returns true")
        t.expectTrue(bool1.boolValue, "boolValue is true")
        t.expectStrEq(bool1.toString(), "true", "toString() returns 'true'")
        t.expectTrue(bool1.toBool(), "toBool() returns true")
        
        def bool2:EvalValue (EvalValue.boolean(false))
        t.expectFalse(bool2.boolValue, "boolValue is false")
        t.expectStrEq(bool2.toString(), "false", "toString() returns 'false'")
        t.expectFalse(bool2.toBool(), "toBool() returns false")
        
        ; ===================================================================
        ; Test arrays
        ; ===================================================================
        
        t.header("Array values")
        def items:[EvalValue]
        push items (EvalValue.number(1.0))
        push items (EvalValue.number(2.0))
        push items (EvalValue.number(3.0))
        def arr:EvalValue (EvalValue.array(items))
        
        t.expectTrue(arr.isArray(), "isArray() returns true")
        t.expectTrue(arr.toBool(), "arrays are truthy")
        
        def arrLen:int (array_length arr.arrayValue)
        if (arrLen == 3) {
            print "  ✓ array has 3 items"
            t.passed = t.passed + 1
        } {
            print "  ✗ FAIL: array has 3 items"
            t.failed = t.failed + 1
        }
        
        ; Array index access
        def first:EvalValue (arr.getIndex(0))
        t.expectNumEq(first.numberValue, 1.0, "getIndex(0) returns first element")
        
        def third:EvalValue (arr.getIndex(2))
        t.expectNumEq(third.numberValue, 3.0, "getIndex(2) returns third element")
        
        def outOfBounds:EvalValue (arr.getIndex(10))
        t.expectTrue(outOfBounds.isNull(), "out of bounds returns null")
        
        ; Array length property
        def arrLenVal:EvalValue (arr.getMember("length"))
        t.expectNumEq(arrLenVal.numberValue, 3.0, "getMember('length') returns 3")
        
        t.header("Array toString")
        def arrStr:string (arr.toString())
        t.expectStrEq(arrStr, "[1, 2, 3]", "array toString is '[1, 2, 3]'")
        
        ; ===================================================================
        ; Test objects
        ; ===================================================================
        
        t.header("Object values")
        def keys:[string]
        def values:[EvalValue]
        push keys "name"
        push values (EvalValue.string("Alice"))
        push keys "age"
        push values (EvalValue.number(30.0))
        def obj:EvalValue (EvalValue.object(keys values))
        
        t.expectTrue(obj.isObject(), "isObject() returns true")
        t.expectTrue(obj.toBool(), "objects are truthy")
        
        ; Object member access
        def nameVal:EvalValue (obj.getMember("name"))
        t.expectStrEq(nameVal.stringValue, "Alice", "getMember('name') returns 'Alice'")
        
        def ageVal:EvalValue (obj.getMember("age"))
        t.expectNumEq(ageVal.numberValue, 30.0, "getMember('age') returns 30")
        
        def missing:EvalValue (obj.getMember("unknown"))
        t.expectTrue(missing.isNull(), "unknown key returns null")
        
        t.header("Object toString")
        def objStr:string (obj.toString())
        print "Object string: " + objStr
        def objStrLen:int (strlen objStr)
        if (objStrLen > 5) {
            print "  ✓ object toString has content"
            t.passed = t.passed + 1
        } {
            print "  ✗ FAIL: object toString has content"
            t.failed = t.failed + 1
        }
        
        ; ===================================================================
        ; Test string properties
        ; ===================================================================
        
        t.header("String properties")
        def testStr:EvalValue (EvalValue.string("hello"))
        def strLen:EvalValue (testStr.getMember("length"))
        t.expectNumEq(strLen.numberValue, 5.0, "string length is 5")
        
        def char0:EvalValue (testStr.getIndex(0))
        t.expectStrEq(char0.stringValue, "h", "getIndex(0) returns 'h'")
        
        def char4:EvalValue (testStr.getIndex(4))
        t.expectStrEq(char4.stringValue, "o", "getIndex(4) returns 'o'")
        
        ; ===================================================================
        ; Test equality
        ; ===================================================================
        
        t.header("Equality checks")
        def a1:EvalValue (EvalValue.number(42.0))
        def a2:EvalValue (EvalValue.number(42.0))
        def a3:EvalValue (EvalValue.number(99.0))
        t.expectTrue(a1.equals(a2), "42 equals 42")
        t.expectFalse(a1.equals(a3), "42 does not equal 99")
        
        def s1:EvalValue (EvalValue.string("test"))
        def s2:EvalValue (EvalValue.string("test"))
        def s3:EvalValue (EvalValue.string("other"))
        t.expectTrue(s1.equals(s2), "'test' equals 'test'")
        t.expectFalse(s1.equals(s3), "'test' does not equal 'other'")
        
        def b1:EvalValue (EvalValue.boolean(true))
        def b2:EvalValue (EvalValue.boolean(true))
        def b3:EvalValue (EvalValue.boolean(false))
        t.expectTrue(b1.equals(b2), "true equals true")
        t.expectFalse(b1.equals(b3), "true does not equal false")
        
        def null1:EvalValue (EvalValue.null())
        def null2:EvalValue (EvalValue.null())
        t.expectTrue(null1.equals(null2), "null equals null")
        
        ; Different types don't equal
        t.expectFalse(a1.equals(s1), "number does not equal string")
        t.expectFalse(b1.equals(null1), "boolean does not equal null")
        
        ; ===================================================================
        ; Summary
        ; ===================================================================
        
        t.summary()
    }
}
